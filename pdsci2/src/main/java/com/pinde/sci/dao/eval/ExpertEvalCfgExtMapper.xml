<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pinde.sci.dao.eval.ExpertEvalCfgExtMapper">
    <select id="searchParentList" parameterType="map" resultMap="com.pinde.sci.dao.base.ExpertEvalCfgMapper.BaseResultMap">
        SELECT * FROM
        EXPERT_EVAL_CFG
        WHERE RECORD_STATUS='Y'
        AND PARENT_CFG_FLOW IS NULL
        <if test="evalYear!=null and evalYear !=''">
            AND EVAL_YEAR=#{evalYear}
        </if>
        <if test="cfgName!=null and cfgName !=''">
            AND CFG_NAME LIKE CONCAT(CONCAT('%', #{cfgName}),'%')
        </if>
        <if test="isPublish!=null and isPublish !=''">
            AND IS_PUBLISH=#{isPublish}
        </if>
        order by eval_year desc
    </select>
    <select id="getMaxOrdinal" resultType="java.lang.Integer">
        SELECT count(ORDINAL) FROM
        EXPERT_EVAL_CFG
        WHERE RECORD_STATUS='Y'
        AND PARENT_CFG_FLOW =#{cfgFlow}
    </select>
    <select id="getChildrenListNotInCfg" resultMap="com.pinde.sci.dao.base.ExpertEvalCfgMapper.BaseResultMap">
    SELECT *
      FROM EXPERT_EVAL_CFG
     WHERE RECORD_STATUS = 'Y'
       AND IS_PUBLISH = 'Y'
       AND PARENT_CFG_FLOW =  #{cfgFlow}
       AND TYPE_ID = 'MANAGE'
       AND ( (ACTION_TYPE_ID = 'MANY'and
               (IS_EXPERT = 'N' OR EXISTS
                (SELECT 1
                     FROM SYS_USER
                    WHERE USER_FLOW = #{expertUserFlow}
                      AND SYS_USER.SRM_EXPERT_FLAG = IS_EXPERT)))
              or
           (ACTION_TYPE_ID = 'SINGLE' and
           (IS_EXPERT = 'N' OR EXISTS
            (SELECT 1
                 FROM SYS_USER
                WHERE USER_FLOW = #{expertUserFlow}
                  AND SYS_USER.SRM_EXPERT_FLAG = IS_EXPERT)) AND NOT EXISTS
            (SELECT 1
                FROM EXPERT_EVAL_ORG_CFG
               WHERE RECORD_STATUS = 'Y'
                 AND EXPERT_EVAL_ORG_CFG.CFG_FLOW = EXPERT_EVAL_CFG.CFG_FLOW
                 AND EXPERT_USER_FLOW != #{expertUserFlow}
                 AND ORG_FLOW = #{orgFlow})))
     ORDER BY LEVEL_ID, ORDINAL
    </select>
    <select id="getSpeListNotSelf" resultMap="com.pinde.sci.dao.base.SysDictMapper.BaseResultMap">
    SELECT DICT_FLOW, DICT_TYPE_ID, DICT_TYPE_NAME, DICT_ID, DICT_NAME
            , DICT_DESC, ORDINAL, RECORD_STATUS, CREATE_TIME, CREATE_USER_FLOW
            , MODIFY_TIME, MODIFY_USER_FLOW, DICT_ISSYS, ORG_NAME, ORG_FLOW
        FROM PDSCI.SYS_DICT
        WHERE DICT_TYPE_ID = 'DoctorTrainingSpe'
        and record_status='Y'
        and not EXISTS (
            select  1 from expert_eval_cfg
            WHERE RECORD_STATUS = 'Y'
            and eval_year =(select eval_year from expert_eval_cfg where cfg_flow=#{cfgFlow})
            and spe_id=dict_id
            and cfg_Flow!=#{cfgFlow}
        )
        ORDER BY ORDINAL
    </select>
    <select id="checkSpeCfgNotSelf" resultMap="com.pinde.sci.dao.base.ExpertEvalCfgMapper.BaseResultMap">
     SELECT *
      FROM EXPERT_EVAL_CFG
     WHERE RECORD_STATUS = 'Y'
        and record_status='Y'
        and eval_year =(select eval_year from expert_eval_cfg where cfg_flow=#{cfgFlow})
        and cfg_Flow!=#{cfgFlow}
        and spe_id=#{speId}
        ORDER BY ORDINAL
    </select>
    <select id="getChildrenListNotInCfgNotManage" resultMap="com.pinde.sci.dao.base.ExpertEvalCfgMapper.BaseResultMap">
    SELECT *
      FROM EXPERT_EVAL_CFG
     WHERE RECORD_STATUS = 'Y'
       AND IS_PUBLISH = 'Y'
       AND PARENT_CFG_FLOW =  #{cfgFlow}
       <if test="speId!=null and speId!=''">
           AND SPE_ID =  #{speId}
       </if>
       AND TYPE_ID != 'MANAGE'
       AND ((ACTION_TYPE_ID = 'MANY'  and
        (IS_EXPERT = 'N' OR EXISTS
        (SELECT 1
        FROM SYS_USER
        WHERE USER_FLOW = #{expertUserFlow}
        AND SYS_USER.SRM_EXPERT_FLAG = IS_EXPERT)) ) or
           (ACTION_TYPE_ID = 'SINGLE' and
           (IS_EXPERT = 'N' OR EXISTS
            (SELECT 1
                 FROM SYS_USER
                WHERE USER_FLOW = #{expertUserFlow}
                  AND SYS_USER.SRM_EXPERT_FLAG = IS_EXPERT)) AND NOT EXISTS
            (SELECT 1
                FROM EXPERT_EVAL_ORG_SPE_CFG
               WHERE RECORD_STATUS = 'Y'
                 AND EXPERT_EVAL_ORG_SPE_CFG.CFG_FLOW = EXPERT_EVAL_CFG.CFG_FLOW
                 AND EXPERT_USER_FLOW != #{expertUserFlow}
                 AND ORG_FLOW = #{orgFlow})))
     ORDER BY LEVEL_ID, ORDINAL
    </select>
</mapper>