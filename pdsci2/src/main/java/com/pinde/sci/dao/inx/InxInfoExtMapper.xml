<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pinde.sci.dao.inx.InxInfoExtMapper" >
    <resultMap id="extResultMap" type="com.pinde.core.model.InxInfoExt"
               extends="com.pinde.core.common.sci.dao.InxInfoMapper.BaseResultMap">
        <association property="column" column="column_id" javaType="com.pinde.core.model.InxColumn">
			<id column="COLUMN_FLOW" jdbcType="VARCHAR" property="columnFlow" />
		    <result column="COLUMN_ID" jdbcType="VARCHAR" property="columnId" />
		    <result column="COLUMN_NAME" jdbcType="VARCHAR" property="columnName" />
		    <result column="PARENT_COLUMN_ID" jdbcType="VARCHAR" property="parentColumnId" />
		    <result column="t2_ORDINAL" jdbcType="DECIMAL" property="ordinal" />
		    <result column="t2_RECORD_STATUS" jdbcType="CHAR" property="recordStatus" />
		    <result column="t2_CREATE_TIME" jdbcType="VARCHAR" property="createTime" />
		    <result column="t2_CREATE_USER_FLOW" jdbcType="VARCHAR" property="createUserFlow" />
		    <result column="t2_MODIFY_TIME" jdbcType="VARCHAR" property="modifyTime" />
		    <result column="t2_MODIFY_USER_FLOW" jdbcType="VARCHAR" property="modifyUserFlow" />
		</association>
	</resultMap>
    <resultMap id="extResultMapWithBLOBs" type="com.pinde.core.model.InxInfoExt"
               extends="com.pinde.core.common.sci.dao.InxInfoMapper.ResultMapWithBLOBs">
        <association property="column" column="column_id" javaType="com.pinde.core.model.InxColumn">
			<id column="COLUMN_FLOW" jdbcType="VARCHAR" property="columnFlow" />
		    <result column="COLUMN_ID" jdbcType="VARCHAR" property="columnId" />
		    <result column="COLUMN_NAME" jdbcType="VARCHAR" property="columnName" />
		    <result column="PARENT_COLUMN_ID" jdbcType="VARCHAR" property="parentColumnId" />
		    <result column="t2_ORDINAL" jdbcType="DECIMAL" property="ordinal" />
		    <result column="t2_RECORD_STATUS" jdbcType="CHAR" property="recordStatus" />
		    <result column="t2_CREATE_TIME" jdbcType="VARCHAR" property="createTime" />
		    <result column="t2_CREATE_USER_FLOW" jdbcType="VARCHAR" property="createUserFlow" />
		    <result column="t2_MODIFY_TIME" jdbcType="VARCHAR" property="modifyTime" />
		    <result column="t2_MODIFY_USER_FLOW" jdbcType="VARCHAR" property="modifyUserFlow" />
		</association>
	</resultMap>
  <select id="selectExtByFlow" parameterType="string" resultMap="extResultMapWithBLOBs">
  	select t1.*,COLUMN_FLOW, t2.COLUMN_ID as t2_column_id, t2.COLUMN_NAME, t2.PARENT_COLUMN_ID, t2.ORDINAL as t2_ORDINAL, t2.RECORD_STATUS as t2_RECORD_STATUS, t2.CREATE_TIME as t2_CREATE_TIME, t2.CREATE_USER_FLOW as t2_CREATE_USER_FLOW, t2.MODIFY_TIME as t2_MODIFY_TIME, t2.MODIFY_USER_FLOW as t2_MODIFY_USER_FLOW
      from INX_INFO t1 left join INX_COLUMN t2 on t1.column_id = t2.column_id where info_flow=#{infoFlow}
  </select>
  <update id="updateInfoState" parameterType="com.pinde.sci.form.inx.InxInfoForm">
      update INX_INFO set INFO_STATUS_ID = #{infoStatusId},INFO_STATUS_NAME = #{infoStatusName} where INFO_STATUS_ID
      <![CDATA[<>]]> 'Failure' and info_flow in
	       <foreach collection="infoFlows" open="(" separator="," close=")" item="item">#{item}</foreach>
	       <if test='infoStatusId=="Passing"'>
	       	and (INFO_STATUS_ID = 'Edit' or INFO_STATUS_ID = 'NoPassed')
	       </if>
  </update>
  <update id="deleteInfoRole" >
      update RES_INFO_ROLE set RECORD_STATUS='N'
	  where INFO_FLOW=#{info.infoFlow} and RECORD_STATUS='Y'
	   <if test="roleFlows !=null and roleFlows.size()>0">
		   and   INFO_ROLE in
		   <foreach collection="roleFlows" open="(" separator="," close=")" item="item">#{item}</foreach>
	   </if>
  </update>

    <select id="searchInfoByOrgBeforeDate" resultMap="com.pinde.core.common.sci.dao.InxInfoMapper.ResultMapWithBLOBs">
  	SELECT *
        FROM INX_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='resSysId!=null and resSysId!=""'>
			AND ROLE_FLOW = #{resSysId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND (ORG_FLOW = #{orgFlow} OR ORG_FLOW IS NULL)
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
		<if test='date!=null and date!=""'>
			AND INFO_TIME >= #{date}
		</if>
		  AND (
	  		NOT EXISTS (
		  		SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=INX_INFO.INFO_FLOW
		  	)
			<if test='userFlow!=null and userFlow!=""'>
				OR EXISTS(
					SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=INX_INFO.INFO_FLOW
					<if test='sessionNumber!=null and sessionNumber!=""'>
						and (session_Number=#{sessionNumber} or session_number is null)
					</if>
					AND INFO_ROLE IN (SELECT ROLE_FLOW FROM SYS_USER_ROLE WHERE RECORD_STATUS='Y' AND USER_FLOW =#{userFlow})
				)
				</if>
		  )
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="searchInfoByOrg" resultMap="com.pinde.core.common.sci.dao.InxInfoMapper.ResultMapWithBLOBs">
  	SELECT *
        FROM INX_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='resSysId!=null and resSysId!=""'>
			AND ROLE_FLOW = #{resSysId}
		</if>
		<if test='orgFlow!=null and orgFlow!="" and orgFlow!="N"'>
			AND ORG_FLOW = #{orgFlow}
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
        <if test='orgFlow=="N"'>
            AND ORG_FLOW IS NOT NULL
        </if>
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="searchInfoByOrg2" resultMap="com.pinde.core.common.sci.dao.InxInfoMapper.ResultMapWithBLOBs">
		SELECT *
        FROM INX_INFO
		WHERE RECORD_STATUS = 'Y'
		AND COLUMN_ID in ('LM05','LM06','LM07','LM08','LM09')
		<if test='resSysId!=null and resSysId!=""'>
			AND ROLE_FLOW = #{resSysId}
		</if>
		<if test='orgFlow!=null and orgFlow!="" and orgFlow!="N"'>
			AND ORG_FLOW = #{orgFlow}
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
		<if test='orgFlow=="N"'>
			AND ORG_FLOW IS NOT NULL
		</if>
		ORDER BY INFO_TIME DESC
	</select>
    <select id="searchInfoByParam" resultMap="com.pinde.core.common.sci.dao.InxInfoMapper.ResultMapWithBLOBs">
  	SELECT *
        FROM INX_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='resSysId!=null and resSysId!=""'>
			AND ROLE_FLOW = #{resSysId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND ORG_FLOW = #{orgFlow}
		</if>
		<if test='noticeTitle!=null and noticeTitle!=""'>
			AND info_title like CONCAT(CONCAT('%', #{noticeTitle}),'%')
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="searchInfoByOrgNoRoleFlow" resultMap="com.pinde.core.common.sci.dao.InxInfoMapper.ResultMapWithBLOBs">
  	SELECT *
        FROM INX_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='resSysId!=null and resSysId!=""'>
			AND ROLE_FLOW = #{resSysId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND ORG_FLOW = #{orgFlow}
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
		  AND  NOT EXISTS (
			SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=INX_INFO.INFO_FLOW
		  )
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="searchInfoByOrgNoRoleFlow2" resultMap="com.pinde.core.common.sci.dao.InxInfoMapper.ResultMapWithBLOBs">
		SELECT *
        FROM INX_INFO
		WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='resSysId!=null and resSysId!=""'>
			AND ROLE_FLOW = #{resSysId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND ORG_FLOW = #{orgFlow}
		</if>
		AND  NOT EXISTS (
		SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=INX_INFO.INFO_FLOW
		)
		ORDER BY INFO_TIME DESC
	</select>
    <select id="searchInfoNotRead" resultMap="com.pinde.core.common.sci.dao.InxInfoMapper.ResultMapWithBLOBs">
  	SELECT *
        FROM INX_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='resSysId!=null and resSysId!=""'>
			AND ROLE_FLOW = #{resSysId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND (ORG_FLOW = #{orgFlow} OR ORG_FLOW IS NULL)
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
		  AND (
	  		NOT EXISTS (
		  		SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=INX_INFO.INFO_FLOW
		  	)
			<if test='userFlow!=null and userFlow!=""'>
				OR EXISTS(
					SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=INX_INFO.INFO_FLOW
	  				<if test='sessionNumber!=null and sessionNumber!=""'>
						and (session_Number=#{sessionNumber} or session_number is null)
					</if>
					AND INFO_ROLE IN (SELECT ROLE_FLOW FROM SYS_USER_ROLE WHERE RECORD_STATUS='Y' AND USER_FLOW =#{userFlow})
				)
				</if>
		  )
	    and not exists (
			SELECT 1 FROM RES_READ_INFO WHERE RECORD_STATUS='Y' AND RES_READ_INFO.INFO_FLOW=INX_INFO.INFO_FLOW
			AND RES_READ_INFO.USER_FLOW=#{userFlow}
	  	)
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="findNoticeWithBLOBsNotHaveRole"
            resultMap="com.pinde.core.common.sci.dao.InxInfoMapper.ResultMapWithBLOBs">
  	SELECT *
        FROM INX_INFO
  	WHERE RECORD_STATUS = 'Y'
  	<if test='info.columnId!=null and info.columnId!=""'>
  		AND COLUMN_ID = #{info.columnId}
  	</if>
  	<if test='info.roleFlow!=null and info.roleFlow!=""'>
  		AND ROLE_FLOW = #{info.roleFlow}
  	</if>
  	<if test='info.orgFlow!=null and info.orgFlow!=""'>
  		AND (ORG_FLOW = #{info.orgFlow} OR ORG_FLOW IS NULL)
  	</if>
  	<if test='info.orgFlow==null or info.orgFlow==""'>
  		AND ORG_FLOW IS NULL
  	</if>
	  AND NOT EXISTS (
	  	SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=INX_INFO.INFO_FLOW
	  )
  	ORDER BY INFO_TIME DESC
  </select>
  
</mapper>