<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pinde.sci.dao.portal.PortalInfoExtMapper" >
    <resultMap id="extResultMap" type="com.pinde.core.model.PortalInfoExt"
               extends="com.pinde.core.common.sci.dao.PortalInfoMapper.BaseResultMap">
        <association property="column" column="column_id" javaType="com.pinde.core.model.PortalColumn">
			<id column="COLUMN_FLOW" jdbcType="VARCHAR" property="columnFlow" />
		    <result column="COLUMN_ID" jdbcType="VARCHAR" property="columnId" />
		    <result column="COLUMN_NAME" jdbcType="VARCHAR" property="columnName" />
		    <result column="PARENT_COLUMN_ID" jdbcType="VARCHAR" property="parentColumnId" />
		    <result column="t2_ORDINAL" jdbcType="DECIMAL" property="ordinal" />
		    <result column="t2_RECORD_STATUS" jdbcType="CHAR" property="recordStatus" />
		    <result column="t2_CREATE_TIME" jdbcType="VARCHAR" property="createTime" />
		    <result column="t2_CREATE_USER_FLOW" jdbcType="VARCHAR" property="createUserFlow" />
		    <result column="t2_MODIFY_TIME" jdbcType="VARCHAR" property="modifyTime" />
		    <result column="t2_MODIFY_USER_FLOW" jdbcType="VARCHAR" property="modifyUserFlow" />
		</association>
	</resultMap>
    <resultMap id="extResultMapWithBLOBs" type="com.pinde.core.model.PortalInfoExt"
               extends="com.pinde.core.common.sci.dao.PortalInfoMapper.ResultMapWithBLOBs">
        <association property="column" column="column_id" javaType="com.pinde.core.model.PortalColumn">
			<id column="COLUMN_FLOW" jdbcType="VARCHAR" property="columnFlow" />
		    <result column="COLUMN_ID" jdbcType="VARCHAR" property="columnId" />
		    <result column="COLUMN_NAME" jdbcType="VARCHAR" property="columnName" />
		    <result column="PARENT_COLUMN_ID" jdbcType="VARCHAR" property="parentColumnId" />
		    <result column="t2_ORDINAL" jdbcType="DECIMAL" property="ordinal" />
		    <result column="t2_RECORD_STATUS" jdbcType="CHAR" property="recordStatus" />
		    <result column="t2_CREATE_TIME" jdbcType="VARCHAR" property="createTime" />
		    <result column="t2_CREATE_USER_FLOW" jdbcType="VARCHAR" property="createUserFlow" />
		    <result column="t2_MODIFY_TIME" jdbcType="VARCHAR" property="modifyTime" />
		    <result column="t2_MODIFY_USER_FLOW" jdbcType="VARCHAR" property="modifyUserFlow" />
		</association>
	</resultMap>
  <select id="selectExtByFlow" parameterType="string" resultMap="extResultMapWithBLOBs">
  	select t1.*,COLUMN_FLOW, t2.COLUMN_ID as t2_column_id, t2.COLUMN_NAME, t2.PARENT_COLUMN_ID, t2.ORDINAL as t2_ORDINAL, t2.RECORD_STATUS as t2_RECORD_STATUS, t2.CREATE_TIME as t2_CREATE_TIME, t2.CREATE_USER_FLOW as t2_CREATE_USER_FLOW, t2.MODIFY_TIME as t2_MODIFY_TIME, t2.MODIFY_USER_FLOW as t2_MODIFY_USER_FLOW
      from PORTAL_INFO t1 left join PORTAL_COLUMN t2 on t1.column_id = t2.column_id where info_flow=#{infoFlow}
  </select>
  <update id="updateInfoState" parameterType="com.pinde.sci.form.portal.PortalInfoForm">
      update PORTAL_INFO set INFO_STATUS_ID = #{infoStatusId},INFO_STATUS_NAME = #{infoStatusName} where INFO_STATUS_ID
      <![CDATA[<>]]> 'Failure' and info_flow in
	       <foreach collection="infoFlows" open="(" separator="," close=")" item="item">#{item}</foreach>
	       <if test='infoStatusId=="Passing"'>
	       	and (INFO_STATUS_ID = 'Edit' or INFO_STATUS_ID = 'NoPassed')
	       </if>
  </update>
  <update id="deleteInfoRole" >
      update RES_INFO_ROLE set RECORD_STATUS='N'
	  where INFO_FLOW=#{info.infoFlow} and RECORD_STATUS='Y'
	   <if test="roleFlows !=null and roleFlows.size()>0">
		   and   INFO_ROLE in
		   <foreach collection="roleFlows" open="(" separator="," close=")" item="item">#{item}</foreach>
	   </if>
  </update>

    <select id="searchInfoByOrgBeforeDate"
            resultMap="com.pinde.core.common.sci.dao.PortalInfoMapper.ResultMapWithBLOBs">
  	SELECT *
      FROM PORTAL_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND (ORG_FLOW = #{orgFlow} OR ORG_FLOW IS NULL)
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
		<if test='date!=null and date!=""'>
			AND INFO_TIME >= #{date}
		</if>
		  AND (
	  		NOT EXISTS (
		  		SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=PORTAL_INFO.INFO_FLOW
		  	)
			<if test='userFlow!=null and userFlow!=""'>
				OR EXISTS(
					SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=PORTAL_INFO.INFO_FLOW
					<if test='sessionNumber!=null and sessionNumber!=""'>
						and (session_Number=#{sessionNumber} or session_number is null)
					</if>
							)
				</if>
		  )
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="searchInfoByOrg" resultMap="com.pinde.core.common.sci.dao.PortalInfoMapper.ResultMapWithBLOBs">
  	SELECT *
      FROM PORTAL_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND ORG_FLOW = #{orgFlow}
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="searchInfoByParam" resultMap="com.pinde.core.common.sci.dao.PortalInfoMapper.ResultMapWithBLOBs">
  	SELECT *
      FROM PORTAL_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND ORG_FLOW = #{orgFlow}
		</if>
		<if test='noticeTitle!=null and noticeTitle!=""'>
			AND info_title like CONCAT(CONCAT('%', #{noticeTitle}),'%')
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="searchInfoByOrgNoRoleFlow"
            resultMap="com.pinde.core.common.sci.dao.PortalInfoMapper.ResultMapWithBLOBs">
  	SELECT *
      FROM PORTAL_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND ORG_FLOW = #{orgFlow}
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
		  AND  NOT EXISTS (
			SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=PORTAL_INFO.INFO_FLOW
		  )
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="searchInfoNotRead" resultMap="com.pinde.core.common.sci.dao.PortalInfoMapper.ResultMapWithBLOBs">
  	SELECT *
      FROM PORTAL_INFO
  	WHERE RECORD_STATUS = 'Y'
		<if test='resNoticeTypeId!=null and resNoticeTypeId!=""'>
			AND COLUMN_ID = #{resNoticeTypeId}
		</if>
		<if test='orgFlow!=null and orgFlow!=""'>
			AND (ORG_FLOW = #{orgFlow} OR ORG_FLOW IS NULL)
		</if>
		<if test='orgFlow==null or orgFlow==""'>
			AND ORG_FLOW IS NULL
		</if>
		  AND (
	  		NOT EXISTS (
		  		SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=PORTAL_INFO.INFO_FLOW
		  	)
			<if test='userFlow!=null and userFlow!=""'>
				OR EXISTS(
					SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=PORTAL_INFO.INFO_FLOW
	  				<if test='sessionNumber!=null and sessionNumber!=""'>
						and (session_Number=#{sessionNumber} or session_number is null)
					</if>
							)
				</if>
		  )
	    and not exists (
			SELECT 1 FROM RES_READ_INFO WHERE RECORD_STATUS='Y' AND RES_READ_INFO.INFO_FLOW=PORTAL_INFO.INFO_FLOW
			AND RES_READ_INFO.USER_FLOW=#{userFlow}
	  	)
  	ORDER BY INFO_TIME DESC
  </select>
    <select id="findNoticeWithBLOBsNotHaveRole"
            resultMap="com.pinde.core.common.sci.dao.PortalInfoMapper.ResultMapWithBLOBs">
  	SELECT *
      FROM PORTAL_INFO
  	WHERE RECORD_STATUS = 'Y'
  	<if test='info.columnId!=null and info.columnId!=""'>
  		AND COLUMN_ID = #{info.columnId}
  	</if>
  	<if test='info.orgFlow!=null and info.orgFlow!=""'>
  		AND (ORG_FLOW = #{info.orgFlow} OR ORG_FLOW IS NULL)
  	</if>
  	<if test='info.orgFlow==null or info.orgFlow==""'>
  		AND ORG_FLOW IS NULL
  	</if>
	  AND NOT EXISTS (
	  	SELECT 1 FROM RES_INFO_ROLE WHERE RECORD_STATUS='Y' AND RES_INFO_ROLE.INFO_FLOW=PORTAL_INFO.INFO_FLOW
	  )
  	ORDER BY INFO_TIME DESC
  </select>
  <select id="getStatistics" resultType="java.util.Map" parameterType="java.util.Map">
	  select su.user_name,su.wei_Xin_Status_Id,
	  (select count(0) from PORTAL_INFO pi where pi.CREATE_USER_FLOW = su.user_flow and pi.RECORD_STATUS='Y' and pi.INFO_STATUS_ID != 'Failure') a,
	  (select count(0) from PORTAL_INFO pi where pi.CREATE_USER_FLOW = su.user_flow and pi.RECORD_STATUS='Y' and pi.INFO_STATUS_ID = 'Passed') b
	  from sys_user su
	  where su.record_status='Y'
	  and su.nation_Id='portal'
	  and EXISTS
	  (select null from Sys_User_Role sur WHERE sur.RECORD_STATUS='Y' and sur.user_Flow = su.user_flow and sur.role_flow = #{userRoleFlow})
	  ORDER by b desc
  </select>
</mapper>