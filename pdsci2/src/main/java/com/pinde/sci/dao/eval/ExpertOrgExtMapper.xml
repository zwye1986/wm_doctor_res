<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pinde.sci.dao.eval.ExpertOrgExtMapper">

    <select id="searchOrg" parameterType="map" resultMap="com.pinde.sci.dao.base.SysOrgMapper.BaseResultMap">
        SELECT
          *
        FROM SYS_ORG
        WHERE RECORD_STATUS='Y'
        <if test=" orgLevelId!=null and orgLevelId !=''">
            AND ORG_LEVEL_ID=#{orgLevelId}
        </if>
        <if test=" orgName!=null and orgName !=''">
            AND ORG_NAME LIKE CONCAT(CONCAT('%', #{orgName}),'%')
        </if>
        <if test="joinEval!=null and joinEval !=''">
            AND EXISTS(
              SELECT 1 FROM EXPERT_ORG WHERE RECORD_STATUS='Y'AND EVAL_YEAR=#{evalYear}
            AND EXPERT_ORG.ORG_FLOW=SYS_ORG.ORG_FLOW
            )
        </if>
        order by org_code desc,org_flow
    </select>
    <select id="evalOrgQueryList" parameterType="map" resultMap="com.pinde.sci.dao.base.SysOrgMapper.BaseResultMap">
        SELECT
          *
        FROM SYS_ORG
        WHERE RECORD_STATUS='Y'
        <if test="orgName!=null and orgName !=''">
            AND ORG_NAME LIKE CONCAT(CONCAT('%', #{orgName}),'%')
        </if>
        AND EXISTS(
            SELECT 1 FROM EXPERT_ORG WHERE RECORD_STATUS='Y'AND EVAL_YEAR=#{evalYear}
            AND EXPERT_ORG.ORG_FLOW=SYS_ORG.ORG_FLOW
        )
        <if test="speId!=null and speId !=''">
            AND EXISTS(
            SELECT 1 FROM EXPERT_ORG_spe WHERE RECORD_STATUS='Y'AND EVAL_YEAR=#{evalYear} and spe_id=#{speId}
            AND EXPERT_ORG_spe.ORG_FLOW=SYS_ORG.ORG_FLOW
            )
        </if>
        order by org_code desc
    </select>
    <select id="getExpertSpeByOrgAndYear" resultType="java.lang.Integer">
        SELECT NVL(COUNT(1),0) FROM EXPERT_ORG_SPE
        WHERE RECORD_STATUS='Y'
        AND ORG_FLOW =#{orgFlow}
        AND EVAL_YEAR =#{evalYear}
        AND EXISTS (
          SELECT 1 FROM RES_ORG_SPE WHERE RECORD_STATUS='Y' AND SPE_TYPE_ID ='DoctorTrainingSpe'
          AND EXPERT_ORG_SPE.ORG_FLOW=RES_ORG_SPE.ORG_FLOW
			AND EXPERT_ORG_SPE.SPE_ID = RES_ORG_SPE.SPE_ID
        )
    </select>
    <resultMap id="clinicalMap" type="hashmap" extends="com.pinde.sci.dao.base.ExpertOrgSpeMapper.BaseResultMap">
        <result column="SCORE" jdbcType="INTEGER" property="score" />
        <result column="ORDER_NUM" jdbcType="INTEGER" property="orderNum" />
    </resultMap>
    <select id="showOrgClinicalList" resultMap="clinicalMap">
        SELECT EOS.*,B.SCORE,B.ORDER_NUM
        FROM EXPERT_ORG_SPE EOS
        LEFT JOIN (
             SELECT EEOS.*, NVL(EVAL_SCORE,'-') SCORE,DENSE_RANK() OVER (PARTITION BY EEOS.SPE_ID ORDER BY TO_NUMBER(NVL(RESULT.EVAL_SCORE,0)) DESC) ORDER_NUM
             FROM EXPERT_ORG_SPE EEOS
              LEFT JOIN EXPERT_EVAL_RESULT RESULT
              ON RESULT.RECORD_STATUS='Y'
              AND RESULT.SPE_ID IS NOT NULL
              AND RESULT.IS_OVER_ALL='Y'
              AND RESULT.TYPE_ID='CLINICAL'
              AND EEOS.EVAL_YEAR=RESULT.EVAL_YEAR
              AND EEOS.SPE_ID=RESULT.SPE_ID
              AND EEOS.ORG_FLOW=RESULT.ORG_FLOW
              WHERE EEOS.RECORD_STATUS='Y'
              AND EEOS.EVAL_YEAR=#{evalYear}
        ) B
        ON B.ORG_FLOW=EOS.ORG_FLOW
        AND B.SPE_ID=EOS.SPE_ID
        WHERE EOS.RECORD_STATUS='Y'
        <if test="speId!=null and speId !=''">
            AND EOS.spe_id=#{speId}
        </if>
        AND EOS.EVAL_YEAR=#{evalYear}
        AND EOS.ORG_FLOW=#{orgFlow}
    </select>
    <resultMap id="OrgSpePmMap" type="hashmap" extends="com.pinde.sci.dao.base.ExpertOrgSpeMapper.BaseResultMap">
        <result column="SCORE" jdbcType="VARCHAR" property="score" />
        <result column="ORDER_NUM" jdbcType="VARCHAR" property="orderNum" />
        <result column="CFG_NAME" jdbcType="VARCHAR" property="cfgName" />
    </resultMap>
    <select id="evalOrgQueryOrgSpePm" resultMap="OrgSpePmMap">
        SELECT EOS.record_flow, EOS.eval_year, EOS.org_flow,org.org_name, EOS.spe_id, EOS.spe_name, EOS.record_status,
        to_char(B.SCORE) AS SCORE, to_char(B.ORDER_NUM) AS ORDER_NUM, cfg.cfg_name
        FROM EXPERT_ORG_SPE EOS
        LEFT JOIN (
             SELECT EEOS.*, NVL(EVAL_SCORE,'-') SCORE,DENSE_RANK() OVER (PARTITION BY EEOS.SPE_ID ORDER BY TO_NUMBER(NVL(RESULT.EVAL_SCORE,0)) DESC) ORDER_NUM,
                result.cfg_flow
             FROM EXPERT_ORG_SPE EEOS
              LEFT JOIN EXPERT_EVAL_RESULT RESULT
              ON RESULT.RECORD_STATUS='Y'
              AND RESULT.SPE_ID IS NOT NULL
              AND RESULT.IS_OVER_ALL='Y'
              AND RESULT.TYPE_ID='CLINICAL'
              AND EEOS.EVAL_YEAR=RESULT.EVAL_YEAR
              AND EEOS.SPE_ID=RESULT.SPE_ID
              AND EEOS.ORG_FLOW=RESULT.ORG_FLOW
              WHERE EEOS.RECORD_STATUS='Y'
              AND EEOS.EVAL_YEAR=#{evalYear}
        ) B
        ON B.ORG_FLOW=EOS.ORG_FLOW
        AND B.SPE_ID=EOS.SPE_ID
        left join expert_eval_cfg cfg
        on b.cfg_Flow=cfg.cfg_flow
        left join sys_org org
        on org.org_flow=eos.org_flow
        WHERE EOS.RECORD_STATUS='Y'
        <if test="speId!=null and speId !=''">
            AND EOS.spe_id=#{speId}
        </if>
        <if test="orgName!=null and orgName !=''">
            AND EOS.org_name like CONCAT(CONCAT('%', #{orgName}),'%')
        </if>
        AND EOS.EVAL_YEAR=#{evalYear}
        order by eos.spe_id,b.order_num
        <if test="orderType!=null and orderType !=''">
            ${orderType}
        </if>,org.org_code
    </select>
    <resultMap id="orgPmMap" type="hashmap" extends="com.pinde.sci.dao.base.ExpertOrgMapper.BaseResultMap">
        <result column="SCORE" jdbcType="VARCHAR" property="score" />
        <result column="ORDER_NUM" jdbcType="VARCHAR" property="orderNum" />
    </resultMap>
    <select id="evalOrgQueryOrgPm" resultMap="orgPmMap">
        SELECT EOS.record_flow, EOS.eval_year, EOS.org_flow,org.org_name, EOS.record_status,
        to_char(B.SCORE)SCORE,to_char(B.ORDER_NUM) ORDER_NUM
        FROM EXPERT_ORG EOS
        LEFT JOIN (
             SELECT EEOS.*, to_char(NVL(EVAL_SCORE,'-')) SCORE,DENSE_RANK() OVER (PARTITION BY EEOS.EVAL_YEAR ORDER BY TO_NUMBER(NVL(RESULT.EVAL_SCORE,0)) DESC) ORDER_NUM
             FROM EXPERT_ORG EEOS
              LEFT JOIN EXPERT_EVAL_RESULT RESULT
              ON RESULT.RECORD_STATUS='Y'
              AND RESULT.SPE_ID IS NULL
              AND RESULT.IS_OVER_ALL='Y'
              AND RESULT.TYPE_ID='MANAGE'
              AND EEOS.EVAL_YEAR=RESULT.EVAL_YEAR
              AND EEOS.ORG_FLOW=RESULT.ORG_FLOW
              WHERE EEOS.RECORD_STATUS='Y'
              AND EEOS.EVAL_YEAR=#{evalYear}
        ) B
        ON B.ORG_FLOW=EOS.ORG_FLOW
        left join sys_org org
        on org.org_flow=eos.org_flow
        WHERE EOS.RECORD_STATUS='Y'
        <if test="orgName!=null and orgName !=''">
            AND EOS.org_name like CONCAT(CONCAT('%', #{orgName}),'%')
        </if>
        AND EOS.EVAL_YEAR=#{evalYear}
        order by b.order_num
        <if test="orderType!=null and orderType !=''">
             ${orderType}
        </if>,org.org_code
    </select>
</mapper>