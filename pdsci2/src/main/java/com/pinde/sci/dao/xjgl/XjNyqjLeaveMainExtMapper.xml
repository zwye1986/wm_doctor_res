<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pinde.sci.dao.xjgl.XjNyqjLeaveMainExtMapper">
    <select id="queryNyqjListByTutor" parameterType="java.util.Map" resultMap="com.pinde.sci.dao.base.NyqjLeaveMainMapper.BaseResultMap">
        select nlm.* from Nyqj_Leave_Main nlm
        where nlm.record_status='Y'
        <if test="doctorFlow!=null and doctorFlow!=''">
          and (nlm.doctor_flow=#{doctorFlow} or nlm.second_doctor_flow=#{doctorFlow})
        </if>
        <if test="userName!=null and userName!=''">
            <bind name="name" value="'%'+userName+'%'"/>
            and nlm.user_name like #{name}
        </if>
        <if test="studentId!=null and studentId!=''">
            <bind name="name" value="'%'+studentId+'%'"/>
            and nlm.student_id like #{name}
        </if>
        <if test="startTime!=null and startTime!='' and endTime!=null and endTime!=''">
            and nlm.apply_time <![CDATA[ >= ]]> #{startTime}
            and nlm.apply_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="applyTypeId!=null and applyTypeId!=''">
            and nlm.apply_type_id=#{applyTypeId}
        </if>
        order by nlm.apply_time desc
    </select>
    <select id="queryNyqjListByPydw" parameterType="java.util.Map" resultMap="com.pinde.sci.dao.base.NyqjLeaveMainMapper.BaseResultMap">
        with a as ( select nlm.* from Nyqj_Leave_Main nlm
            left join res_doctor rd
            on rd.doctor_flow=nlm.user_flow
            and rd.record_status='Y'
            where nlm.record_status='Y'
            and nlm.second_doctor_flow is null
            and nlm.doctor_flow is not null
            and nlm.doctor_audit_status_id='Passed'
            <if test="orgFlow!=null and orgFlow!=''">
                and rd.org_flow=#{orgFlow}
            </if>
            union all
            select nlm.* from Nyqj_Leave_Main nlm
            left join res_doctor rd
            on rd.doctor_flow=nlm.user_flow
            and rd.record_status='Y'
            where nlm.record_status='Y'
            and nlm.doctor_flow is null
            and nlm.second_doctor_flow is not null
            and nlm.second_audit_status_id='Passed'
            <if test="orgFlow!=null and orgFlow!=''">
                and rd.org_flow=#{orgFlow}
            </if>
            union all
            select nlm.* from Nyqj_Leave_Main nlm
            left join res_doctor rd
            on rd.doctor_flow=nlm.user_flow
            and rd.record_status='Y'
            where nlm.record_status='Y'
            and nlm.doctor_flow is not null
            and nlm.second_doctor_flow is not null
            and nlm.doctor_audit_status_id='Passed'
            and nlm.second_audit_status_id='Passed'
            <if test="orgFlow!=null and orgFlow!=''">
                and rd.org_flow=#{orgFlow}
            </if>
        )
        select a.* from a where 1=1
        <if test="userName!=null and userName!=''">
            <bind name="name" value="'%'+userName+'%'"/>
            and a.user_name like #{name}
        </if>
        <if test="studentId!=null and studentId!=''">
            <bind name="name" value="'%'+studentId+'%'"/>
            and a.student_id like #{name}
        </if>
        <if test="startTime!=null and startTime!='' and endTime!=null and endTime!=''">
            and a.apply_time <![CDATA[ >= ]]> #{startTime}
            and a.apply_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="applyTypeId!=null and applyTypeId!=''">
            and a.apply_type_id=#{applyTypeId}
        </if>
        order by a.apply_time desc
    </select>
    <select id="queryNyqjListBySzk" parameterType="java.util.Map" resultMap="com.pinde.sci.dao.base.NyqjLeaveMainMapper.BaseResultMap">
        select nlm.* from Nyqj_Leave_Main nlm
        where nlm.record_status='Y'
        <if test="yjsbmAuditFlag!=null and yjsbmAuditFlag!=''">
            and nlm.yjsbm_audit_flag=#{yjsbmAuditFlag}
        </if>
        <if test="pydwAuditStatusId!=null and pydwAuditStatusId!=''">
            and nlm.pydw_audit_status_id=#{pydwAuditStatusId}
        </if>
        <if test="userName!=null and userName!=''">
            <bind name="name" value="'%'+userName+'%'"/>
            and nlm.user_name like #{name}
        </if>
        <if test="studentId!=null and studentId!=''">
            <bind name="name" value="'%'+studentId+'%'"/>
            and nlm.student_id like #{name}
        </if>
        <if test="startTime!=null and startTime!='' and endTime!=null and endTime!=''">
            and nlm.apply_time <![CDATA[ >= ]]> #{startTime}
            and nlm.apply_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="applyTypeId!=null and applyTypeId!=''">
            and nlm.apply_type_id=#{applyTypeId}
        </if>
        order by nlm.apply_time desc
    </select>
</mapper>