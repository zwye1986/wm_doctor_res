<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pinde.res.dao.stdp.ext.TeachingActivityInfoExtMapper">
    <resultMap id="activityMap" type="hashmap" extends="com.pinde.sci.dao.base.TeachingActivityInfoMapper.ResultMapWithBLOBs">
        <result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
        <result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR" />
        <result column="FILE_NAME" property="fileName" jdbcType="VARCHAR" />
        <result column="EVAL_SCORE" property="evalScore" jdbcType="VARCHAR" />
        <result column="EVAL_SCORE2" property="evalScore2" jdbcType="VARCHAR" />
        <result column="IS_REGIEST" property="isRegiest" jdbcType="VARCHAR" />
        <result column="IS_SCAN" property="isScan" jdbcType="VARCHAR" />
        <result column="IS_SCAN2" property="isScan2" jdbcType="VARCHAR" />
        <result column="RESULT_FLOW" property="resultFlow" jdbcType="VARCHAR" />
        <result column="SCAN_NUM" property="scanNum" jdbcType="VARCHAR" />
        <result column="REGIEST_NUM" property="regiestNum" jdbcType="VARCHAR" />
        <result column="QRCODE1" property="qrCode1" jdbcType="VARCHAR" />
        <result column="QRCODE2" property="qrCode2" jdbcType="VARCHAR" />
        <result column="QTY" property="qty" jdbcType="VARCHAR" />
        <result column="IS_EFFECTIVE2" property="isEffective" jdbcType="VARCHAR" />
        <result column="ACTIVITY_STATUS" property="activityStatus" jdbcType="VARCHAR" />
        <result column="SUBMIT_ROLE" property="submitRole" jdbcType="VARCHAR" />
        <result column="AUDIT_ROLE" property="auditRole" jdbcType="VARCHAR" />
        <result column="OPINION" property="opinion" jdbcType="VARCHAR" />
    </resultMap>
    <resultMap id="activityResultMap" type="hashmap" extends="com.pinde.sci.dao.base.TeachingActivityResultMapper.BaseResultMap">
        <result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
        <result column="SESSION_NUMBER" property="sessionNumber" jdbcType="VARCHAR" />
        <result column="TRAINING_SPE_NAME" property="speName" jdbcType="VARCHAR" />
        <result column="DOCTOR_CATEGORY_NAME" property="doctorCategoryName" jdbcType="VARCHAR" />
        <result column="SIGIN_TIME" property="siginTime" jdbcType="VARCHAR" />
        <result column="SIGIN_TIME2" property="siginTime2" jdbcType="VARCHAR" />
        <result column="REGIEST_TIME1" property="regiestTime1" jdbcType="VARCHAR" />
        <result column="ACTIVITY_STATUS" property="activityStatus" jdbcType="VARCHAR" />
        <result column="SUBMIT_ROLE" property="submitRole" jdbcType="VARCHAR" />
        <result column="AUDIT_ROLE" property="auditRole" jdbcType="VARCHAR" />
    </resultMap>
    <resultMap id="activityTargetEvalMap" type="hashmap" extends="com.pinde.sci.dao.base.TeachingActivityInfoTargetMapper.BaseResultMap">
        <result column="EVAL_SCORE" property="evalScore" jdbcType="VARCHAR" />
    </resultMap>
    <select id="findActivityList" resultMap="activityMap">
        SELECT INFO.*, SU.USER_NAME, D.DEPT_NAME, RESULT.EVAL_SCORE,F.FILE_NAME,RESULT.SCAN_NUM,RESULT2.REGIEST_NUM
        <!--'func://funcFlow=activitySigin'||'&amp;'||'activityFlow='||INFO.ACTIVITY_FLOW QRCODE1,
        'func://funcFlow=activityOutSigin'||'&amp;'||'activityFlow='||INFO.ACTIVITY_FLOW QRCODE2-->
        <if test="roleFlag=='doctor'.toString()">
            ,R.RESULT_FLOW,R.IS_REGIEST,R.IS_SCAN,R.IS_SCAN2,R.EVAL_SCORE EVAL_SCORE2,R.IS_EFFECTIVE IS_EFFECTIVE2
        </if>
          FROM TEACHING_ACTIVITY_INFO INFO
          LEFT JOIN SYS_USER SU
            ON INFO.SPEAKER_FLOW = SU.USER_FLOW
          LEFT JOIN SYS_DEPT D
            ON D.DEPT_FLOW = INFO.DEPT_FLOW
          LEFT JOIN (SELECT ACTIVITY_FLOW, To_char(ROUND(SUM(EVAL_SCORE) / COUNT(EVAL_SCORE))) EVAL_SCORE,count(1) SCAN_NUM
                       FROM TEACHING_ACTIVITY_RESULT T
                      WHERE T.RECORD_STATUS = 'Y'
                          AND T.IS_SCAN='Y'
                          AND T.IS_SCAN2='Y'
                      GROUP BY ACTIVITY_FLOW) RESULT
            ON RESULT.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
        LEFT JOIN (SELECT ACTIVITY_FLOW, count(1) REGIEST_NUM
                    FROM TEACHING_ACTIVITY_RESULT T
                    WHERE T.RECORD_STATUS = 'Y'
                    AND T.IS_REGIEST='Y'
                    GROUP BY ACTIVITY_FLOW) RESULT2
        ON RESULT2.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
        <if test="roleFlag=='doctor'.toString()">
            LEFT JOIN TEACHING_ACTIVITY_RESULT R
            ON R.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
            AND R.RECORD_STATUS='Y'
            AND R.USER_FLOW=#{userFlow}
        </if>
          LEFT JOIN PUB_FILE F ON INFO.FILE_FLOW=F.FILE_FLOW AND F.RECORD_STATUS='Y'
         WHERE INFO.RECORD_STATUS = 'Y'
           AND SU.RECORD_STATUS = 'Y'
           AND D.RECORD_STATUS = 'Y'
        <if test='roleFlag!=null and roleFlag!=""'>
            <if test="roleFlag=='teach'.toString()">
                AND INFO.SPEAKER_FLOW = #{userFlow}
            </if>
            <if test="roleFlag=='head'.toString()">
                <if test="isOwner=='Y'.toString()">
                    AND INFO.SPEAKER_FLOW = #{userFlow}
                </if>
                <if test="isOwner=='N'.toString()">
                </if>
                AND INFO.DEPT_FLOW IN (
                        select SUD.DEPT_fLOW
                        from SYS_USER_DEPT sud
                        where sud.RECORD_STATUS='Y'
                        and sud.USER_FLOW=#{userFlow}
                       UNION
                      SELECT DEPT_FLOW
                      FROM SYS_USER WHERE USER_FLOW=#{userFlow}
                )
            </if>
            <if test="roleFlag=='local'.toString()">
               AND INFO.ORG_FLOW = #{orgFlow}
               AND INFO.DEPT_FLOW IN (SELECT DEPT_FLOW
                                        FROM SYS_DEPT
                                       WHERE ORG_FLOW = #{orgFlow}
                                         AND RECORD_STATUS = 'Y')
            </if>
            <if test="roleFlag=='doctor'.toString()">
                and INFO.activity_status = 'pass'
                <if test="infoOrgFlow!=null and infoOrgFlow!=''">
                    AND INFO.ORG_FLOW = #{infoOrgFlow}
                </if>
                <if test="deptFlow!=null and deptFlow!=''">
                    AND INFO.DEPT_FLOW = #{deptFlow}
                </if>
                <if test="isNew!=null and isNew!=''">
                    AND START_TIME  <![CDATA[>=]]> to_char(SYSDATE, 'yyyy-MM-dd HH24:MI')
                    AND end_TIME >= to_char(SYSDATE, 'yyyy-MM-dd HH24:MI')
                </if>
                <if test="isEval!=null and isEval!=''">
                    AND (IS_REGIEST ='Y' OR IS_SCAN='Y')
                    AND EXISTS (
                      SELECT 1 FROM Teaching_activity_result
                      WHERE RECORD_STATUS='Y' AND  USER_FLOW=#{userFlow}
                      AND Teaching_activity_result.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
                    )
                </if>
               and info.dept_flow in ( select sd.dept_flow
                from sys_dept sd
                where sd.record_status = 'Y'
                and ( exists (
                        select null
                from res_doctor_sch_process rdsp
                        where rdsp.record_status = 'Y'
                        and rdsp.dept_flow = sd.dept_flow
                        and rdsp.user_flow=#{userFlow}
                        <if test='isCurrent!=null and isCurrent!="" and isCurrent=="Y".toString()'>
                            and rdsp.sch_start_date <![CDATA[<=]]>to_char(sysdate,'yyyy-mm-dd')
                            and rdsp.sch_end_date>=to_char(sysdate,'yyyy-mm-dd')
                        </if>
                        )
                        <if test='isCurrent==null or isCurrent=="" or isCurrent=="N".toString()'>
                            <if test='orgFlow!=null and orgFlow!=""'>
                                or
                                sd.org_flow=#{orgFlow}
                                OR sd.org_flow IN (
                                    SELECT  ORG_FLOW
                                    FROM res_joint_org
                                    WHERE JOINT_ORG_FLOW = #{orgFlow}AND record_status = 'Y'
                                    )
                            </if>
                        </if>
                )
               )
            </if>
        </if>
        <if test='userName!=null and userName!=""'>
            AND SU.USER_NAME LIKE CONCAT(CONCAT('%', #{userName}),'%')
        </if>
        <if test='activityName!=null and activityName!=""'>
            AND INFO.ACTIVITY_NAME LIKE CONCAT(CONCAT('%', #{activityName}),'%')
        </if>
        <if test='yearMonth!=null and yearMonth!=""'>
            and SUBSTR(INFO.START_TIME,0,7) = #{yearMonth}
        </if>
        <if test='deptFlow!=null and deptFlow!=""'>
            AND INFO.DEPT_FLOW = #{deptFlow}
        </if>
        <if test='activityTypeId!=null and activityTypeId!=""'>
            AND INFO.ACTIVITY_TYPE_ID = #{activityTypeId}
        </if>
        <if test='startTime!=null and startTime!="" and (endTime==null or endTime=="")'>
            and START_TIME  >= #{startTime}
        </if>
        <if test='endTime!=null and endTime!="" and (startTime==null or startTime=="")'>
            and END_TIME <![CDATA[<]]>= #{endTime}
        </if>
        <if test='endTime!=null and endTime!="" and startTime!=null and startTime!=""'>
            and(
            (START_TIME>=#{startTime} and #{endTime}>=START_TIME)
            or
            (END_TIME>=#{startTime} and #{endTime}>=END_TIME)
            )
        </if>
        order by START_TIME desc,END_TIME desc, RESULT.EVAL_SCORE desc
    </select>

    <!--查询教学活动 -->
    <select id="findActivityList2" resultMap="activityMap">
        SELECT INFO.*, SU.USER_NAME, D.DEPT_NAME, RESULT.EVAL_SCORE,PF.FILE_FLOWS,nvl(RESULT.SCAN_NUM,0) SCAN_NUM,RESULT2.REGIEST_NUM
        <if test="roleFlag=='doctor'.toString()">
            ,R.RESULT_FLOW,R.IS_REGIEST,R.IS_SCAN,R.IS_SCAN2,R.EVAL_SCORE EVAL_SCORE2,R.IS_EFFECTIVE IS_EFFECTIVE2
        </if>
        FROM TEACHING_ACTIVITY_INFO INFO
        LEFT JOIN SYS_USER SU
        ON INFO.SPEAKER_FLOW = SU.USER_FLOW
        LEFT JOIN SYS_DEPT D
        ON D.DEPT_FLOW = INFO.DEPT_FLOW
        LEFT JOIN (SELECT ACTIVITY_FLOW, To_char(ROUND(SUM(EVAL_SCORE) / COUNT(EVAL_SCORE))) EVAL_SCORE,count(1) SCAN_NUM
        FROM TEACHING_ACTIVITY_RESULT T
        WHERE T.RECORD_STATUS = 'Y'
        AND T.IS_SCAN='Y'
        AND T.IS_SCAN2='Y'
        GROUP BY ACTIVITY_FLOW) RESULT
        ON RESULT.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
        LEFT JOIN (SELECT ACTIVITY_FLOW, count(1) REGIEST_NUM
        FROM TEACHING_ACTIVITY_RESULT T
        WHERE T.RECORD_STATUS = 'Y'
        AND T.IS_REGIEST='Y'
        GROUP BY ACTIVITY_FLOW) RESULT2
        ON RESULT2.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
        <if test="roleFlag=='doctor'.toString()">
            LEFT JOIN TEACHING_ACTIVITY_RESULT R
            ON R.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
            AND R.RECORD_STATUS='Y'
            AND R.USER_FLOW=#{userFlow}
        </if>
        LEFT JOIN (
        SELECT wm_concat(file_flow) as file_flows,product_flow
        from PUB_FILE
        where RECORD_STATUS = 'Y' and product_flow is not null
        group by product_flow
        ) pf on pf.product_flow = INFO.ACTIVITY_FLOW
        <if test='school != null and school !=""'>
            LEFT JOIN RES_DOCTOR ED ON INFO.SPEAKER_FLOW = ED.DOCTOR_FLOW
        </if>
        WHERE INFO.RECORD_STATUS = 'Y'
        AND SU.RECORD_STATUS = 'Y'
        AND D.RECORD_STATUS = 'Y'
        <if test='roleFlag!=null and roleFlag!=""'>
            <if test="roleFlag=='teach'.toString()">
                AND INFO.SPEAKER_FLOW = #{userFlow}
            </if>
            <if test="roleFlag=='head'.toString() or roleFlag == 'secretary'.toString()">
                AND INFO.DEPT_FLOW IN (
                select SUD.DEPT_fLOW
                from SYS_USER_DEPT sud
                where sud.RECORD_STATUS='Y'
                and sud.USER_FLOW=#{userFlow}
                UNION
                SELECT DEPT_FLOW
                FROM SYS_USER WHERE USER_FLOW=#{userFlow}
                )
            </if>
            <if test="roleFlag=='spe'.toString()">
                AND INFO.DEPT_FLOW IN (
                select dept_flow from Res_Training_Spe_Dept
                where record_status='Y'
                AND ORG_FLOW = #{orgFlow}
                and training_spe_id in(
                SELECT res_training_spe_id FROM sys_user
                where user_flow =#{userFlow}
                )
                )
            </if>
            <if test="roleFlag=='local'.toString()">
                AND INFO.ORG_FLOW = #{orgFlow}
                AND INFO.DEPT_FLOW IN (SELECT DEPT_FLOW
                FROM SYS_DEPT
                WHERE ORG_FLOW = #{orgFlow}
                AND RECORD_STATUS = 'Y')
            </if>
            <if test="roleFlag=='university'.toString()">
                AND INFO.ORG_FLOW in(SELECT DISTINCT RDR.ORG_FLOW
                FROM
                RES_DOCTOR_RECRUIT RDR
                LEFT JOIN
                RES_DOCTOR RD ON RDR.DOCTOR_FLOW=RD.DOCTOR_FLOW
                JOIN SYS_USER SU
                ON SU.USER_FLOW = RD.DOCTOR_FLOW
                WHERE RD.RECORD_STATUS = 'Y'
                AND SU.RECORD_STATUS = 'Y'
                AND RDR.RECORD_STATUS='Y'
                AND RD.ORG_FLOW=RDR.ORG_FLOW
                AND RD.DOCTOR_TYPE_ID = 'Graduate'
                <if test="(sendSchoolId != null and sendSchoolId != '')">
                    and rd.work_org_id = #{sendSchoolId}
                </if>
                <if test="(sendSchoolName != null and sendSchoolName != '')">
                    and rd.work_org_name = #{sendSchoolName}
                </if>
                )
                AND INFO.DEPT_FLOW IN (SELECT DEPT_FLOW
                FROM SYS_DEPT
                WHERE ORG_FLOW in(SELECT DISTINCT RDR.ORG_FLOW
                FROM
                RES_DOCTOR_RECRUIT RDR
                LEFT JOIN
                RES_DOCTOR RD ON RDR.DOCTOR_FLOW=RD.DOCTOR_FLOW
                JOIN SYS_USER SU
                ON SU.USER_FLOW = RD.DOCTOR_FLOW
                WHERE RD.RECORD_STATUS = 'Y'
                AND SU.RECORD_STATUS = 'Y'
                AND RDR.RECORD_STATUS='Y'
                AND RD.ORG_FLOW=RDR.ORG_FLOW
                AND RD.DOCTOR_TYPE_ID = 'Graduate'
                <if test="(sendSchoolId != null and sendSchoolId != '')">
                    and rd.work_org_id = #{sendSchoolId}
                </if>
                <if test="(sendSchoolName != null and sendSchoolName != '')">
                    and rd.work_org_name = #{sendSchoolName}
                </if>)
                AND RECORD_STATUS = 'Y')
            </if>
            <if test="roleFlag=='doctor'.toString()">
                <if test="isNew!=null and isNew!=''">
                    AND START_TIME  <![CDATA[>=]]> to_char(SYSDATE, 'yyyy-MM-dd HH24:MI')
                    AND end_TIME >= to_char(SYSDATE, 'yyyy-MM-dd HH24:MI')
                </if>
                and info.activity_status = 'pass'
                <if test="isEval!=null and isEval!=''">
                    AND (IS_REGIEST ='Y' OR IS_SCAN='Y')
                    AND EXISTS (
                    SELECT 1 FROM Teaching_activity_result
                    WHERE RECORD_STATUS='Y' AND  USER_FLOW=#{userFlow}
                    AND Teaching_activity_result.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
                    )
                </if>
                and info.dept_flow in ( select sd.dept_flow
                from sys_dept sd
                where sd.record_status = 'Y'
                and ( exists (
                select null
                from res_doctor_sch_process rdsp
                where rdsp.record_status = 'Y'
                and rdsp.org_flow = sd.org_flow
                and rdsp.user_flow=#{userFlow}
                <if test='isCurrent!=null and isCurrent!=""'>
                    and rdsp.sch_start_date <![CDATA[<=]]>to_char(sysdate,'yyyy-mm-dd')
                    and rdsp.sch_end_date>=to_char(sysdate,'yyyy-mm-dd')
                </if>
                )
                <if test='isCurrent==null or isCurrent==""'>
                    <if test='orgFlow!=null and orgFlow!=""'>
                        or
                        sd.org_flow=#{orgFlow}
                    </if>
                </if>
                )
                )
            </if>
        </if>
        <if test='userName!=null and userName!=""'>
            AND SU.USER_NAME LIKE CONCAT(CONCAT('%', #{userName}),'%')
        </if>
        <if test='activityFlow!=null and activityFlow!=""'>
            AND INFO.ACTIVITY_FLOW = #{activityFlow}
        </if>
        <if test='activityName!=null and activityName!=""'>
            AND INFO.ACTIVITY_NAME LIKE CONCAT(CONCAT('%', #{activityName}),'%')
        </if>
        <if test='deptFlow!=null and deptFlow!=""'>
            AND INFO.DEPT_FLOW = #{deptFlow}
        </if>
        <if test='deptName!=null and deptName!=""'>
            AND D.DEPT_NAME = #{deptName}
        </if>
        <if test='activityTypeId!=null and activityTypeId!=""'>
            AND INFO.ACTIVITY_TYPE_ID = #{activityTypeId}
        </if>
        <if test='startTime!=null and startTime!="" and (endTime==null or endTime=="")'>
            and START_TIME  >= #{startTime}
        </if>
        <if test='activityStatus!=null and activityStatus!="" '>
            and activity_status = #{activityStatus}
        </if>
        <if test='endTime!=null and endTime!="" and (startTime==null or startTime=="")'>
            and END_TIME <![CDATA[<]]>= #{endTime}
        </if>
        <if test='endTime!=null and endTime!="" and startTime!=null and startTime!=""'>
            and(
            (START_TIME>=#{startTime} and #{endTime}>=START_TIME)
            or
            (END_TIME>=#{startTime} and #{endTime}>=END_TIME)
            )
        </if>
        <!--判断活动是否有效 -->
        <if test='isEffective != null and isEffective !="" and isEffective =="1"'>
            and RESULT.SCAN_NUM > 0
            and info.is_effective='Y'
        </if>
        <if test='isEffective != null and isEffective !="" and isEffective =="0"'>
            and ((RESULT.SCAN_NUM  is null or RESULT.SCAN_NUM = '')
            OR (  RESULT.SCAN_NUM > 0  and info.is_effective='N'
            ))
        </if>

        <if test='orderByClo == null or orderByClo ==""'>
            order by START_TIME desc,END_TIME desc, RESULT.EVAL_SCORE desc
        </if>
        <if test='orderByClo != null and orderByClo !="" and orderByClo=="activityName"'>
            order by NLSSORT(ACTIVITY_NAME,'NLS_SORT = SCHINESE_PINYIN_M')
        </if>
        <if test='orderByClo != null and orderByClo !="" and orderByClo=="activityType"'>
            order by NLSSORT(ACTIVITY_TYPE_NAME,'NLS_SORT = SCHINESE_PINYIN_M')
        </if>
        <if test='orderByClo != null and orderByClo !="" and orderByClo=="deptName"'>
            order by NLSSORT(DEPT_NAME,'NLS_SORT = SCHINESE_PINYIN_M')
        </if>
        <if test='orderByClo != null and orderByClo !="" and orderByClo=="userName"'>
            order by NLSSORT(SU.USER_NAME,'NLS_SORT = SCHINESE_PINYIN_M')
        </if>
        <if test='orderByFall != null and orderByFall !="" and orderByFall=="DESC"'>
            DESC
        </if>
    </select>

    <select id="findActivityTypeList" resultMap="activityMap">
        SELECT INFO.ACTIVITY_TYPE_ID,count(1) QTY
          FROM TEACHING_ACTIVITY_INFO INFO
          LEFT JOIN SYS_USER SU
            ON INFO.SPEAKER_FLOW = SU.USER_FLOW
          LEFT JOIN SYS_DEPT D
            ON D.DEPT_FLOW = INFO.DEPT_FLOW
          LEFT JOIN (SELECT ACTIVITY_FLOW, To_char(ROUND(SUM(EVAL_SCORE) / COUNT(EVAL_SCORE))) EVAL_SCORE,count(1) SCAN_NUM
                       FROM TEACHING_ACTIVITY_RESULT T
                      WHERE T.RECORD_STATUS = 'Y'
                          AND T.IS_SCAN='Y'
                          AND T.IS_SCAN2='Y'
                      GROUP BY ACTIVITY_FLOW) RESULT
            ON RESULT.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
        LEFT JOIN (SELECT ACTIVITY_FLOW, count(1) REGIEST_NUM
                    FROM TEACHING_ACTIVITY_RESULT T
                    WHERE T.RECORD_STATUS = 'Y'
                    AND T.IS_REGIEST='Y'
                    GROUP BY ACTIVITY_FLOW) RESULT2
        ON RESULT2.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
        <if test="roleFlag=='doctor'.toString()">
            LEFT JOIN TEACHING_ACTIVITY_RESULT R
            ON R.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
            AND R.RECORD_STATUS='Y'
            AND R.USER_FLOW=#{userFlow}
        </if>
          LEFT JOIN PUB_FILE F ON INFO.FILE_FLOW=F.FILE_FLOW AND F.RECORD_STATUS='Y'
         WHERE INFO.RECORD_STATUS = 'Y'
           AND SU.RECORD_STATUS = 'Y'
           AND D.RECORD_STATUS = 'Y'
        <if test='roleFlag!=null and roleFlag!=""'>
            <if test="roleFlag=='teach'.toString()">
                AND INFO.SPEAKER_FLOW = #{userFlow}
            </if>
            <if test="roleFlag=='head'.toString()">
                <if test="isOwner=='Y'.toString()">
                    AND INFO.SPEAKER_FLOW = #{userFlow}
                </if>
                <if test="isOwner=='N'.toString()">
                </if>
                AND INFO.DEPT_FLOW IN (
                        select SUD.DEPT_fLOW
                        from SYS_USER_DEPT sud
                        where sud.RECORD_STATUS='Y'
                        and sud.USER_FLOW=#{userFlow}
                       UNION
                      SELECT DEPT_FLOW
                      FROM SYS_USER WHERE USER_FLOW=#{userFlow}
                )
            </if>
            <if test="roleFlag=='local'.toString()">
               AND INFO.ORG_FLOW = #{orgFlow}
               AND INFO.DEPT_FLOW IN (SELECT DEPT_FLOW
                                        FROM SYS_DEPT
                                       WHERE ORG_FLOW = #{orgFlow}
                                         AND RECORD_STATUS = 'Y')
            </if>
            <if test="roleFlag=='doctor'.toString()">
                <if test="orgFlow!=null and orgFlow!=''">
                    AND INFO.ORG_FLOW = #{orgFlow}
                </if>
                <if test="deptFlow!=null and deptFlow!=''">
                    AND INFO.DEPT_FLOW = #{deptFlow}
                </if>
                <if test="isNew!=null and isNew!=''">
                    AND START_TIME  <![CDATA[>=]]> to_char(SYSDATE, 'yyyy-MM-dd HH24:MI')
                    AND end_TIME >= to_char(SYSDATE, 'yyyy-MM-dd HH24:MI')
                </if>
                <if test="isEval!=null and isEval!=''">
                    AND EXISTS (
                      SELECT 1 FROM Teaching_activity_result
                      WHERE RECORD_STATUS='Y' AND  USER_FLOW=#{userFlow}
                      AND Teaching_activity_result.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
                    )
                </if>
               and info.dept_flow in ( select sd.dept_flow
                from sys_dept sd
                where sd.record_status = 'Y'
                and ( exists (
                        select null
                from res_doctor_sch_process rdsp
                        where rdsp.record_status = 'Y'
                        and rdsp.dept_flow = sd.dept_flow
                        and rdsp.user_flow=#{userFlow}
                    ) or exists (
                        select null
                        from res_doctor rd
                       where rd.doctor_flow=#{userFlow}
                       and rd.org_flow=sd.org_flow
                    )
                )
               )
            </if>
        </if>
        <if test='userName!=null and userName!=""'>
            AND SU.USER_NAME LIKE CONCAT(CONCAT('%', #{userName}),'%')
        </if>
        <if test='activityName!=null and activityName!=""'>
            AND INFO.ACTIVITY_NAME LIKE CONCAT(CONCAT('%', #{activityName}),'%')
        </if>
        <if test='yearMonth!=null and yearMonth!=""'>
            and SUBSTR(INFO.START_TIME,0,7) = #{yearMonth}
        </if>
        <if test='deptFlow!=null and deptFlow!=""'>
            AND INFO.DEPT_FLOW = #{deptFlow}
        </if>
        <if test='activityTypeId!=null and activityTypeId!=""'>
            AND INFO.ACTIVITY_TYPE_ID = #{activityTypeId}
        </if>
        <if test='startTime!=null and startTime!="" and (endTime==null or endTime=="")'>
            and START_TIME  >= #{startTime}
        </if>
        <if test='endTime!=null and endTime!="" and (startTime==null or startTime=="")'>
            and END_TIME <![CDATA[<]]>= #{endTime}
        </if>
        <if test='endTime!=null and endTime!="" and startTime!=null and startTime!=""'>
            and(
            (START_TIME>=#{startTime} and #{endTime}>=START_TIME)
            or
            (END_TIME>=#{startTime} and #{endTime}>=END_TIME)
            )
        </if>
        group by INFO.ACTIVITY_TYPE_ID
        order by INFO.ACTIVITY_TYPE_ID
    </select>
    <resultMap id="DeptActivityMap" type="hashmap" >
        <result column="TYPE_ID" property="typeId" jdbcType="VARCHAR" />
        <result column="QTY" property="qty" jdbcType="VARCHAR" />
    </resultMap>
    <select id="getDeptActivityStatisticsMap" resultMap="DeptActivityMap">
        SELECT DEPT_FLOW||ACTIVITY_TYPE_ID TYPE_ID,
                ACTIVITY_TYPE_NAME,
                COUNT(1) QTY
       FROM TEACHING_ACTIVITY_INFO INFO
        WHERE RECORD_STATUS = 'Y'
        and dept_flow=#{deptFlow}
        and is_effective='Y'
        <if test='startTime!=null and startTime!="" and (endTime==null or endTime=="")'>
            and START_TIME  >= #{startTime}
        </if>
        <if test='endTime!=null and endTime!="" and (startTime==null or startTime=="")'>
            and END_TIME <![CDATA[<]]>= #{endTime}
        </if>
        <if test='endTime!=null and endTime!="" and startTime!=null and startTime!=""'>
            and(
            (START_TIME>=#{startTime} and #{endTime}>=START_TIME)
            or
            (END_TIME>=#{startTime} and #{endTime}>=END_TIME)
            )
        </if>
        GROUP BY
        DEPT_FLOW,
        ACTIVITY_TYPE_ID,
        ACTIVITY_TYPE_NAME
    </select>
    <select id="getTeacherActivityStatisticsMap" resultMap="DeptActivityMap">
        SELECT DEPT_FLOW||SPEAKER_FLOW||ACTIVITY_TYPE_ID TYPE_ID,
                ACTIVITY_TYPE_NAME,
                COUNT(1) QTY
       FROM TEACHING_ACTIVITY_INFO INFO
        WHERE RECORD_STATUS = 'Y'
        and dept_flow=#{deptFlow}
        and SPEAKER_FLOW=#{teacherFlow}
        and is_effective='Y'
        <if test='startTime!=null and startTime!="" and (endTime==null or endTime=="")'>
            and START_TIME  >= #{startTime}
        </if>
        <if test='endTime!=null and endTime!="" and (startTime==null or startTime=="")'>
            and END_TIME <![CDATA[<]]>= #{endTime}
        </if>
        <if test='endTime!=null and endTime!="" and startTime!=null and startTime!=""'>
            and(
            (START_TIME>=#{startTime} and #{endTime}>=START_TIME)
            or
            (END_TIME>=#{startTime} and #{endTime}>=END_TIME)
            )
        </if>
        GROUP BY
        DEPT_FLOW,SPEAKER_FLOW,
        ACTIVITY_TYPE_ID,
        ACTIVITY_TYPE_NAME
    </select>
    <select id="getDoctorActivityStatisticsMap" resultMap="DeptActivityMap">
        SELECT result.user_flow||ACTIVITY_TYPE_ID TYPE_ID,
                ACTIVITY_TYPE_NAME,
                COUNT(1) QTY
       FROM teaching_activity_result result
        left join  TEACHING_ACTIVITY_INFO INFO
        on info.activity_flow=result.activity_flow
        WHERE info.RECORD_STATUS = 'Y'
        and result.record_status ='Y'
        and result.user_flow=#{doctorFlow}
        and info.is_effective='Y'
        and result.is_effective='Y'
        <if test='startTime!=null and startTime!="" and (endTime==null or endTime=="")'>
            and START_TIME  >= #{startTime}
        </if>
        <if test='endTime!=null and endTime!="" and (startTime==null or startTime=="")'>
            and END_TIME <![CDATA[<]]>= #{endTime}
        </if>
        <if test='endTime!=null and endTime!="" and startTime!=null and startTime!=""'>
            and(
            (START_TIME>=#{startTime} and #{endTime}>=START_TIME)
            or
            (END_TIME>=#{startTime} and #{endTime}>=END_TIME)
            )
        </if>
        GROUP BY
        result.user_flow,
        ACTIVITY_TYPE_ID,
        ACTIVITY_TYPE_NAME
    </select>
    <select id="readActivityRegists" resultMap="activityResultMap">
        SELECT INFO.*, SU.USER_NAME, D.SESSION_NUMBER,D.TRAINING_SPE_NAME,D.doctor_category_name,to_char(to_date(info.scan_time,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') sigin_time
           ,to_char(to_date(info.REGIEST_time,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') regiest_Time1
        ,to_char(to_date(info.scan_time2,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') sigin_time2
          FROM TEACHING_ACTIVITY_RESULT INFO
          LEFT JOIN SYS_USER SU
            ON INFO.USER_FLOW = SU.USER_FLOW
          LEFT JOIN RES_DOCTOR D
            ON D.DOCTOR_FLOW = INFO.USER_FLOW
         WHERE INFO.RECORD_STATUS = 'Y'
         AND INFO.ACTIVITY_FLOW=#{activityFlow}
                      AND ( INFO.IS_REGIEST='Y')
         ORDER BY EVAL_SCORE DESC
    </select>
    <select id="readActivityResults" resultMap="activityResultMap">
        SELECT INFO.*, SU.USER_NAME, D.SESSION_NUMBER,D.TRAINING_SPE_NAME,D.doctor_category_name,to_char(to_date(info.scan_time,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') sigin_time
        ,to_char(to_date(info.REGIEST_time,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') REGIEST_time1
        ,to_char(to_date(info.scan_time2,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') sigin_time2
          FROM TEACHING_ACTIVITY_RESULT INFO
          LEFT JOIN SYS_USER SU
            ON INFO.USER_FLOW = SU.USER_FLOW
          LEFT JOIN RES_DOCTOR D
            ON D.DOCTOR_FLOW = INFO.USER_FLOW
         WHERE INFO.RECORD_STATUS = 'Y'
         AND INFO.ACTIVITY_FLOW=#{activityFlow}
         AND INFO.IS_SCAN='Y'
        <if test='searchStr!=null and searchStr!=""'>
            and (
            d.TRAINING_SPE_NAME like CONCAT(CONCAT('%', #{searchStr}),'%')
            OR su.USER_NAME like CONCAT(CONCAT('%', #{searchStr}),'%')
            )
        </if>
         ORDER BY EVAL_SCORE DESC,SU.USER_NAME, D.SESSION_NUMBER
    </select>
    <select id="readActivityResults2" resultMap="activityResultMap">
        SELECT INFO.*, SU.USER_NAME, D.SESSION_NUMBER,D.TRAINING_SPE_NAME,D.doctor_category_name,D.doctor_type_name,to_char(to_date(info.scan_time,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') sigin_time
        ,to_char(to_date(info.REGIEST_time,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') REGIEST_time1
        ,to_char(to_date(info.scan_time2,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') sigin_time2
          FROM TEACHING_ACTIVITY_RESULT INFO
          LEFT JOIN SYS_USER SU
            ON INFO.USER_FLOW = SU.USER_FLOW
          LEFT JOIN RES_DOCTOR D
            ON D.DOCTOR_FLOW = INFO.USER_FLOW
         WHERE INFO.RECORD_STATUS = 'Y'
         AND INFO.ACTIVITY_FLOW=#{activityFlow}
                      AND INFO.IS_SCAN='Y'
         ORDER BY EVAL_SCORE DESC
    </select>
    <select id="readActivityResultsByType" resultMap="activityResultMap">
        SELECT INFO.*, SU.USER_NAME, D.SESSION_NUMBER,D.TRAINING_SPE_NAME,D.doctor_category_name,to_char(to_date(info.scan_time,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') sigin_time
        ,to_char(to_date(info.REGIEST_time,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') REGIEST_time1
        ,to_char(to_date(info.scan_time2,'yyyyMMddHH24miss'),'yyyy-MM-dd hh24:mi:ss') sigin_time2
          FROM TEACHING_ACTIVITY_RESULT INFO
          LEFT JOIN SYS_USER SU
            ON INFO.USER_FLOW = SU.USER_FLOW
          LEFT JOIN RES_DOCTOR D
            ON D.DOCTOR_FLOW = INFO.USER_FLOW
         WHERE INFO.RECORD_STATUS = 'Y'
         AND INFO.ACTIVITY_FLOW=#{activityFlow}
        <if test='typeId!=null and typeId!="" and typeId=="Y".toString()'>
           and  INFO.IS_REGIEST='Y'
        </if>
        <if test='typeId!=null and typeId!="" and typeId!="Y".toString()'>
            AND INFO.IS_SCAN='Y'
        </if>
        <if test='searchStr!=null and searchStr!=""'>
            and (
            d.TRAINING_SPE_NAME like CONCAT(CONCAT('%', #{searchStr}),'%')
            OR su.USER_NAME like CONCAT(CONCAT('%', #{searchStr}),'%')
            )
        </if>
         ORDER BY EVAL_SCORE DESC,SU.USER_NAME, D.SESSION_NUMBER
    </select>

    <resultMap id="getDeptCountActivityStatisticsListMap" type="hashmap">
        <result column="NUM" property="num" jdbcType="VARCHAR" />
        <result column="DEPT_FLOW" property="deptFlow" jdbcType="VARCHAR" />
        <result column="ORG_FLOW" property="orgFlow" jdbcType="VARCHAR" />
        <result column="DEPT_CODE" property="deptCode" jdbcType="VARCHAR" />
        <result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR" />
        <result column="ORDINAL" property="ordinal" jdbcType="DECIMAL" />
        <result column="RECORD_STATUS" property="recordStatus" jdbcType="VARCHAR" />
        <result column="CREATE_TIME" property="createTime" jdbcType="VARCHAR" />
        <result column="CREATE_USER_FLOW" property="createUserFlow" jdbcType="VARCHAR" />
        <result column="MODIFY_TIME" property="modifyTime" jdbcType="VARCHAR" />
        <result column="MODIFY_USER_FLOW" property="modifyUserFlow" jdbcType="VARCHAR" />
        <result column="DEPT_PINYIN" property="deptPinyin" jdbcType="VARCHAR" />
        <result column="DEPT_ID" property="deptId" jdbcType="VARCHAR" />
        <result column="DEPT_PID" property="deptPid" jdbcType="VARCHAR" />
    </resultMap>
    <select id="getDeptCountActivityStatisticsList" resultMap="getDeptCountActivityStatisticsListMap">
        SELECT * FROM (
        SELECT (
        SELECT COUNT(ACTIVITY_FLOW) FROM TEACHING_ACTIVITY_INFO WHERE DEPT_FLOW=S.DEPT_FLOW AND IS_EFFECTIVE = 'Y'and  RECORD_STATUS = 'Y'
        <if test='startTime!=null and startTime!="" and (endTime==null or endTime=="")'>
            and START_TIME  >= #{startTime}
        </if>
        <if test='endTime!=null and endTime!="" and (startTime==null or startTime=="")'>
            and END_TIME <![CDATA[<]]>= #{endTime}
        </if>
        <if test='endTime!=null and endTime!="" and startTime!=null and startTime!=""'>
            and(
            (START_TIME>=#{startTime} and #{endTime}>=START_TIME)
            or
            (END_TIME>=#{startTime} and #{endTime}>=END_TIME)
            )
        </if>
        ) NUM,
        DEPT_FLOW, ORG_FLOW, DEPT_CODE, DEPT_NAME, ORDINAL
        , RECORD_STATUS, CREATE_TIME, CREATE_USER_FLOW, MODIFY_TIME, MODIFY_USER_FLOW
        , DEPT_PINYIN, DEPT_ID, DEPT_PID
        FROM SYS_DEPT S
        WHERE RECORD_STATUS = 'Y'
        <if test='deptFlow!=null and deptFlow!=""'>
            AND DEPT_FLOW = #{deptFlow}
        </if>
        <if test='orgFlow!=null and orgFlow!=""'>
            AND ORG_FLOW = #{orgFlow}
        </if>
        ORDER BY RECORD_STATUS DESC, ORDINAL
        )
        <if test='notNull!=null and notNull!="" and notNull=="Y"'>
            where NUM > 0
        </if>
    </select>

    <select id="readActivityTargetEvals" resultMap="activityTargetEvalMap">
        SELECT T.*,B.EVAL_SCORE
          FROM TEACHING_ACTIVITY_INFO_TARGET T
          LEFT JOIN (SELECT T.TARGET_FLOW,
                            T.ACTIVITY_FLOW,
                             T.TARGET_NAME,
                             TO_CHAR(ROUND(SUM(E.EVAL_SCORE) / COUNT(E.EVAL_FLOW))) EVAL_SCORE
          FROM TEACHING_ACTIVITY_INFO_TARGET T
          LEFT JOIN TEACHING_ACTIVITY_RESULT R
            ON T.ACTIVITY_FLOW = R.ACTIVITY_FLOW
           AND R.RECORD_STATUS = 'Y'
           AND R.IS_SCAN='Y'
           AND R.IS_SCAN2='Y'
          LEFT JOIN TEACHING_ACTIVITY_EVAL E
            ON E.RESULT_FLOW = R.RESULT_FLOW
            AND E.USER_FLOW=R.USER_FLOW
           AND E.TARGET_FLOW = T.TARGET_FLOW
           AND E.RECORD_STATUS = 'Y'
         GROUP BY T.TARGET_FLOW,T.ACTIVITY_FLOW, T.TARGET_NAME) B
         ON T.TARGET_FLOW=B.TARGET_FLOW
         AND T.ACTIVITY_FLOW=B.ACTIVITY_FLOW
         WHERE T.RECORD_STATUS='Y'
         AND T.ACTIVITY_FLOW=#{activityFlow}
         ORDER BY ORDINAL
    </select>
    <select id="readActivity" resultMap="activityMap">
        SELECT INFO.*, SU.USER_NAME, D.DEPT_NAME, RESULT.EVAL_SCORE,PF.file_flows
          FROM TEACHING_ACTIVITY_INFO INFO
          LEFT JOIN SYS_USER SU
            ON INFO.SPEAKER_FLOW = SU.USER_FLOW
          LEFT JOIN SYS_DEPT D
            ON D.DEPT_FLOW = INFO.DEPT_FLOW
          LEFT JOIN (SELECT ACTIVITY_FLOW, To_char(SUM(EVAL_SCORE) / COUNT(1)) EVAL_SCORE
                       FROM TEACHING_ACTIVITY_RESULT T
                      WHERE T.RECORD_STATUS = 'Y'
                      AND T.IS_SCAN='Y'
                      AND T.IS_SCAN2='Y'
                      GROUP BY ACTIVITY_FLOW) RESULT
            ON RESULT.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
          <!--LEFT JOIN PUB_FILE F ON INFO.FILE_FLOW=F.FILE_FLOW AND F.RECORD_STATUS='Y'-->
          LEFT JOIN (
				SELECT WM_CONCAT(file_flow) AS file_flows, product_flow
				FROM PUB_FILE
				WHERE RECORD_STATUS = 'Y'
				GROUP BY product_flow
			) pf ON pf.product_flow = INFO.ACTIVITY_FLOW
         WHERE INFO.ACTIVITY_FLOW=#{activityFlow}
    </select>
    <select id="checkTime" resultType="int">
        SELECT count(1)
          FROM TEACHING_ACTIVITY_INFO INFO
         WHERE INFO.RECORD_STATUS='Y'
         <if test="activity.activityFlow!=null and activity.activityFlow!=''">
            AND INFO.ACTIVITY_FLOW!=#{activity.activityFlow}
         </if>
        and  INFO.activity_status in ('pass','audit')
        AND  INFO.SPEAKER_FLOW=#{activity.speakerFlow}
        and (
            (
            START_TIME <![CDATA[<=]]> #{activity.startTime}
            and END_TIME >= #{activity.startTime}
            )
            or
            (
            START_TIME <![CDATA[<=]]> #{activity.endTime}
            and END_TIME >= #{activity.endTime}
            )
            or
            (
            START_TIME <![CDATA[>=]]> #{activity.startTime}
            and END_TIME <![CDATA[<=]]> #{activity.endTime}
            )
        )
    </select>
    <select id="checkJoin" resultType="int">
        SELECT count(1)
          FROM TEACHING_ACTIVITY_INFO INFO
         WHERE INFO.RECORD_STATUS='Y'
         <if test="activityFlow!=null and activityFlow!=''">
            AND INFO.ACTIVITY_FLOW!=#{activityFlow}
         </if>
        AND   INFO.ACTIVITY_FLOW in (
            select ACTIVITY_FLOW
            FROM TEACHING_ACTIVITY_RESULT T
            WHERE T.RECORD_STATUS = 'Y'
            and t.IS_REGIEST='Y'
            and t.user_flow=#{userFlow}
        )
        and exists (
            select 1 from TEACHING_ACTIVITY_INFO tai
           where tai.ACTIVITY_FLOW=#{activityFlow}
            and (
            (
                INFO.START_TIME <![CDATA[<=]]> tai.START_TIME
                and INFO.END_TIME >= tai.START_TIME
            )
            or
            (
                INFO.START_TIME <![CDATA[<=]]> tai.END_TIME
                and INFO.END_TIME >= tai.END_TIME
            )
            or
            (
                INFO.START_TIME <![CDATA[>=]]> tai.START_TIME
                and INFO.END_TIME <![CDATA[<=]]> tai.END_TIME
            )
          )
        )
    </select>

    <select id="checkJoin2" resultType="int">
        SELECT count(1)
        FROM TEACHING_ACTIVITY_INFO INFO
        WHERE INFO.RECORD_STATUS='Y'
        <if test="activityFlow!=null and activityFlow!=''">
            AND INFO.ACTIVITY_FLOW!=#{activityFlow}
        </if>
        AND   INFO.ACTIVITY_FLOW in (
        select ACTIVITY_FLOW
        FROM TEACHING_ACTIVITY_RESULT T
        WHERE T.RECORD_STATUS = 'Y'
        and t.user_flow=#{userFlow}
        and (t.IS_REGIEST='Y' or t.IS_SCAN = 'Y')
        )
        and exists (
        select 1 from TEACHING_ACTIVITY_INFO tai
        where tai.ACTIVITY_FLOW=#{activityFlow}
        and (
        (
        INFO.START_TIME <![CDATA[<]]> tai.START_TIME
        and INFO.END_TIME > tai.START_TIME
        )
        or
        (
        INFO.START_TIME <![CDATA[<]]> tai.END_TIME
        and INFO.END_TIME > tai.END_TIME
        )
        or
        (
        INFO.START_TIME <![CDATA[>]]> tai.START_TIME
        and INFO.END_TIME <![CDATA[<]]> tai.END_TIME
        )
        or
        (
        INFO.START_TIME <![CDATA[<]]> tai.START_TIME
        and INFO.END_TIME <![CDATA[>]]> tai.END_TIME
        )
        )
        )
    </select>

    <resultMap id="TeacherActivityStatistics" type="hashmap" >
        <result column="USER_FLOW" property="userFlow" jdbcType="VARCHAR" />
        <result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
        <result column="DEPT_FLOW" property="deptFlow" jdbcType="VARCHAR" />
        <result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR" />
    </resultMap>
    <select id="getTeacherActivityStatistics" resultMap="TeacherActivityStatistics">
        select *
        from ( SELECT SU.USER_FLOW, SU.USER_NAME, DEPT.DEPT_FLOW, DEPT.DEPT_NAME
        FROM SYS_USER su
                  LEFT JOIN SYS_USER_DEPT SUD
                    ON SU.USER_FLOW = SUD.USER_FLOW
                  LEFT JOIN SYS_DEPT DEPT
                    ON DEPT.DEPT_FLOW = SUD.DEPT_FLOW
                 WHERE SU.RECORD_STATUS = 'Y'
                   AND SUD.RECORD_STATUS = 'Y'
                   AND DEPT.RECORD_STATUS = 'Y'
                   AND NOT EXISTS (SELECT NULL
                          FROM res_doctor rd
                         WHERE su.user_flow = rd.doctor_flow
                           AND rd.RECORD_STATUS = 'Y')
                <if test='userFlow!=null and userFlow!=""'>
                    and su.user_flow != #{userFlow}
                </if>
                <if test='orgFlow!=null and orgFlow!=""'>
                    and su.org_flow = #{orgFlow}
                </if>
                <if test='deptFlow!=null and deptFlow!=""'>
                    and SUD.DEPT_FLOW = #{deptFlow}
                </if>
                <if test='deptName!=null and deptName!=""'>
                    <bind name="deptName" value="'%'+deptName+'%'"/>
                    and su.DEPT_NAME like #{deptName}
                </if>
                <if test='idNo!=null and idNo!=""'>
                    <bind name="idNo" value="'%'+idNo+'%'"/>
                    and su.id_no like #{idNo}
                </if>
                <if test='userPhone!=null and userPhone!=""'>
                    <bind name="userPhone" value="'%'+userPhone+'%'"/>
                    and su.user_phone like #{userPhone}
                </if>
                <if test='userEmail!=null and userEmail!=""'>
                    <bind name="userEmail" value="'%'+userEmail+'%'"/>
                    and su.user_email like #{userEmail}
                </if>
                <if test='userCode!=null and userCode!=""'>
                    <bind name="userCode" value="'%'+userCode+'%'"/>
                    and su.user_code like #{userCode}
                </if>
                <if test='userName!=null and userName!=""'>
                    <bind name="name" value="'%'+userName+'%'"/>
                    and su.user_name like #{name}
                </if>
                <if test='statusId!=null and statusId!=""'>
                    and su.status_Id = #{statusId}
                </if>
                <if test="roleList!=null">
                    and (
                        exists(
                        select null from SYS_USER_ROLE sur
                        where sur.RECORD_STATUS='Y'
                        and su.USER_FLOW=sur.USER_FLOW
                        and sur.ROLE_FLOW in
                        <foreach collection="roleList" item="item" index="index" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                        )
                    )
                </if>
                union
                select SU.USER_FLOW, SU.USER_NAME, DEPT.DEPT_FLOW, DEPT.DEPT_NAME
                from sys_user su
                LEFT JOIN SYS_DEPT DEPT
                ON DEPT.DEPT_FLOW = su.DEPT_FLOW
                WHERE SU.RECORD_STATUS = 'Y'
                AND DEPT.RECORD_STATUS = 'Y'
                   AND NOT EXISTS (SELECT NULL
                          FROM res_doctor rd
                         WHERE su.user_flow = rd.doctor_flow
                           AND rd.RECORD_STATUS = 'Y')
                <if test='userFlow!=null and userFlow!=""'>
                    and su.user_flow != #{userFlow}
                </if>
                <if test='orgFlow!=null and orgFlow!=""'>
                    and su.org_flow = #{orgFlow}
                </if>
                <if test='deptFlow!=null and deptFlow!=""'>
                    and DEPT.DEPT_FLOW = #{deptFlow}
                </if>
                <if test='deptName!=null and deptName!=""'>
                    <bind name="deptName" value="'%'+deptName+'%'"/>
                    and su.DEPT_NAME like #{deptName}
                </if>
                <if test='idNo!=null and idNo!=""'>
                    <bind name="idNo" value="'%'+idNo+'%'"/>
                    and su.id_no like #{idNo}
                </if>
                <if test='userPhone!=null and userPhone!=""'>
                    <bind name="userPhone" value="'%'+userPhone+'%'"/>
                    and su.user_phone like #{userPhone}
                </if>
                <if test='userEmail!=null and userEmail!=""'>
                    <bind name="userEmail" value="'%'+userEmail+'%'"/>
                    and su.user_email like #{userEmail}
                </if>
                <if test='userCode!=null and userCode!=""'>
                    <bind name="userCode" value="'%'+userCode+'%'"/>
                    and su.user_code like #{userCode}
                </if>
                <if test='userName!=null and userName!=""'>
                    <bind name="name" value="'%'+userName+'%'"/>
                    and su.user_name like #{name}
                </if>
                <if test='statusId!=null and statusId!=""'>
                    and su.status_Id = #{statusId}
                </if>
                <if test="roleList!=null">
                    and (
                        exists(
                        select null from SYS_USER_ROLE sur
                        where sur.RECORD_STATUS='Y'
                        and su.USER_FLOW=sur.USER_FLOW
                        and sur.ROLE_FLOW in
                        <foreach collection="roleList" item="item" index="index" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                        )
                    )
                </if>
        )A
        order by NLSSORT(A.USER_NAME,'NLS_SORT = SCHINESE_PINYIN_M'),A.DEPT_FLOW
    </select>
    <resultMap id="doctorActivity" type="hashmap" >
        <result  property="doctorFlow" column="DOCTOR_FLOW" javaType="string"/>
        <result  property="doctorName" column="USER_NAME" javaType="string"/>
        <result  property="trainingTypeId" column="TRAINING_TYPE_ID" javaType="string"/>
        <result  property="trainingTypeName" column="TRAINING_TYPE_NAME" javaType="string"/>
        <result  property="trainingSpeId" column="TRAINING_SPE_ID" javaType="string"/>
        <result  property="trainingSpeName" column="TRAINING_SPE_NAME" javaType="string"/>
        <result  property="sessionNumber" column="SESSION_NUMBER" javaType="string"/>
    </resultMap>
    <select id="getDoctorActivityStatistics" resultMap="doctorActivity">
        SELECT rd.DOCTOR_FLOW,
            DR.RECRUIT_FLOW,
            DR.ORG_NAME,
            DR.ORG_FLOW,
            SU.USER_NAME,
            DR.CAT_SPE_ID TRAINING_TYPE_ID,
            DR.CAT_SPE_NAME TRAINING_TYPE_NAME,
            DR.SPE_ID TRAINING_SPE_ID,
            DR.SPE_NAME TRAINING_SPE_NAME,
            DR.SESSION_NUMBER
            FROM RES_DOCTOR_RECRUIT dr
            LEFT JOIN RES_DOCTOR RD
            ON DR.DOCTOR_FLOW = RD.DOCTOR_FLOW
            INNER JOIN SYS_USER SU
            ON RD.DOCTOR_FLOW = SU.USER_FLOW
            WHERE  RD.RECORD_STATUS = 'Y'
            AND DR.RECORD_STATUS='Y'
            AND SU.RECORD_STATUS = 'Y'
            AND dr.AUDIT_STATUS_ID = 'Passed'
            <if test="docTypeList!=null and docTypeList.size>0">
                and rd.DOCTOR_TYPE_ID in
                <foreach collection="docTypeList" open="(" separator="," close=")" item="item">#{item}</foreach>
            </if>
            AND DR.ORG_FLOW IN
            ( SELECT ORG_FLOW FROM SYS_ORG ORG
            WHERE ORG.RECORD_STATUS = 'Y'
            AND ORG.ORG_PROV_ID = '320000'
            AND ORG.ORG_TYPE_ID = 'Hospital'
            <if test='	jointOrgFlag == null or jointOrgFlag == ""'>
                <if test='orgLevel != null and orgLevel != ""'>
                    AND ORG.ORG_LEVEL_ID = #{orgLevel}
                </if>
                <if test='orgFlowList != null and orgFlowList.size>0'>
                    AND	ORG.ORG_FLOW in
                    <foreach collection="orgFlowList" open="(" separator="," close=")" item="item">#{item}</foreach>
                </if>
            </if>
            )
            <if test='typeId != null and typeId != ""'>
                AND rd.TRAINING_TYPE_ID = #{typeId}
            </if>
            <if test='speId != null and speId != ""'>
                AND rd.TRAINING_SPE_ID = #{speId}
            </if>
            <if test='sessionNumber != null and sessionNumber != ""'>
                AND DR.SESSION_NUMBER = #{sessionNumber}
            </if>
            <if test='userName != null and userName != ""'>
                <bind name="name" value="'%'+userName+'%'"/>
                AND SU.USER_NAME LIKE #{name}
            </if>
            <if test='idNo != null and idNo != ""'>
                <bind name="idNo" value="'%'+idNo+'%'"/>
                AND su.ID_NO LIKE #{idNo}
            </if>
            <if test='graduationYear != null and graduationYear != ""'>
                AND DR.GRADUATION_YEAR = #{graduationYear}
            </if>
            order by dr.org_flow,dr.session_number desc,DR.SPE_ID,su.user_name
    </select>
    <select id="checkJoinList" resultMap="com.pinde.sci.dao.base.TeachingActivityInfoMapper.ResultMapWithBLOBs">
        SELECT *
        FROM TEACHING_ACTIVITY_INFO INFO
        WHERE INFO.RECORD_STATUS='Y'
        <if test="activityFlow!=null and activityFlow!=''">
            AND INFO.ACTIVITY_FLOW!=#{activityFlow}
        </if>
        AND   INFO.ACTIVITY_FLOW in (
        select ACTIVITY_FLOW
        FROM TEACHING_ACTIVITY_RESULT T
        WHERE T.RECORD_STATUS = 'Y'
        and (t.IS_REGIEST='Y' or t.IS_SCAN = 'Y')
        and t.user_flow=#{userFlow}
        )
        and exists (
        select 1 from TEACHING_ACTIVITY_INFO tai
        where tai.ACTIVITY_FLOW=#{activityFlow}
        and (
        (
        INFO.START_TIME <![CDATA[<]]> tai.START_TIME
        and INFO.END_TIME > tai.START_TIME
        )
        or
        (
        INFO.START_TIME <![CDATA[<]]> tai.END_TIME
        and INFO.END_TIME > tai.END_TIME
        )
        or
        (
        INFO.START_TIME <![CDATA[>]]> tai.START_TIME
        and INFO.END_TIME <![CDATA[<]]> tai.END_TIME
        )
        or
        (
        INFO.START_TIME <![CDATA[<]]> tai.START_TIME
        and INFO.END_TIME <![CDATA[>]]> tai.END_TIME
        )
        )
        )
    </select>

    <select id="getActivityListByRole" resultMap="com.pinde.sci.dao.base.TeachingActivityInfoMapper.ResultMapWithBLOBs">
        SELECT * FROM TEACHING_ACTIVITY_INFO
        WHERE RECORD_STATUS = 'Y'
        <if test='Month != null and Month != ""'>
            AND SUBSTR(START_TIME,0,7)= #{Month}
        </if>
        <if test='date != null and date != ""'>
            AND SUBSTR(START_TIME,0,10)= #{date}
        </if>
        <if test='roleFlag != null and roleFlag != "" and roleFlag=="local"'>
            AND ORG_FLOW = #{orgFlow}
        </if>
        <if test='roleFlag != null and roleFlag != "" and roleFlag=="kzr"'>
            AND DEPT_FLOW IN (
            SELECT SUD.DEPT_FLOW
            FROM SYS_USER_DEPT SUD
            WHERE SUD.RECORD_STATUS = 'Y'
            AND SUD.USER_FLOW = #{userFlow}
            UNION
            SELECT DEPT_FLOW
            FROM SYS_USER
            WHERE USER_FLOW = #{userFlow})
        </if>
        <if test='roleFlag != null and roleFlag != "" and roleFlag=="Teacher"'>
            AND SPEAKER_FLOW = #{userFlow}
        </if>
    </select>

	<resultMap id="DoctorMap" type="map" extends="com.pinde.sci.dao.base.SysDeptMapper.BaseResultMap">
		<result column="ORG_NAME" jdbcType="VARCHAR" property="orgName" />
	</resultMap>
	<select id="searchDeptByDoctor" resultMap="DoctorMap">
		select sd.*,so.org_name
        from sys_dept sd
		LEFT join sys_org so
		on sd.org_flow=so.org_flow
		where sd.record_status = 'Y'
		and ( exists (
				select null
        from res_doctor_sch_process rdsp
				where rdsp.record_status = 'Y'
				and rdsp.dept_flow = sd.dept_flow
				and rdsp.user_flow=#{userFlow}
			)
			<if test='orgFlow!=null and orgFlow!=""'>
				or	sd.org_flow=#{orgFlow}
			</if>
		)
		order by sd.org_flow,sd.ordinal
	</select>
</mapper>