<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pinde.res.dao.jswjw.ext.ResRecExtMapper" >
	<resultMap type="HashMap" id="auditCountMap">
		<result  property="key" column="REC_TYPE_ID" javaType="string"/>
		<result property="value" column="audit_count" javaType="java.math.BigDecimal"/>
	</resultMap>
	
	<resultMap type="HashMap" id="recCountMap">
		<result property="recKey" column="REC_KEY" javaType="string"/>
		<result property="finishCount" column="FINISH_COUNT" javaType="java.math.BigDecimal"/>
	</resultMap>
	
	<resultMap type="HashMap" id="teacherAuditCount">
		<result property="teacherFlow" column="TEACHER_FLOW" javaType="string"/>
		<result property="teacherName" column="TEACHER_NAME" javaType="string"/>
		<result property="auditCount" column="AUDIT_COUNT" javaType="java.math.BigDecimal"/>
	</resultMap>

	<resultMap id="BaseResultMap" type="com.pinde.core.model.ResRec" >
		<id column="REC_FLOW" property="recFlow" jdbcType="VARCHAR" />
		<result column="ORG_FLOW" property="orgFlow" jdbcType="VARCHAR" />
		<result column="ORG_NAME" property="orgName" jdbcType="VARCHAR" />
		<result column="DEPT_FLOW" property="deptFlow" jdbcType="VARCHAR" />
		<result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR" />
		<result column="SCH_DEPT_FLOW" property="schDeptFlow" jdbcType="VARCHAR" />
		<result column="SCH_DEPT_NAME" property="schDeptName" jdbcType="VARCHAR" />
		<result column="REC_TYPE_ID" property="recTypeId" jdbcType="VARCHAR" />
		<result column="REC_TYPE_NAME" property="recTypeName" jdbcType="VARCHAR" />
		<result column="ITEM_NAME" property="itemName" jdbcType="VARCHAR" />
		<result column="REC_VERSION" property="recVersion" jdbcType="VARCHAR" />
		<result column="OPER_TIME" property="operTime" jdbcType="VARCHAR" />
		<result column="OPER_USER_FLOW" property="operUserFlow" jdbcType="VARCHAR" />
		<result column="OPER_USER_NAME" property="operUserName" jdbcType="VARCHAR" />
		<result column="STATUS_ID" property="statusId" jdbcType="VARCHAR" />
		<result column="STATUS_NAME" property="statusName" jdbcType="VARCHAR" />
		<result column="AUDIT_TIME" property="auditTime" jdbcType="VARCHAR" />
		<result column="AUDIT_USER_FLOW" property="auditUserFlow" jdbcType="VARCHAR" />
		<result column="AUDIT_USER_NAME" property="auditUserName" jdbcType="VARCHAR" />
		<result column="AUDIT_STATUS_ID" property="auditStatusId" jdbcType="VARCHAR" />
		<result column="AUDIT_STATUS_NAME" property="auditStatusName" jdbcType="VARCHAR" />
		<result column="HEAD_AUDIT_TIME" property="headAuditTime" jdbcType="VARCHAR" />
		<result column="HEAD_AUDIT_USER_FLOW" property="headAuditUserFlow" jdbcType="VARCHAR" />
		<result column="HEAD_AUDIT_USER_NAME" property="headAuditUserName" jdbcType="VARCHAR" />
		<result column="HEAD_AUDIT_STATUS_ID" property="headAuditStatusId" jdbcType="VARCHAR" />
		<result column="HEAD_AUDIT_STATUS_NAME" property="headAuditStatusName" jdbcType="VARCHAR" />
		<result column="RECORD_STATUS" property="recordStatus" jdbcType="VARCHAR" />
		<result column="CREATE_TIME" property="createTime" jdbcType="VARCHAR" />
		<result column="CREATE_USER_FLOW" property="createUserFlow" jdbcType="VARCHAR" />
		<result column="MODIFY_TIME" property="modifyTime" jdbcType="VARCHAR" />
		<result column="MODIFY_USER_FLOW" property="modifyUserFlow" jdbcType="VARCHAR" />
		<result column="MANAGER_AUDIT_TIME" property="managerAuditTime" jdbcType="VARCHAR" />
		<result column="MANAGER_AUDIT_USER_FLOW" property="managerAuditUserFlow" jdbcType="VARCHAR" />
		<result column="MANAGER_AUDIT_USER_NAME" property="managerAuditUserName" jdbcType="VARCHAR" />
		<result column="MANAGER_AUDIT_STATUS_ID" property="managerAuditStatusId" jdbcType="VARCHAR" />
		<result column="MANAGER_AUDIT_STATUS_NAME" property="managerAuditStatusName" jdbcType="VARCHAR" />
		<result column="ADMIN_AUDIT_TIME" property="adminAuditTime" jdbcType="VARCHAR" />
		<result column="ADMIN_AUDIT_USER_FLOW" property="adminAuditUserFlow" jdbcType="VARCHAR" />
		<result column="ADMIN_AUDIT_USER_NAME" property="adminAuditUserName" jdbcType="VARCHAR" />
		<result column="ADMIN_AUDIT_STATUS_ID" property="adminAuditStatusId" jdbcType="VARCHAR" />
		<result column="ADMIN_AUDIT_STATUS_NAME" property="adminAuditStatusName" jdbcType="VARCHAR" />
		<result column="ITEM_ID" property="itemId" jdbcType="VARCHAR" />
		<result column="PROCESS_FLOW" property="processFlow" jdbcType="VARCHAR" />
		<result column="REC_FORM" property="recForm" jdbcType="VARCHAR" />
		<result column="SCH_ROTATION_DEPT_FLOW" property="schRotationDeptFlow" jdbcType="VARCHAR" />
		<result column="MEDICINE_TYPE" property="medicineType" jdbcType="VARCHAR" />
	</resultMap>
	<select id="searchAuditCount" resultMap="auditCountMap">
		select REC_TYPE_ID,count(REC_TYPE_ID) audit_count from pdsci.RES_REC rr,pdsci.RES_DOCTOR_SCH_PROCESS rdp 
			where rr.RECORD_STATUS='Y' and rdp.RECORD_STATUS='Y'  and user_flow = oper_user_flow and rr.SCH_DEPT_FLOW= rdp.SCH_DEPT_FLOW
			   <if test='roleFlag=="teacher"'> 
			   and TEACHER_USER_FLOW=#{userFlow} and (AUDIT_STATUS_ID is null)
			   </if>
			   <if test='roleFlag=="head"'> 
			   and HEAD_USER_FLOW=#{userFlow} and (HEAD_AUDIT_STATUS_ID is null )
			   </if>
			   GROUP BY REC_TYPE_ID
	</select>
	<select id="selectByExampleTwo" resultMap="BaseResultMap" parameterType="com.pinde.core.model.ResRecExample" >
		select
		<if test="distinct" >
			distinct
		</if>
		SCH_ROTATION_DEPT_FLOW,REC_TYPE_ID,ITEM_ID
		from PDSCI.RES_REC
		<if test="_parameter != null" >
			<where >
				<foreach collection="oredCriteria" item="criteria" separator="or" >
					<if test="criteria.valid" >
						<trim prefix="(" suffix=")" prefixOverrides="and" >
							<foreach collection="criteria.criteria" item="criterion" >
								<choose >
									<when test="criterion.noValue" >
										and ${criterion.condition}
									</when>
									<when test="criterion.singleValue" >
										and ${criterion.condition} #{criterion.value}
									</when>
									<when test="criterion.betweenValue" >
										and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
									</when>
									<when test="criterion.listValue" >
										and ${criterion.condition}
										<foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
											#{listItem}
										</foreach>
									</when>
								</choose>
							</foreach>
						</trim>
					</if>
				</foreach>
			</where>
		</if>
		<if test="orderByClause != null" >
			order by ${orderByClause}
		</if>
	</select>
	<select id="notAudited" resultType="int">
		select count(*) from RES_REC rr 
		 where rr.RECORD_STATUS='Y'
		 and rr.AUDIT_STATUS_ID is null
		 <if test="startDate!=null and startDate!=''">
			 and rr.OPER_TIME<![CDATA[>=]]>#{startDate}
		</if>
	    <if test="endDate!=null and endDate!=''">
		 	 and rr.OPER_TIME<![CDATA[<=]]>#{endDate}
	    </if>
		and rr.rec_type_id in ('CaseRegistry','DiseaseRegistry','SkillRegistry','OperationRegistry','CampaignRegistry')
	    <!--and rr.REC_TYPE_ID not in('Delay','ReturnTraining','DoctorAuth','TeacherGrade','DeptGrade','AfterSummary','AfterEvaluation')-->
		 and (
			exists(
			  select null
			  from (
					SELECT p.*, RD.DOCTOR_TYPE_ID, nvl((
					SELECT CFG_VALUE
					FROM sys_cfg cfg
					WHERE cfg.record_status = 'Y'
					AND cfg.cfg_code = ('jswjw_' || rd.org_flow || '_P001')
					), 'N') AS STU_JD_GC, nvl((
					SELECT CFG_VALUE
					FROM sys_cfg cfg
					WHERE cfg.record_status = 'Y'
					AND cfg.cfg_code = ('jswjw_sendSchool_' || rd.Work_Org_Id || '_P007')
					AND RD.DOCTOR_TYPE_ID = 'Graduate'
					), 'Y') AS STU_SEND_SCHOOL_GC, nvl((
					SELECT CFG_VALUE
					FROM sys_cfg cfg
					WHERE cfg.record_status = 'Y'
					AND cfg.cfg_code = ('jswjw_' || rd.org_flow || '_P008')
					), 'N') AS STU_JDZS_GC
					, nvl((
					SELECT CFG_VALUE
					FROM sys_cfg cfg
					WHERE cfg.record_status = 'Y'
					AND cfg.cfg_code = ('jswjw_' || TU.org_flow || '_P001')
					), 'N') AS TEA_JD_GC, nvl((
					SELECT CFG_VALUE
					FROM sys_cfg cfg
					WHERE cfg.record_status = 'Y'
					AND cfg.cfg_code = ('jswjw_' || TU.org_flow || '_P006')
					), 'N') AS TEA_APP,
				nvl((select CFG_VALUE from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code =
				'jsres_doctor_app_menu_'||rd.doctor_flow),'N')APP_MENU_FLAG,
				nvl(cfg2.power_start_time,'0000-00-00') power_start_time, nvl(cfg2.power_end_time,'9999-99-99') power_end_time
					FROM res_doctor_sch_process p
					LEFT JOIN res_doctor rd ON p.user_flow = rd.doctor_flow
					LEFT JOIN sys_user su ON su.user_flow = rd.doctor_flow
					LEFT JOIN sys_user tu ON tu.user_flow = p.teacher_user_flow
					left join jsres_power_cfg cfg2
					on cfg2.record_status='Y' and cfg2.cfg_code = 'jsres_doctor_data_time_'||rd.doctor_flow
					WHERE p.record_status = 'Y'
					AND rd.record_status = 'Y'
					AND su.record_status = 'Y'
					AND tu.record_status = 'Y'

					<if test="typeList!=null and typeList.size()>0">
						and rd.doctor_Type_Id in
						<foreach collection="typeList" item="item" open="(" close=")" separator="," >
							#{item}
						</foreach>
					</if>
				) rdsp
			  where rdsp.RECORD_STATUS='Y'
				AND
		rdsp.APP_MENU_FLAG='Y'
		AND ( ( rdsp.SCH_START_DATE  <![CDATA[ <= ]]> rdsp.power_start_time AND rdsp.SCH_END_DATE >= rdsp.power_END_time)
		or (rdsp.SCH_START_DATE  <![CDATA[ >= ]]> rdsp.power_start_time AND rdsp.SCH_START_DATE <![CDATA[ <= ]]>rdsp.power_END_time)
		or (rdsp.SCH_END_DATE  <![CDATA[ >= ]]> rdsp.power_start_time AND rdsp.SCH_END_DATE <![CDATA[ <= ]]>rdsp.power_END_time))
			  and 
			  rr.PROCESS_FLOW=rdsp.PROCESS_FLOW
			  <if test="teacherUserFlow!=null and teacherUserFlow!=''">
			  	and rdsp.TEACHER_USER_FLOW=#{teacherUserFlow}
			  </if>
			)
		)
	</select>
	
	<select id="isNotAudited" resultType="int">
		select count(rr.REC_FLOW) from RES_REC rr 
		 where rr.RECORD_STATUS='Y'
		 and rr.AUDIT_STATUS_ID is not null
		 <if test="startDate!=null and startDate!=''">
			 and rr.OPER_TIME<![CDATA[>=]]>#{startDate}
		</if>
	    <if test="endDate!=null and endDate!=''">
		 	 and rr.OPER_TIME<![CDATA[<=]]>#{endDate}
	    </if>
		 and (
			exists(
			  select null
			  from RES_DOCTOR_SCH_PROCESS rdsp
			  where rdsp.RECORD_STATUS='Y' 
			  and 
			  rr.PROCESS_FLOW=rdsp.PROCESS_FLOW
			  <if test="teacherUserFlow!=null and teacherUserFlow!=''">
			  	and rdsp.TEACHER_USER_FLOW=#{teacherUserFlow}
			  </if>
			)
		)
		<if test="typeList!=null and typeList.size()>0">
			and exists (
			select 1 from res_doctor where doctor_Type_Id in
			<foreach collection="typeList" item="item" open="(" close=")" separator="," >
				#{item}
			</foreach>
			and doctor_flow=oper_user_flow
			)
		</if>
	</select>

	<select id="resSearchProssFlowRecRec"  parameterType="java.util.Map" resultMap="com.pinde.sci.dao.base.ResRecMapper.ResultMapWithBLOBs">
		select * from DEPT_TEACHER_GRADE_INFO  rr
		where rr.RECORD_STATUS='Y'
		<if test="startDate!=null and startDate!=''">
			and rr.OPER_TIME<![CDATA[>=]]>#{startDate}
		</if>
		<if test="endDate!=null and endDate!=''">
			and rr.OPER_TIME<![CDATA[<=]]>#{endDate}
		</if>
		and (exists(
		select null from RES_DOCTOR_SCH_PROCESS rdsp
		where rdsp.RECORD_STATUS='Y'
		<if test="teacherUserFlow!=null and teacherUserFlow!=''">
			and rdsp.TEACHER_USER_FLOW=#{teacherUserFlow}
		</if>
		and rr.PROCESS_FLOW =rdsp.PROCESS_FLOW
		and rr.OPER_USER_FLOW=rdsp.USER_FLOW
		and rr.rec_type_id ='TeacherGrade'
		))
	</select>
	<select id="searchProssFlowRecRec"  parameterType="java.util.Map" resultMap="com.pinde.sci.dao.base.ResRecMapper.ResultMapWithBLOBs">
		select * from DEPT_TEACHER_GRADE_INFO  rr
		where rr.RECORD_STATUS='Y'
		<if test="startDate!=null and startDate!=''">
			 and rr.OPER_TIME<![CDATA[>=]]>#{startDate}
		</if>
	    <if test="endDate!=null and endDate!=''">
		 	 and rr.OPER_TIME<![CDATA[<=]]>#{endDate}
	    </if>
		and (exists(
				select null
				from (select  P.TEACHER_USER_FLOW TEACHER_USER_FLOW,
				p.PROCESS_FLOW PROCESS_FLOW,
				su.user_flow user_flow,
				RD.DOCTOR_TYPE_ID,
				nvl((select CFG_VALUE from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code = 'jsres_doctor_app_menu_'||rd.doctor_flow),'N')APP_MENU_FLAG

		from res_doctor_sch_process p
				left join res_doctor rd
				on p.user_flow = rd.doctor_flow
				left join sys_user su
				on su.user_flow = rd.doctor_flow
				left join sys_user tu
				on tu.user_flow = p.teacher_user_flow
				where p.record_status = 'Y'
				and rd.record_status = 'Y'
				and su.record_status = 'Y'
				and tu.record_status = 'Y') A
				WHERE A.APP_MENU_FLAG='Y'
			  <if test="teacherUserFlow!=null and teacherUserFlow!=''">
				  and a.TEACHER_USER_FLOW=#{teacherUserFlow}
			  </if>
			  and rr.PROCESS_FLOW =a.PROCESS_FLOW
			  and rr.OPER_USER_FLOW=a.USER_FLOW
			  and rr.rec_type_id ='TeacherGrade'
	 	))
	</select>
	
	<select id="searchProssFlowRec"  parameterType="java.util.Map" resultMap="com.pinde.sci.dao.base.ResRecMapper.ResultMapWithBLOBs">
   			 select rr.* from RES_DOCTOR_SCH_PROCESS rdsp
   			  inner join SCH_ARRANGE_RESULT sar on rdsp.SCH_RESULT_FLOW=sar.RESULT_FLOW
   			  inner join SCH_ROTATION_DEPT srd on srd.GROUP_FLOW=sar.STANDARD_GROUP_FLOW 
   			  								and srd.STANDARD_DEPT_ID=sar.STANDARD_DEPT_ID
   			  inner join  RES_SCH_PROCESS_EXPRESS  rr on rr.OPER_USER_FLOW=rdsp.USER_FLOW	and srd.RECORD_FLOW=rr.SCH_ROTATION_DEPT_FLOW
			  where rdsp.RECORD_STATUS='Y' and sar.RECORD_STATUS='Y' and srd.RECORD_STATUS='Y' and rr.RECORD_STATUS='Y'
			  and rr.REC_CONTENT is not null
			  <if test="teacherUserFlow!=null and teacherUserFlow!=''">
				  and rdsp.TEACHER_USER_FLOW=#{teacherUserFlow}
			  </if>
			  and rr.rec_type_id ='AfterSummary'
	</select>
	
	<select id="searchDeptFlowRec"  parameterType="java.util.Map" resultMap="com.pinde.sci.dao.base.ResRecMapper.ResultMapWithBLOBs">
		select * from DEPT_TEACHER_GRADE_INFO  rr
		where rr.RECORD_STATUS='Y'
		<if test="startDate!=null and startDate!=''">
			 and rr.OPER_TIME<![CDATA[>=]]>#{startDate}
		</if>
	    <if test="endDate!=null and endDate!=''">
		 	 and rr.OPER_TIME<![CDATA[<=]]>#{endDate}
	    </if>
		and (exists(
				select NULL
				from (select p.PROCESS_FLOW PROCESS_FLOW,
				P.USER_FLOW USER_FLOW ,
				P.DEPT_FLOW DEPT_FLOW,
				RD.DOCTOR_TYPE_ID,
		nvl((select CFG_VALUE from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code = 'jsres_doctor_app_menu_'||rd.doctor_flow),'N')APP_MENU_FLAG
		from res_doctor_sch_process p
				left join res_doctor rd
				on p.user_flow = rd.doctor_flow
				left join sys_user su
				on su.user_flow = rd.doctor_flow
				left join sys_user tu
				on tu.user_flow = p.teacher_user_flow
				where p.record_status = 'Y'
				and rd.record_status = 'Y'
				and su.record_status = 'Y'
				and tu.record_status = 'Y') A
				WHERE  A.APP_MENU_FLAG='Y'
				AND rr.PROCESS_FLOW = a.PROCESS_FLOW
				AND rr.OPER_USER_FLOW = a.USER_FLOW
				AND rr.rec_type_id = 'DeptGrade'
				<if test="deptFlow!=null and deptFlow!=''">
					and a.DEPT_FLOW=#{deptFlow}
				</if>
				and rr.rec_type_id ='DeptGrade'
	 	))
	</select>

	<select id="resSearchDeptFlowRec"  parameterType="java.util.Map" resultMap="com.pinde.sci.dao.base.ResRecMapper.ResultMapWithBLOBs">
		select * from DEPT_TEACHER_GRADE_INFO  rr
		where rr.RECORD_STATUS='Y'
		<if test="startDate!=null and startDate!=''">
			and rr.OPER_TIME<![CDATA[>=]]>#{startDate}
		</if>
		<if test="endDate!=null and endDate!=''">
			and rr.OPER_TIME<![CDATA[<=]]>#{endDate}
		</if>
		and (exists(
		select null from RES_DOCTOR_SCH_PROCESS rdsp
		where rdsp.RECORD_STATUS='Y'
		<if test="deptFlow!=null and deptFlow!=''">
			and rdsp.DEPT_FLOW=#{deptFlow}
		</if>
		and rr.PROCESS_FLOW =rdsp.PROCESS_FLOW
		and rr.OPER_USER_FLOW=rdsp.USER_FLOW
		and rr.rec_type_id ='DeptGrade'
		))
	</select>
	<select id="searchRecByUserAndSchdept" resultMap="com.pinde.sci.dao.base.ResRecMapper.BaseResultMap">
		SELECT * 
		FROM PDSCI.RES_REC
		WHERE RECORD_STATUS = 'Y'
		AND OPER_USER_FLOW IN
		<foreach collection="userFlows" item="userFlow" open="(" separator="," close=")">  
  			#{userFlow}
 		</foreach>
 		<if test='recTypeId != null and recTypeId != ""'>
 			AND REC_TYPE_ID = #{recTypeId}
 		</if>
 		<if test='itemName != null and itemName != ""'>
 			AND ITEM_NAME LIKE CONCAT(CONCAT('%', #{itemName}),'%')
 		</if>
		AND SCH_DEPT_FLOW IN
		<foreach collection="schDeptFlows" item="schDeptFlow" open="(" separator="," close=")">  
  			#{schDeptFlow}
 		</foreach>
	</select>

	<select id="countRecWithDoc" resultMap="recCountMap">
		SELECT OPER_USER_FLOW||process_flow||SCH_DEPT_FLOW||REC_TYPE_ID REC_KEY,COUNT(*) FINISH_COUNT
		FROM PDSCI.RES_REC
		WHERE RECORD_STATUS = 'Y'
		AND OPER_USER_FLOW IN 
		<foreach collection="userFlows" item="userFlow" open="(" separator="," close=")">
			#{userFlow}
		</foreach>
		AND SCH_DEPT_FLOW IN 
		<foreach collection="schDeptFlows" item="schDeptFlow" open="(" separator="," close=")">
			#{schDeptFlow}
		</foreach>
		<if test='isAudit != null and isAudit == "teacher"'>
			AND AUDIT_STATUS_ID IS NULL
		</if>
		<if test='isAudit != null and isAudit == "head"'>
			AND HEAD_AUDIT_STATUS_ID IS NULL
		</if>
        <if test='isAudit != null and isAudit == "secretary"'>
            AND HEAD_AUDIT_STATUS_ID IS NULL
        </if>
		GROUP BY OPER_USER_FLOW,REC_TYPE_ID,SCH_DEPT_FLOW,process_flow
	</select>
	
	<select id="searchByRecForAudit" resultMap="com.pinde.sci.dao.base.ResRecMapper.BaseResultMap">
		SELECT *
		FROM PDSCI.RES_REC
		WHERE RECORD_STATUS = 'Y'
		<if test='recTypeId != null and recTypeId != ""'>
			AND REC_TYPE_ID = #{recTypeId}
		</if>
		<if test='processFlow != null and processFlow != ""'>
			AND PROCESS_FLOW = #{processFlow}
		</if>
<!-- 		AND (AUDIT_STATUS_ID <![CDATA[<>]]> 'TeacherAuditN' OR AUDIT_STATUS_ID IS NULL) -->
		ORDER BY AUDIT_STATUS_ID NULLS FIRST,OPER_TIME
	</select>
	
	<select id="searchTeacherAuditCount" resultMap="teacherAuditCount">
		SELECT RDSP.TEACHER_USER_FLOW TEACHER_FLOW,RDSP.TEACHER_USER_NAME TEACHER_NAME,COUNT(*) AUDIT_COUNT 
		FROM PDSCI.RES_REC RR,PDSCI.RES_DOCTOR_SCH_PROCESS RDSP
		WHERE RR.RECORD_STATUS = 'Y'
		AND RDSP.RECORD_STATUS = 'Y'
		AND RR.OPER_USER_FLOW = RDSP.USER_FLOW
		AND RR.SCH_DEPT_FLOW = RDSP.SCH_DEPT_FLOW
<!-- 		AND RDSP.IS_CURRENT_FLAG = 'Y' -->
		<if test='headUserFlow!=null and headUserFlow!=""'>
			AND RDSP.HEAD_USER_FLOW = #{headUserFlow}
		</if>
		<if test='isAudit!=null and isAudit=="Y"'>
			AND RR.AUDIT_STATUS_ID IS NOT NULL
		</if>
		<if test='isAudit!=null and isAudit=="N"'>
			AND RR.AUDIT_STATUS_ID IS NULL
		</if>
		GROUP BY RDSP.TEACHER_USER_FLOW,RDSP.TEACHER_USER_NAME
	</select>
	
	<select id="searchDoctorNotAuditCount" resultMap="recCountMap">
		SELECT RDSP.USER_FLOW REC_KEY,COUNT(*) FINISH_COUNT 
		FROM PDSCI.RES_REC RR,PDSCI.RES_DOCTOR_SCH_PROCESS RDSP
		WHERE RR.RECORD_STATUS = 'Y'
		AND RDSP.RECORD_STATUS = 'Y'
		AND RR.OPER_USER_FLOW = RDSP.USER_FLOW
		AND RR.SCH_DEPT_FLOW = RDSP.SCH_DEPT_FLOW
		AND RDSP.IS_CURRENT_FLAG = 'Y'
		<if test='schDeptFlow!=null and schDeptFlow!=""'>
			AND RDSP.SCH_DEPT_FLOW = #{schDeptFlow}
		</if>
		<if test='teacherUserFlow!=null and teacherUserFlow!=""'>
			AND RDSP.TEACHER_USER_FLOW = #{teacherUserFlow}
		</if>
		<if test='isAudit!=null and isAudit=="Y"'>
			AND RR.AUDIT_STATUS_ID IS NOT NULL
		</if>
		<if test='isAudit!=null and isAudit=="N"'>
			AND RR.AUDIT_STATUS_ID IS NULL
		</if>
		<if test='recTypeIds!=null'>
			AND RR.REC_TYPE_ID IN
			<foreach collection="recTypeIds" close=")" item="recTypeId" open="(" separator=",">
				#{recTypeId}
			</foreach>
		</if>
		GROUP BY RDSP.USER_FLOW
	</select>

    <select id="searchAfterAuditRecNew"
            resultMap="com.pinde.core.common.sci.dao.ResSchProcessExpressMapper.ResultMapWithBLOBs">
		SELECT RR.*
		FROM PDSCI.SYS_USER SU,PDSCI.RES_DOCTOR_SCH_PROCESS RDSP,PDSCI.RES_SCH_PROCESS_EXPRESS RR
		WHERE SU.RECORD_STATUS = 'Y'
		AND RDSP.RECORD_STATUS = 'Y'
		AND RR.RECORD_STATUS = 'Y'
		AND SU.USER_FLOW = RR.OPER_USER_FLOW
		AND RDSP.USER_FLOW = RR.OPER_USER_FLOW
		AND RR.REC_TYPE_ID IN
		<foreach collection="recTypeIds" close=")" item="recTypeId" open="(" separator=",">
			#{recTypeId}
		</foreach>

		AND RR.PROCESS_FLOW = RDSP.PROCESS_FLOW
		<if test='process!=null'>
			<if test='process.teacherUserFlow!=null and process.teacherUserFlow!=""'>
				AND RDSP.TEACHER_USER_FLOW = #{process.teacherUserFlow}
			</if>
			<if test='process.headUserFlow!=null and process.headUserFlow!=""'>
				AND RDSP.HEAD_USER_FLOW = #{process.headUserFlow}
			</if>
			<if test='process.isCurrentFlag!=null and process.isCurrentFlag!=""'>
				AND RDSP.IS_CURRENT_FLAG = #{process.isCurrentFlag}
			</if>
			<if test='process.userFlow!=null and process.userFlow!=""'>
				AND RDSP.USER_FLOW = #{process.userFlow}
			</if>
		</if>
		<if test='user!=null'>
			<if test='user.name!=null and user.name!=""'>
				AND SU.USER_NAME LIKE #{user.name}
			</if>
		</if>
		<if test='roleFlagMap!=null'>
			<if test='roleFlagMap.year!=null and roleFlagMap.year!=""'>
				AND RR.OPER_TIME LIKE CONCAT(#{roleFlagMap.year},'%')
			</if>
			<if test='roleFlagMap.roleFlag!=null and roleFlagMap.roleFlag!=""'>
				<if test='roleFlagMap.roleFlag=="teacher"'>
					ORDER BY RR.AUDIT_STATUS_ID NULLS FIRST
				</if>
				<if test='roleFlagMap.roleFlag=="head"'>
					<if test='roleFlagMap.val!=null and roleFlagMap.val!=""'>
						AND( RR.DEPT_FLOW IN (
						SELECT SUD.DEPT_FLOW
						FROM PDSCI.SYS_USER_DEPT SUD
						WHERE SUD.RECORD_STATUS = 'Y'
						AND SUD.USER_FLOW = #{roleFlagMap.val}
						) or rdsp.head_user_flow=#{roleFlagMap.val} )
					</if>
					ORDER BY RR.HEAD_AUDIT_STATUS_ID NULLS FIRST
				</if>
				<if test='roleFlagMap.roleFlag=="manager"'>
					<if test='roleFlagMap.val!=null and roleFlagMap.val!=""'>
						AND RDSP.USER_FLOW IN (
						SELECT DOCTOR_FLOW
						FROM PDSCI.RES_DOCTOR
						WHERE RECORD_STATUS = 'Y'
						<if test='roleFlagMap.trainingSpeId!=null and roleFlagMap.trainingSpeId!=""'>
							AND TRAINING_SPE_ID = #{roleFlagMap.trainingSpeId}
						</if>
						<if test='roleFlagMap.trainingSpeId==null or roleFlagMap.trainingSpeId==""'>
							AND TRAINING_SPE_ID IN (
							SELECT TRAINING_SPE_ID
							FROM PDSCI.RES_USER_SPE
							WHERE RECORD_STATUS = 'Y'
							AND USER_FLOW = #{roleFlagMap.val}
							)
						</if>
						AND ORG_FLOW IN (
						SELECT ORG_FLOW
						FROM PDSCI.SYS_USER
						WHERE USER_FLOW = #{roleFlagMap.val}
						)
						)
					</if>
					ORDER BY RR.MANAGER_AUDIT_STATUS_ID NULLS FIRST
				</if>
				<if test='roleFlagMap.roleFlag=="admin"'>
					<if test='roleFlagMap.val!=null and roleFlagMap.val!=""'>
						AND RR.ORG_FLOW = #{roleFlagMap.val}
					</if>
					ORDER BY RR.ADMIN_AUDIT_STATUS_ID NULLS FIRST
				</if>
			</if>
		</if>
	</select>


	<select id="searchAfterAuditRec" resultMap="com.pinde.sci.dao.base.ResRecMapper.ResultMapWithBLOBs">
	    SELECT RR.*
	    FROM PDSCI.SYS_USER SU,PDSCI.RES_DOCTOR_SCH_PROCESS RDSP,PDSCI.RES_REC RR
	    WHERE SU.RECORD_STATUS = 'Y'
    	AND RDSP.RECORD_STATUS = 'Y'
    	AND RR.RECORD_STATUS = 'Y'
    	AND SU.USER_FLOW = RR.OPER_USER_FLOW
    	AND RDSP.USER_FLOW = RR.OPER_USER_FLOW
    	AND RR.REC_TYPE_ID IN 
   		<foreach collection="recTypeIds" close=")" item="recTypeId" open="(" separator=",">
   			#{recTypeId}
   		</foreach>
    	
    	AND RR.PROCESS_FLOW = RDSP.PROCESS_FLOW
    	<if test='process!=null'>
    		<if test='process.teacherUserFlow!=null and process.teacherUserFlow!=""'>
    			AND RDSP.TEACHER_USER_FLOW = #{process.teacherUserFlow}
    		</if>
    		<if test='process.headUserFlow!=null and process.headUserFlow!=""'>
    			AND RDSP.HEAD_USER_FLOW = #{process.headUserFlow}
    		</if>
    		<if test='process.isCurrentFlag!=null and process.isCurrentFlag!=""'>
    			AND RDSP.IS_CURRENT_FLAG = #{process.isCurrentFlag}
    		</if>
    		<if test='process.userFlow!=null and process.userFlow!=""'>
    			AND RDSP.USER_FLOW = #{process.userFlow}
    		</if>
    	</if>
	    <if test='user!=null'>
		    <if test='user.name!=null and user.name!=""'>
		    	AND SU.USER_NAME LIKE #{user.name}
		    </if>
	    </if>
	    <if test='roleFlagMap!=null'>
	    	<if test='roleFlagMap.year!=null and roleFlagMap.year!=""'>
	    		AND RR.OPER_TIME LIKE CONCAT(#{roleFlagMap.year},'%')
	    	</if>
		    <if test='roleFlagMap.roleFlag!=null and roleFlagMap.roleFlag!=""'>
		    	<if test='roleFlagMap.roleFlag=="teacher"'>
		    		ORDER BY RR.AUDIT_STATUS_ID NULLS FIRST
		    	</if>
		    	<if test='roleFlagMap.roleFlag=="head"'>
		    		<if test='roleFlagMap.val!=null and roleFlagMap.val!=""'>
		    			AND( RR.DEPT_FLOW IN (
		    				SELECT SUD.DEPT_FLOW 
							FROM PDSCI.SYS_USER_DEPT SUD
							WHERE SUD.RECORD_STATUS = 'Y'
							AND SUD.USER_FLOW = #{roleFlagMap.val}
						) or rdsp.head_user_flow=#{roleFlagMap.val} )
		    		</if>
		    		ORDER BY RR.HEAD_AUDIT_STATUS_ID NULLS FIRST
		    	</if>
		    	<if test='roleFlagMap.roleFlag=="manager"'>
		    		<if test='roleFlagMap.val!=null and roleFlagMap.val!=""'>
		    			AND RDSP.USER_FLOW IN (
		    				SELECT DOCTOR_FLOW
		    				FROM PDSCI.RES_DOCTOR
		    				WHERE RECORD_STATUS = 'Y'
		    				<if test='roleFlagMap.trainingSpeId!=null and roleFlagMap.trainingSpeId!=""'>
		    					AND TRAINING_SPE_ID = #{roleFlagMap.trainingSpeId}
		    				</if>
		    				<if test='roleFlagMap.trainingSpeId==null or roleFlagMap.trainingSpeId==""'>
			    				AND TRAINING_SPE_ID IN (
			    					SELECT TRAINING_SPE_ID
			    					FROM PDSCI.RES_USER_SPE
			    					WHERE RECORD_STATUS = 'Y'
			    					AND USER_FLOW = #{roleFlagMap.val}
			    				)
		    				</if>
			    			AND ORG_FLOW IN (
			    				SELECT ORG_FLOW
			    				FROM PDSCI.SYS_USER
			    				WHERE USER_FLOW = #{roleFlagMap.val}
			    			)
		    			)
		    		</if>
		    		ORDER BY RR.MANAGER_AUDIT_STATUS_ID NULLS FIRST
		    	</if>
		    	<if test='roleFlagMap.roleFlag=="admin"'>
		    		<if test='roleFlagMap.val!=null and roleFlagMap.val!=""'>
		    			AND RR.ORG_FLOW = #{roleFlagMap.val}
		    		</if>
		    		ORDER BY RR.ADMIN_AUDIT_STATUS_ID NULLS FIRST
		    	</if>
		    </if>
	    </if>
	</select>
	<select id="searchSXSRecData" resultMap="com.pinde.sci.dao.base.ResRecMapper.ResultMapWithBLOBs">
	    SELECT RR.*
	    FROM PDSCI.SYS_USER SU,PDSCI.RES_REC RR
	    WHERE SU.RECORD_STATUS = 'Y'
    	AND RR.RECORD_STATUS = 'Y'
    	AND SU.USER_FLOW = RR.OPER_USER_FLOW
		<if test='roleFlagMap.roleFlag=="admin"'>
			<if test='roleFlagMap.doctorFlow!=null and roleFlagMap.doctorFlow!=""'>
				AND RR.oper_user_flow = #{roleFlagMap.doctorFlow}
			</if>
		</if>
    	AND RR.REC_TYPE_ID IN
   		<foreach collection="recTypeIds" close=")" item="recTypeId" open="(" separator=",">
   			#{recTypeId}
   		</foreach>
	    <if test='roleFlagMap!=null'>
	    	<if test='roleFlagMap.year!=null and roleFlagMap.year!=""'>
	    		AND RR.OPER_TIME LIKE CONCAT(#{roleFlagMap.year},'%')
	    	</if>
		    <if test='roleFlagMap.roleFlag!=null and roleFlagMap.roleFlag!=""'>
		    	<if test='roleFlagMap.roleFlag=="teacher"'>
		    		ORDER BY RR.AUDIT_STATUS_ID NULLS FIRST
		    	</if>
		    	<if test='roleFlagMap.roleFlag=="head"'>
		    		<if test='roleFlagMap.val!=null and roleFlagMap.val!=""'>
		    			AND( RR.DEPT_FLOW IN (
		    				SELECT SUD.DEPT_FLOW
							FROM PDSCI.SYS_USER_DEPT SUD
							WHERE SUD.RECORD_STATUS = 'Y'
							AND SUD.USER_FLOW = #{roleFlagMap.val}
						) or su.user_flow in ( select user_flow from res_doctor_sch_process rdsp where rdsp.record_status='Y' and rdsp.head_user_flow=#{roleFlagMap.val}) )
		    		</if>
		    		ORDER BY RR.HEAD_AUDIT_STATUS_ID NULLS FIRST
		    	</if>
		    	<if test='roleFlagMap.roleFlag=="manager"'>
		    		<if test='roleFlagMap.val!=null and roleFlagMap.val!=""'>
		    			AND su.USER_FLOW IN (
		    				SELECT DOCTOR_FLOW
		    				FROM PDSCI.RES_DOCTOR
		    				WHERE RECORD_STATUS = 'Y'
		    				<if test='roleFlagMap.trainingSpeId!=null and roleFlagMap.trainingSpeId!=""'>
		    					AND TRAINING_SPE_ID = #{roleFlagMap.trainingSpeId}
		    				</if>
			    			AND ORG_FLOW IN (
			    				SELECT ORG_FLOW
			    				FROM PDSCI.SYS_USER
			    				WHERE USER_FLOW = #{roleFlagMap.val}
			    			)
		    			)
		    		</if>
		    		ORDER BY RR.MANAGER_AUDIT_STATUS_ID NULLS FIRST
		    	</if>
		    	<if test='roleFlagMap.roleFlag=="admin"'>
		    		<if test='roleFlagMap.val!=null and roleFlagMap.val!=""'>
		    			AND RR.ORG_FLOW = #{roleFlagMap.val}
		    		</if>
		    		ORDER BY RR.ADMIN_AUDIT_STATUS_ID NULLS FIRST
		    	</if>
		    </if>
	    </if>
	</select>
	<resultMap id="findTrainChartsMap" type="map">
		<result property="orgFlow" column="ORG_FLOW" javaType="string"/>
		<result property="orgName" column="ORG_NAME" javaType="string"/>
		<result property="countNum" column="COUNT_NUM" javaType="string"/>
	</resultMap>
	<select id="findTrainCharts" resultMap="findTrainChartsMap">
		select a.org_flow, a.org_name, count(1) COUNT_NUM
		from (select org.org_flow,
		org.org_name,
		xmltype(rec_content).extract('//sessionNumber/text()').getstringval()      session_Number,
		xmltype(rec_content).extract('//trainSpe/text()').getstringval()      train_Spe
		from sys_org org
		left join res_rec rr
		on rr.org_flow = org.org_flow
		where org.record_status = 'Y'
		and rr.record_status='Y'
		and rr.rec_type_id = 'ReturnTraining'
		AND substr(xmltype(rr.rec_content).extract('//auditStatusName').getstringval(),22,1) = '1'
		<if test="orgFlowList !=null and orgFlowList.size>0">
			and org.org_flow in
			<foreach collection="orgFlowList" close=")" item="orgFlow" open="(" separator=",">
				#{orgFlow}
			</foreach>
		</if>
		) a
		where 1=1

		<if test="year !=null and year!=''">
			and a.session_number=#{year}
		</if>
		<if test="speName !=null and speName !=''">
			AND a.train_Spe like  CONCAT(CONCAT('%', #{speName}),'%')
		</if>
		group by a.org_flow, a.org_name
	</select>

	<resultMap type="HashMap" id="willAfterCount">
		<result property="deptFlow" column="DEPT_FLOW" javaType="string"/>
		<result property="countNum" column="COUNT_NUM" javaType="java.math.BigDecimal"/>
	</resultMap>
	<select id="searchDeptWillAfter" resultMap="willAfterCount">
		SELECT RDSP.DEPT_FLOW DEPT_FLOW,COUNT(1) COUNT_NUM
		FROM  PDSCI.RES_DOCTOR_SCH_PROCESS RDSP
		WHERE RDSP.RECORD_STATUS = 'Y'
			AND RDSP.IS_CURRENT_FLAG = 'Y'
			AND RDSP.ORG_FLOW = #{orgFlow}
			AND RDSP.PROCESS_FLOW IN (
			SELECT PROCESS_FLOW
			FROM  PDSCI.RES_SCH_PROCESS_EXPRESS RR
			WHERE RR.RECORD_STATUS = 'Y'
			AND RR.ORG_FLOW = #{orgFlow}
			AND (RR.REC_TYPE_ID = 'AfterEvaluation' OR RR.REC_TYPE_ID = 'AfterSummary')
		)
		GROUP BY RDSP.DEPT_FLOW
	</select>
	
	<resultMap type="HashMap" id="willAfterCountDoc">
		<result property="processFlow" column="PROCESS_FLOW" javaType="string"/>
		<result property="countNum" column="COUNT_NUM" javaType="java.math.BigDecimal"/>
	</resultMap>
	<select id="searchDeptWillAfterDoc" resultMap="willAfterCountDoc">
		SELECT RDSP.PROCESS_FLOW PROCESS_FLOW,COUNT(1) COUNT_NUM
		FROM  PDSCI.RES_DOCTOR_SCH_PROCESS RDSP
		WHERE RDSP.RECORD_STATUS = 'Y'
			AND RDSP.IS_CURRENT_FLAG = 'Y'
			AND RDSP.ORG_FLOW = #{orgFlow}
			<if test="deptFlow!=null and deptFlow!=''">
				and dept_flow=#{deptFlow}
			</if>
			AND RDSP.PROCESS_FLOW IN (
			SELECT PROCESS_FLOW 
			FROM  PDSCI.RES_SCH_PROCESS_EXPRESS RR
			WHERE RR.RECORD_STATUS = 'Y'
			AND RR.ORG_FLOW = #{orgFlow}
			AND (RR.REC_TYPE_ID = 'AfterEvaluation' OR RR.REC_TYPE_ID = 'AfterSummary')
		)
		GROUP BY RDSP.PROCESS_FLOW
	</select>
	
	
	<select id="searchProssingRec" parameterType="java.util.Map" resultMap="com.pinde.sci.dao.base.ResRecMapper.BaseResultMap">
		SELECT
			REC_FLOW,
			ORG_FLOW,
			ORG_NAME,
			DEPT_FLOW,
			DEPT_NAME,
			SCH_DEPT_FLOW,
			SCH_DEPT_NAME,
			REC_TYPE_ID,
			REC_TYPE_NAME,
			ITEM_NAME,
			REC_VERSION,
			REC_CONTENT,
			OPER_TIME,
			OPER_USER_FLOW,
			OPER_USER_NAME,
			STATUS_ID,
			STATUS_NAME,
			AUDIT_TIME,
			AUDIT_USER_FLOW,
			AUDIT_USER_NAME,
			AUDIT_STATUS_ID,
			AUDIT_STATUS_NAME,
			HEAD_AUDIT_TIME,
			HEAD_AUDIT_USER_FLOW,
			HEAD_AUDIT_USER_NAME,
			HEAD_AUDIT_STATUS_ID,
			HEAD_AUDIT_STATUS_NAME,
			RECORD_STATUS,
			CREATE_TIME,
			CREATE_USER_FLOW,
			MODIFY_TIME,
			MODIFY_USER_FLOW,
			MANAGER_AUDIT_TIME,
			MANAGER_AUDIT_USER_FLOW,
			MANAGER_AUDIT_USER_NAME,
			MANAGER_AUDIT_STATUS_ID,
			MANAGER_AUDIT_STATUS_NAME,
			ADMIN_AUDIT_TIME,
			ADMIN_AUDIT_USER_FLOW,
			ADMIN_AUDIT_USER_NAME,
			ADMIN_AUDIT_STATUS_ID,
			ADMIN_AUDIT_STATUS_NAME,
			ITEM_ID,
			PROCESS_FLOW,
			REC_FORM,
			SCH_ROTATION_DEPT_FLOW,
			DATE_TIME,
			MEDICINE_TYPE
		FROM
			RES_REC RR
		WHERE
			RR.RECORD_STATUS = 'Y'
		<if test="doctorFlow!=null and doctorFlow!=''">
			AND RR.OPER_USER_FLOW = #{doctorFlow}
		</if>
		<if test="processFlow!=null and processFlow!=''">
			AND RR.SCH_ROTATION_DEPT_FLOW = #{processFlow}
		</if>
		AND EXISTS (
			SELECT 1
			FROM SCH_ARRANGE_RESULT SAR
			WHERE SAR.RECORD_STATUS = 'Y'
			AND SAR.DOCTOR_FLOW = RR.OPER_USER_FLOW
			<if test="standardDeptId!=null and standardDeptId!=''">
				AND SAR.STANDARD_DEPT_ID = #{standardDeptId}
			</if>
			<if test="standardGroupFlow!=null and standardGroupFlow!=''">
		  		AND SAR.STANDARD_GROUP_FLOW = #{standardGroupFlow}
		  	</if>
 		  	and to_char(to_date(rr.oper_time,'yyyymmddhh24miss'),'yyyy-mm-dd') <![CDATA[<=]]> sar.sch_end_date
		  	and to_char(to_date(rr.oper_time,'yyyymmddhh24miss'),'yyyy-mm-dd') <![CDATA[>=]]> sar.sch_start_date
 		)
	</select>
	
	<resultMap type="HashMap" id="gradeContentMap">
		<result property="key" column="KEY" javaType="string"/>
		<result property="operUserName" column="OPER_USER_NAME" javaType="string"/>
		<result property="operUserFlow" column="OPER_USER_FLOW" javaType="string"/>
		<result property="content" column="CONTENT" javaType="string"/>
		<result property="recFlow" column="REC_FLOW" javaType="string"/>
		<result property="sessionNumber" column="SESSION_NUMBER" javaType="string"/>
	</resultMap>
	<select id="getRecContentByProcess"  parameterType="java.util.Map" resultMap="gradeContentMap">
		select 
			<if test='recTypeId!=null and recTypeId=="TeacherGrade"'>
				rdsp.teacher_user_flow KEY,
			</if>
			<if test='recTypeId!=null and recTypeId=="DeptGrade"'>
				rdsp.dept_flow KEY,
			</if>
			rr.oper_user_name OPER_USER_NAME,
			rr.oper_user_flow OPER_USER_FLOW,
			rr.rec_content CONTENT,
			rr.rec_flow REC_FLOW,
			rd.SESSION_NUMBER
		from pdsci.res_rec rr
		inner join pdsci.res_doctor_sch_process rdsp
		on rdsp.record_status = 'Y'
		and rdsp.process_flow = rr.process_flow
		left join res_doctor rd
		on rd.doctor_flow=rr.oper_user_flow
		where rr.record_status = 'Y'
		and rd.record_status='Y'
		<if test="sessionNumber!=null and sessionNumber!=''">
			and rd.SESSION_NUMBER=#{sessionNumber}
		</if>
		and rr.rec_type_id = #{recTypeId}
		<if test='deptFlow!=null and deptFlow!=""'>
			and rdsp.dept_flow = #{deptFlow}
		</if>
		<if test='deptName!=null and deptName!=""'>
			and rdsp.dept_Name like CONCAT(CONCAT('%', #{deptName}),'%')
		</if>
		<if test='teacherFlow!=null and teacherFlow!=""'>
			and rdsp.teacher_user_flow = #{teacherFlow}
		</if>
		<if test='operStartDate!=null and operStartDate!=""'>
			and rr.oper_time >= #{operStartDate}
		</if>
		<if test='operEndDate!=null and operEndDate!=""'>
			and rr.oper_time <![CDATA[<=]]> #{operEndDate}
		</if>
		
		<if test='teacherFlows!=null and teacherFlows.size()>0'>
			and rdsp.teacher_user_flow in 
			<foreach collection="teacherFlows" close=")" item="tf" open="(" separator=",">
				#{tf}
			</foreach>
		</if>
		<if test='deptFlows!=null and deptFlows.size()>0'>
			and rdsp.dept_flow in 
			<foreach collection="deptFlows" close=")" item="df" open="(" separator=",">
				#{df}
			</foreach>
		</if>
		order by rr.oper_time
	</select>
	<select id="getRecContentByProcessForUni"  parameterType="java.util.Map" resultMap="gradeContentMap">
		select
			<if test='recTypeId!=null and recTypeId=="TeacherGrade"'>
				rdsp.teacher_user_flow KEY,
			</if>
			<if test='recTypeId!=null and recTypeId=="DeptGrade"'>
				rdsp.dept_flow KEY,
			</if>
			rr.oper_user_name OPER_USER_NAME,
			rr.oper_user_flow OPER_USER_FLOW,
			rr.rec_content CONTENT,
			rr.rec_flow REC_FLOW,
			rd.SESSION_NUMBER
		from pdsci.DEPT_TEACHER_GRADE_INFO rr
		inner join pdsci.res_doctor_sch_process rdsp
		on rdsp.record_status = 'Y'
		and rdsp.process_flow = rr.process_flow
		left join res_doctor rd
		on rd.doctor_flow=rr.oper_user_flow
		where rr.record_status = 'Y'
		and rd.record_status='Y'
		AND RD.DOCTOR_TYPE_ID = 'Graduate'
		<if test="sessionNumber!=null and sessionNumber!=''">
			and rd.SESSION_NUMBER=#{sessionNumber}
		</if>
		AND (
		<trim prefix="" prefixOverrides="OR">
			<if test="(org.sendSchoolId != null and org.sendSchoolId != '')">OR rd.work_org_id = #{org.sendSchoolId}</if>
			<if test="(org.sendSchoolName != null and org.sendSchoolName != '')">OR rd.work_org_name = #{org.sendSchoolName}</if>
		</trim>
		)
		and rr.rec_type_id = #{recTypeId}
		<if test='deptFlow!=null and deptFlow!=""'>
			and rdsp.dept_flow = #{deptFlow}
		</if>
		<if test='deptName!=null and deptName!=""'>
			and rdsp.dept_Name like CONCAT(CONCAT('%', #{deptName}),'%')
		</if>
		<if test='teacherFlow!=null and teacherFlow!=""'>
			and rdsp.teacher_user_flow = #{teacherFlow}
		</if>
		<if test='operStartDate!=null and operStartDate!=""'>
			and rr.oper_time >= #{operStartDate}
		</if>
		<if test='operEndDate!=null and operEndDate!=""'>
			and rr.oper_time <![CDATA[<=]]> #{operEndDate}
		</if>

		<if test='teacherFlows!=null and teacherFlows.size()>0'>
			and rdsp.teacher_user_flow in
			<foreach collection="teacherFlows" close=")" item="tf" open="(" separator=",">
				#{tf}
			</foreach>
		</if>
		<if test='deptFlows!=null and deptFlows.size()>0'>
			and rdsp.dept_flow in
			<foreach collection="deptFlows" close=")" item="df" open="(" separator=",">
				#{df}
			</foreach>
		</if>
		order by rr.oper_time
	</select>

	<update id="modifyResRegStatus" parameterType="java.util.Map">
		update PDSCI.RES_REG SET STATUS_ID = #{statusId},STATUS_NAME = #{statusName}
		WHERE REG_YEAR = #{regNumber}
		 and exists(select null from res_doctor where RES_DOCTOR.RECORD_STATUS = 'Y' AND RES_DOCTOR.DOCTOR_STATUS_ID=#{oldStatusId} and RES_REG.user_flow = res_doctor.doctor_flow)
	</update>
	<update id="orgBatchAuditDoctorInfo" parameterType="java.util.Map">
		UPDATE RES_REC
		SET AUDIT_TIME =to_char(sysdate, 'YYYYMMDDHH24MISS'),
			AUDIT_USER_FLOW= '${sysuser.userFlow}',
			AUDIT_USER_NAME= '${sysuser.userName}(一键审核)',
			AUDIT_STATUS_ID='TeacherAuditY',
			AUDIT_STATUS_NAME='带教老师审核通过',
			MODIFY_TIME=to_char(sysdate, 'YYYYMMDDHH24MISS'),
			MODIFY_USER_FLOW ='${sysuser.userFlow}'
		 WHERE RECORD_STATUS = 'Y'
		   AND AUDIT_STATUS_ID IS NULL
		   AND ORG_FLOW = #{orgFlow}
		   AND REC_TYPE_ID IN ('CaseRegistry',
							   'DiseaseRegistry',
							   'SkillRegistry',
							   'OperationRegistry',
							   'CampaignRegistry')
		   AND EXISTS
		 (SELECT 1
				  FROM PDSCI.RES_DOCTOR_RECRUIT DR
				  LEFT JOIN SCH_ROTATION_DEPT T
					ON DR.ROTATION_FLOW = T.ROTATION_FLOW
				   AND T.ORG_FLOW IS NULL
				 WHERE DR.RECORD_STATUS = 'Y'
				   AND DR.AUDIT_STATUS_ID = 'Passed'
				   AND DR.ORG_FLOW = #{orgFlow}
				   AND DR.GRADUATION_YEAR = #{graduationYear}
				   AND T.RECORD_STATUS = 'Y'
				   AND T.RECORD_FLOW IS NOT NULL
				   AND T.RECORD_FLOW = RES_REC.SCH_ROTATION_DEPT_FLOW)
	</update>
	<select id="getJoinActivityNumByDeptFlow" resultType="integer">
		SELECT COUNT(1)
		  FROM TEACHING_ACTIVITY_RESULT R
		  LEFT JOIN TEACHING_ACTIVITY_INFO INFO
			ON R.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
		  LEFT JOIN SCH_ARRANGE_RESULT SAR
			ON R.USER_FLOW = SAR.DOCTOR_FLOW
		  LEFT JOIN SCH_ROTATION_DEPT SRD
			ON SAR.STANDARD_GROUP_FLOW = SRD.GROUP_FLOW
		   AND SAR.STANDARD_DEPT_ID = SRD.STANDARD_DEPT_ID
		 WHERE R.RECORD_STATUS = 'Y'
		   AND SRD.RECORD_STATUS = 'Y'
		   AND INFO.RECORD_STATUS = 'Y'
		   AND SAR.RECORD_STATUS = 'Y'
		   AND INFO.IS_EFFECTIVE = 'Y'
		   AND R.IS_EFFECTIVE = 'Y'
		   AND SRD.RECORD_FLOW = #{deptFlow}
		   AND R.USER_FLOW = #{userFlow}
		   AND ((SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.start_time, 0, 10) AND
			   SAR.SCH_END_DATE >= substr(info.end_time, 0, 10)) or
			   (SAR.SCH_START_DATE >= substr(info.start_time, 0, 10) AND
			   SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)) or
			   (SAR.SCH_END_DATE >= substr(info.start_time, 0, 10) AND
			   SAR.SCH_END_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)))
	</select>
	<select id="searchByRecWithBLOBsByMap4Hb" resultMap="com.pinde.sci.dao.base.ResRecMapper.ResultMapWithBLOBs" parameterType="map">
		select * from res_rec
			   where record_status='Y'
			   <if test="recTypeId != null and recTypeId != ''">
				   and rec_type_id=#{recTypeId}
			   </if>
			   <if test="doctorFlow != null and doctorFlow != ''">
				   and oper_user_flow=#{doctorFlow}
			   </if>
			   and exists (
				   select 1 from res_doctor_sch_process p
				   where p.record_status='Y'
				   <if test="doctorFlow != null and doctorFlow != ''">
					   and p.user_flow=#{doctorFlow}
				   </if>
				   and p.sch_result_flow in (
					   select result_flow from sch_arrange_result
					   where record_status='Y'
					   <if test="doctorFlow != null and doctorFlow != ''">
						   and doctor_flow=#{doctorFlow}
					   </if>
					   <if test="rotationFlow != null and rotationFlow != ''">
						   and rotation_flow=#{rotationFlow}
					   </if>
				   )
			  )
	</select>

	<!--/****************************高******校******管******理******员******角******色************************************************/-->

	<resultMap type="HashMap" id="uniBarkingMap">
		<result column="ORG_FLOW" property="orgFlow" javaType="string"/>
		<result column="ORG_NAME" property="orgName" javaType="string"/>
		<result column="REASON_NAME" property="reasonName" javaType="string"/>
		<result column="REASON_ID" property="reasonId" javaType="string"/>
		<result column="POLICY_NAME" property="policyName" javaType="string"/>
		<result column="POLICY_ID" property="policyId" javaType="string"/>
		<result column="REASON" property="reason" javaType="string"/>
		<result column="POLICY" property="policy" javaType="string"/>
		<result column="DISPOSITON" property="dispositon" javaType="string"/>
		<result column="REMARK" property="remark" javaType="string"/>
		<result column="SESSION_NUMBER" property="sessionNumber" javaType="string"/>
		<result column="TRAIN_SPE" property="trainSpe" javaType="string"/>
		<result column="WORK_ORG_ID" property="workOrgId" javaType="string"/>
		<result column="WORK_ORG_NAME" property="workOrgName" javaType="string"/>
		<result column="DOCTOR_TYPE_ID" property="doctorTypeId" javaType="string"/>
		<result column="DOCTOR_TYPE_NAME" property="doctorTypeName" javaType="string"/>
		<result column="TRAINING_TYPE_ID" property="trainingTypeId" javaType="string"/>
		<result column="TRAINING_TYPE_NAME" property="trainingTypeName" javaType="string"/>
		<result column="CREATE_TIME" property="createTime" javaType="string"/>
		<result column="OPER_USER_NAME" property="operUserName" javaType="string"/>
		<result column="OPER_USER_FLOW" property="operUserFlow"  javaType="string"/>
	</resultMap>
	<select id="searchInfoForUni" resultMap="uniBarkingMap" parameterType="map">

		select *
		from (
			select
			rr.ORG_FLOW,
			rr.ORG_NAME,
			rr.OPER_USER_NAME,
			rr.OPER_USER_FLOW,
			xmltype(rec_content).extract('//reasonName/text()').getstringval()      REASON_NAME,
			substr(xmltype(rec_content).extract('//reasonName').getstringval(),17,1)      REASON_ID,
			xmltype(rec_content).extract('//policyName/text()').getstringval()      POLICY_NAME,
			substr(xmltype(rec_content).extract('//policyName').getstringval(),17,1)      POLICY_ID,
			xmltype(rec_content).extract('//reason/text()').getstringval()      REASON,
			xmltype(rec_content).extract('//policy/text()').getstringval()      POLICY,
			xmltype(rec_content).extract('//dispositon/text()').getstringval()      DISPOSITON,
			xmltype(rec_content).extract('//remark/text()').getstringval()      REMARK,
			xmltype(rec_content).extract('//sessionNumber/text()').getstringval()      SESSION_NUMBER,
			xmltype(rec_content).extract('//trainSpe/text()').getstringval()      TRAIN_SPE,
			d.WORK_ORG_ID,
			d.WORK_ORG_NAME,
		 	D.DOCTOR_TYPE_ID,
			D.DOCTOR_TYPE_NAME,
			D.TRAINING_TYPE_ID,
			D.TRAINING_TYPE_NAME,
			rr.CREATE_TIME
			from res_rec rr
				left join RES_DOCTOR d on rr.OPER_USER_FLOW = d.DOCTOR_FLOW
			where  rr.record_status='Y'
			AND d.RECORD_STATUS = 'Y'
			and rr.rec_type_id = 'ReturnTraining'
			<if test="resRec!=null">
				<if test="resRec.orgFlow!=null and resRec.orgFlow!=''">
					and rr.ORG_FLOW = #{resRec.orgFlow}
				</if>
				<if test="resRec.operUserName!=null and resRec.operUserName!=''">
					and rr.OPER_USER_NAME like CONCAT(CONCAT('%', #{resRec.operUserName}),'%')
				</if>
			</if>
			) a
		where 1=1
		<if test="resDoctor!=null">
			and (
			<trim prefix="" prefixOverrides="OR">
				<if test="resDoctor.workOrgId != null and resDoctor.workOrgId != ''">OR A.work_org_id = #{resDoctor.workOrgId}</if>
				<if test="resDoctor.workOrgName != null and resDoctor.workOrgName != ''">OR A.work_org_name = #{resDoctor.workOrgName}</if>
			</trim>
			)
			and a.DOCTOR_TYPE_ID = 'Graduate'
			<if test="resDoctor.trainingSpeName!=null and resDoctor.trainingSpeName!=''">
				and A.TRAIN_SPE like  CONCAT(CONCAT('%', #{resDoctor.trainingSpeName}),'%')
			</if>
			<if test="resDoctor.trainingTypeId!=null and resDoctor.trainingTypeId!=''">
				and A.TRAINING_TYPE_ID = #{resDoctor.trainingTypeId}
			</if>
			<if test="resDoctor.sessionNumber!=null and resDoctor.sessionNumber!=''">
				and A.SESSION_NUMBER = #{resDoctor.sessionNumber}
			</if>
			<if test="resDoctor.regNo!=null and resDoctor.regNo!=''">
				and A.REASON_ID = #{resDoctor.regNo}
			</if>
			<if test="resDoctor.emergencyPhone!=null and resDoctor.emergencyPhone!=''">
				and A.POLICY_ID = #{resDoctor.emergencyPhone}
			</if>
		</if>
		order by A.create_time desc
	</select>
	<resultMap type="HashMap" id="searchInfo2Map">
		<result column="REC_FLOW" property="recFlow" javaType="string"/>
		<result column="ORG_FLOW" property="orgFlow" javaType="string"/>
		<result column="ORG_NAME" property="orgName" javaType="string"/>
		<result column="REASON_NAME" property="reasonName" javaType="string"/>
		<result column="REASON_ID" property="reasonId" javaType="string"/>
		<result column="POLICY_NAME" property="policyName" javaType="string"/>
		<result column="POLICY_ID" property="policyId" javaType="string"/>
		<result column="REASON" property="reason" javaType="string"/>
		<result column="POLICY" property="policy" javaType="string"/>
		<result column="DISPOSITON" property="dispositon" javaType="string"/>
		<result column="REMARK" property="remark" javaType="string"/>
		<result column="SESSION_NUMBER" property="sessionNumber" javaType="string"/>
		<result column="TRAIN_SPE" property="trainSpe" javaType="string"/>
		<result column="AUDIT_STATUS_NAME" property="auditStatusName" javaType="string"/>
		<result column="AUDIT_STATUS_ID" property="auditStatusId" javaType="string"/>
		<result column="AUDIT_OPINION" property="auditOpinion" javaType="string"/>
		<result column="WORK_ORG_ID" property="workOrgId" javaType="string"/>
		<result column="WORK_ORG_NAME" property="workOrgName" javaType="string"/>
		<result column="DOCTOR_TYPE_ID" property="doctorTypeId" javaType="string"/>
		<result column="DOCTOR_TYPE_NAME" property="doctorTypeName" javaType="string"/>
		<result column="TRAINING_TYPE_ID" property="trainingTypeId" javaType="string"/>
		<result column="TRAINING_TYPE_NAME" property="trainingTypeName" javaType="string"/>
		<result column="CREATE_TIME" property="createTime" javaType="string"/>
		<result column="MODIFY_TIME" property="modifyTime" javaType="string"/>
		<result column="OPER_USER_NAME" property="operUserName" javaType="string"/>
		<result column="OPER_USER_FLOW" property="operUserFlow"  javaType="string"/>
	</resultMap>
	<select id="searchInfo2" resultMap="searchInfo2Map" parameterType="map">

		select *
		from (
			select
			rr.REC_FLOW REC_FLOW,
			rr.ORG_FLOW,
			rr.ORG_NAME,
			rr.OPER_USER_NAME,
			rr.OPER_USER_FLOW,
			xmltype(rec_content).extract('//reasonName/text()').getstringval()      REASON_NAME,
			substr(xmltype(rec_content).extract('//reasonName').getstringval(),17,1)      REASON_ID,
			xmltype(rec_content).extract('//policyName/text()').getstringval()      POLICY_NAME,
			substr(xmltype(rec_content).extract('//policyName').getstringval(),17,1)      POLICY_ID,
			xmltype(rec_content).extract('//reason/text()').getstringval()      REASON,
			xmltype(rec_content).extract('//policy/text()').getstringval()      POLICY,
			xmltype(rec_content).extract('//dispositon/text()').getstringval()      DISPOSITON,
			xmltype(rec_content).extract('//remark/text()').getstringval()      REMARK,
			xmltype(rec_content).extract('//sessionNumber/text()').getstringval()      SESSION_NUMBER,
			xmltype(rec_content).extract('//trainSpe/text()').getstringval()      TRAIN_SPE,
			xmltype(rec_content).extract('//auditStatusName/text()').getstringval()      AUDIT_STATUS_NAME,
			substr(xmltype(rec_content).extract('//auditStatusName').getstringval(),22,1)      AUDIT_STATUS_ID,
			xmltype(rec_content).extract('//auditOpinion/text()').getstringval()      AUDIT_OPINION,
			rr.CREATE_TIME,
			rr.MODIFY_TIME
			from res_rec rr
			where  rr.record_status='Y'
			and rr.rec_type_id = 'ReturnTraining'
			<if test="resRec!=null">
				<if test="resRec.orgFlow!=null and resRec.orgFlow!=''">
					and rr.ORG_FLOW = #{resRec.orgFlow}
				</if>
				<if test="resRec.operUserName!=null and resRec.operUserName!=''">
					and rr.OPER_USER_NAME like CONCAT(CONCAT('%', #{resRec.operUserName}),'%')
				</if>
			</if>
			) a
		where 1=1
		<if test="orgFlowList !=null and orgFlowList.size>0">
			and a.org_flow in
			<foreach collection="orgFlowList" close=")" item="orgFlow" open="(" separator=",">
				#{orgFlow}
			</foreach>
		</if>
		<if test="userFlowList !=null and userFlowList.size>0">
			and a.OPER_USER_FLOW in
			<foreach collection="userFlowList" close=")" item="userFlow" open="(" separator=",">
				#{userFlow}
			</foreach>
		</if>
		<if test="resDoctor!=null">
			<if test="resDoctor.trainingSpeName!=null and resDoctor.trainingSpeName!=''">
				and A.TRAIN_SPE like  CONCAT(CONCAT('%', #{resDoctor.trainingSpeName}),'%')
			</if>
			<if test="resDoctor.trainingTypeId!=null and resDoctor.trainingTypeId!=''">
				and A.TRAINING_TYPE_ID = #{resDoctor.trainingTypeId}
			</if>
			<if test="resDoctor.sessionNumber!=null and resDoctor.sessionNumber!=''">
				and A.SESSION_NUMBER = #{resDoctor.sessionNumber}
			</if>
			<if test="resDoctor.regNo!=null and resDoctor.regNo!=''">
				and A.REASON_ID = #{resDoctor.regNo}
			</if>
			<if test="resDoctor.emergencyPhone!=null and resDoctor.emergencyPhone!=''">
				and A.POLICY_ID = #{resDoctor.emergencyPhone}
			</if>
			<if test="resDoctor.emergencyName!=null and resDoctor.emergencyName!=''">
				and A.AUDIT_STATUS_ID = #{resDoctor.emergencyName}
			</if>
			<if test="resDoctor.groupId!=null and resDoctor.groupId!=''">
				and A.AUDIT_STATUS_ID not in ('2')
			</if>
		</if>
		order by A.create_time desc
	</select>

	<resultMap type="HashMap" id="JoinActivityMap">
		<result column="SPEAKER_FLOW" javaType="string" property="speakerFlow" />
		<result column="SPEAKER_NAME" javaType="string" property="speakerName" />
		<result column="SPEAKER_PHONE" javaType="string" property="speakerPhone" />
		<result column="ACTIVITY_NAME" javaType="string" property="activityName" />
		<result column="ACTIVITY_TYPE_ID" javaType="string" property="activityTypeId" />
		<result column="ACTIVITY_TYPE_NAME" javaType="string" property="activityTypeName" />
		<result column="START_TIME" javaType="string" property="startTime" />
		<result column="END_TIME" javaType="string" property="endTime" />
		<result column="ACTIVITY_ADDRESS" javaType="string" property="activityAddress" />
		<result column="ACTIVITY_REMARK" javaType="string" property="activityRemark" />
		<result column="REC_CONTENT" javaType="string" property="recContent" />
		<result column="REC_FLOW" javaType="string" property="recFlow" />
		<result column="REC_TYPE_ID" javaType="string" property="recTypeId" />
		<result column="RESULT_FLOW" javaType="string" property="resultFlow" />
	</resultMap>
	<select id="queryJoinActivityAndEditList" resultMap="JoinActivityMap" parameterType="map">
		SELECT * FROM (
		SELECT INFO.ACTIVITY_FLOW REC_FLOW,
			   INFO.ACTIVITY_NAME,
			   INFO.SPEAKER_FLOW,
			   SU.USER_NAME SPEAKER_NAME,
			   INFO.ACTIVITY_TYPE_ID,
			   INFO.ACTIVITY_TYPE_NAME,
			   substr(info.start_time, 0, 10) START_TIME,
			   INFO.END_TIME,
			   INFO.ACTIVITY_ADDRESS,
			   INFO.ACTIVITY_REMARK,
			   NULL REC_CONTENT,
			   '' REC_TYPE_ID,
			   '1' ORNIAL,
			   INFO.CREATE_TIME
		  FROM TEACHING_ACTIVITY_RESULT R
		  LEFT JOIN TEACHING_ACTIVITY_INFO INFO
			ON R.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
		  LEFT JOIN SCH_ARRANGE_RESULT SAR
			ON R.USER_FLOW = SAR.DOCTOR_FLOW
		  LEFT JOIN SCH_ROTATION_DEPT SRD
			ON SAR.STANDARD_GROUP_FLOW = SRD.GROUP_FLOW
		   AND SAR.STANDARD_DEPT_ID = SRD.STANDARD_DEPT_ID
		  LEFT JOIN SYS_USER SU ON SU.USER_FLOW =INFO.SPEAKER_FLOW
		 WHERE R.RECORD_STATUS = 'Y'
		   AND SRD.RECORD_STATUS = 'Y'
		   AND INFO.RECORD_STATUS = 'Y'
		   AND SAR.RECORD_STATUS = 'Y'
		   AND INFO.IS_EFFECTIVE = 'Y'
		   AND R.IS_EFFECTIVE = 'Y'
		   AND SRD.RECORD_FLOW = #{deptFlow}
		   AND R.USER_FLOW = #{userFlow}
		   AND ((SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.start_time, 0, 10) AND
			   SAR.SCH_END_DATE >= substr(info.end_time, 0, 10)) or
			   (SAR.SCH_START_DATE >= substr(info.start_time, 0, 10) AND
			   SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)) or
			   (SAR.SCH_END_DATE >= substr(info.start_time, 0, 10) AND
			   SAR.SCH_END_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)))
		union all
		select REC_FLOW,
			   '' ACTIVITY_NAME,
			   '' SPEAKER_FLOW,
			   to_nchar('') SPEAKER_NAME,
			   '' ACTIVITY_TYPE_ID,
			   '' ACTIVITY_TYPE_NAME,
			   '' START_TIME,
			   '' END_TIME,
			   '' ACTIVITY_ADDRESS,
			   '' ACTIVITY_REMARK,
			   REC_CONTENT,
			   REC_TYPE_ID,
			   '2' ORNIAL,
			   CREATE_TIME
		  from res_rec
		 where record_status = 'Y'
		   and rec_type_id =#{recTypeId}
		   and oper_user_flow = #{userFlow}
		   and Sch_Rotation_Dept_Flow =#{deptFlow}
		) ORDER BY ORNIAL,CREATE_TIME,REC_FLOW
	</select>
	<select id="getJoinActivity" resultMap="JoinActivityMap" >
		select * from (
		SELECT INFO.ACTIVITY_FLOW REC_FLOW,
			   INFO.ACTIVITY_NAME,
			   INFO.SPEAKER_FLOW,
			   SU.USER_NAME SPEAKER_NAME,
			   INFO.ACTIVITY_TYPE_ID,
			   INFO.ACTIVITY_TYPE_NAME,
			   substr(info.start_time, 0, 10) START_TIME,
			   INFO.END_TIME,
			   INFO.ACTIVITY_ADDRESS,
			   INFO.ACTIVITY_REMARK,
			   NULL REC_CONTENT,
			   '' REC_TYPE_ID,
			   '1' ORNIAL,
			   INFO.CREATE_TIME,
				SAR.RESULT_FLOW,
				ROW_NUMBER() OVER (order by SAR.SCH_START_DATE)AS RN
		  FROM  TEACHING_ACTIVITY_INFO INFO
		  LEFT JOIN SYS_USER SU ON SU.USER_FLOW =INFO.SPEAKER_FLOW
		  LEFT JOIN SCH_ARRANGE_RESULT SAR
			ON   ((SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.start_time, 0, 10) AND
			SAR.SCH_END_DATE >= substr(info.end_time, 0, 10)) or
			(SAR.SCH_START_DATE >= substr(info.start_time, 0, 10) AND
			SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)) or
			(SAR.SCH_END_DATE >= substr(info.start_time, 0, 10) AND
			SAR.SCH_END_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)))
			AND SAR.RECORD_STATUS='Y'
		 	AND SAR.DOCTOR_FLOW =#{userFlow}
		 	AND exists (
			select 1
			from SCH_ROTATION_DEPT SRD
			where SRD.record_status='Y'
			and srd.record_flow=#{deptFlow}
			and sar.STANDARD_GROUP_FLOW = srd.group_flow
			and sar.standard_dept_id = srd.standard_dept_id
			)
		 WHERE INFO.RECORD_STATUS = 'Y'
		 AND INFO.ACTIVITY_FLOW=#{dataFlow}
		 ) where rn=1
	</select>
	<select id="searchDelayInfoForUni" resultMap="com.pinde.sci.dao.base.ResRecMapper.ResultMapWithBLOBs" parameterType="map">
		select r.*
		from PDSCI.RES_REC r
		left join RES_DOCTOR d on r.OPER_USER_FLOW = d.DOCTOR_FLOW
		WHERE r.RECORD_STATUS = 'Y'
		AND d.RECORD_STATUS = 'Y'
		<if test="resRec!=null">
			<if test="resRec.recTypeId!=null and resRec.recTypeId!=''">
				and r.REC_TYPE_ID = #{resRec.recTypeId}
			</if>
			<if test="resRec.orgFlow!=null and resRec.orgFlow!=''">
				and r.ORG_FLOW = #{resRec.orgFlow}
			</if>
			<if test="resRec.operUserName!=null and resRec.operUserName!=''">
				and r.OPER_USER_NAME like CONCAT(CONCAT('%', #{resRec.operUserName}),'%')
			</if>
		</if>
		<if test="resDoctor!=null">
			and (
			<trim prefix="" prefixOverrides="OR">
				<if test="resDoctor.workOrgId != null and resDoctor.workOrgId != ''">OR d.work_org_id = #{resDoctor.workOrgId}</if>
				<if test="resDoctor.workOrgName != null and resDoctor.workOrgName != ''">OR d.work_org_name = #{resDoctor.workOrgName}</if>
			</trim>
			)
			<if test="resDoctor.doctorTypeId!=null and resDoctor.doctorTypeId!=''">
				and d.DOCTOR_TYPE_ID = #{resDoctor.doctorTypeId}
			</if>
			<if test="resDoctor.trainingSpeId!=null and resDoctor.trainingSpeId!=''">
				and d.TRAINING_SPE_ID = #{resDoctor.trainingSpeId}
			</if>
			<if test="resDoctor.trainingTypeId!=null and resDoctor.trainingTypeId!=''">
				and d.TRAINING_TYPE_ID = #{resDoctor.trainingTypeId}
			</if>
		</if>
		order by r.create_time desc
	</select>
</mapper>