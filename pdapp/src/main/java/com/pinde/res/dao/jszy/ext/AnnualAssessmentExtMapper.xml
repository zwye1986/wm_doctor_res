<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pinde.res.dao.jszy.ext.AnnualAssessmentExtMapper">
    <resultMap id="BaseResultMap" type="com.pinde.res.model.jszy.mo.AnnualAssessmentExt"
               extends="com.pinde.sci.dao.base.ResAnnualAssessmentMapper.ResultMapWithBLOBs">
        <result column="DISCIPLE_START_DATE" property="discipleStartDate" jdbcType="VARCHAR"/>
        <result column="DISCIPLE_END_DATE" property="discipleEndDate" jdbcType="VARCHAR"/>
        <result column="DAY_SELECT_COUNT" property="daySelectCount" jdbcType="VARCHAR"/>
        <result column="NOTE_SELECT_COUNT" property="noteSelectCount" jdbcType="VARCHAR"/>
        <result column="EXPERIENCE_SELECT_COUNT" property="experienceSelectCount" jdbcType="VARCHAR"/>
        <result column="BOOK_STUDY_COUNT" property="bookStudyCount" jdbcType="VARCHAR"/>
        <result column="BOOKEXP_SELECT_COUNT" property="bookexpSelectCount" jdbcType="VARCHAR"/>
        <result column="CASES_COUNT" property="casesCount" jdbcType="VARCHAR"/>
        <result column="DISCIPLE_TEACHER_FLOW" property="discipleTeacherFlow" jdbcType="VARCHAR"/>
        <result column="DISCIPLE_TEACHER_NAME" property="discipleTeacherName" jdbcType="VARCHAR"/>
    </resultMap>
    <select id="initAnnualAssessmentExt" parameterType="com.pinde.sci.model.mo.ResAnnualAssessment"
            resultMap="BaseResultMap">
        select
        rd.DOCTOR_FLOW,
        rd.DOCTOR_NAME,
        rd.disciple_teacher_flow,
        rd.disciple_TEACHER_NAME,
        <if test="recordFlow == null">
          #{recordYear}   RECORD_YEAR,
        </if>
        <if test="recordFlow != null">
            raa.RECORD_YEAR,
            raa.RECORD_FLOW,
            raa.TEACHER_FLOW,
            raa.TEACHER_NAME,
            raa.STUDY_START_DATE,
            raa.STUDY_END_DATE,
            raa.DAY_COUNT,
            raa.NOTE_COUNT,
            raa.EXPERIENCE_COUNT,
            raa.TCM_COUNT,
            raa.XXTH_COUNT,
            raa.TYPICAL_CASES_COUNT,
            raa.ASSESSMENT_IMG_URL,
            raa.COMPLELE_CONTENT,
            raa.COMPLELE_SIGN_TIME,
            raa.EXPERIENCE_CONTENT,
            raa.EXPERIENCE_SIGN_TIME,
            raa.AUDIT_CONTENT,
            raa.AUDIT_TIME,
            raa.AUDIT_USER_FLOW,
            raa.AUDIT_USER_NAME,
            raa.AUDIT_STATUS_ID,
            raa.AUDIT_STATUS_NAME,
            raa.ADMIN_CONTENT,
            raa.ADMIN_TIME,
            raa.ADMIN_USER_FLOW,
            raa.ADMIN_USER_NAME,
            raa.ADMIN_STATUS_ID,
            raa.ADMIN_STATUS_NAME,
            raa.RECORD_STATUS,
            raa.CREATE_TIME,
            raa.CREATE_USER_FLOW,
            raa.MODIFY_TIME,
            raa.MODIFY_USER_FLOW,
        </if>
        <if test="studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!=''">
            #{studyStartDate} AS DISCIPLE_START_DATE,
            #{studyEndDate} AS DISCIPLE_END_DATE,
            to_date(#{studyEndDate}, 'yyyy-MM-dd') -
            to_date(#{studyStartDate}, 'yyyy-MM-dd')+1 day_select_count,
        </if>
        <if test="!(studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!='')">
            raa.STUDY_START_DATE DISCIPLE_START_DATE,
            raa.STUDY_END_DATE DISCIPLE_END_DATE,
            to_date(raa.STUDY_END_DATE, 'yyyy-mm-dd') -
            to_date(raa.STUDY_START_DATE, 'yyyy-mm-dd')+1 day_select_count,
        </if>
        ( select count(1) from RES_DISCIPLE_NOTE_INFO where record_status='Y' and NOTE_TYPE_ID='Note' and
        AUDIT_STATUS_ID='Qualified'
        and doctor_flow=rd.doctor_flow
        <if test="studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!=''">
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') >= #{studyStartDate}
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') <![CDATA[<=]]> #{studyEndDate}
        </if>
        <if test="!(studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!='')">
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') >= raa.STUDY_START_DATE
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') <![CDATA[<=]]> raa.STUDY_END_DATE
        </if>
        ) note_select_count,
        (select count(1) from RES_DISCIPLE_NOTE_INFO where record_status='Y' and NOTE_TYPE_ID='Experience' and
        AUDIT_STATUS_ID='Qualified'
        and doctor_flow=rd.doctor_flow
        <if test="studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!=''">
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') >= #{studyStartDate}
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') <![CDATA[<=]]> #{studyEndDate}
        </if>
        <if test="!(studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!='')">
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') >= raa.STUDY_START_DATE
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') <![CDATA[<=]]> raa.STUDY_END_DATE
        </if>
        ) experience_select_count,

        (select count(1) from RES_BOOK_STUDY_RECORD where record_status='Y'
        and doctor_flow=rd.doctor_flow
        <if test="studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!=''">
            and STUDY_START_TIME >= #{studyStartDate}
            and STUDY_START_TIME <![CDATA[<=]]> #{studyEndDate}
        </if>
        <if test="!(studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!='')">
            and STUDY_START_TIME >= raa.STUDY_START_DATE
            and STUDY_START_TIME <![CDATA[<=]]> raa.STUDY_END_DATE
        </if>) book_study_count,

        ( select count(1) from RES_DISCIPLE_NOTE_INFO where record_status='Y' and NOTE_TYPE_ID='BookExperience' and
        AUDIT_STATUS_ID='Qualified'
        and doctor_flow=rd.doctor_flow
        <if test="studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!=''">
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') >= #{studyStartDate}
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') <![CDATA[<=]]> #{studyEndDate}
        </if>
        <if test="!(studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!='')">
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') >= raa.STUDY_START_DATE
            and to_char(to_date(STUDY_START_DATE,'yyyy"年"mm"月"dd"日"'),'yyyy-mm-dd') <![CDATA[<=]]>raa.STUDY_END_DATE
        </if>
        )bookExp_select_count,

        (select count(1) from RES_TYPICAL_CASES where record_status='Y' and AUDIT_STATUS_ID='Qualified'
        and doctor_flow=rd.doctor_flow
        <if test="studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!=''">
            and VISIT_DATE >= #{studyStartDate}
            and VISIT_DATE <![CDATA[<=]]> #{studyEndDate}
        </if>
        <if test="!(studyStartDate != null and studyStartDate!='' and studyEndDate != null and studyEndDate!='')">
            and VISIT_DATE >= raa.STUDY_START_DATE
            and VISIT_DATE <![CDATA[<=]]> raa.STUDY_END_DATE
        </if>) cases_count
        from res_doctor rd
        left join res_disciple_info rdi on rdi.doctor_flow = rd.doctor_flow and rdi.record_status = 'Y'
        <if test="recordFlow != null">
            left join RES_ANNUAL_ASSESSMENT raa on raa.RECORD_FLOW = #{recordFlow}
        </if>
        where
        rd.record_status = 'Y'
        and rd.doctor_flow=#{doctorFlow}
    </select>
    <select id="checkAnnualDate" resultType="java.lang.Integer">
        select nvl(count(1),0)
        from pdsci.res_annual_assessment
        where record_status = 'Y'
        and doctor_flow = #{doctorFlow}
        and (
        (
        STUDY_START_DATE <![CDATA[<=]]> #{startDate}
        and  STUDY_END_DATE >= #{startDate}
        )
        or
        (
        STUDY_START_DATE <![CDATA[<=]]> #{endDate}
        and  STUDY_END_DATE >= #{endDate}
        )
        or
        (
        STUDY_START_DATE <![CDATA[>=]]> #{startDate}
        and  STUDY_END_DATE <![CDATA[<=]]> #{endDate}
        )
        )
    </select>

</mapper>