<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pinde.res.dao.jswjw.ext.ResDoctorSchProcessExtMapper">
    <resultMap type="HashMap" id="processCountMap">
        <result property="key" column="USER_FLOW" javaType="string"/>
        <result property="value" column="PROCESS_COUNT" javaType="java.math.BigDecimal"/>
    </resultMap>
    <resultMap type="HashMap" id="processResRecShMap">
        <result property="processFlow" column="PROCESS_FLOW" javaType="string"/>
        <result property="userFlow" column="USER_FLOW" javaType="string"/>
        <result property="userName" column="USER_NAME" javaType="string"/>
        <result property="content" column="REC_CONTENT" javaType="string"/>
    </resultMap>
    <select id="processRecShMap" resultMap="processResRecShMap">
        select rdsp.PROCESS_FLOW, rdsp.USER_FLOW,su.USER_NAME,rr.REC_CONTENT from RES_DOCTOR_SCH_PROCESS rdsp,RES_REC
        rr,SYS_USER su
        where rdsp.RECORD_STATUS='Y' and rr.RECORD_STATUS='Y' and su.RECORD_STATUS='Y'
        and rr.PROCESS_FLOW =rdsp.PROCESS_FLOW
        and rr.OPER_USER_FLOW=rdsp.USER_FLOW
        and su.USER_FLOW=rdsp.USER_FLOW
        and rr.rec_type_id ='DeptGrade'
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="startDate!=null and startDate!=''">
            and rr.OPER_TIME<![CDATA[>=]]>#{startDate}
        </if>
        <if test="endDate!=null and endDate!=''">
            and rr.OPER_TIME<![CDATA[<=]]>#{endDate}
        </if>
    </select>
    <select id="processRecRecTeacherMap" resultMap="processResRecShMap">
        select rdsp.PROCESS_FLOW, rdsp.USER_FLOW,su.USER_NAME,rr.REC_CONTENT from RES_DOCTOR_SCH_PROCESS rdsp,RES_REC
        rr,SYS_USER su
        where rdsp.RECORD_STATUS='Y' and rr.RECORD_STATUS='Y' and su.RECORD_STATUS='Y'
        and rr.PROCESS_FLOW =rdsp.PROCESS_FLOW
        and rr.OPER_USER_FLOW=rdsp.USER_FLOW
        and su.USER_FLOW=rdsp.USER_FLOW
        and rr.rec_type_id ='TeacherGrade'
        <if test="teacherFlow!=null and teacherFlow!=''">
            and rdsp.TEACHER_USER_FLOW=#{teacherFlow}
        </if>
        <if test="startDate!=null and startDate!=''">
            and rr.OPER_TIME<![CDATA[>=]]>#{startDate}
        </if>
        <if test="endDate!=null and endDate!=''">
            and rr.OPER_TIME<![CDATA[<=]]>#{endDate}
        </if>
    </select>
    <select id="schDoctorSchProcessDistinctQuery" resultType="int">
        select count(distinct a.user_flow)
        from (select P.*,
        RD.DOCTOR_TYPE_ID,
        nvl((select CFG_VALUE from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code =
        'jsres_doctor_app_menu_'||rd.doctor_flow),'N')APP_MENU_FLAG,
        nvl(cfg2.power_start_time,'0000-00-00') power_start_time, nvl(cfg2.power_end_time,'9999-99-99') power_end_time
        from res_doctor_sch_process p
        left join res_doctor rd
        on p.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rd.doctor_flow
        left join sys_user tu
        on tu.user_flow = p.teacher_user_flow
        left join jsres_power_cfg cfg2
        on cfg2.record_status='Y' and cfg2.cfg_code = 'jsres_doctor_data_time_'||rd.doctor_flow
        where p.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y') A
        left join RES_SCH_PROCESS_EXPRESS rr
        on a.process_flow=rr.process_flow
        and rr.rec_type_id='AfterEvaluation'
        and rr.record_status='Y'
        where a.RECORD_STATUS='Y'
        and rr.rec_type_id is null
        and a.TEACHER_USER_FLOW=#{teacherUserFlow}
        and
        a.APP_MENU_FLAG='Y'
        AND ( ( a.SCH_START_DATE  <![CDATA[ <= ]]> A.power_start_time AND a.SCH_END_DATE >= A.power_END_time)
        or (a.SCH_START_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_START_DATE <![CDATA[ <= ]]>A.power_END_time)
        or (a.SCH_END_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_END_DATE <![CDATA[ <= ]]>A.power_END_time))
        <if test="deptFlow!=null and deptFlow!=''">
            and a.DEPT_FLOW=#{deptFlow}
        </if>
        <!--(
        (A.DOCTOR_TYPE_ID !='Graduate' AND A.STU_JD_GC='Y')
        OR
        (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='Y')
        OR
        (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='N' AND A.STU_JD_GC='Y' AND A.STU_JDZS_GC='Y')
        )-->
    </select>
    <select id="schDoctorSchProcessTeacherQuery" resultType="int">
        select count(distinct a.user_flow)
        from (select P.*,
        RD.DOCTOR_TYPE_ID,
        nvl((select CFG_VALUE from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code =
        'jsres_doctor_app_menu_'||rd.doctor_flow),'N')APP_MENU_FLAG,
        nvl(cfg2.power_start_time,'0000-00-00') power_start_time, nvl(cfg2.power_end_time,'9999-99-99') power_end_time
        from res_doctor_sch_process p
        left join res_doctor rd
        on p.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rd.doctor_flow
        left join sys_user tu
        on tu.user_flow = p.teacher_user_flow
        left join jsres_power_cfg cfg2
        on cfg2.record_status='Y' and cfg2.cfg_code = 'jsres_doctor_data_time_'||rd.doctor_flow
        where p.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y') A
        where a.RECORD_STATUS='Y'
        and a.TEACHER_USER_FLOW=#{teacherUserFlow}
        and
        a.APP_MENU_FLAG='Y'
        AND ( ( a.SCH_START_DATE  <![CDATA[ <= ]]> A.power_start_time AND a.SCH_END_DATE >= A.power_END_time)
        or (a.SCH_START_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_START_DATE <![CDATA[ <= ]]>A.power_END_time)
        or (a.SCH_END_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_END_DATE <![CDATA[ <= ]]>A.power_END_time))
        <if test="deptFlow!=null and deptFlow!=''">
            and a.DEPT_FLOW=#{deptFlow}
        </if>
        <!--(
        (A.DOCTOR_TYPE_ID !='Graduate' AND A.STU_JD_GC='Y')
        OR
        (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='Y')
        OR
        (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='N' AND A.STU_JD_GC='Y' AND A.STU_JDZS_GC='Y')
        )-->
    </select>
    <select id="schDoctorSchProcessWaitingExamineQuery" resultType="int">
		select count(0) from RES_DOCTOR_SCH_PROCESS re,RES_REC rr,sys_user su
		where re.RECORD_STATUS='Y' and rr.RECORD_STATUS='Y'
		and rr.oper_user_flow=su.user_flow
		and su.record_status='Y'
		and re.TEACHER_USER_FLOW=#{teacherUserFlow}
		and re.PROCESS_FLOW=rr.PROCESS_FLOW
		and rr.AUDIT_STATUS_ID is null
		and rr.rec_type_id not in ('Delay','ReturnTraining','DoctorAuth','TeacherGrade','DeptGrade','AfterSummary','AfterEvaluation','DOPS','Mini_CEX')
	</select>

    <select id="schProcessStudentDistinctQuery" resultType="int">
        select count(distinct(a.USER_FLOW)) from (
        SELECT SAR.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        RDR.SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        nvl((select CFG_VALUE
        from jsres_power_cfg cfg
        where cfg.record_status = 'Y'
        and cfg.cfg_code = 'jsres_doctor_app_menu_' || rd.doctor_flow),
        'N') APP_MENU_FLAG,
        nvl(cfg2.power_start_time, '0000-00-00') power_start_time,
        nvl(cfg2.power_end_time, '9999-99-99') power_end_time,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'isCurrent'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        'isSch'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'notCurrent'
        else
        ''
        end STATUS_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '轮转中'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        '已出科'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '待入科'
        else
        ''
        end STATUS_NAME
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        left join jsres_power_cfg cfg2
        on cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        ) a
        WHERE
        a.APP_MENU_FLAG = 'Y'
        AND (a.SCH_START_DATE  <![CDATA[<=]]> A.power_start_time
        AND a.SCH_END_DATE >= A.power_END_time
        OR a.SCH_START_DATE >= A.power_start_time
        AND a.SCH_START_DATE  <![CDATA[<=]]> A.power_END_time
        OR a.SCH_END_DATE >= A.power_start_time
        AND a.SCH_END_DATE  <![CDATA[<=]]> A.power_END_time)
        AND A.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        <if test="isSch!=null and isSch!=''">
           and a.STATUS_ID !='isSch'
        </if>
        and (
        exists(
        select null
        from SYS_USER_DEPT sud
        where sud.RECORD_STATUS='Y'
        and sud.USER_FLOW=#{userFlow}
        and a.DEPT_FLOW=sud.DEPT_FLOW
        )
        <if test="deptFlow!=null and deptFlow!=''">
            or a.DEPT_FLOW=#{deptFlow}
        </if>
        )
        and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
    </select>
    <select id="schProcessComingStudentQuery" resultType="int">
		select count(distinct(rdsp.USER_FLOW)) from RES_DOCTOR_SCH_PROCESS rdsp 
		where RECORD_STATUS='Y'
		and TO_CHAR(SYSDATE, 'yyyy-mm-dd') <![CDATA[>=]]> TO_CHAR(TO_DATE(rdsp.SCH_END_DATE,'yyyy-mm-dd')-7,'yyyy-mm-dd')
		and  TO_CHAR(SYSDATE, 'yyyy-mm-dd') <![CDATA[<=]]>TO_CHAR(TO_DATE(rdsp.SCH_END_DATE,'yyyy-mm-dd'),'yyyy-mm-dd')
		and (
			exists(
			  select null
			  from SYS_USER_DEPT sud
			  where sud.RECORD_STATUS='Y' 
			  and sud.USER_FLOW=#{userFlow}
			  and rdsp.DEPT_FLOW=sud.DEPT_FLOW
			)
			or  rdsp.DEPT_FLOW=#{deptFlow}
		)
	</select>
    <select id="schProcessStudentQuery" resultType="int">
		select count(distinct(rdsp.USER_FLOW)) from RES_DOCTOR_SCH_PROCESS rdsp
		 where rdsp.RECORD_STATUS='Y' 
		  and (
				exists(
				  select null
				  from SYS_USER_DEPT sud
				  where sud.RECORD_STATUS='Y' 
				  and sud.USER_FLOW=#{userFlow}
				  and rdsp.DEPT_FLOW=sud.DEPT_FLOW
				)
				or rdsp.DEPT_FLOW=#{deptFlow}
			)
	</select>

    <select id="countProcessByUser" resultMap="processCountMap">
        SELECT USER_FLOW,COUNT(*) PROCESS_COUNT
        FROM PDSCI.RES_DOCTOR_SCH_PROCESS
        WHERE USER_FLOW IN
        <foreach collection="userFlows" item="userFlow" open="(" separator="," close=")">
            #{userFlow}
        </foreach>
        AND RECORD_STATUS = 'Y'
        GROUP BY USER_FLOW
    </select>

    <resultMap type="HashMap" id="processUserMap">
        <result column="SESSION_NUMBER" javaType="string" property="sessionNumber"></result>
        <result column="RESULT_FLOW" javaType="string" property="resultFlow"></result>
        <result column="SPE_NAME" javaType="string" property="speName"></result>
        <result column="PROCESS_FLOW" javaType="string" property="processFlow"></result>
        <result column="USER_FLOW" javaType="string" property="userFlow"></result>
        <result column="ORG_FLOW" javaType="string" property="orgFlow"></result>
        <result column="ORG_NAME" javaType="string" property="orgName"></result>
        <result column="DEPT_FLOW" javaType="string" property="deptFlow"></result>
        <result column="DEPT_NAME" javaType="string" property="deptName"></result>
        <result column="SCH_DEPT_FLOW" javaType="string" property="schDeptFlow"></result>
        <result column="SCH_DEPT_NAME" javaType="string" property="schDeptName"></result>
        <result column="SCH_RESULT_FLOW" javaType="string" property="schResultFlow"></result>
        <result column="SCH_START_DATE" javaType="string" property="schStartDate"></result>
        <result column="SCH_END_DATE" javaType="string" property="schEndDate"></result>
        <result column="TEACHER_USER_FLOW" javaType="string" property="teacherUserFlow"></result>
        <result column="TEACHER_USER_NAME" javaType="string" property="teacherUserName"></result>
        <result column="HEAD_USER_FLOW" javaType="string" property="headUserFlow"></result>
        <result column="HEAD_USER_NAME" javaType="string" property="headUserName"></result>
        <result column="SCH_FLAG" javaType="string" property="schFlag"></result>
        <result column="SCH_SCORE" javaType="string" property="schScore"></result>
        <result column="IS_CURRENT_FLAG" javaType="string" property="isCurrentFlag"></result>
        <result column="USER_NAME" javaType="string" property="userName"></result>
        <result column="USER_HEAD_IMG" javaType="string" property="userHeadImg"></result>
        <result column="SEX_NAME" javaType="string" property="sexName"></result>
        <result column="USER_PHONE" javaType="string" property="userPhone"></result>
        <result column="STATUS_NAME" javaType="string" property="statusName"></result>
        <result column="STATUS_ID" javaType="string" property="statusId"></result>
        <result column="QTY" javaType="string" property="qty"></result>
        <result column="cq_num" javaType="string" property="cq"></result>
        <result column="qq_num" javaType="string" property="qq"></result>
        <result column="lx_num" javaType="string" property="lx"></result>
        <result column="TEMPORARY_AUDIT_STATUS_ID" javaType="string" property="temporaryAuditStatusId"></result>
        <result column="TEMPORARY_AUDIT_STATUS_NAME" javaType="string" property="temporaryAuditStatusName"></result>
    </resultMap>
    <select id="schDoctorSchProcessHead" resultMap="processUserMap">
        select * from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        rd.training_spe_name SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'isCurrent'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        'isSch'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'notCurrent'
        else
        ''
        end STATUS_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '轮转中'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        '已出科'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '待入科'
        else
        ''
        end STATUS_NAME
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and nvl((select CFG_VALUE
        from jsres_power_cfg cfg
        where cfg.record_status = 'Y'
        and cfg.cfg_code = 'jsres_doctor_app_menu_' || rd.doctor_flow),
        'N') ='Y'
        and not exists(
        select 1 from jsres_power_cfg cfg2
        where cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        and (nvl(cfg2.power_start_time, '0000-00-00')>rdsp.sch_start_date
        or nvl(cfg2.power_end_time, '9999-99-99')<![CDATA[<]]>rdsp.sch_end_date)
        )
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')

        and (
            exists(
            select null
            from SYS_USER_DEPT sud
            where sud.RECORD_STATUS='Y'
            and sud.USER_FLOW=#{headFlow}
            and rdsp.DEPT_FLOW=sud.DEPT_FLOW
            )
            or exists(
             select 1 from sys_user where user_flow=#{headFlow}
            and rdsp.dept_flow=sys_user.dept_flow
            )
        )
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW=#{doctorFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        ) a
        WHERE 1=1
        <if test='seachStr!=null and seachStr!=""'>
            and (
             a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            )
        </if>
        <if test='typeId!=null and typeId!=""'>
            <if test="typeId=='allDoc'">
                and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
            </if>
            <if test="typeId=='monthCurrent'">
                and SUBSTR(a.SCH_START_DATE,0,7) <![CDATA[<=]]>#{yearMonth}
                and SUBSTR(a.SCH_END_DATE,0,7) <![CDATA[>=]]>#{yearMonth}
            </if>
            <if test="typeId=='monthSch'">
                and SUBSTR(a.SCH_END_DATE,0,7) = #{yearMonth}
            </if>
            <if test="typeId=='waitSch'">
                <if test='yearMonth!=null and yearMonth!=""'>
                    and SUBSTR(a.SCH_START_DATE,0,7) = #{yearMonth}
                </if>
            </if>
            <if test="typeId=='errorSch'">
                and a.SCH_END_DATE <![CDATA[<=]]>#{yearMonth}
                and not exists(
                select 1 from res_sch_process_express e
                where e.process_flow=a.process_flow
                and e.record_status='Y' and e.rec_type_id='AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
                )
            </if>
        </if>
        ORDER BY a.SCH_START_DATE DESC
    </select>
    <select id="attendList" resultMap="processUserMap">
        
    SELECT a.session_number,result_flow,spe_name,cat_spe_name,user_flow,a.USER_NAME,SCH_START_DATE,sch_end_date,dept_name,
        sum(case when nvl(ja.attend_status,0)='1' then 1 else 0 end) AS cq_num,
        sum(case when nvl(ja.attend_status,0)='0' then 1 else 0 end) AS qq_num,
        sum(case when nvl(ja.attend_status,0)='-1' then 1 else 0 end) AS lx_num
    FROM (
      SELECT rd.SESSION_NUMBER, SAR.RESULT_FLOW, RDR.SPE_ID, rd.training_spe_name AS SPE_NAME, RDR.CAT_SPE_ID
        , RDR.CAT_SPE_NAME, RDSP.PROCESS_FLOW, RDSP.USER_FLOW, RDSP.ORG_FLOW, RDSP.ORG_NAME
        , RDSP.DEPT_FLOW, RDSP.DEPT_NAME, RDSP.SCH_DEPT_FLOW, RDSP.SCH_DEPT_NAME, RDSP.SCH_RESULT_FLOW
        , RDSP.SCH_START_DATE, RDSP.SCH_END_DATE, RDSP.TEACHER_USER_FLOW, tu.user_name AS TEACHER_USER_NAME, RDSP.HEAD_USER_FLOW
        , RDSP.HEAD_USER_NAME, RDSP.SCH_FLAG, RDSP.SCH_SCORE, RDSP.IS_CURRENT_FLAG, SU.USER_NAME
        , SU.USER_HEAD_IMG, RD.DOCTOR_TYPE_ID, CASE WHEN rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(SYSDATE, 'yyyy-MM-dd')
        AND (
          SELECT 1
          FROM res_sch_process_express e
          WHERE e.process_flow = rdsp.process_flow
            AND e.record_status = 'Y'
            and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
            AND rownum = 1
          ) IS NULL THEN 'isCurrent' WHEN (
          SELECT 1
          FROM res_sch_process_express e
          WHERE e.process_flow = rdsp.process_flow
            AND e.record_status = 'Y'
            and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
            AND rownum = 1
          ) IS NOT NULL THEN 'isSch' WHEN rdsp.SCH_START_DATE >= to_char(SYSDATE, 'yyyy-MM-dd')
        AND (
          SELECT 1
          FROM res_sch_process_express e
          WHERE e.process_flow = rdsp.process_flow
            AND e.record_status = 'Y'
            and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
            AND rownum = 1
          ) IS NULL THEN 'notCurrent' ELSE NULL END AS STATUS_ID,
        CASE WHEN rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(SYSDATE, 'yyyy-MM-dd')
        AND (
          SELECT 1
          FROM res_sch_process_express e
          WHERE e.process_flow = rdsp.process_flow
            AND e.record_status = 'Y'
            and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
            AND rownum = 1
          ) IS NULL THEN '轮转中' WHEN (
          SELECT 1
          FROM res_sch_process_express e
          WHERE e.process_flow = rdsp.process_flow
            AND e.record_status = 'Y'
            and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
            AND rownum = 1
          ) IS NOT NULL THEN '已出科' WHEN rdsp.SCH_START_DATE >= to_char(SYSDATE, 'yyyy-MM-dd')
        AND (
          SELECT 1
          FROM res_sch_process_express e
          WHERE e.process_flow = rdsp.process_flow
            AND e.record_status = 'Y'
            and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
            AND rownum = 1
          ) IS NULL THEN '待入科' ELSE NULL END AS STATUS_NAME
      FROM RES_DOCTOR_SCH_PROCESS rdsp
      LEFT JOIN sch_arrange_result sar ON rdsp.sch_result_flow = sar.result_flow 
      LEFT JOIN res_doctor_recruit rdr ON rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW
      AND rdr.RECORD_STATUS = 'Y'
      AND sar.session_number = rdr.SESSION_NUMBER
      AND rdr.AUDIT_STATUS_ID = 'Passed' 
      LEFT JOIN res_doctor rd ON rdsp.user_flow = rd.doctor_flow 
      LEFT JOIN sys_user su ON su.user_flow = rdsp.user_flow 
        LEFT JOIN sys_user tu ON tu.user_flow = rdsp.teacher_user_flow 
      WHERE rdsp.record_status = 'Y'
        AND rd.record_status = 'Y'
        AND su.record_status = 'Y'
        AND tu.record_status = 'Y'
        AND sar.record_status = 'Y'
        AND nvl((
          SELECT check_status_id
          FROM jsres_power_cfg cfg
          WHERE cfg.record_status = 'Y'
            AND cfg.cfg_code = ('jsres_doctor_attendance_' || rd.doctor_flow)
          ), 'N') = 'Passed'
        AND NOT EXISTS (SELECT 1
          FROM jsres_power_cfg cfg2
          WHERE cfg2.record_status = 'Y'
            AND cfg2.cfg_code = ('jsres_doctor_data_time_' || rd.doctor_flow)
            AND (nvl(cfg2.power_start_time, '0000-00-00') > rdsp.sch_start_date
              OR nvl(cfg2.power_end_time, '9999-99-99') <![CDATA[<]]> rdsp.sch_end_date))
        AND rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate', 'CompanyEntrust')
        AND (EXISTS (SELECT NULL
            FROM SYS_USER_DEPT sud
            WHERE sud.RECORD_STATUS = 'Y'
              AND sud.USER_FLOW = #{headFlow}
              AND rdsp.DEPT_FLOW = sud.DEPT_FLOW)
          OR EXISTS (SELECT 1
            FROM sys_user
            WHERE user_flow = #{headFlow}
              AND rdsp.dept_flow = sys_user.dept_flow))
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW=#{doctorFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
    ) a
    left join sys_date_info sdi
    on sdi.DATE_MONTH=#{yearMonth}
    and sdi.DATE_DAY>=a.sch_start_date
    and sdi.DATE_DAY<![CDATA[<=]]>a.sch_end_date
    left join jsres_attendance ja
    on ja.doctor_flow=a.user_flow
    and sdi.date_day=ja.attend_date
    and ja.record_status='Y'
    WHERE 1 = 1
        <if test='seachStr!=null and seachStr!=""'>
            and (
             a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            )
        </if>
        <if test="nowDate!=null and nowDate!=''">
            and DATE_DAY <![CDATA[<=]]>#{nowDate}
        </if>
        and STATUS_ID='isCurrent'
        and SUBSTR(a.SCH_START_DATE,0,7) <![CDATA[<=]]>#{yearMonth}
        and SUBSTR(a.SCH_END_DATE,0,7) <![CDATA[>=]]>#{yearMonth}
      group by a.session_number,result_flow,spe_name,a.USER_NAME,cat_spe_name,user_flow,SCH_START_DATE,sch_end_date,dept_name
    ORDER BY a.result_flow,a.SCH_START_DATE  DESC

    </select>
    <select id="jsresHeadUserList" resultMap="processUserMap">
        select USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME,count(1) QTY from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        rd.training_spe_name SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'isCurrent'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        'isSch'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'notCurrent'
        else
        ''
        end STATUS_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '轮转中'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        '已出科'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '待入科'
        else
        ''
        end STATUS_NAME
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and nvl((select CFG_VALUE
        from jsres_power_cfg cfg
        where cfg.record_status = 'Y'
        and cfg.cfg_code = 'jsres_doctor_app_menu_' || rd.doctor_flow),
        'N') ='Y'
        and not exists(
        select 1 from jsres_power_cfg cfg2
        where cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        and (nvl(cfg2.power_start_time, '0000-00-00')>rdsp.sch_start_date
        or nvl(cfg2.power_end_time, '9999-99-99')<![CDATA[<]]>rdsp.sch_end_date)
        )
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')

        and (
            exists(
            select null
            from SYS_USER_DEPT sud
            where sud.RECORD_STATUS='Y'
            and sud.USER_FLOW=#{headFlow}
            and rdsp.DEPT_FLOW=sud.DEPT_FLOW
            )
            or exists(
             select 1 from sys_user where user_flow=#{headFlow}
            and rdsp.dept_flow=sys_user.dept_flow
            )
        )
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW=#{doctorFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        ) a
        WHERE 1=1
        <if test='seachStr!=null and seachStr!=""'>
            and (
             a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            )
        </if>
        <if test='typeId!=null and typeId!=""'>
            <if test="typeId=='allDoc'">
                and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
            </if>
            <if test="typeId=='monthCurrent'">
                and SUBSTR(a.SCH_START_DATE,0,7) <![CDATA[<=]]>#{yearMonth}
                and SUBSTR(a.SCH_END_DATE,0,7) <![CDATA[>=]]>#{yearMonth}
            </if>
            <if test="typeId=='monthSch'">
                and SUBSTR(a.SCH_END_DATE,0,7) = #{yearMonth}
            </if>
            <if test="typeId=='waitSch'">
                <if test='yearMonth!=null and yearMonth!=""'>
                    and SUBSTR(a.SCH_START_DATE,0,7) = #{yearMonth}
                </if>
            </if>
            <if test="typeId=='errorSch'">
                and a.SCH_END_DATE <![CDATA[<=]]>#{yearMonth}
                and not exists(
                select 1 from res_sch_process_express e
                where e.process_flow=a.process_flow
                and e.record_status='Y' and e.rec_type_id='AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
                )
            </if>
        </if>
       GROUP BY USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME
        ORDER BY  SESSION_NUMBER DESC,SPE_NAME ,USER_FLOW,USER_NAME
    </select>
    <select id="afterUserList" resultMap="processUserMap">
        select USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME,count(1) QTY from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        rd.training_spe_name SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and nvl((select CFG_VALUE
        from jsres_power_cfg cfg
        where cfg.record_status = 'Y'
        and cfg.cfg_code = 'jsres_doctor_app_menu_' || rd.doctor_flow),
        'N') ='Y'
        and not exists(
        select 1 from jsres_power_cfg cfg2
        where cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        and (nvl(cfg2.power_start_time, '0000-00-00')>rdsp.sch_start_date
        or nvl(cfg2.power_end_time, '9999-99-99')<![CDATA[<]]>rdsp.sch_end_date)
        )
        AND EXISTS (SELECT 1
        FROM RES_SCH_PROCESS_EXPRESS RR
        WHERE RR.RECORD_STATUS = 'Y'
        AND RR.PROCESS_FLOW = rdsp.PROCESS_FLOW
        AND RR.REC_TYPE_ID = 'AfterEvaluation'
        AND RR.MANAGER_AUDIT_USER_FLOW IS NOT NULL
        AND RR.HEAD_AUDIT_STATUS_ID IS NULL)
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        and (
            exists(
            select null
            from SYS_USER_DEPT sud
            where sud.RECORD_STATUS='Y'
            and sud.USER_FLOW=#{headFlow}
            and rdsp.DEPT_FLOW=sud.DEPT_FLOW
            )
            or exists(
             select 1 from sys_user where user_flow=#{headFlow}
            and rdsp.dept_flow=sys_user.dept_flow
            )
        )
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW=#{doctorFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        ) a
        WHERE 1=1
        <if test='seachStr!=null and seachStr!=""'>
            and (
             a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            <!--OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')-->
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            )
        </if>
       GROUP BY USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME
        ORDER BY  SESSION_NUMBER DESC,SPE_NAME ,USER_FLOW,USER_NAME
    </select>
    <select id="temporaryOutAuditList" resultMap="processUserMap">
        select USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME,PROCESS_FLOW,SCH_DEPT_NAME,SCH_START_DATE,SCH_END_DATE,count(1) QTY from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        rd.training_spe_name SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        and (
        exists(
        select null
        from SYS_USER_DEPT sud
        where sud.RECORD_STATUS='Y'
        and sud.USER_FLOW=#{headFlow}
        and rdsp.DEPT_FLOW=sud.DEPT_FLOW
        )
        or exists(
        select 1 from sys_user where user_flow=#{headFlow}
        and rdsp.dept_flow=sys_user.dept_flow
        )
        )
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW=#{doctorFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        AND rdsp.TEMPORARY_OUT = 'Y'
        AND rdsp.TEMPORARY_AUDIT_STATUS_ID = 'Auditing'
        ) a
        WHERE 1=1
        <if test='seachStr!=null and seachStr!=""'>
            and (
            a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            <!--OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')-->
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            )
        </if>
        GROUP BY USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME,PROCESS_FLOW,SCH_DEPT_NAME,SCH_START_DATE,SCH_END_DATE
        ORDER BY  SESSION_NUMBER DESC,SPE_NAME ,USER_FLOW,USER_NAME
    </select>
    <select id="temporaryOutList" resultMap="processUserMap">
        select USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME,PROCESS_FLOW,SCH_DEPT_NAME,SCH_START_DATE,SCH_END_DATE,TEMPORARY_AUDIT_STATUS_NAME,TEMPORARY_AUDIT_STATUS_ID,count(1) QTY from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        rd.training_spe_name SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        RDSP.TEMPORARY_AUDIT_STATUS_ID,
        RDSP.TEMPORARY_AUDIT_STATUS_NAME,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        <if test="roleId != null and roleId != 'Student'.toString()">
            and (
            exists(
            select null
            from SYS_USER_DEPT sud
            where sud.RECORD_STATUS='Y'
            and sud.USER_FLOW=#{headFlow}
            and rdsp.DEPT_FLOW=sud.DEPT_FLOW
            )
            or exists(
            select 1 from sys_user where user_flow=#{headFlow}
            and rdsp.dept_flow=sys_user.dept_flow
            )
            )
        </if>
        <if test="roleId != null and roleId == 'Student'.toString()">
            and rd.DOCTOR_FLOW=#{doctorFlow}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW=#{doctorFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        AND rdsp.TEMPORARY_OUT = 'Y'
        <if test="temporaryAuditStatusId!=null and temporaryAuditStatusId!=''">
            AND rdsp.TEMPORARY_AUDIT_STATUS_ID = #{temporaryAuditStatusId}
        </if>
        ) a
        WHERE 1=1
        <if test='seachStr!=null and seachStr!=""'>
            and (
            a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            <!--OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')-->
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            )
        </if>
        GROUP BY USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME,PROCESS_FLOW,SCH_DEPT_NAME,SCH_START_DATE,SCH_END_DATE,TEMPORARY_AUDIT_STATUS_NAME,TEMPORARY_AUDIT_STATUS_ID
        ORDER BY  SESSION_NUMBER DESC,SPE_NAME ,USER_FLOW,USER_NAME
    </select>
    <select id="afterAuditList" resultMap="processUserMap">
        select * from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        rd.training_spe_name SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'isCurrent'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        'isSch'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation'and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'notCurrent'
        else
        ''
        end STATUS_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation'and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '轮转中'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation'and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        '已出科'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation'and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '待入科'
        else
        ''
        end STATUS_NAME
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and nvl((select CFG_VALUE
        from jsres_power_cfg cfg
        where cfg.record_status = 'Y'
        and cfg.cfg_code = 'jsres_doctor_app_menu_' || rd.doctor_flow),
        'N') ='Y'
        and not exists(
        select 1 from jsres_power_cfg cfg2
        where cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        and (nvl(cfg2.power_start_time, '0000-00-00')>rdsp.sch_start_date
        or nvl(cfg2.power_end_time, '9999-99-99')<![CDATA[<]]>rdsp.sch_end_date)
        )
        AND EXISTS (SELECT 1
        FROM RES_SCH_PROCESS_EXPRESS RR
        WHERE RR.RECORD_STATUS = 'Y'
        AND RR.PROCESS_FLOW = rdsp.PROCESS_FLOW
        AND RR.REC_TYPE_ID = 'AfterEvaluation'
        AND RR.MANAGER_AUDIT_USER_FLOW IS NOT NULL
        AND RR.HEAD_AUDIT_STATUS_ID IS NULL)
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        and (
            exists(
            select null
            from SYS_USER_DEPT sud
            where sud.RECORD_STATUS='Y'
            and sud.USER_FLOW=#{headFlow}
            and rdsp.DEPT_FLOW=sud.DEPT_FLOW
            )
            or exists(
             select 1 from sys_user where user_flow=#{headFlow}
            and rdsp.dept_flow=sys_user.dept_flow
            )
        )
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW=#{doctorFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        ) a
        WHERE 1=1
        <if test='seachStr!=null and seachStr!=""'>
            and (
             a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            )
        </if>
        ORDER BY  SCH_START_DATE
    </select>
    <select id="jsresHeadCount" resultType="int">
        select COUNT(DISTINCT USER_FLOW ) from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        rd.training_spe_name SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'isCurrent'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        'isSch'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'notCurrent'
        else
        ''
        end STATUS_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '轮转中'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        '已出科'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '待入科'
        else
        ''
        end STATUS_NAME
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and nvl((select CFG_VALUE
        from jsres_power_cfg cfg
        where cfg.record_status = 'Y'
        and cfg.cfg_code = 'jsres_doctor_app_menu_' || rd.doctor_flow),
        'N') ='Y'
        and not exists(
        select 1 from jsres_power_cfg cfg2
        where cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        and (nvl(cfg2.power_start_time, '0000-00-00')>rdsp.sch_start_date
        or nvl(cfg2.power_end_time, '9999-99-99')<![CDATA[<]]>rdsp.sch_end_date)
        )
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')

        and (
            exists(
            select null
            from SYS_USER_DEPT sud
            where sud.RECORD_STATUS='Y'
            and sud.USER_FLOW=#{headFlow}
            and rdsp.DEPT_FLOW=sud.DEPT_FLOW
            )
            or exists(
             select 1 from sys_user where user_flow=#{headFlow}
            and rdsp.dept_flow=sys_user.dept_flow
            )
        )
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        ) a
        WHERE 1=1
        <if test='seachStr!=null and seachStr!=""'>
            and (
             a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            )
        </if>
        <if test='typeId!=null and typeId!=""'>
            <if test="typeId=='allDoc'">
                and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
            </if>
            <if test="typeId=='monthCurrent'">
                and SUBSTR(a.SCH_START_DATE,0,7) <![CDATA[<=]]>#{yearMonth}
                and SUBSTR(a.SCH_END_DATE,0,7) <![CDATA[>=]]>#{yearMonth}
            </if>
            <if test="typeId=='monthSch'">
                and SUBSTR(a.SCH_END_DATE,0,7) = #{yearMonth}
            </if>
            <if test="typeId=='waitSch'">
                <if test='yearMonth!=null and yearMonth!=""'>
                    and SUBSTR(a.SCH_START_DATE,0,7) = #{yearMonth}
                </if>
            </if>
            <if test="typeId=='errorSch'">
                and a.SCH_END_DATE <![CDATA[<=]]>#{yearMonth}
                and not exists(
                select 1 from res_sch_process_express e
                where e.process_flow=a.process_flow
                and e.record_status='Y' and e.rec_type_id='AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
                )
            </if>
        </if>
    </select>
    <select id="deptTeacherUsers" resultMap="processUserMap">
        select USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME,count(1) QTY from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        RDR.SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'isCurrent'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        'isSch'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'notCurrent'
        else
        ''
        end STATUS_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '轮转中'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        '已出科'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '待入科'
        else
        ''
        end STATUS_NAME
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and nvl((select CFG_VALUE
        from jsres_power_cfg cfg
        where cfg.record_status = 'Y'
        and cfg.cfg_code = 'jsres_doctor_app_menu_' || rd.doctor_flow),
        'N') ='Y'
        and not exists(
        select 1 from jsres_power_cfg cfg2
        where cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        and (nvl(cfg2.power_start_time, '0000-00-00')>rdsp.sch_start_date
        or nvl(cfg2.power_end_time, '9999-99-99')<![CDATA[<]]>rdsp.sch_end_date)
        )
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')

        and (
            exists(
            select null
            from SYS_USER_DEPT sud
            where sud.RECORD_STATUS='Y'
            and sud.USER_FLOW=#{userFlow}
            and rdsp.DEPT_FLOW=sud.DEPT_FLOW
            )
            or exists(
            select 1 from sys_user where user_flow=#{userFlow}
            and rdsp.dept_flow=sys_user.dept_flow
            )
        )
        <if test="doctorFlow!=null and doctorFlow!=''">
            and  rdsp.USER_FLOW=#{doctorFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and  rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="teacherFlow!=null and teacherFlow!=''">
            and rdsp.teacher_user_flow = #{teacherFlow}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        ) a
        WHERE 1=1
        <if test='seachStr!=null and seachStr!=""'>
            and a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
        </if>
        and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
        GROUP BY USER_FLOW,SESSION_NUMBER,USER_NAME,SPE_NAME
        ORDER BY  SESSION_NUMBER DESC,SPE_NAME ,USER_FLOW,USER_NAME
    </select>
    <select id="deptTeacherDocList" resultMap="processUserMap">
        select * from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        RDR.SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'isCurrent'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        'isSch'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'notCurrent'
        else
        ''
        end STATUS_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '轮转中'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        '已出科'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '待入科'
        else
        ''
        end STATUS_NAME
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and nvl((select CFG_VALUE
        from jsres_power_cfg cfg
        where cfg.record_status = 'Y'
        and cfg.cfg_code = 'jsres_doctor_app_menu_' || rd.doctor_flow),
        'N') ='Y'
        and not exists(
        select 1 from jsres_power_cfg cfg2
        where cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        and (nvl(cfg2.power_start_time, '0000-00-00')>rdsp.sch_start_date
        or nvl(cfg2.power_end_time, '9999-99-99')<![CDATA[<]]>rdsp.sch_end_date)
        )
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')

        and (
            exists(
            select null
            from SYS_USER_DEPT sud
            where sud.RECORD_STATUS='Y'
            and sud.USER_FLOW=#{userFlow}
            and rdsp.DEPT_FLOW=sud.DEPT_FLOW
            )
            or exists(
            select 1 from sys_user where user_flow=#{userFlow}
            and rdsp.dept_flow=sys_user.dept_flow
            )
        )
        <if test="doctorFlow!=null and doctorFlow!=''">
            and  rdsp.USER_FLOW=#{doctorFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and  rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="teacherFlow!=null and teacherFlow!=''">
            and rdsp.teacher_user_flow = #{teacherFlow}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        ) a
        WHERE 1=1
        <if test='seachStr!=null and seachStr!=""'>
            and (
             a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            )
        </if>
        and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
        ORDER BY a.SCH_START_DATE DESC
    </select>
    <select id="deptUsersDocCount" resultType="int">
        select count(DISTINCT USER_FLOW ) from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        RDR.SPE_ID,
        RDR.SPE_NAME,
        RDR.CAT_SPE_ID,
        RDR.CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        RDSP.USER_FLOW,
        RDSP.ORG_FLOW,
        RDSP.ORG_NAME,
        RDSP.DEPT_FLOW,
        RDSP.DEPT_NAME,
        RDSP.SCH_DEPT_FLOW,
        RDSP.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'isCurrent'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        'isSch'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        'notCurrent'
        else
        ''
        end STATUS_ID,
        case
        when rdsp.SCH_START_DATE <![CDATA[<=]]> to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '轮转中'
        when (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is not null then
        '已出科'
        when rdsp.SCH_START_DATE >= to_char(sysdate, 'yyyy-MM-dd') and
        (select 1
        from res_sch_process_express e
        where e.process_flow = rdsp.process_flow
        and e.record_status = 'Y'
        and e.rec_type_id = 'AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
        and rownum = 1) is null then
        '待入科'
        else
        ''
        end STATUS_NAME
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        and sar.record_status = 'Y'
        and nvl((select CFG_VALUE
        from jsres_power_cfg cfg
        where cfg.record_status = 'Y'
        and cfg.cfg_code = 'jsres_doctor_app_menu_' || rd.doctor_flow),
        'N') ='Y'
        and not exists(
        select 1 from jsres_power_cfg cfg2
        where cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        and (nvl(cfg2.power_start_time, '0000-00-00')>rdsp.sch_start_date
        or nvl(cfg2.power_end_time, '9999-99-99')<![CDATA[<]]>rdsp.sch_end_date)
        )
        and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        and (
            exists(
            select null
            from SYS_USER_DEPT sud
            where sud.RECORD_STATUS='Y'
            and sud.USER_FLOW=#{userFlow}
            and rdsp.DEPT_FLOW=sud.DEPT_FLOW
            )
            or exists(
            select 1 from sys_user where user_flow=#{userFlow}
            and rdsp.dept_flow=sys_user.dept_flow
            )
        )
        <if test="deptFlow!=null and deptFlow!=''">
         and  rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="teacherFlow!=null and teacherFlow!=''">
            and rdsp.teacher_user_flow = #{teacherFlow}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        ) a
        WHERE 1=1
        and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
    </select>
    <select id="deptUsersCount" resultType="int">
        SELECT count(1) FROM (
              SELECT A.*,
                       D.DEPT_NAME,
                       SU.USER_NAME,
                       ROW_NUMBER() OVER(PARTITION BY A.USER_FLOW ORDER BY A.DEPT_FLOW) RN
                      FROM (SELECT USER_FLOW, DEPT_FLOW
                              FROM SYS_USER_DEPT
                             WHERE RECORD_STATUS = 'Y'
                             AND DEPT_FLOW IN (
                                SELECT DEPT_FLOW FROM SYS_USER_DEPT  WHERE RECORD_STATUS = 'Y' AND USER_FLOW=#{userFlow}
                                UNION ALL
                                SELECT DEPT_FLOW FROM SYS_USER  WHERE RECORD_STATUS = 'Y' AND USER_FLOW=#{userFlow}
                             )
                            UNION
                            SELECT USER_FLOW, DEPT_FLOW
                              FROM SYS_USER
                             WHERE RECORD_STATUS = 'Y'
                             AND DEPT_FLOW IN (
                                SELECT DEPT_FLOW FROM SYS_USER_DEPT  WHERE RECORD_STATUS = 'Y' AND USER_FLOW=#{userFlow}
                                UNION ALL
                                SELECT DEPT_FLOW FROM SYS_USER  WHERE RECORD_STATUS = 'Y' AND USER_FLOW=#{userFlow}
                             )
                        ) A
                  LEFT JOIN SYS_DEPT D
                    ON D.DEPT_FLOW = A.DEPT_FLOW
                  LEFT JOIN SYS_USER SU
                    ON A.USER_FLOW = SU.USER_FLOW
                 WHERE D.RECORD_STATUS = 'Y'
                   AND SU.RECORD_STATUS = 'Y'
                   and su.status_id='Activated'
                   AND EXISTS
                 (SELECT 1
                          FROM SYS_USER_ROLE ROLE
                         WHERE ROLE.RECORD_STATUS = 'Y'
                           AND ROLE.USER_FLOW = A.USER_FLOW
                           AND ROLE.ROLE_FLOW =#{roleFlow})
                   <if test='deptFlow!=null and deptFlow!=""'>
                    AND A.DEPT_FLOW =#{deptFlow}
                   </if>
                   ) B WHERE RN=1
    </select>
    <select id="schDoctorSchProcessHeadCount" resultType="int">
        select count(DISTINCT USER_FLOW) from (
        SELECT rd.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        rd.training_spe_id AS SPE_ID,
        rd.training_spe_name AS SPE_NAME,
        rd.training_type_id CAT_SPE_ID,
        rd.training_type_Name CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        sar.DOCTOR_FLOW AS USER_FLOW,
        sar.ORG_FLOW,
        sar.ORG_NAME,
        sar.DEPT_FLOW,
        sar.DEPT_NAME,
        sar.SCH_DEPT_FLOW,
        sar.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        sar.SCH_START_DATE,
        sar.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name AS TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        nvl(RPC.POWER_START_TIME, NULL) AS POWER_START_TIME,
        nvl(RPC.POWER_END_TIME, NULL) AS POWER_END_TIME,
        case
        when rdsp.process_flow is null then
        'notCurrent'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        'isCurrent'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        'isSch'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        'notCurrent'
        ELSE
        NULL
        END
        end AS STATUS_ID,
        case
        when rdsp.process_flow is null then
        '待入科'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        '轮转中'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        '已出科'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        '待入科'
        ELSE
        NULL
        END
        end AS STATUS_NAME
        FROM sch_arrange_result sar
        LEFT JOIN (select row_number() over(partition by sch_result_flow order by create_time desc) rn,
        p.*
        from RES_DOCTOR_SCH_PROCESS p
        where p.record_status = 'Y') rdsp
        ON rdsp.sch_result_flow = sar.result_flow
        AND rdsp.record_status = 'Y'
        and rdsp.rn = 1
        LEFT JOIN res_doctor rd
        ON sar.doctor_flow = rd.doctor_flow
        LEFT JOIN sys_user su
        ON su.user_flow = sar.doctor_flow
        LEFT JOIN sys_user tu
        ON tu.user_flow = rdsp.teacher_user_flow
        AND tu.record_status = 'Y'
        LEFT JOIN RES_POWER_CFG RPC
        ON ('res_doctor_app_login_' || RDSP.USER_FLOW) = RPC.CFG_CODE
        WHERE rd.record_status = 'Y'
        AND su.record_status = 'Y'
        AND sar.record_status = 'Y'
        <if test='doctorFlow!=null and doctorFlow!=""'>
            and su.user_flow=#{doctorFlow}
        </if>
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and rpc.record_status = 'Y'
            and rpc.cfg_value = 'Y'
        </if>
        ) a
        WHERE A.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        and (exists(
        select null
        from SYS_USER_DEPT sud
        where sud.RECORD_STATUS='Y'
        and sud.USER_FLOW=#{headFlow}
        and a.DEPT_FLOW=sud.DEPT_FLOW
        )
        <if test="deptFlow!=null and deptFlow!=''">
            or a.DEPT_FLOW=#{deptFlow}
        </if>)
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and (a.POWER_START_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.POWER_END_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.SCH_START_DATE <![CDATA[>=]]> a.POWER_START_TIME
            AND a.SCH_END_DATE <![CDATA[<=]]> a.POWER_END_TIME)
            and a.POWER_START_TIME is not null
            and a.POWER_END_TIME is not null
        </if>
        <if test='seachStr!=null and seachStr!=""'>
            and (a.session_number like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%'))
        </if>
        <if test='typeId!=null and typeId!=""'>
            <if test="typeId=='allDoc'">
                and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
            </if>
            <if test="typeId=='monthCurrent'">
                and SUBSTR(a.SCH_START_DATE,0,7) <![CDATA[<=]]>to_char(sysdate,'yyyy-MM')
                and SUBSTR(a.SCH_END_DATE,0,7) <![CDATA[>=]]>to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='monthSch'">
                and SUBSTR(a.SCH_END_DATE,0,7) = to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='waitSch'">
                <if test='yearMonth!=null and yearMonth!=""'>
                    and SUBSTR(a.SCH_START_DATE,0,7) = #{yearMonth}
                </if>
                and a.status_id='notCurrent'
            </if>
            <if test="typeId=='errorSch'">
                and a.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and a.status_id!='isSch'
                and a.status_id!='notCurrent'
            </if>
        </if>
    </select>

    <select id="schDoctorSchProcessSpe" resultMap="processUserMap">
        select * from (
        SELECT SAR.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        rd.training_spe_id AS SPE_ID,
        rd.training_spe_name AS SPE_NAME,
        rd.training_type_id CAT_SPE_ID,
        rd.training_type_Name CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        sar.DOCTOR_FLOW AS USER_FLOW,
        sar.ORG_FLOW,
        sar.ORG_NAME,
        sar.DEPT_FLOW,
        sar.DEPT_NAME,
        sar.SCH_DEPT_FLOW,
        sar.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        sar.SCH_START_DATE,
        sar.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name AS TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        nvl(RPC.POWER_START_TIME, NULL) AS POWER_START_TIME,
        nvl(RPC.POWER_END_TIME, NULL) AS POWER_END_TIME,
        case
        when rdsp.process_flow is null then
        'notCurrent'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        'isCurrent'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        'isSch'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        'notCurrent'
        ELSE
        NULL
        END
        end AS STATUS_ID,
        case
        when rdsp.process_flow is null then
        '待入科'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        '轮转中'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        '已出科'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        '待入科'
        ELSE
        NULL
        END
        end AS STATUS_NAME
        FROM sch_arrange_result sar
        LEFT JOIN (select row_number() over(partition by sch_result_flow order by create_time desc) rn,
        p.*
        from RES_DOCTOR_SCH_PROCESS p
        where p.record_status = 'Y') rdsp
        ON rdsp.sch_result_flow = sar.result_flow
        AND rdsp.record_status = 'Y'
        and rdsp.rn = 1
        LEFT JOIN res_doctor rd
        ON sar.doctor_flow = rd.doctor_flow
        LEFT JOIN sys_user su
        ON su.user_flow = sar.doctor_flow
        LEFT JOIN sys_user tu
        ON tu.user_flow = rdsp.teacher_user_flow
        AND tu.record_status = 'Y'
        LEFT JOIN RES_POWER_CFG RPC
        ON ('res_doctor_app_login_' || RDSP.USER_FLOW) = RPC.CFG_CODE
        WHERE rd.record_status = 'Y'
        AND su.record_status = 'Y'
        AND sar.record_status = 'Y'
        <if test='doctorFlow!=null and doctorFlow!=""'>
            and su.user_flow=#{doctorFlow}
        </if>
        <if test='sessionNumber!=null and sessionNumber!=""'>
            and rd.session_number=#{sessionNumber}
        </if>
        <if test='deptFlow!=null and deptFlow!=""'>
            and rd.DEPART_MENT_FLOW=#{deptFlow}
        </if>
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and rpc.record_status = 'Y'
            and rpc.cfg_value = 'Y'
        </if>

        <if test='doctorFlow!=null and doctorFlow!=""'>
            <if test='docTypeId!="deptStudent".toString()'>
                   and sar.dept_flow in
                      (  select D.DEPT_FLOW
                      from RES_TRAINING_SPE_DEPT d
                      where d.Training_Spe_Id IN ( SELECT RES_Training_Spe_Id FROM SYS_USER WHERE USER_FLOW=#{userFlow})
                      and d.record_status='Y'
                  )
            </if>
        </if>
        <if test='doctorFlow==null or doctorFlow==""'>
            and (sar.dept_flow in
            (
                select D.DEPT_FLOW
                from RES_TRAINING_SPE_DEPT d
                where d.Training_Spe_Id IN ( SELECT RES_Training_Spe_Id FROM SYS_USER WHERE USER_FLOW=#{userFlow})
                and d.record_status='Y'
            )
            OR  rd.Training_Spe_Id IN ( SELECT RES_Training_Spe_Id FROM SYS_USER WHERE USER_FLOW=#{userFlow})
            )
        </if>
        ) a
        WHERE A.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        <if test='doctorTypeId!=null and doctorTypeId!=""'>
            and  A.DOCTOR_TYPE_ID =#{doctorTypeId}
        </if>
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and (a.POWER_START_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.POWER_END_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.SCH_START_DATE <![CDATA[>=]]> a.POWER_START_TIME
            AND a.SCH_END_DATE <![CDATA[<=]]> a.POWER_END_TIME)
            and a.POWER_START_TIME is not null
            and a.POWER_END_TIME is not null
        </if>
        <if test='seachStr!=null and seachStr!=""'>
            and (a.session_number like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%'))
        </if>
        <if test='typeId!=null and typeId!=""'>
            <if test="typeId=='allDoc'">
            </if>
            <if test="typeId=='monthCurrent'">
                and SUBSTR(a.SCH_START_DATE,0,7) <![CDATA[<=]]>to_char(sysdate,'yyyy-MM')
                and SUBSTR(a.SCH_END_DATE,0,7) <![CDATA[>=]]>to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='monthSch'">
                and SUBSTR(a.SCH_END_DATE,0,7) = to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='waitSch'">
                <if test='yearMonth!=null and yearMonth!=""'>
                    and SUBSTR(a.SCH_START_DATE,0,7) = #{yearMonth}
                </if>
                and a.status_id='notCurrent'
            </if>
            <if test="typeId=='errorSch'">
                and a.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and a.status_id!='isSch'
                and a.status_id!='notCurrent'
            </if>
        </if>
        ORDER BY a.SCH_START_DATE DESC
    </select>
    <resultMap id="readDocTypeMap" type="hashmap">
        <result column="DOCTOR_TYPE_ID" javaType="string" property="doctorTypeId"></result>
        <result column="QTY" javaType="string" property="qty"></result>
    </resultMap>
    <select id="readDocTypeMap" resultMap="readDocTypeMap">
        select DOCTOR_TYPE_ID,count(1) QTY
        FROM  res_doctor rd
        LEFT JOIN sys_user su
        ON su.user_flow = rd.doctor_flow
        WHERE rd.record_status = 'Y'
        AND su.record_status = 'Y'
         and rd.Training_Spe_Id IN ( SELECT RES_Training_Spe_Id FROM SYS_USER WHERE USER_FLOW=#{userFlow})
        <if test='sessionNumber!=null and sessionNumber!=""'>
            and rd.session_number=#{sessionNumber}
        </if>
       group by DOCTOR_TYPE_ID
    </select>
    <select id="readDocEducationMap" resultMap="readDocTypeMap">
        select su.EDUCATION_ID DOCTOR_TYPE_ID,count(1) QTY
        FROM  res_doctor rd
        LEFT JOIN sys_user su
        ON su.user_flow = rd.doctor_flow
        WHERE rd.record_status = 'Y'
        AND su.record_status = 'Y'
         and rd.Training_Spe_Id IN ( SELECT RES_Training_Spe_Id FROM SYS_USER WHERE USER_FLOW=#{userFlow})
        <if test='sessionNumber!=null and sessionNumber!=""'>
            and rd.session_number=#{sessionNumber}
        </if>
       group by EDUCATION_ID
    </select>
    <select id="readSessionNumberDocMap" resultMap="readDocTypeMap">
      SELECT  SESSION_NUMBER||DOCTOR_STATUS_ID DOCTOR_TYPE_ID,COUNT(1) QTY
        FROM  RES_DOCTOR RD
        LEFT JOIN SYS_USER SU
        ON SU.USER_FLOW = RD.DOCTOR_FLOW
        WHERE RD.RECORD_STATUS = 'Y'
        AND SU.RECORD_STATUS = 'Y'
         and rd.Training_Spe_Id IN ( SELECT RES_Training_Spe_Id FROM SYS_USER WHERE USER_FLOW=#{userFlow})
         AND DOCTOR_STATUS_ID IN (SELECT DICT_ID from SYS_DICT WHERE DICT_TYPE_ID='DoctorStatus' AND RECORD_STATUS='Y')
       group by SESSION_nUMBER,DOCTOR_STATUS_ID
    </select>
    <resultMap id="readTeacherStatisticsMap" type="hashmap">
        <result column="DEPT_FLOW" javaType="string" property="deptFlow"></result>
        <result column="DEPT_NAME" javaType="string" property="deptName"></result>
        <result column="QTY1" javaType="string" property="qty1"></result>
        <result column="QTY2" javaType="string" property="qty2"></result>
    </resultMap>
    <select id="readTeacherStatistics" resultMap="readTeacherStatisticsMap">
        SELECT DEPT_FLOW, DEPT_NAME, COUNT(USER_FLOW)QTY1, COUNT(LEVEL_ID2)QTY2
          FROM (SELECT A.*,
                       D.DEPT_NAME,
                       SU.USER_NAME,
                       DECODE(SU.CERTIFICATE_LEVEL_ID,
                              '4',
                              NULL,
                              SU.CERTIFICATE_LEVEL_ID) LEVEL_ID2,
                       NVL(SU.CERTIFICATE_LEVEL_ID, '4') LEVEL_ID,
                       ROW_NUMBER() OVER(PARTITION BY A.USER_FLOW ORDER BY A.DEPT_FLOW) RN
                  FROM (SELECT USER_FLOW, DEPT_FLOW
                          FROM SYS_USER_DEPT
                         WHERE RECORD_STATUS = 'Y'
                        UNION
                        SELECT USER_FLOW, DEPT_FLOW
                          FROM SYS_USER
                         WHERE RECORD_STATUS = 'Y'
                           AND DEPT_FLOW IS NOT NULL) A
                  LEFT JOIN SYS_DEPT D
                    ON D.DEPT_FLOW = A.DEPT_FLOW
                  LEFT JOIN SYS_USER SU
                    ON A.USER_FLOW = SU.USER_FLOW
                 WHERE D.RECORD_STATUS = 'Y'
                   AND SU.RECORD_STATUS = 'Y'
                   AND A.DEPT_FLOW IN
                       (SELECT D.DEPT_FLOW
                          FROM RES_TRAINING_SPE_DEPT D
                         WHERE D.TRAINING_SPE_ID IN
                               (SELECT RES_TRAINING_SPE_ID
                                  FROM SYS_USER
                                 WHERE USER_FLOW = #{userFlow})
                           AND D.RECORD_STATUS = 'Y')
                   AND EXISTS
                 (SELECT 1
                          FROM SYS_USER_ROLE ROLE
                         WHERE ROLE.RECORD_STATUS = 'Y'
                           AND ROLE.USER_FLOW = A.USER_FLOW
                           AND ROLE.ROLE_FLOW =#{roleFlow})) b
         WHERE RN = 1
         GROUP BY DEPT_FLOW, DEPT_NAME
    </select>
    <resultMap id="teacherMap" type="hashmap">
        <result column="USER_FLOW" javaType="string" property="userFlow"></result>
        <result column="USER_NAME" javaType="string" property="userName"></result>
        <result column="USER_HEAD_IMG" javaType="string" property="userHeadImg"></result>
        <result column="DEPT_FLOW" javaType="string" property="deptFlow"></result>
        <result column="DEPT_NAME" javaType="string" property="deptName"></result>
        <result column="LEVEL_ID2" javaType="string" property="levelId"></result>
    </resultMap>
    <select id="teacherList" resultMap="teacherMap">
        SELECT *
          FROM (SELECT A.*,
                       D.DEPT_NAME,
                       SU.USER_NAME,
                       SU.USER_HEAD_IMG,
                       DECODE(SU.CERTIFICATE_LEVEL_ID,
                              '4',
                              NULL,
                              SU.CERTIFICATE_LEVEL_ID) LEVEL_ID2,
                       NVL(SU.CERTIFICATE_LEVEL_ID, '4') LEVEL_ID,
                       ROW_NUMBER() OVER(PARTITION BY A.USER_FLOW ORDER BY A.DEPT_FLOW) RN
                  FROM (SELECT USER_FLOW, DEPT_FLOW
                          FROM SYS_USER_DEPT
                         WHERE RECORD_STATUS = 'Y'
                        UNION
                        SELECT USER_FLOW, DEPT_FLOW
                          FROM SYS_USER
                         WHERE RECORD_STATUS = 'Y'
                           AND DEPT_FLOW IS NOT NULL) A
                  LEFT JOIN SYS_DEPT D
                    ON D.DEPT_FLOW = A.DEPT_FLOW
                  LEFT JOIN SYS_USER SU
                    ON A.USER_FLOW = SU.USER_FLOW
                 WHERE D.RECORD_STATUS = 'Y'
                   AND SU.RECORD_STATUS = 'Y'
                   AND A.DEPT_FLOW IN
                       (SELECT D.DEPT_FLOW
                          FROM RES_TRAINING_SPE_DEPT D
                         WHERE D.TRAINING_SPE_ID IN
                               (SELECT RES_TRAINING_SPE_ID
                                  FROM SYS_USER
                                 WHERE USER_FLOW = #{userFlow})
                           AND D.RECORD_STATUS = 'Y')
                   AND EXISTS
                 (SELECT 1
                          FROM SYS_USER_ROLE ROLE
                         WHERE ROLE.RECORD_STATUS = 'Y'
                           AND ROLE.USER_FLOW = A.USER_FLOW
                           AND ROLE.ROLE_FLOW =#{roleFlow})) b
         WHERE RN = 1
            <if test='deptFlow!=null and deptFlow!=""'>
                and DEPT_FLOW=#{deptFlow}
            </if>
            <if test='isHave!=null and isHave!="" and isHave=="Y".toString()'>
                and LEVEL_ID!='4'
            </if>
            <if test='isHave!=null and isHave!="" and isHave=="N".toString()'>
                and LEVEL_ID ='4'
            </if>
            <if test='seachStr!=null and seachStr!=""'>
                and  USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            </if>
    </select>
    <select id="schDoctorSchProcessSpeCount" resultType="int">
        select count(DISTINCT USER_FLOW) from (
        SELECT SAR.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        rd.training_spe_id AS SPE_ID,
        rd.training_spe_name AS SPE_NAME,
        rd.training_type_id CAT_SPE_ID,
        rd.training_type_Name CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        sar.DOCTOR_FLOW AS USER_FLOW,
        sar.ORG_FLOW,
        sar.ORG_NAME,
        sar.DEPT_FLOW,
        sar.DEPT_NAME,
        sar.SCH_DEPT_FLOW,
        sar.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        sar.SCH_START_DATE,
        sar.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name AS TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        nvl(RPC.POWER_START_TIME, NULL) AS POWER_START_TIME,
        nvl(RPC.POWER_END_TIME, NULL) AS POWER_END_TIME,
        case
        when rdsp.process_flow is null then
        'notCurrent'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        'isCurrent'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        'isSch'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        'notCurrent'
        ELSE
        NULL
        END
        end AS STATUS_ID,
        case
        when rdsp.process_flow is null then
        '待入科'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        '轮转中'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        '已出科'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        '待入科'
        ELSE
        NULL
        END
        end AS STATUS_NAME
        FROM sch_arrange_result sar
        LEFT JOIN (select row_number() over(partition by sch_result_flow order by create_time desc) rn,
        p.*
        from RES_DOCTOR_SCH_PROCESS p
        where p.record_status = 'Y') rdsp
        ON rdsp.sch_result_flow = sar.result_flow
        AND rdsp.record_status = 'Y'
        and rdsp.rn = 1
        LEFT JOIN res_doctor rd
        ON sar.doctor_flow = rd.doctor_flow
        LEFT JOIN sys_user su
        ON su.user_flow = sar.doctor_flow
        LEFT JOIN sys_user tu
        ON tu.user_flow = rdsp.teacher_user_flow
        AND tu.record_status = 'Y'
        LEFT JOIN RES_POWER_CFG RPC
        ON ('res_doctor_app_login_' || RDSP.USER_FLOW) = RPC.CFG_CODE
        WHERE rd.record_status = 'Y'
        AND su.record_status = 'Y'
        AND sar.record_status = 'Y'
        <if test='doctorFlow!=null and doctorFlow!=""'>
            and su.user_flow=#{doctorFlow}
        </if>
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and rpc.record_status = 'Y'
            and rpc.cfg_value = 'Y'
        </if>
            and (sar.dept_flow in
            (   select D.DEPT_FLOW
                from RES_TRAINING_SPE_DEPT d
                where d.Training_Spe_Id IN ( SELECT RES_Training_Spe_Id FROM SYS_USER WHERE USER_FLOW=#{userFlow})
                and d.record_status='Y'
            )
            OR
             rd.Training_Spe_Id IN ( SELECT RES_Training_Spe_Id FROM SYS_USER WHERE USER_FLOW=#{userFlow})
          )
        ) a
        WHERE A.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and (a.POWER_START_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.POWER_END_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.SCH_START_DATE <![CDATA[>=]]> a.POWER_START_TIME
            AND a.SCH_END_DATE <![CDATA[<=]]> a.POWER_END_TIME)
            and a.POWER_START_TIME is not null
            and a.POWER_END_TIME is not null
        </if>
        <if test='seachStr!=null and seachStr!=""'>
            and (a.session_number like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%'))
        </if>
        <if test='typeId!=null and typeId!=""'>
            <if test="typeId=='allDoc'">
                and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
            </if>
            <if test="typeId=='monthCurrent'">
                and SUBSTR(a.SCH_START_DATE,0,7) <![CDATA[<=]]>to_char(sysdate,'yyyy-MM')
                and SUBSTR(a.SCH_END_DATE,0,7) <![CDATA[>=]]>to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='monthSch'">
                and SUBSTR(a.SCH_END_DATE,0,7) = to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='waitSch'">
                <if test='yearMonth!=null and yearMonth!=""'>
                    and SUBSTR(a.SCH_START_DATE,0,7) = #{yearMonth}
                </if>
                and a.status_id='notCurrent'
            </if>
            <if test="typeId=='errorSch'">
                and a.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and a.status_id!='isSch'
                and a.status_id!='notCurrent'
            </if>
        </if>
    </select>
    <select id="findNeedAuditAbsences" resultType="int">
        select count(1) from
        sch_doctor_absence
        WHERE RECORD_STATUS='Y'
        AND IS_REGISTER='N'
        AND ORG_FLOW=#{user.orgFlow}
        AND TEACHER_FLOW=#{user.userFlow}
        AND TEACHER_AGREE_FLAG IS NULL
    </select>
    <select id="findNeedSpeAuditAbsences" resultType="int">
        select count(1) from  sch_doctor_absence
        WHERE RECORD_STATUS='Y'
        AND IS_REGISTER='N'
        AND ORG_FLOW=#{user.orgFlow}
        AND EXISTS(SELECT 1 FROM SYS_USER WHERE TRAINING_SPE_ID=RES_TRAINING_SPE_ID AND USER_FLOW=#{user.userFlow} )
        AND HEAD_AGREE_FLAG IS NULL
        AND TEACHER_AGREE_FLAG IS  NOT NULL
    </select>
    <resultMap type="HashMap" id="processMap">
        <result column="doctor_flow" javaType="string" property="doctorFlow"/>
        <result column="doctor_name" javaType="string" property="doctorName"/>
        <result column="doctor_img" javaType="string" property="doctorImg"/>
        <result column="user_phone" javaType="string" property="phone"/>
        <result column="sch_start_date" javaType="string" property="schStartDate"/>
        <result column="sch_end_date" javaType="string" property="schEndDate"/>
        <result column="start_date" javaType="string" property="startDate"/>
        <result column="end_date" javaType="string" property="endDate"/>
        <result column="score" javaType="string" property="score"/>
        <result column="sch_flag" javaType="string" property="schFlag"/>
        <result column="is_current_flag" javaType="string" property="isCurrentFlag"/>
        <result column="result_flow" javaType="string" property="resultFlow"/>
        <result column="sch_dept_name" javaType="string" property="schDeptName"/>
        <result column="process_flow" javaType="string" property="processFlow"/>
        <result column="session_number" javaType="string" property="sessionNumber"/>
        <result column="training_spe_id" javaType="string" property="trainingSpeId"/>
        <result column="training_spe_name" javaType="string" property="trainingSpeName"/>
        <result column="DEPART_MENT_FLOW" javaType="string" property="departMentFlow"/>
        <result column="DEPART_MENT_name" javaType="string" property="departMentName"/>
        <result column="work_org_name" property="workOrgName" jdbcType="VARCHAR" />
        <result column="doctor_type_id" property="doctorTypeId" jdbcType="VARCHAR" />
        <result column="QTY" property="qty" jdbcType="VARCHAR" />
    </resultMap>
    <select id="schDoctorSchProcessHeadUserList" resultMap="processMap">
        <if test="typeId!=''and typeId=='deptStudent'">
            SELECT rd.doctor_flow,
                    rd.doctor_name,
                    rd.session_number,
                    rd.training_spe_id,
                    rd.training_spe_name,
                    rd.DEPART_MENT_FLOW,
                    rd.DEPART_MENT_name,
                    rd.doctor_type_id,
                    rd.work_org_name,
                    su.user_phone ,
                    su.user_head_img    AS doctor_img
            from sys_user su
            left join res_doctor rd
            on su.user_flow = rd.doctor_flow
            LEFT JOIN RES_POWER_CFG RPC
            ON ('res_doctor_app_login_' || su.USER_FLOW) = RPC.CFG_CODE
            where su.record_status = 'Y'
            and rd.record_status = 'Y'
            and su.user_flow != #{userFlow}
            AND DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate', 'CompanyEntrust')
            <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
                and rpc.record_status = 'Y'
                and rpc.cfg_value = 'Y'
                and exists (
                select 1 from res_doctor_sch_process resp
                where record_status='Y'
                and (RPC.POWER_START_TIME BETWEEN resp.SCH_START_DATE AND resp.SCH_END_DATE
                OR RPC.POWER_END_TIME BETWEEN resp.SCH_START_DATE AND resp.SCH_END_DATE
                OR resp.SCH_START_DATE <![CDATA[>=]]> RPC.POWER_START_TIME
                AND resp.SCH_END_DATE <![CDATA[<=]]> RPC.POWER_END_TIME)
                and RPC.POWER_START_TIME is not null
                and RPC.POWER_END_TIME is not null
                and resp.user_flow=su.user_flow
                )
            </if>
            <if test="userName!=null and userName!=''">
                <bind name="name" value="'%'+userName+'%'"/>
                and su.USER_NAME like #{name}
            </if>
            <if test="speId!=null and speId!=''">
                and rd.training_spe_id = #{speId}
            </if>
            <if test="doctorFlow!=null and doctorFlow!=''">
                and rd.doctor_flow = #{doctorFlow}
            </if>
            <if test="sessionNumber!=null and sessionNumber!=''">
                and rd.session_number = #{sessionNumber}
            </if>
            <if test="isAfter!=null and isAfter!=''">
              and exists (  SELECT 1
                FROM PDSCI.RES_DOCTOR_SCH_PROCESS RDSP
                WHERE RDSP.RECORD_STATUS = 'Y'
                and exists(select null from RES_SCH_PROCESS_EXPRESS rr
                where RDSP.USER_FLOW = RR.OPER_USER_FLOW
                and RR.PROCESS_FLOW = RDSP.PROCESS_FLOW
                and RR.REC_TYPE_ID IN ('AfterEvaluation', 'AfterSummary')
                and RR.AUDIT_STATUS_ID is not null
                AND RR.RECORD_STATUS='Y'
                and RR.HEAD_AUDIT_STATUS_ID IS NULL)
                and RDSP.USER_FLOW = SU.USER_FLOW)
            </if>
            <if test="isError!=null and isError!=''">
                and exists (  SELECT 1
                FROM PDSCI.RES_DOCTOR_SCH_PROCESS a
                LEFT JOIN SCH_ARRANGE_RESULT R ON
                a.SCH_RESULT_FLOW=R.RESULT_FLOW
                WHERE a.RECORD_STATUS = 'Y'
                AND R.RECORD_STATUS='Y'
                AND (a.SCH_FLAG != 'Y' or a.IS_CURRENT_FLAG = 'Y')
                and R.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and a.USER_FLOW = SU.USER_FLOW)
            </if>
            and ( exists (select 1
            from sys_user_dept sud
            left join sys_dept d on sud.dept_flow=d.dept_flow
            where sud.record_status='Y'
            and d.record_status = 'Y'
            and sud.user_flow=#{userFlow}
            and d.dept_flow = rd.depart_ment_flow)
            or exists (select 1
            from sys_user sud
            where sud.record_status='Y'
            and sud.user_flow=#{userFlow}
            and sud.dept_flow = rd.depart_ment_flow)
            )
            ORDER BY rd.session_number desc,rd.training_spe_id ,su.user_flow
        </if>
        <if test="typeId!=''and typeId=='cycleStudent'">
            SELECT rd.doctor_flow,
                    rd.doctor_name,
                    rd.session_number,
                    rd.training_spe_id,
                    rd.training_spe_name,
                    rd.DEPART_MENT_FLOW,
                    rd.DEPART_MENT_name,
                    rd.doctor_type_id,
                    rd.work_org_name,
                    su.user_phone ,
                    su.user_head_img    AS doctor_img
            from sys_user su
            left join res_doctor rd
            on su.user_flow=rd.doctor_flow
            where su.record_status='Y'
            and rd.record_status='Y'
            and su.user_flow != #{userFlow}
            <if test="userName!=null and userName!=''">
                <bind name="name" value="'%'+userName+'%'"/>
                and su.USER_NAME like #{name}
            </if>
            <if test="speId!=null and speId!=''">
                and rd.training_spe_id = #{speId}
            </if>
            <if test="doctorFlow!=null and doctorFlow!=''">
                and rd.doctor_flow = #{doctorFlow}
            </if>
            <if test="sessionNumber!=null and sessionNumber!=''">
                and rd.session_number = #{sessionNumber}
            </if>
            and exists(
            SELECT 1
            FROM pdsci.res_doctor_sch_process rdsp
            LEFT JOIN res_power_cfg rpc
            on 'res_doctor_web_' || rdsp.user_flow = rpc.cfg_code
            INNER JOIN pdsci.sch_arrange_result sar
            ON sar.record_status = 'Y'
            AND sar.result_flow = rdsp.sch_result_flow
            WHERE rdsp.record_status = 'Y'
            and (rdsp.sch_flag ='Y' or rdsp.is_current_flag='Y')
            <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
                and rpc.record_status = 'Y'
                and rpc.cfg_value = 'Y'
                and exists (
                select 1 from res_doctor_sch_process resp
                where record_status='Y'
                and (RPC.POWER_START_TIME BETWEEN resp.SCH_START_DATE AND resp.SCH_END_DATE
                OR RPC.POWER_END_TIME BETWEEN resp.SCH_START_DATE AND resp.SCH_END_DATE
                OR resp.SCH_START_DATE <![CDATA[>=]]> RPC.POWER_START_TIME
                AND resp.SCH_END_DATE <![CDATA[<=]]> RPC.POWER_END_TIME)
                and RPC.POWER_START_TIME is not null
                and RPC.POWER_END_TIME is not null
                and resp.user_flow=su.user_flow
                )
            </if>
            <if test="isAfter!=null and isAfter!=''">
                and exists(select null from RES_SCH_PROCESS_EXPRESS rr
                where RDSP.USER_FLOW = RR.OPER_USER_FLOW
                and RR.PROCESS_FLOW = RDSP.PROCESS_FLOW
                and RR.REC_TYPE_ID IN ('AfterEvaluation', 'AfterSummary')
                and RR.AUDIT_STATUS_ID is not null
                AND RR.RECORD_STATUS='Y'
                and RR.HEAD_AUDIT_STATUS_ID IS NULL)
            </if>
            <if test="isError!=null and isError!=''">
                and exists (  SELECT 1
                FROM PDSCI.RES_DOCTOR_SCH_PROCESS a
                LEFT JOIN SCH_ARRANGE_RESULT R ON
                a.SCH_RESULT_FLOW=R.RESULT_FLOW
                WHERE a.RECORD_STATUS = 'Y'
                AND R.RECORD_STATUS='Y'
                AND (a.SCH_FLAG != 'Y' or a.IS_CURRENT_FLAG = 'Y')
                and R.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and a.process_Flow = rdsp.process_Flow)
            </if>
            and rdsp.user_flow=su.user_flow
            and ( exists (
            select 1
            from sys_user_dept sud
            left join sys_dept d on sud.dept_flow=d.dept_flow
            where sud.record_status='Y'
            and d.record_status = 'Y'
            and d.dept_flow = sar.dept_flow
            and d.dept_flow in (
            select sud.dept_flow from sys_user_dept sud
            left join sys_dept d on sud.dept_flow=d.dept_flow
            where sud.record_status='Y'
            and d.record_status = 'Y'
            and sud.user_flow=#{userFlow}
            union
            select dept_flow
            from sys_user sud
            where sud.record_status='Y'
            and sud.user_flow=#{userFlow}
            )
            )
            or
            sar.dept_flow in (
            select sud.dept_flow from sys_user_dept sud
            left join sys_dept d on sud.dept_flow=d.dept_flow
            where sud.record_status='Y'
            and d.record_status = 'Y'
            and sud.user_flow=#{userFlow}
            union
            select dept_flow
            from sys_user sud
            where sud.record_status='Y'
            and sud.user_flow=#{userFlow}
            )
            )
            )
            and su.user_flow not in (
            select su.user_flow
            from sys_user su
            left join res_doctor rd
            on su.user_flow = rd.doctor_flow
            where su.record_status = 'Y'
            and rd.record_status = 'Y'
            and su.user_flow != #{userFlow}
            and ( exists (select 1
            from sys_user_dept sud
            left join sys_dept d on sud.dept_flow=d.dept_flow
            where sud.record_status='Y'
            and d.record_status = 'Y'
            and sud.user_flow=#{userFlow}
            and d.dept_flow = rd.depart_ment_flow)
            or exists (select 1
            from sys_user sud
            where sud.record_status='Y'
            and sud.user_flow=#{userFlow}
            and sud.dept_flow = rd.depart_ment_flow)
            )
            )
            ORDER BY rd.session_number desc,rd.training_spe_id ,su.user_flow
        </if>
    </select>
    <select id="schDoctorSchProcessSpeUserList" resultMap="processMap">
        <if test="typeId!=''and typeId=='deptStudent'">
            SELECT rd.doctor_flow,
                    rd.doctor_name,
                    rd.session_number,
                    rd.training_spe_id,
                    rd.training_spe_name,
                    rd.DEPART_MENT_FLOW,
                    rd.DEPART_MENT_name,
                    rd.doctor_type_id,
                    rd.work_org_name,
                    su.user_phone ,
                    su.user_head_img    AS doctor_img
            from sys_user su
            left join res_doctor rd
            on su.user_flow = rd.doctor_flow
            LEFT JOIN RES_POWER_CFG RPC
            ON ('res_doctor_app_login_' || su.USER_FLOW) = RPC.CFG_CODE
            where su.record_status = 'Y'
            and rd.record_status = 'Y'
            and su.user_flow != #{userFlow}
            AND DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate', 'CompanyEntrust')
            <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
                and rpc.record_status = 'Y'
                and rpc.cfg_value = 'Y'
                and exists (
                select 1 from res_doctor_sch_process resp
                where record_status='Y'
                and (RPC.POWER_START_TIME BETWEEN resp.SCH_START_DATE AND resp.SCH_END_DATE
                OR RPC.POWER_END_TIME BETWEEN resp.SCH_START_DATE AND resp.SCH_END_DATE
                OR resp.SCH_START_DATE <![CDATA[>=]]> RPC.POWER_START_TIME
                AND resp.SCH_END_DATE <![CDATA[<=]]> RPC.POWER_END_TIME)
                and RPC.POWER_START_TIME is not null
                and RPC.POWER_END_TIME is not null
                and resp.user_flow=su.user_flow
                )
            </if>
            <if test="userName!=null and userName!=''">
                <bind name="name" value="'%'+userName+'%'"/>
                and su.USER_NAME like #{name}
            </if>
            <if test="studentName!=null and studentName!=''">
                <bind name="name" value="'%'+studentName+'%'"/>
                and su.USER_NAME like #{name}
            </if>
            <if test="speId!=null and speId!=''">
                and rd.training_spe_id = #{speId}
            </if>
            <if test="doctorTypeId!=null and doctorTypeId!=''">
                and rd.doctor_Type_Id = #{doctorTypeId}
            </if>
            <if test="deptMentFlow!=null and deptMentFlow!=''">
                and rd.DEPART_MENT_FLOW = #{deptMentFlow}
            </if>
            <if test="doctorFlow!=null and doctorFlow!=''">
                and rd.doctor_flow = #{doctorFlow}
            </if>
            <if test="sessionNumber!=null and sessionNumber!=''">
                and rd.session_number = #{sessionNumber}
            </if>
            <if test="isAfter!=null and isAfter!=''">
              and exists (  SELECT 1
                FROM PDSCI.RES_DOCTOR_SCH_PROCESS RDSP
                WHERE RDSP.RECORD_STATUS = 'Y'
                and exists(select null from RES_SCH_PROCESS_EXPRESS rr
                where RDSP.USER_FLOW = RR.OPER_USER_FLOW
                and RR.PROCESS_FLOW = RDSP.PROCESS_FLOW
                and RR.REC_TYPE_ID IN ('AfterEvaluation', 'AfterSummary')
                and RR.AUDIT_STATUS_ID is not null
                AND RR.RECORD_STATUS='Y'
                and RR.HEAD_AUDIT_STATUS_ID IS NULL)
                and RDSP.USER_FLOW = SU.USER_FLOW)
            </if>
            <if test="isError!=null and isError!=''">
                and exists (  SELECT 1
                FROM PDSCI.RES_DOCTOR_SCH_PROCESS a
                LEFT JOIN SCH_ARRANGE_RESULT R ON
                a.SCH_RESULT_FLOW=R.RESULT_FLOW
                WHERE a.RECORD_STATUS = 'Y'
                AND R.RECORD_STATUS='Y'
                AND (a.SCH_FLAG != 'Y' or a.IS_CURRENT_FLAG = 'Y')
                and R.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and a.USER_FLOW = SU.USER_FLOW)
            </if>
            and (
                exists (select 1
                from sys_user sud
                where sud.user_flow=#{userFlow}
                and sud.res_training_spe_id = rd.training_spe_id)
            )
            and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
            ORDER BY rd.session_number desc,rd.training_spe_id ,su.user_flow
        </if>
        <if test="typeId!=''and typeId=='cycleStudent'">
            SELECT rd.doctor_flow,
                    rd.doctor_name,
                    rd.session_number,
                    rd.training_spe_id,
                    rd.training_spe_name,
                    rd.DEPART_MENT_FLOW,
                    rd.DEPART_MENT_name,
                    rd.doctor_type_id,
                    rd.work_org_name,
                    su.user_phone ,
                    su.user_head_img    AS doctor_img
            from sys_user su
            left join res_doctor rd
            on su.user_flow=rd.doctor_flow
            where su.record_status='Y'
            and rd.record_status='Y'
            and su.user_flow != #{userFlow}
            <if test="userName!=null and userName!=''">
                <bind name="name" value="'%'+userName+'%'"/>
                and su.USER_NAME like #{name}
            </if>
            <if test="studentName!=null and studentName!=''">
                <bind name="name" value="'%'+studentName+'%'"/>
                and su.USER_NAME like #{name}
            </if>
            <if test="speId!=null and speId!=''">
                and rd.training_spe_id = #{speId}
            </if>
            <if test="doctorFlow!=null and doctorFlow!=''">
                and rd.doctor_flow = #{doctorFlow}
            </if>
            <if test="doctorTypeId!=null and doctorTypeId!=''">
                and rd.doctor_Type_Id = #{doctorTypeId}
            </if>
            <if test="deptMentFlow!=null and deptMentFlow!=''">
                and rd.DEPART_MENT_FLOW = #{deptMentFlow}
            </if>
            <if test="sessionNumber!=null and sessionNumber!=''">
                and rd.session_number = #{sessionNumber}
            </if>
            and rd.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
            and (
             not  exists (select 1
            from sys_user sud
            where sud.user_flow=#{userFlow}
            and sud.res_training_spe_id = rd.training_spe_id)
            )
            and exists(
                SELECT 1
                FROM pdsci.res_doctor_sch_process rdsp
                LEFT JOIN res_power_cfg rpc
                on 'res_doctor_web_' || rdsp.user_flow = rpc.cfg_code
                INNER JOIN pdsci.sch_arrange_result sar
                ON sar.record_status = 'Y'
                AND sar.result_flow = rdsp.sch_result_flow
                WHERE rdsp.record_status = 'Y'
                and (rdsp.sch_flag ='Y' or rdsp.is_current_flag='Y')
                <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
                    and rpc.record_status = 'Y'
                    and rpc.cfg_value = 'Y'
                    and exists (
                    select 1 from res_doctor_sch_process resp
                    where record_status='Y'
                    and (RPC.POWER_START_TIME BETWEEN resp.SCH_START_DATE AND resp.SCH_END_DATE
                    OR RPC.POWER_END_TIME BETWEEN resp.SCH_START_DATE AND resp.SCH_END_DATE
                    OR resp.SCH_START_DATE <![CDATA[>=]]> RPC.POWER_START_TIME
                    AND resp.SCH_END_DATE <![CDATA[<=]]> RPC.POWER_END_TIME)
                    and RPC.POWER_START_TIME is not null
                    and RPC.POWER_END_TIME is not null
                    and resp.user_flow=su.user_flow
                    )
                </if>
                <if test="isAfter!=null and isAfter!=''">
                    and exists(select null from RES_SCH_PROCESS_EXPRESS rr
                    where RDSP.USER_FLOW = RR.OPER_USER_FLOW
                    and RR.PROCESS_FLOW = RDSP.PROCESS_FLOW
                    and RR.REC_TYPE_ID IN ('AfterEvaluation', 'AfterSummary')
                    and RR.AUDIT_STATUS_ID is not null
                    AND RR.RECORD_STATUS='Y'
                    and RR.HEAD_AUDIT_STATUS_ID IS NULL)
                </if>
                <if test="isError!=null and isError!=''">
                and exists (  SELECT 1
                FROM PDSCI.RES_DOCTOR_SCH_PROCESS a
                LEFT JOIN SCH_ARRANGE_RESULT R ON
                a.SCH_RESULT_FLOW=R.RESULT_FLOW
                WHERE a.RECORD_STATUS = 'Y'
                AND R.RECORD_STATUS='Y'
                AND (a.SCH_FLAG != 'Y' or a.IS_CURRENT_FLAG = 'Y')
                and R.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and a.process_Flow = rdsp.process_Flow)
                </if>
                 and rdsp.user_flow=su.user_flow
                and rdsp.dept_flow in
                    (select D.DEPT_FLOW
                        from RES_TRAINING_SPE_DEPT d
                        where d.Training_Spe_Id IN ( SELECT RES_Training_Spe_Id FROM SYS_USER WHERE USER_FLOW=#{userFlow})
                        and d.record_status='Y'
                       )
                )
            ORDER BY rd.session_number desc,rd.training_spe_id ,su.user_flow
        </if>
    </select>
    <select id="schDoctorSchProcessUserList" resultMap="processMap">
        SELECT rd.doctor_flow,
               rd.doctor_name,
               rd.session_number,
               rd.training_spe_id,
               rd.training_spe_name,
               rd.doctor_type_id,
               rd.work_org_name,
               su.user_phone,
               su.user_head_img AS doctor_img,
               COUNT(1) QTY
          FROM sys_user su
          LEFT JOIN res_doctor rd ON su.user_flow = rd.doctor_flow
          LEFT JOIN (SELECT rdsp.USER_FLOW,
                            rdsp.SCH_START_DATE,
                            rdsp.SCH_END_DATE,
                            nvl((SELECT check_status_id
                                  FROM jsres_power_cfg cfg
                                 WHERE cfg.record_status = 'Y'
                                   AND cfg.cfg_code =
                                       ('jsres_doctor_attendance_' || rdsp.USER_FLOW)),
                                'N') AS APP_MENU_FLAG,
                            nvl(cfg2.power_start_time, '0000-00-00') AS power_start_time,
                            nvl(cfg2.power_end_time, '9999-99-99') AS power_end_time,
                            MONTHS_BETWEEN(to_date(substr(rdsp.sch_end_date,0,7),'yyyy-MM'),to_date(substr(rdsp.sch_start_date,0,7),'yyyy-MM'))+1
                            evl_count ,
                            (select count(1) from RES_DOCTOR_SCH_PROCESS_EVAL eval where eval.process_flow=rdsp.process_flow and
                            eval.record_status='Y') evled_count
                       FROM RES_DOCTOR_SCH_PROCESS rdsp
                       LEFT JOIN jsres_power_cfg cfg2 ON cfg2.record_status = 'Y'
                                                     AND cfg2.cfg_code =
                                                         ('jsres_doctor_data_time_' ||
                                                         rdsp.USER_FLOW)
                      WHERE rdsp.record_status = 'Y'
                            <if test="teacherUserFlow!=null and teacherUserFlow!=''">
                                and rdsp.TEACHER_USER_FLOW = #{teacherUserFlow}
                            </if>
                            <if test="deptFlow!=null and deptFlow!=''">
                                and rdsp.dept_flow = #{deptFlow}
                            </if>

                        <if test="biaoJi!=null and biaoJi!=''">
                            <if test="dataType=='fiveData'">
                                and (
                                    exists(
                                    select null
                                    from res_rec rr
                                    where rr.RECORD_STATUS='Y'
                                    and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                                    and rr.AUDIT_STATUS_ID is null
                                    )
                                )
                            </if>
                            <if test="dataType=='skill'">
                                and ( not exists(
                                select null
                                from RES_SCH_PROCESS_EXPRESS rr
                                where rr.RECORD_STATUS='Y'
                                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                                and rr.rec_type_id in('DOPS')
                                )
                                or not exists(
                                select null
                                from RES_SCH_PROCESS_EXPRESS rr
                                where rr.RECORD_STATUS='Y'
                                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                                and rr.rec_type_id in('Mini_CEX')
                                )
                                )
                            </if>
                            <if test="dataType=='after'">
                                and  not exists(
                                        select null
                                        from RES_SCH_PROCESS_EXPRESS rr
                                        where rr.RECORD_STATUS='Y'
                                        and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                                        and rr.rec_type_id='AfterEvaluation'
                                    )
                            </if>
                            <if test="dataType=='dayAttend'">
                                and exists(
                                    SELECT 1 FROM sys_date_info sdi
                                    left join jsres_attendance ja
                                    on sdi.date_day=ja.attend_date
                                    and ja.record_status='Y'
                                    and doctor_flow=rdsp.user_flow
                                    where date_day <![CDATA[ <= ]]> rdsp.sch_end_date
                                    and date_day >= rdsp.sch_start_date
                                    and (ja.AUDIT_STATUS_ID ='Auditing' or ja.AUDIT_STATUS_ID is null)
                                )
                            </if>
                        </if>
                        <if test="biaoJi==null or biaoJi==''">
                            <if test="dataType=='skill'">
                                and  exists(
                                select null
                                from RES_SCH_PROCESS_EXPRESS rr
                                where rr.RECORD_STATUS='Y'
                                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                                and rr.rec_type_id in('DOPS','Mini_CEX')
                                )
                            </if>
                        </if>
        ) a ON A.USER_FLOW =SU.USER_FLOW
         WHERE su.record_status = 'Y'
           AND rd.record_status = 'Y'
            and su.user_flow != #{teacherUserFlow}

        <if test="biaoJi!=null and biaoJi!=''and biaoJi=='Y'.toString()">
            <if test="dataType=='docEval'">
                and a.evl_count!=a.evled_count
            </if>
        </if>
        <if test="biaoJi!=null and biaoJi!=''and biaoJi=='N'.toString()">
            <if test="dataType=='docEval'">
                and a.evled_count>0
            </if>
        </if>
            <if test="userName!=null and userName!=''">
                <bind name="name" value="'%'+userName+'%'"/>
                and su.USER_NAME like #{name}
            </if>
            <if test="studentName!=null and studentName!=''">
                <bind name="name" value="'%'+studentName+'%'"/>
                and su.USER_NAME like #{name}
            </if>
            <if test="trainingTypeId!=null and trainingTypeId!=''">
                and rd.training_type_id = #{trainingTypeId}
            </if>
            <if test="trainingSpeId!=null and trainingSpeId!=''">
                and rd.training_spe_id = #{trainingSpeId}
            </if>
            <if test="doctorFlow!=null and doctorFlow!=''">
                and rd.doctor_flow = #{doctorFlow}
            </if>
            <if test="doctorTypeId!=null and doctorTypeId!=''">
                and rd.doctor_Type_Id = #{doctorTypeId}
            </if>
            <if test="deptMentFlow!=null and deptMentFlow!=''">
                and rd.DEPART_MENT_FLOW = #{deptMentFlow}
            </if>
            <if test="sessionNumber!=null and sessionNumber!=''">
                and rd.session_number = #{sessionNumber}
            </if>
           AND rd.DOCTOR_TYPE_ID IN
               ('Company', 'Social', 'Graduate', 'CompanyEntrust')
           AND a.APP_MENU_FLAG = 'Passed'
           AND (a.SCH_START_DATE <![CDATA[ <= ]]> A.power_start_time AND
               a.SCH_END_DATE >= A.power_END_time OR
               a.SCH_START_DATE >= A.power_start_time AND
               a.SCH_START_DATE <![CDATA[ <= ]]> A.power_END_time OR
               a.SCH_END_DATE >= A.power_start_time AND
               a.SCH_END_DATE <![CDATA[ <= ]]> A.power_END_time)
         GROUP BY rd.doctor_flow,rd.doctor_name,rd.session_number,rd.training_spe_id,rd.training_spe_name,rd.doctor_type_id,rd.work_org_name,su.user_phone,su.user_head_img
         ORDER BY rd.session_number DESC, rd.training_spe_id, rd.doctor_flow
    </select>

    <select id="schDoctorSchProcessUserList1" resultMap="processMap">
        SELECT rd.doctor_flow,
        rd.doctor_name,
        rd.session_number,
        rd.training_spe_id,
        rd.training_spe_name,
        rd.doctor_type_id,
        rd.work_org_name,
        su.user_phone,
        su.user_head_img AS doctor_img,
        COUNT(1) QTY
        FROM sys_user su
        LEFT JOIN res_doctor rd ON su.user_flow = rd.doctor_flow
        LEFT JOIN (SELECT rdsp.USER_FLOW,
        rdsp.SCH_START_DATE,
        rdsp.SCH_END_DATE,
        nvl((SELECT check_status_id
        FROM jsres_power_cfg cfg
        WHERE cfg.record_status = 'Y'
        AND cfg.cfg_code =
        ('jsres_doctor_attendance_' || rdsp.USER_FLOW)),
        'N') AS APP_MENU_FLAG,
        nvl(cfg2.power_start_time, '0000-00-00') AS power_start_time,
        nvl(cfg2.power_end_time, '9999-99-99') AS power_end_time,
        MONTHS_BETWEEN(to_date(substr(rdsp.sch_end_date,0,7),'yyyy-MM'),to_date(substr(rdsp.sch_start_date,0,7),'yyyy-MM'))+1
        evl_count ,
        (select count(1) from RES_DOCTOR_SCH_PROCESS_EVAL eval where eval.process_flow=rdsp.process_flow and
        eval.record_status='Y') evled_count
        FROM RES_DOCTOR_SCH_PROCESS rdsp
        LEFT JOIN jsres_power_cfg cfg2 ON cfg2.record_status = 'Y'
        AND cfg2.cfg_code =
        ('jsres_doctor_data_time_' ||
        rdsp.USER_FLOW)
        WHERE rdsp.record_status = 'Y'
        <if test="teacherUserFlow!=null and teacherUserFlow!=''">
            and rdsp.TEACHER_USER_FLOW = #{teacherUserFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.dept_flow = #{deptFlow}
        </if>

        <if test="biaoJi!=null and biaoJi!=''">
            <if test="dataType=='fiveData'">
                and (
                exists(
                select null
                from res_rec_campaign_registry rr
                where rr.RECORD_STATUS='Y'
                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                and rr.AUDIT_STATUS_ID is null
                ) or exists(
                select null
                from res_rec_case_registry rr
                where rr.RECORD_STATUS='Y'
                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                and rr.AUDIT_STATUS_ID is null
                ) or exists(
                select null
                from res_rec_disease_registry rr
                where rr.RECORD_STATUS='Y'
                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                and rr.AUDIT_STATUS_ID is null
                ) or exists(
                select null
                from res_rec_operation_registry rr
                where rr.RECORD_STATUS='Y'
                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                and rr.AUDIT_STATUS_ID is null
                ) or exists(
                select null
                from res_rec_skill_registry rr
                where rr.RECORD_STATUS='Y'
                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                and rr.AUDIT_STATUS_ID is null
                )
                )
            </if>
            <if test="dataType=='skill'">
                and ( not exists(
                select null
                from RES_SCH_PROCESS_EXPRESS rr
                where rr.RECORD_STATUS='Y'
                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                and rr.rec_type_id in('DOPS')
                )
                or not exists(
                select null
                from RES_SCH_PROCESS_EXPRESS rr
                where rr.RECORD_STATUS='Y'
                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                and rr.rec_type_id in('Mini_CEX')
                )
                )
            </if>
            <if test="dataType=='after'">
                and  not exists(
                select null
                from RES_SCH_PROCESS_EXPRESS rr
                where rr.RECORD_STATUS='Y'
                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                and rr.rec_type_id='AfterEvaluation'
                )
            </if>
            <if test="dataType=='dayAttend'">
                and exists(
                SELECT 1 FROM sys_date_info sdi
                left join jsres_attendance ja
                on sdi.date_day=ja.attend_date
                and ja.record_status='Y'
                and doctor_flow=rdsp.user_flow
                where date_day <![CDATA[ <= ]]> rdsp.sch_end_date
                and date_day >= rdsp.sch_start_date
                and (ja.AUDIT_STATUS_ID ='Auditing' or ja.AUDIT_STATUS_ID is null)
                )
            </if>
        </if>
        <if test="biaoJi==null or biaoJi==''">
            <if test="dataType=='skill'">
                and  exists(
                select null
                from RES_SCH_PROCESS_EXPRESS rr
                where rr.RECORD_STATUS='Y'
                and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                and rr.rec_type_id in('DOPS','Mini_CEX')
                )
            </if>
        </if>
        ) a ON A.USER_FLOW =SU.USER_FLOW
        WHERE su.record_status = 'Y'
        AND rd.record_status = 'Y'
        and su.user_flow != #{teacherUserFlow}

        <if test="biaoJi!=null and biaoJi!=''and biaoJi=='Y'.toString()">
            <if test="dataType=='docEval'">
                and a.evl_count!=a.evled_count
            </if>
        </if>
        <if test="biaoJi!=null and biaoJi!=''and biaoJi=='N'.toString()">
            <if test="dataType=='docEval'">
                and a.evled_count>0
            </if>
        </if>
        <if test="userName!=null and userName!=''">
            <bind name="name" value="'%'+userName+'%'"/>
            and su.USER_NAME like #{name}
        </if>
        <if test="studentName!=null and studentName!=''">
            <bind name="name" value="'%'+studentName+'%'"/>
            and su.USER_NAME like #{name}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            and rd.training_type_id = #{trainingTypeId}
        </if>
        <if test="trainingSpeId!=null and trainingSpeId!=''">
            and rd.training_spe_id = #{trainingSpeId}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rd.doctor_flow = #{doctorFlow}
        </if>
        <if test="doctorTypeId!=null and doctorTypeId!=''">
            and rd.doctor_Type_Id = #{doctorTypeId}
        </if>
        <if test="deptMentFlow!=null and deptMentFlow!=''">
            and rd.DEPART_MENT_FLOW = #{deptMentFlow}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number = #{sessionNumber}
        </if>
        AND rd.DOCTOR_TYPE_ID IN
        ('Company', 'Social', 'Graduate', 'CompanyEntrust')
        AND a.APP_MENU_FLAG = 'Passed'
        AND (a.SCH_START_DATE <![CDATA[ <= ]]> A.power_start_time AND
        a.SCH_END_DATE >= A.power_END_time OR
        a.SCH_START_DATE >= A.power_start_time AND
        a.SCH_START_DATE <![CDATA[ <= ]]> A.power_END_time OR
        a.SCH_END_DATE >= A.power_start_time AND
        a.SCH_END_DATE <![CDATA[ <= ]]> A.power_END_time)
        GROUP BY rd.doctor_flow,rd.doctor_name,rd.session_number,rd.training_spe_id,rd.training_spe_name,rd.doctor_type_id,rd.work_org_name,su.user_phone,su.user_head_img
        ORDER BY rd.session_number DESC, rd.training_spe_id, rd.doctor_flow
    </select>

    <resultMap type="HashMap" id="dataNoAuditMap">
        <result column="oper_user_flow" javaType="string" property="doctorFlow"/>
        <result column="oper_user_name" javaType="string" property="doctorName"/>
        <result column="process_flow" javaType="string" property="processFlow"/>
        <result column="rec_type_id" javaType="string" property="recTypeId"/>
        <result column="rec_type_name" javaType="string" property="recTypeName"/>
        <result column="num" javaType="string" property="notAuditNum"/>
        <result column="rec_flow" javaType="string" property="recFlow"/>
    </resultMap>
    <select id="findSkillNoAudit" parameterType="java.util.Map" resultMap="dataNoAuditMap">
        SELECT a.oper_user_flow,RR.OPER_USER_NAME,a.process_flow, a.rec_type_id, rr.rec_flow
          FROM (
            <if test="recTypes!=null and recTypes.size>0">
                <foreach collection="recTypes" item="item" index="index" separator=" UNION ALL " >
                    SELECT #{docFlow} oper_user_flow,#{processFlow} PROCESS_FLOW ,#{item} REC_TYPE_ID FROM DUAL
                </foreach>
            </if>
          ) a
           left join
          RES_SCH_PROCESS_EXPRESS rr on rr.process_flow=a.process_flow
         and rr.rec_type_id = a.rec_type_id
         and rr.oper_user_flow=a.oper_user_flow
         and rr.record_status='Y'
        where a.oper_user_flow=#{docFlow}
        <if test="biaoJi!=null and biaoJi!=''">
         and rr.rec_flow is null
        </if>
        <if test="biaoJi==null or biaoJi==''">
         and rr.rec_flow is not null
        </if>
    </select>
    <resultMap id="absenceMap" type="hashmap" extends="com.pinde.sci.dao.base.SchDoctorAbsenceMapper.BaseResultMap">
        <result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
        <result column="user_Head_Img" property="userHeadImg" jdbcType="VARCHAR" />
    </resultMap>
    <select id="getAbsenceList" resultMap="absenceMap">
        SELECT ABSENCE.*,u.user_name,u.user_Head_Img
        FROM SCH_DOCTOR_ABSENCE ABSENCE
        LEFT JOIN SYS_USER U
        ON ABSENCE.DOCTOR_FLOW=U.USER_FLOW
        WHERE ABSENCE.RECORD_STATUS='Y'
        AND IS_REGISTER='N'
        AND ABSENCE.ORG_FLOW=#{orgFlow}
        AND ABSENCE.TEACHER_FLOW=#{userFlow}
        <if test='isAudit!=null and isAudit!="" and isAudit=="Y".toString()'>
           AND TEACHER_AGREE_FLAG IS NULL
        </if>
        <if test='isAudit!=null and isAudit!="" and isAudit=="N".toString()'>
           AND TEACHER_AGREE_FLAG IS NOT NULL
        </if>
        <if test='isAbsence!=null and isAbsence!="" and isAbsence=="Y".toString()'>
           AND REPEAL_ABSENCE ='Y'
           AND REPEAL_ABSENCE_DAY IS NULL
        </if>
        <if test='isAbsence!=null and isAbsence!="" and isAbsence=="N".toString()'>
            AND REPEAL_ABSENCE ='Y'
            AND REPEAL_ABSENCE_DAY IS NOT NULL
        </if>
        <if test='Audited!=null and Audited!="" and Audited=="Y".toString()'>
            AND (
              TEACHER_AGREE_FLAG IS NOT NULL
              or REPEAL_ABSENCE_DAY IS NOT NULL
            )
        </if>
            <if test="userName!=null and userName!=''">
                <bind name="name" value="'%'+userName+'%'"/>
                and U.USER_NAME like #{name}
            </if>
            <if test="speId!=null and speId!=''">
                and ABSENCE.TRAINING_SPE_ID = #{speId}
            </if>
            <if test="sessionNumber!=null and sessionNumber!=''">
                and ABSENCE.session_number = #{sessionNumber}
            </if>
        ORDER BY START_DATE DESC,U.USER_NAME
    </select>
    <select id="getSpeAbsenceList" resultMap="absenceMap">
        SELECT ABSENCE.*,u.user_name,u.user_Head_Img
        FROM SCH_DOCTOR_ABSENCE ABSENCE
        LEFT JOIN SYS_USER U
        ON ABSENCE.DOCTOR_FLOW=U.USER_FLOW
        WHERE ABSENCE.RECORD_STATUS='Y'
        AND IS_REGISTER='N'
        AND ABSENCE.ORG_FLOW=#{orgFlow}
        AND EXISTS(SELECT 1 FROM SYS_USER WHERE TRAINING_SPE_ID=RES_TRAINING_SPE_ID AND USER_FLOW=#{userFlow} )
        AND TEACHER_AGREE_FLAG IS  NOT NULL
        <if test='isAudit!=null and isAudit!="" and isAudit=="Y".toString()'>
            AND HEAD_AGREE_FLAG IS NULL
        </if>
        <if test='isAudit!=null and isAudit!="" and isAudit=="N".toString()'>
           AND HEAD_AGREE_FLAG IS NOT NULL
        </if>
        <if test='isAbsence!=null and isAbsence!="" and isAbsence=="Y".toString()'>
           AND REPEAL_ABSENCE ='Y'
           AND REPEAL_ABSENCE_DAY IS NULL
        </if>
        <if test='isAbsence!=null and isAbsence!="" and isAbsence=="N".toString()'>
            AND REPEAL_ABSENCE ='Y'
            AND REPEAL_ABSENCE_DAY IS NOT NULL
        </if>
        <if test='Audited!=null and Audited!="" and Audited=="Y".toString()'>
            AND (
              HEAD_AGREE_FLAG IS NOT NULL
            )
        </if>
            <if test="userName!=null and userName!=''">
                <bind name="name" value="'%'+userName+'%'"/>
                and U.USER_NAME like #{name}
            </if>
            <if test="speId!=null and speId!=''">
                and ABSENCE.TRAINING_SPE_ID = #{speId}
            </if>
            <if test="sessionNumber!=null and sessionNumber!=''">
                and ABSENCE.session_number = #{sessionNumber}
            </if>
        ORDER BY START_DATE DESC,U.USER_NAME
    </select>
    <select id="absenceCountDetail" resultType="hashmap">
      select absence_type_id ,count(1) qty from (
        SELECT a.*,
           nvl((select case
                     when day_time = 'M01' then
                      M01
                     when day_time = 'M02' then
                      M02
                     when day_time = 'M03' then
                      M03
                     when day_time = 'M04' then
                      M04
                     when day_time = 'M05' then
                      M05
                     when day_time = 'M06' then
                      M06
                     when day_time = 'M07' then
                      M07
                     when day_time = 'M08' then
                      M08
                     when day_time = 'M09' then
                      M09
                     when day_time = 'M10' then
                      M10
                     when day_time = 'M11' then
                      M11
                     when day_time = 'M12' then
                      M12
                     when day_time = 'M13' then
                      M13
                     when day_time = 'M14' then
                      M14
                     when day_time = 'M15' then
                      M15
                     when day_time = 'M16' then
                      M16
                     when day_time = 'M17' then
                      M17
                     when day_time = 'M18' then
                      M18
                     when day_time = 'M19' then
                      M19
                     when day_time = 'M20' then
                      M20
                     when day_time = 'M21' then
                      M21
                     when day_time = 'M22' then
                      M22
                     when day_time = 'M23' then
                      M23
                     when day_time = 'M24' then
                      M24
                     when day_time = 'M25' then
                      M25
                     when day_time = 'M26' then
                      M26
                     when day_time = 'M27' then
                      M27
                     when day_time = 'M28' then
                      M28
                     when day_time = 'M29' then
                      M29
                     when day_time = 'M30' then
                      M30
                     when day_time = 'M31' then
                      M31
                     else
                      ''
                   end
              from ZSEY_HR_KQ_MONTH
             where record_status = 'Y'
               and KQ_DATE = month_time
               and user_flow =#{flow}),'00') absence_type_id
      FROM (SELECT level AS flow,
                   to_char(to_date(#{startDate}, 'yyyy-mm-dd') + level - 1,
                           'yyyy-mm-dd') AS date_time,
                   to_char(to_date(#{startDate}, 'yyyy-mm-dd') + level - 1,
                           'yyyy-mm') month_time,
                   'M' ||
                   to_char(to_date(#{startDate}, 'yyyy-mm-dd') + level - 1, 'dd') day_time
              FROM dual
            CONNECT BY level <![CDATA[<=]]> to_date(#{endDate}, 'yyyy-mm-dd') -
                       to_date(#{startDate}, 'yyyy-mm-dd') + 1) A)b
                  group by absence_type_id
    </select>
    <select id="absenceCount" resultType="int">
      select count(1) from (
        SELECT a.*,
           (select case
                     when day_time = 'M01' then
                      M01
                     when day_time = 'M02' then
                      M02
                     when day_time = 'M03' then
                      M03
                     when day_time = 'M04' then
                      M04
                     when day_time = 'M05' then
                      M05
                     when day_time = 'M06' then
                      M06
                     when day_time = 'M07' then
                      M07
                     when day_time = 'M08' then
                      M08
                     when day_time = 'M09' then
                      M09
                     when day_time = 'M10' then
                      M10
                     when day_time = 'M11' then
                      M11
                     when day_time = 'M12' then
                      M12
                     when day_time = 'M13' then
                      M13
                     when day_time = 'M14' then
                      M14
                     when day_time = 'M15' then
                      M15
                     when day_time = 'M16' then
                      M16
                     when day_time = 'M17' then
                      M17
                     when day_time = 'M18' then
                      M18
                     when day_time = 'M19' then
                      M19
                     when day_time = 'M20' then
                      M20
                     when day_time = 'M21' then
                      M21
                     when day_time = 'M22' then
                      M22
                     when day_time = 'M23' then
                      M23
                     when day_time = 'M24' then
                      M24
                     when day_time = 'M25' then
                      M25
                     when day_time = 'M26' then
                      M26
                     when day_time = 'M27' then
                      M27
                     when day_time = 'M28' then
                      M28
                     when day_time = 'M29' then
                      M29
                     when day_time = 'M30' then
                      M30
                     when day_time = 'M31' then
                      M31
                     else
                      ''
                   end
              from ZSEY_HR_KQ_MONTH
             where record_status = 'Y'
               and KQ_DATE = month_time
               and user_flow =#{flow}) absence_type_id
      FROM (SELECT level AS flow,
                   to_char(to_date(#{startDate}, 'yyyy-mm-dd') + level - 1,
                           'yyyy-mm-dd') AS date_time,
                   to_char(to_date(#{startDate}, 'yyyy-mm-dd') + level - 1,
                           'yyyy-mm') month_time,
                   'M' ||
                   to_char(to_date(#{startDate}, 'yyyy-mm-dd') + level - 1, 'dd') day_time
              FROM dual
            CONNECT BY level <![CDATA[<=]]> to_date(#{endDate}, 'yyyy-mm-dd') -
                       to_date(#{startDate}, 'yyyy-mm-dd') + 1) A)b
            where nvl(absence_type_id,'00') !='00'
    </select>
    <select id="schDeptDoctorSchProcess" resultMap="processUserMap">
        SELECT
        DISTINCT
        RDSP.USER_FLOW,
        sar.dept_flow,
        SU.USER_NAME,
        SU.USER_HEAD_IMG
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join sch_arrange_result sar
        on rdsp.sch_result_flow = sar.result_flow
        left join res_doctor_recruit rdr
        on (rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW and rdr.RECORD_STATUS = 'Y' and
        sar.session_number = rdr.SESSION_NUMBER and
        rdr.AUDIT_STATUS_ID = 'Passed')
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rdsp.user_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        left join jsres_power_cfg cfg2
        on cfg2.record_status = 'Y'
        and cfg2.cfg_code = 'jsres_doctor_data_time_' || rd.doctor_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and sar.record_status = 'Y'
        <if test='deptFlow!=null and deptFlow!=""'>
            and rdsp.DEPT_FLOW=#{deptFlow}
        </if>
        <if test='searchStr!=null and searchStr!=""'>
            and (
            rd.session_number like CONCAT(CONCAT('%', #{searchStr}),'%')
            OR su.USER_NAME like CONCAT(CONCAT('%', #{searchStr}),'%')
            )
        </if>
        <if test='typeId!=null and typeId!=""'>
            <if test="typeId=='allDoc'">

            </if>
            <if test="typeId=='monthCurrent'">
                and SUBSTR(rdsp.SCH_START_DATE,0,7) <![CDATA[<=]]>to_char(sysdate,'yyyy-MM')
                and SUBSTR(rdsp.SCH_END_DATE,0,7) <![CDATA[>=]]>to_char(sysdate,'yyyy-MM')
            </if>
            <if test="typeId=='monthSch'">
                and SUBSTR(rdsp.SCH_END_DATE,0,7) = to_char(sysdate,'yyyy-MM')
            </if>
            <if test="typeId=='waitSch'">
                <if test='yearMonth!=null and yearMonth!=""'>
                    and SUBSTR(rdsp.SCH_START_DATE,0,7) = #{yearMonth}
                </if>
            </if>
            <if test="typeId=='errorSch'">
                and rdsp.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and not exists(
                select 1 from res_sch_process_express e
                where e.process_flow=rdsp.process_flow
                and e.record_status='Y' and e.rec_type_id='AfterEvaluation' and (MANAGER_AUDIT_USER_FLOW is null or MANAGER_AUDIT_USER_FLOW is not null and head_audit_status_id is not null)
                )
            </if>
        </if>
        ORDER BY RDSP.DEPT_FLOW DESC
    </select>

    <resultMap id="docOrgHistoryExtMap" type="com.pinde.res.model.jswjw.mo.JsResDoctorOrgHistoryExt"
               extends="com.pinde.sci.dao.base.ResDoctorOrgHistoryMapper.BaseResultMap">
        <association property="resDoctor" javaType="com.pinde.core.model.ResDoctor">
            <id column="doctorFlow" jdbcType="VARCHAR" property="doctorFlow"/>
            <result column="doctorName" jdbcType="VARCHAR" property="doctorName"/>
            <result column="dsessionNumber" jdbcType="VARCHAR" property="sessionNumber"/>
            <result column="dtrainingSpeName" jdbcType="VARCHAR" property="trainingSpeName"/>
        </association>
        <association property="sysUser" javaType="com.pinde.core.model.SysUser">
            <id column="user_Flow" jdbcType="VARCHAR" property="userFlow"/>
            <result column="USER_HEAD_IMG" jdbcType="VARCHAR" property="userHeadImg"/>
            <result column="user_name" jdbcType="VARCHAR" property="userName"/>
        </association>
    </resultMap>
    <select id="getSpeChangeList" resultMap="docOrgHistoryExtMap">
        SELECT doh.*,
        d.DOCTOR_FLOW doctorFlow, d.DOCTOR_NAME doctorName, d.SESSION_NUMBER dsessionNumber,d.TRAINING_SPE_NAME
        dtrainingSpeName,
        su.user_flow,su.user_name,su.USER_HEAD_IMG
        from pdsci.RES_DOCTOR_ORG_HISTORY doh, pdsci.RES_DOCTOR d,sys_user su
        where doh.DOCTOR_FLOW = d.DOCTOR_FLOW
        and d.doctor_flow=su.user_flow
        and su.record_status='Y'
        and doh.RECORD_STATUS = 'Y'
        and d.RECORD_STATUS = 'Y'
        <if test="typeId == null or typeId ==''">
            AND (doh.ORG_FLOW = #{orgFlow}
            or doh.HISTORY_ORG_FLOW = #{orgFlow})
        </if>
        <if test="typeId =='changeIn'">
            AND doh.ORG_FLOW = #{orgFlow}
        </if>
        <if test="typeId =='changeOut'">
            AND doh.HISTORY_ORG_FLOW = #{orgFlow}
        </if>

        <if test="sessionNumber!=null and sessionNumber!=''">
            AND d.SESSION_NUMBER= #{sessionNumber}
        </if>
        <if test="changeTypeId!=null and changeTypeId!=''">
            and doh.CHANGE_TYPE_ID = #{changeTypeId}
        </if>
        <if test="changeStatusIdList!=null">
            and doh.CHANGE_STATUS_ID in
            <foreach collection="changeStatusIdList" open="(" separator="," close=")" item="item">#{item}</foreach>
        </if>
        order by doh.CREATE_TIME DESC
    </select>

    <resultMap type="HashMap" id="docCountMap">
        <result property="key" column="KEY" javaType="string"/>
        <result property="value" column="NUM" javaType="java.lang.Integer"/>
    </resultMap>
    <select id="getOrgSpeDocNum" resultMap="docCountMap">
		select CAT_SPE_ID||SPE_ID KEY,count(*) NUM
		from RES_DOCTOR_RECRUIT
		where RECORD_STATUS = 'Y'
			and RES_DOCTOR_RECRUIT.session_Number = #{sessionNumber}
			AND RES_DOCTOR_RECRUIT.cat_spe_id in ( 'DoctorTrainingSpe','AssiGeneral')
			AND RES_DOCTOR_RECRUIT.AUDIT_STATUS_ID = 'Passed'
			and RES_DOCTOR_RECRUIT.ORG_FLOW = #{orgFlow}
			and exists(
			select doctor_flow from RES_DOCTOR
			WHERE RES_DOCTOR.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
			and RES_DOCTOR_RECRUIT.doctor_flow =RES_DOCTOR.doctor_flow
			)
			and exists(
				select 1 from Res_Org_Spe
				where record_status='Y'
				and org_flow=#{orgFlow}
				and spe_type_id in ( 'DoctorTrainingSpe','AssiGeneral')
				and RES_DOCTOR_RECRUIT.spe_id=Res_Org_Spe.spe_id
			)
		group BY CAT_SPE_ID,SPE_ID
	</select>
    <select id="schDoctorSchProcessQuery" parameterType="java.util.Map" resultMap="processUserMap">
        select a.* from
        (select rdsp.PROCESS_FLOW,
        rdsp.USER_FLOW,
        rdsp.ORG_FLOW,
        rdsp.ORG_NAME,
        rdsp.DEPT_FLOW,
        rdsp.DEPT_NAME,
        rdsp.SCH_DEPT_FLOW,
        rdsp.SCH_DEPT_NAME,
        rdsp.SCH_RESULT_FLOW,
        rdsp.SCH_START_DATE,
        rdsp.SCH_END_DATE,
        rdsp.TEACHER_USER_FLOW,
        rdsp.TEACHER_USER_NAME,
        rdsp.HEAD_USER_FLOW,
        rdsp.HEAD_USER_NAME,
        rdsp.SCH_FLAG,
        rdsp.SCH_SCORE,
        rdsp.IS_CURRENT_FLAG ,
        su.USER_Name,
        su.USER_HEAD_IMG,
        rd.DOCTOR_TYPE_ID,
        nvl((select CFG_VALUE from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code =
        'jsres_doctor_app_menu_'||rd.doctor_flow),'N')APP_MENU_FLAG,
        nvl(cfg2.power_start_time,'0000-00-00') power_start_time, nvl(cfg2.power_end_time,'9999-99-99') power_end_time
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rd.doctor_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        left join jsres_power_cfg cfg2
        on cfg2.record_status='Y' and cfg2.cfg_code = 'jsres_doctor_data_time_'||rd.doctor_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        <if test="teacherUserFlow!=null and teacherUserFlow!=''">
            and rdsp.TEACHER_USER_FLOW = #{teacherUserFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW = #{deptFlow}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW = #{doctorFlow}
        </if>
        <if test="schStartDate!=null and schStartDate!=''">
            and rdsp.SCH_START_DATE <![CDATA[>=]]> #{schStartDate}
        </if>
        <if test="schEndDate!=null and schEndDate!=''">
            and rdsp.SCH_END_DATE <![CDATA[<=]]> #{schEndDate}
        </if>
        <if test="userName!=null and userName!=''">
            <bind name="name" value="'%'+userName+'%'"/>
            and su.USER_NAME like #{name}
        </if>
        <if test="biaoJi!=null and biaoJi!=''">
            and (
            exists(
            select null
            from res_rec rr
            where rr.RECORD_STATUS='Y'
            and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
            and rr.AUDIT_STATUS_ID is null
            )
            )
        </if>
        ) a
        where
        a.APP_MENU_FLAG='Y'
        AND ( ( a.SCH_START_DATE  <![CDATA[ <= ]]> A.power_start_time AND a.SCH_END_DATE >= A.power_END_time)
        or (a.SCH_START_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_START_DATE <![CDATA[ <= ]]>A.power_END_time)
        or (a.SCH_END_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_END_DATE <![CDATA[ <= ]]>A.power_END_time))
        <!--(
            (A.DOCTOR_TYPE_ID !='Graduate' AND A.STU_JD_GC='Y')
            OR
            (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='Y')
            OR
            (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='N' AND A.STU_JD_GC='Y' AND A.STU_JDZS_GC='Y')
        )-->
        ORDER BY a.process_flow DESC
    </select>

    <select id="schDoctorSchProcessQuery1" parameterType="java.util.Map" resultMap="processUserMap">
        select a.* from
        (select rdsp.PROCESS_FLOW,
        rdsp.USER_FLOW,
        rdsp.ORG_FLOW,
        rdsp.ORG_NAME,
        rdsp.DEPT_FLOW,
        rdsp.DEPT_NAME,
        rdsp.SCH_DEPT_FLOW,
        rdsp.SCH_DEPT_NAME,
        rdsp.SCH_RESULT_FLOW,
        rdsp.SCH_START_DATE,
        rdsp.SCH_END_DATE,
        rdsp.TEACHER_USER_FLOW,
        rdsp.TEACHER_USER_NAME,
        rdsp.HEAD_USER_FLOW,
        rdsp.HEAD_USER_NAME,
        rdsp.SCH_FLAG,
        rdsp.SCH_SCORE,
        rdsp.IS_CURRENT_FLAG ,
        su.USER_Name,
        su.USER_HEAD_IMG,
        rd.DOCTOR_TYPE_ID,
        nvl((select CFG_VALUE from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code =
        'jsres_doctor_app_menu_'||rd.doctor_flow),'N')APP_MENU_FLAG,
        nvl(cfg2.power_start_time,'0000-00-00') power_start_time, nvl(cfg2.power_end_time,'9999-99-99') power_end_time
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rd.doctor_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        left join jsres_power_cfg cfg2
        on cfg2.record_status='Y' and cfg2.cfg_code = 'jsres_doctor_data_time_'||rd.doctor_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        <if test="teacherUserFlow!=null and teacherUserFlow!=''">
            and rdsp.TEACHER_USER_FLOW = #{teacherUserFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW = #{deptFlow}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW = #{doctorFlow}
        </if>
        <if test="schStartDate!=null and schStartDate!=''">
            and rdsp.SCH_START_DATE <![CDATA[>=]]> #{schStartDate}
        </if>
        <if test="schEndDate!=null and schEndDate!=''">
            and rdsp.SCH_END_DATE <![CDATA[<=]]> #{schEndDate}
        </if>
        <if test="userName!=null and userName!=''">
            <bind name="name" value="'%'+userName+'%'"/>
            and su.USER_NAME like #{name}
        </if>
        <if test="biaoJi!=null and biaoJi!=''">
            and (
            exists(
            select null
            from res_rec_campaign_registry rr
            where rr.RECORD_STATUS='Y'
            and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
            and rr.AUDIT_STATUS_ID is null
            ) or exists(
            select null
            from res_rec_case_registry rr
            where rr.RECORD_STATUS='Y'
            and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
            and rr.AUDIT_STATUS_ID is null
            ) or exists(
            select null
            from res_rec_disease_registry rr
            where rr.RECORD_STATUS='Y'
            and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
            and rr.AUDIT_STATUS_ID is null
            ) or exists(
            select null
            from res_rec_operation_registry rr
            where rr.RECORD_STATUS='Y'
            and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
            and rr.AUDIT_STATUS_ID is null
            ) or exists(
            select null
            from res_rec_skill_registry rr
            where rr.RECORD_STATUS='Y'
            and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
            and rr.AUDIT_STATUS_ID is null
            )
            )
        </if>
        ) a
        where
        a.APP_MENU_FLAG='Y'
        AND ( ( a.SCH_START_DATE  <![CDATA[ <= ]]> A.power_start_time AND a.SCH_END_DATE >= A.power_END_time)
        or (a.SCH_START_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_START_DATE <![CDATA[ <= ]]>A.power_END_time)
        or (a.SCH_END_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_END_DATE <![CDATA[ <= ]]>A.power_END_time))
        <!--(
            (A.DOCTOR_TYPE_ID !='Graduate' AND A.STU_JD_GC='Y')
            OR
            (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='Y')
            OR
            (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='N' AND A.STU_JD_GC='Y' AND A.STU_JDZS_GC='Y')
        )-->
        ORDER BY a.process_flow DESC
    </select>

    <select id="schDoctorSchProcessDayAttend" parameterType="java.util.Map" resultMap="processUserMap">
        select a.* from
        (select rdsp.PROCESS_FLOW,
        rdsp.USER_FLOW,
        rdsp.ORG_FLOW,
        rdsp.ORG_NAME,
        rdsp.DEPT_FLOW,
        rdsp.DEPT_NAME,
        rdsp.SCH_DEPT_FLOW,
        rdsp.SCH_DEPT_NAME,
        rdsp.SCH_RESULT_FLOW,
        rdsp.SCH_START_DATE,
        rdsp.SCH_END_DATE,
        rdsp.TEACHER_USER_FLOW,
        rdsp.TEACHER_USER_NAME,
        rdsp.HEAD_USER_FLOW,
        rdsp.HEAD_USER_NAME,
        rdsp.SCH_FLAG,
        rdsp.SCH_SCORE,
        rdsp.IS_CURRENT_FLAG ,
        su.USER_Name,
        su.USER_HEAD_IMG,
        rd.DOCTOR_TYPE_ID,
        nvl((select check_status_id from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code =
        'jsres_doctor_attendance_'||rd.doctor_flow),'N')APP_MENU_FLAG,
        nvl(cfg2.power_start_time,'0000-00-00') power_start_time, nvl(cfg2.power_end_time,'9999-99-99') power_end_time
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rd.doctor_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        left join jsres_power_cfg cfg2
        on cfg2.record_status='Y' and cfg2.cfg_code = 'jsres_doctor_data_time_'||rd.doctor_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        <if test="teacherUserFlow!=null and teacherUserFlow!=''">
            and rdsp.TEACHER_USER_FLOW = #{teacherUserFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.DEPT_FLOW = #{deptFlow}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW = #{doctorFlow}
        </if>
        <if test="schStartDate!=null and schStartDate!=''">
            and rdsp.SCH_START_DATE <![CDATA[>=]]> #{schStartDate}
        </if>
        <if test="schEndDate!=null and schEndDate!=''">
            and rdsp.SCH_END_DATE <![CDATA[<=]]> #{schEndDate}
        </if>
        <if test="userName!=null and userName!=''">
            <bind name="name" value="'%'+userName+'%'"/>
            and su.USER_NAME like #{name}
        </if>
        <if test="biaoJi!=null and biaoJi!=''">
            and exists(
                SELECT 1 FROM sys_date_info sdi
                left join jsres_attendance ja
                on sdi.date_day=ja.attend_date
                and ja.record_status='Y'
                and ja.doctor_flow=rdsp.user_flow
                where date_day <![CDATA[ <= ]]> rdsp.sch_end_date
                and date_day >= rdsp.sch_start_date
                and (ja.AUDIT_STATUS_ID ='Auditing' or ja.AUDIT_STATUS_ID is null)
            )
        </if>
        ) a
        where
        a.APP_MENU_FLAG='Passed'
        AND ( ( a.SCH_START_DATE  <![CDATA[ <= ]]> A.power_start_time AND a.SCH_END_DATE >= A.power_END_time)
        or (a.SCH_START_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_START_DATE <![CDATA[ <= ]]>A.power_END_time)
        or (a.SCH_END_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_END_DATE <![CDATA[ <= ]]>A.power_END_time))
        ORDER BY a.process_flow DESC
    </select>

    <resultMap type="HashMap" id="dayAttendMap">
        <result column="USER_FLOW" javaType="string" property="userFlow"></result>
        <result column="PROCESS_FLOW" javaType="string" property="processFlow"></result>
        <result column="TEACHER_REMARKS" javaType="string" property="remarks"></result>
        <result column="SCH_START_DATE" javaType="string" property="schStartDate"></result>
        <result column="SCH_END_DATE" javaType="string" property="schEndDate"></result>
        <result column="DATE_DAY" javaType="string" property="dateDay"></result>
        <result column="ATTENDANCE_FLOW" javaType="string" property="attendanceFlow"></result>
        <result column="ATTEND_STATUS" javaType="string" property="attendStatus"></result>
        <result column="ATTEND_STATUS_NAME" javaType="string" property="attendStatusName"></result>
        <result column="AUDIT_STATUS_ID" javaType="string" property="auditStatusId"></result>
        <result column="AUDIT_STATUS_NAME" javaType="string" property="auditStatusName"></result>
        <result column="ATTEND_TIME" javaType="string" property="attendTime"></result>
        <result column="ATTEND_LOCAL" javaType="string" property="attendLocal"></result>
    </resultMap>
    <select id="dayAttendList" parameterType="java.util.Map" resultMap="dayAttendMap">
        select *
        from (
        SELECT RDSP.USER_FLOW,
        RDSP.PROCESS_FLOW,
        RDSP.SCH_START_DATE,
        RDSP.SCH_END_DATE,
        SDI.DATE_DAY,
        JA.ATTENDANCE_FLOW,
        JA.ATTEND_STATUS,
        JA.ATTEND_STATUS_NAME,
        JA.AUDIT_STATUS_ID,
        JA.AUDIT_STATUS_NAME,
        JA.TEACHER_REMARKS,
        JAD.ATTEND_TIME,
        JAD.ATTEND_LOCAL,
        ROW_NUMBER() OVER(PARTITION BY RDSP.USER_FLOW,DATE_DAY ORDER BY ATTEND_TIME DESC) rn
        FROM RES_DOCTOR_SCH_PROCESS RDSP
        LEFT JOIN SYS_DATE_INFO SDI ON SDI.RECORD_STATUS = 'Y'
        AND DATE_DAY  <![CDATA[<=]]> RDSP.SCH_END_DATE
        AND DATE_DAY >= RDSP.SCH_START_DATE
        <if test="nowDate!=null and nowDate!=''">
            AND DATE_DAY <![CDATA[<=]]>#{nowDate}
        </if>
        LEFT JOIN JSRES_ATTENDANCE JA ON SDI.DATE_DAY = JA.ATTEND_DATE
        AND JA.RECORD_STATUS = 'Y'
        AND JA.DOCTOR_FLOW = RDSP.USER_FLOW
        LEFT JOIN JSRES_ATTENDANCE_DETAIL JAD ON JAD.ATTENDANCE_FLOW =
        JA.ATTENDANCE_FLOW and jad.record_status='Y'
        WHERE RDSP.RECORD_STATUS = 'Y'
        <if test="processFlow!=null and processFlow!=''">
            and rdsp.process_flow =#{processFlow}
        </if>
        <if test="attendType!=null and attendType!=''">
            <if test="attendType=='0'.toString()">
                and (JA.ATTEND_STATUS = '0' OR JA.ATTEND_STATUS IS NULL)
            </if>
            <if test="attendType!='0'.toString()">
                and (JA.ATTEND_STATUS = #{attendType})
            </if>
        </if>
        <if test="biaoJi!=null and biaoJi!=''">
          and (JA.AUDIT_STATUS_ID = 'Auditing' OR JA.AUDIT_STATUS_ID IS NULL)
        </if>
        )
        where rn = 1
        ORDER BY DATE_DAY DESC
    </select>

    <select id="searchProcessByDoctor" resultMap="com.pinde.sci.dao.base.ResDoctorSchProcessMapper.BaseResultMap">
        SELECT RDSP.*
        FROM PDSCI.RES_DOCTOR_SCH_PROCESS RDSP,PDSCI.RES_DOCTOR RD
        WHERE RDSP.RECORD_STATUS = 'Y'
        AND RD.RECORD_STATUS = 'Y'
        AND RDSP.USER_FLOW = RD.DOCTOR_FLOW
        <if test="doctor!=null">
            <if test='doctor.doctorName!=null and doctor.doctorName!=""'>
                AND RD.DOCTOR_NAME LIKE CONCAT(CONCAT('%', #{doctor.doctorName}),'%')
            </if>
            <if test='doctor.trainingSpeId!=null and doctor.trainingSpeId!=""'>
                AND RD.TRAINING_SPE_ID = #{doctor.trainingSpeId}
            </if>
            <if test='doctor.sessionNumber!=null and doctor.sessionNumber!=""'>
                AND RD.SESSION_NUMBER = #{doctor.sessionNumber}
            </if>
        </if>
        <if test="process!=null">
            <if test='process.teacherUserFlow!=null and process.teacherUserFlow!=""'>
                AND RDSP.TEACHER_USER_FLOW = #{process.teacherUserFlow}
            </if>
            <if test='process.headUserFlow!=null and process.headUserFlow!=""'>
                AND RDSP.HEAD_USER_FLOW = #{process.headUserFlow}
            </if>
            <if test='process.isCurrentFlag!=null and process.isCurrentFlag!=""'>
                AND RDSP.IS_CURRENT_FLAG = #{process.isCurrentFlag}
            </if>
            <if test='process.startDate!=null and process.startDate!=""'>
                AND RDSP.START_DATE >= #{process.startDate}
            </if>
            <if test='process.endDate!=null and process.endDate!=""'>
                AND RDSP.START_DATE <![CDATA[<]]>= #{process.endDate}
            </if>
            <if test='process.schDeptFlow!=null and process.schDeptFlow!=""'>
                AND RDSP.SCH_DEPT_FLOW = #{process.schDeptFlow}
            </if>
        </if>
        <if test='roleFlagMap!=null'>
            <if test='roleFlagMap.roleFlag!=null and roleFlagMap.roleFlag!="" and roleFlagMap.val!=null and roleFlagMap.val!=""'>
                <if test='roleFlagMap.roleFlag=="head"'>
                    AND ( RDSP.SCH_DEPT_FLOW IN (
                    SELECT SCH_DEPT_FLOW
                    FROM PDSCI.SCH_DEPT
                    WHERE RECORD_STATUS = 'Y'
                    AND DEPT_FLOW IN (
                    SELECT DEPT_FLOW
                    FROM SYS_USER_DEPT
                    WHERE RECORD_STATUS = 'Y'
                    AND USER_FLOW = #{roleFlagMap.val}
                    )
                    ) or rdsp.head_user_flow=#{roleFlagMap.val} )
                </if>
                <if test='roleFlagMap.roleFlag=="manager"'>
                    AND RD.TRAINING_SPE_ID IN (
                    SELECT TRAINING_SPE_ID
                    FROM PDSCI.RES_USER_SPE
                    WHERE RECORD_STATUS = 'Y'
                    AND USER_FLOW = #{roleFlagMap.val}
                    )
                    AND RD.ORG_FLOW IN (
                    SELECT ORG_FLOW
                    FROM PDSCI.SYS_USER
                    WHERE USER_FLOW = #{roleFlagMap.val}
                    )
                </if>
                <if test='roleFlagMap.roleFlag=="admin"'>
                    AND RDSP.ORG_FLOW = #{roleFlagMap.val}
                </if>
            </if>
        </if>
    </select>

    <select id="searchTeachDept" resultType="string">
        SELECT DISTINCT SCH_DEPT_FLOW
        FROM PDSCI.RES_DOCTOR_SCH_PROCESS
        WHERE RECORD_STATUS = 'Y'
        <if test='userFlow!=null and userFlow!=""'>
            AND TEACHER_USER_FLOW = #{userFlow}
        </if>
    </select>

    <select id="searchRotationDoctor" resultType="string">
        SELECT DISTINCT USER_FLOW
        FROM PDSCI.RES_DOCTOR_SCH_PROCESS
        WHERE RECORD_STATUS = 'Y'
        AND USER_FLOW IN
        <foreach collection="doctorFlows" item="doctorFlow" open="(" separator="," close=")">
            #{doctorFlow}
        </foreach>
    </select>

    <select id="searchCurrentProcessByUserFlow"
            resultMap="com.pinde.sci.dao.base.ResDoctorSchProcessMapper.BaseResultMap">
        SELECT
        <!-- 		DISTINCT RDSP.PROCESS_FLOW, -->
        RDSP.*
        FROM PDSCI.RES_DOCTOR_SCH_PROCESS RDSP
        WHERE RDSP.RECORD_STATUS = 'Y'
        <if test='isCurrentFlag!=null and isCurrentFlag!=""'>
            AND RDSP.IS_CURRENT_FLAG = #{isCurrentFlag}
        </if>
        <if test='userFlow!=null and userFlow!=""'>
            AND EXISTS (
            SELECT NULL
            FROM SYS_USER_DEPT SUD,PDSCI.SCH_DEPT SD
            WHERE SUD.RECORD_STATUS = 'Y'
            AND SD.RECORD_STATUS = 'Y'
            AND SUD.DEPT_FLOW = SD.DEPT_FLOW
            AND SUD.USER_FLOW = #{userFlow}
            AND SD.SCH_DEPT_FLOW = RDSP.SCH_DEPT_FLOW
            )
        </if>
    </select>

    <select id="searchProcessByUserSpe" resultMap="com.pinde.sci.dao.base.ResDoctorSchProcessMapper.BaseResultMap">
        SELECT RDSP.*
        FROM PDSCI.RES_DOCTOR_SCH_PROCESS RDSP,PDSCI.RES_DOCTOR RD,PDSCI.RES_USER_SPE RUS
        WHERE RDSP.RECORD_STATUS = 'Y'
        AND RD.RECORD_STATUS = 'Y'
        AND RUS.RECORD_STATUS = 'Y'
        AND RDSP.USER_FLOW = RD.DOCTOR_FLOW
        AND RD.TRAINING_SPE_ID = RUS.TRAINING_SPE_ID
        <if test='isCurrentFlag!=null and isCurrentFlag!=""'>
            AND RDSP.IS_CURRENT_FLAG = #{isCurrentFlag}
        </if>
        <if test='userFlow!=null and userFlow!=""'>
            AND RUS.USER_FLOW = #{userFlow}
            AND RD.ORG_FLOW IN (
            SELECT ORG_FLOW
            FROM PDSCI.SYS_USER
            WHERE RECORD_STATUS = 'Y'
            AND USER_FLOW = #{userFlow}
            )
        </if>
    </select>
    <resultMap id="SchProcessResDoctorExt" type="HashMap">
        <result property="doctorFlow" column="DOCTOR_FLOW" javaType="string"/>
        <result property="doctorName" column="DOCTOR_NAME" javaType="string"/>
        <result property="schDeptName" column="SCH_DEPT_NAME" javaType="string"/>
        <result property="schDeptFlow" column="SCH_DEPT_FLOW" javaType="string"/>
        <result property="sessionNumber" column="SESSION_NUMBER" javaType="string"/>
        <result property="trainingSpeName" column="TRAINING_SPE_NAME" javaType="string"/>
        <result property="schStartDate" column="SCH_START_DATE" javaType="string"/>
        <result property="schEndDate" column="SCH_END_DATE" javaType="string"/>
        <result property="teacherUserFlow" column="TEACHER_USER_FLOW" javaType="string"/>
        <result property="teacherUserName" column="TEACHER_USER_NAME" javaType="string"/>
        <result property="recContent" column="REC_CONTENT" javaType="string"/>
        <result property="recTypeId" column="REC_TYPE_ID" javaType="string"/>
    </resultMap>
    <select id="searTrainingQuery" resultMap="SchProcessResDoctorExt">
        SELECT
        rd.DOCTOR_FLOW,
        rdsp.SCH_DEPT_NAME,
        rdsp.TEACHER_USER_FLOW,
        rdsp.TEACHER_USER_NAME,
        rdsp.SCH_DEPT_FLOW,
        rd.DOCTOR_NAME,
        rd.SESSION_NUMBER,
        rd.TRAINING_SPE_NAME,
        rdsp.SCH_START_DATE,
        rdsp.SCH_END_DATE,
        rr.REC_CONTENT,
        rr.REC_TYPE_ID
        FROM
        RES_DOCTOR rd
        INNER JOIN
        RES_DOCTOR_SCH_PROCESS rdsp
        ON
        rd.DOCTOR_FLOW = rdsp.USER_FLOW
        INNER JOIN
        SCH_ARRANGE_RESULT sar
        ON
        rdsp.SCH_RESULT_FLOW = sar.RESULT_FLOW
        INNER JOIN
        SCH_ROTATION_DEPT srd
        ON
        srd.GROUP_FLOW = sar.STANDARD_GROUP_FLOW
        AND
        srd.STANDARD_DEPT_ID = sar.STANDARD_DEPT_ID
        LEFT JOIN
        RES_REC rr
        ON
        rr.OPER_USER_FLOW = rdsp.USER_FLOW
        WHERE rdsp.RECORD_STATUS = 'Y'
        AND sar.RECORD_STATUS = 'Y'
        AND srd.RECORD_STATUS = 'Y'
        AND rd.RECORD_STATUS = 'Y'
        AND rr.RECORD_STATUS = 'Y'
        AND srd.RECORD_FLOW = rr.SCH_ROTATION_DEPT_FLOW
        AND EXISTS (SELECT NULL FROM RES_DOCTOR_RECRUIT rdr WHERE rdr.DOCTOR_FLOW = rd.DOCTOR_FLOW AND
        rdr.RECORD_STATUS='Y' AND rdr.AUDIT_STATUS_ID = 'Passed')
        AND rr.CREATE_TIME> (SELECT NVL(MAX(rr2.CREATE_TIME),'0') FROM RES_REC rr2 WHERE
        rd.DOCTOR_FLOW=rr2.OPER_USER_FLOW AND rr2.REC_TYPE_ID='ReturnTraining')
        <if test='orgFlow != null and orgFlow != ""'>
            AND rdsp.ORG_FLOW=#{orgFlow}
        </if>
        <if test='date != null and date != ""'>
            <bind name="currDate" value="'%'+date+'%'"/>
            AND rdsp.SCH_END_DATE like #{currDate}
        </if>
        ORDER BY rd.DOCTOR_FLOW,rdsp.SCH_START_DATE
    </select>
    <resultMap id="docWorkExt" type="HashMap">
        <result property="standardDeptId" column="STANDARD_DEPT_ID" javaType="string"/>
        <result property="standDeptName" column="STANDARD_DEPT_NAME" javaType="string"/>
        <result property="schDeptFlow" column="SCH_DEPT_FLOW" javaType="string"/>
        <result property="schDeptName" column="SCH_DEPT_NAME" javaType="string"/>
        <result property="schStartDate" column="SCH_START_DATE" javaType="string"/>
        <result property="schEndDate" column="SCH_END_DATE" javaType="string"/>
        <result property="month" column="F_MONTH" javaType="string"/>
        <result property="teacherUserFlow" column="TEACHER_USER_FLOW" javaType="string"/>
        <result property="schFlag" column="SCH_FLAG" javaType="string"/>
        <result property="teacherUserName" column="TEACHER_USER_NAME" javaType="string"/>
        <result property="headUserName" column="HEAD_USER_NAME" javaType="string"/>
        <result property="reqNum" column="REQ_NUM" javaType="string"/>
        <result property="completeNum" column="COMPLETE_NUM" javaType="string"/>
        <result property="evaluationNum" column="EVALUATION_NUM" javaType="string"/>
    </resultMap>
    <select id="docWorkingDetail" resultMap="docWorkExt">
        select
        dept.STANDARD_DEPT_ID,
        dept.STANDARD_DEPT_NAME,
        rdsp.SCH_DEPT_FLOW,
        rdsp.SCH_DEPT_NAME,
        rdsp.SCH_START_DATE,
        to_char(CEIL((TO_DATE(rdsp.SCH_END_DATE, 'YYYY-MM-DD') - TO_DATE(rdsp.SCH_START_DATE, 'YYYY-MM-DD')) / 30 * 10)
        / 10,'FM90.09') F_MONTH,
        rdsp.SCH_END_DATE,
        rdsp.TEACHER_USER_FLOW,
        RDSP.SCH_FLAG,
        rdsp.TEACHER_USER_NAME,
        rdsp.HEAD_USER_NAME,
        nvl((SELECT SUM(srdr.REQ_NUM)
        FROM SCH_ROTATION_DEPT_REQ srdr
        WHERE dept.RECORD_FLOW = srdr.REL_RECORD_FLOW
        AND srdr.RECORD_STATUS = 'Y'
        ),0) REQ_NUM,
        nvl( (SELECT COUNT(1)
        FROM RES_REC rr

        WHERE rr.RECORD_STATUS = 'Y'
        AND rr.SCH_ROTATION_DEPT_FLOW = dept.RECORD_FLOW
        AND rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
        AND rr.REC_TYPE_ID IN ('CaseRegistry',
        'DiseaseRegistry',
        'SkillRegistry',
        'OperationRegistry')),0) COMPLETE_NUM,
        nvl((SELECT COUNT(1)
        FROM RES_SCH_PROCESS_EXPRESS rr
        WHERE rr.RECORD_STATUS = 'Y'
        AND rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
        AND rr.SCH_ROTATION_DEPT_FLOW = dept.RECORD_FLOW
        AND rr.REC_TYPE_ID = 'AfterEvaluation'),0) EVALUATION_NUM
        FROM sch_rotation_dept dept
        left join sch_arrange_result r
        on dept.group_flow=r.standard_group_flow
        AND r.STANDARD_DEPT_ID = dept.STANDARD_DEPT_ID
        and r.record_status='Y'
        <if test='userFlow != null and userFlow != ""'>
            AND r.doctor_flow= #{userFlow}
        </if>
        left JOIN RES_DOCTOR_SCH_PROCESS rdsp
        ON rdsp.SCH_RESULT_FLOW = r.RESULT_FLOW
        and rdsp.RECORD_STATUS = 'Y'
        WHERE dept.record_status = 'Y'
        AND dept.org_flow IS NULL
        AND EXISTS
        (SELECT 1
        FROM sch_rotation_group g
        WHERE 1=1
        <if test='rotationFlow != null and rotationFlow != ""'>
            and rotation_flow = #{rotationFlow}
        </if>

        AND record_status = 'Y'
        AND org_flow IS NULL
        AND g.group_flow = dept.group_flow)
        ORDER BY r.CREATE_TIME asc

    </select>
    <resultMap id="docWorkSearchExt" type="HashMap">
        <result property="doctorFlow" column="DOCTOR_FLOW" javaType="string"/>
        <result property="doctorName" column="DOCTOR_NAME" javaType="string"/>
        <result property="trainingSpeId" column="TRAINING_SPE_ID" javaType="string"/>
        <result property="trainingSpeName" column="TRAINING_SPE_NAME" javaType="string"/>
        <result property="sessionNumber" column="SESSION_NUMBER" javaType="string"/>
        <result property="reqNum" column="REQ_NUM" javaType="string"/>
        <result property="completeNum" column="COMPLETE_NUM" javaType="string"/>
        <result property="rotationNum" column="rotationNum" javaType="string"/>
        <result property="schNum" column="schNum" javaType="string"/>
        <result property="ylz" column="ylz" javaType="string"/>
    </resultMap>
    <select id="docWorkingSearch" resultMap="docWorkSearchExt">
        SELECT rd.DOCTOR_FLOW,
        rd.DOCTOR_NAME,
        rd.TRAINING_SPE_ID,
        rd.TRAINING_SPE_NAME,
        rd.SESSION_NUMBER,
        nvl((SELECT SUM(req.REQ_NUM)
        FROM SCH_ROTATION_DEPT_REQ req
        WHERE req.record_status = 'Y'
        AND REQ.ROTATION_FLOW = RD.ROTATION_FLOW
        and req.rec_type_id in ('CaseRegistry',
        'DiseaseRegistry',
        'SkillRegistry',
        'OperationRegistry')),0) REQ_NUM,
        NVL((SELECT COUNT(1)
        FROM RES_REC rr
        INNER JOIN SCH_ROTATION_DEPT srd
        ON rr.SCH_ROTATION_DEPT_FLOW = srd.RECORD_FLOW
        WHERE rr.RECORD_STATUS = 'Y'
        AND srd.RECORD_STATUS = 'Y'
        AND RR.OPER_USER_FLOW = RD.DOCTOR_FLOW
        AND rr.REC_TYPE_ID IN ('CaseRegistry',
        'DiseaseRegistry',
        'SkillRegistry',
        'OperationRegistry')),
        0) COMPLETE_NUM,
        NVL((SELECT COUNT(1)
        FROM sch_rotation_dept dept
        WHERE record_status = 'Y'
        AND dept.org_flow IS NULL
        AND EXISTS
        (SELECT 1
        FROM sch_rotation_group g
        WHERE rotation_flow = RD.ROTATION_FLOW
        AND record_status = 'Y'
        AND org_flow IS NULL
        AND g.group_flow = dept.group_flow)),
        0) AS rotationNum,
        NVL((select count(1)
        from (SELECT count(rr.rec_type_id), sar.result_flow, rdsp.user_flow
        FROM SCH_ARRANGE_RESULT sar

        inner JOIN RES_DOCTOR_SCH_PROCESS rdsp
        ON rdsp.SCH_RESULT_FLOW = sar.RESULT_FLOW
        inner join RES_SCH_PROCESS_EXPRESS rr
        on rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
        INNER JOIN SCH_ROTATION_DEPT srd
        ON rr.SCH_ROTATION_DEPT_FLOW = srd.RECORD_FLOW
        WHERE rr.RECORD_STATUS = 'Y'
        AND srd.RECORD_STATUS = 'Y'
        and sar.RECORD_STATUS = 'Y'
        AND rdsp.RECORD_STATUS = 'Y'
        AND rdsp.ORG_FLOW = rd.org_flow
        AND RR.OPER_USER_FLOW = rd.doctor_flow
        AND rr.REC_TYPE_ID = 'AfterEvaluation'
        group by sar.result_flow, rdsp.user_flow
        having count(rr.rec_type_id) > 0) t),
        0) schNum,
        NVL((select count(1)
        from (SELECT rr.process_flow, count(rr.rec_flow)
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join RES_REC rr
        on rr.process_flow = rdsp.process_flow
        WHERE rr.RECORD_STATUS = 'Y'
        and rdsp.record_status = 'Y'
        AND rdsp.ORG_FLOW = rd.org_flow
        AND RR.OPER_USER_FLOW = rd.doctor_flow
        AND rr.REC_TYPE_ID IN
        ('CaseRegistry',
        'DiseaseRegistry',
        'SkillRegistry',
        'OperationRegistry')
        group by rr.process_flow
        having count(rr.rec_flow) > 0)),
        0) ylz

        FROM RES_DOCTOR rd
        INNER JOIN SYS_USER SU
        ON RD.DOCTOR_FLOW = SU.USER_FLOW
        LEFT JOIN (SELECT MAX(GRADUATION_YEAR) AS GRADUATION_YEAR, DOCTOR_FLOW
        FROM RES_DOCTOR_RECRUIT
        GROUP BY DOCTOR_FLOW) rdr
        ON rdr.DOCTOR_FLOW = rd.DOCTOR_FLOW
        WHERE rd.RECORD_STATUS = 'Y'
        <if test='orgFlow != null and orgFlow != ""'>
            AND rd.ORG_FLOW = #{orgFlow}
        </if>
        <if test='speId != null and speId != ""'>
            AND rd.TRAINING_SPE_ID = #{speId}
        </if>
        <if test='sessionNumber != null and sessionNumber != ""'>
            AND rd.SESSION_NUMBER = #{sessionNumber}
        </if>
        <if test='docName != null and docName != ""'>
            <bind name="name" value="'%'+docName+'%'"/>
            AND rd.DOCTOR_NAME LIKE #{name}
        </if>
        <if test='cardNo != null and cardNo != ""'>
            AND su.ID_NO = #{cardNo}
        </if>
        <if test='trainType != null and trainType != ""'>
            AND rd.training_type_id = #{trainType}
        </if>
        <if test='graduationYear != null and graduationYear != ""'>
            AND rdr.GRADUATION_YEAR = #{graduationYear}
        </if>
    </select>

    <resultMap id="searchTeacherWorkloadMap" type="HashMap">
        <result property="schDeptFlow" column="SCH_DEPT_FLOW" javaType="string"/>
        <result property="schDeptName" column="SCH_DEPT_NAME" javaType="string"/>
        <result property="userFlow" column="TEACHER_USER_FLOW" javaType="string"/>
        <result property="userName" column="USER_NAME" javaType="string"/>
        <result property="allNumber" column="ALL_SUM" javaType="string"/>
        <result property="schFlagNumber" column="SCH_FLAG_NUM" javaType="string"/>
        <result property="isCurrentFlagNumber" column="IS_CURRENT_FLAG_NUM" javaType="string"/>
        <result property="auditNumber" column="AUDIT_NUM" javaType="string"/>
        <result property="notAuditNumber" column="NOT_AUDIT_NUM" javaType="string"/>
    </resultMap>
    <select id="searchTeacherWorkload" resultMap="searchTeacherWorkloadMap">
        SELECT T.SCH_DEPT_FLOW,
        DEPT.SCH_DEPT_NAME,
        T.TEACHER_USER_FLOW,
        U.USER_NAME,
        (SELECT COUNT(1)
        FROM RES_DOCTOR_SCH_PROCESS A
        WHERE A.RECORD_STATUS = 'Y'
        AND (A.SCH_FLAG = 'Y' or A.IS_CURRENT_FLAG = 'Y')
        <if test='operStartDate != null and operStartDate != ""'>
            AND A.START_DATE <![CDATA[>=]]> #{operStartDate}
        </if>
        <if test='operEndDate != null and operEndDate != ""'>
            AND A.END_DATE <![CDATA[<=]]> #{operEndDate}
        </if>
        AND A.SCH_DEPT_FLOW = T.SCH_DEPT_FLOW
        AND A.TEACHER_USER_FLOW = T.TEACHER_USER_FLOW) ALL_SUM,
        (SELECT COUNT(1)
        FROM RES_DOCTOR_SCH_PROCESS A
        WHERE A.RECORD_STATUS = 'Y'
        AND A.SCH_FLAG = 'Y'
        AND A.SCH_DEPT_FLOW = T.SCH_DEPT_FLOW
        <if test='operStartDate != null and operStartDate != ""'>
            AND A.START_DATE <![CDATA[>=]]> #{operStartDate}
        </if>
        <if test='operEndDate != null and operEndDate != ""'>
            AND A.END_DATE <![CDATA[<=]]> #{operEndDate}
        </if>
        AND A.TEACHER_USER_FLOW = T.TEACHER_USER_FLOW) SCH_FLAG_NUM,
        (SELECT COUNT(1)
        FROM RES_DOCTOR_SCH_PROCESS A
        WHERE A.RECORD_STATUS = 'Y'
        AND A.IS_CURRENT_FLAG = 'Y'
        AND A.SCH_DEPT_FLOW = T.SCH_DEPT_FLOW
        AND A.TEACHER_USER_FLOW = T.TEACHER_USER_FLOW) IS_CURRENT_FLAG_NUM,
        (SELECT COUNT(1)
        FROM RES_REC RR
        WHERE RR.RECORD_STATUS = 'Y'
        AND RR.AUDIT_STATUS_ID IS NOT NULL
        <if test='recTypeIds!=null and recTypeIds.size>0'>
            AND RR.REC_TYPE_ID IN
            <foreach collection="recTypeIds" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        AND EXISTS
        (SELECT 1
        FROM RES_DOCTOR_SCH_PROCESS A
        WHERE A.RECORD_STATUS = 'Y'
        <if test='operStartDate != null and operStartDate != ""'>
            AND A.START_DATE <![CDATA[>=]]> #{operStartDate}
        </if>
        <if test='operEndDate != null and operEndDate != ""'>
            AND A.END_DATE <![CDATA[<=]]> #{operEndDate}
        </if>
        AND A.PROCESS_FLOW = RR.PROCESS_FLOW
        AND A.SCH_DEPT_FLOW = T.SCH_DEPT_FLOW
        AND A.TEACHER_USER_FLOW = T.TEACHER_USER_FLOW)) AUDIT_NUM,

        (SELECT COUNT(1)
        FROM RES_REC RR
        WHERE RR.RECORD_STATUS = 'Y'
        AND RR.AUDIT_STATUS_ID IS NULL
        <if test='recTypeIds!=null and recTypeIds.size>0'>
            AND RR.REC_TYPE_ID IN
            <foreach collection="recTypeIds" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        AND EXISTS
        (SELECT 1
        FROM RES_DOCTOR_SCH_PROCESS A
        WHERE A.RECORD_STATUS = 'Y'
        <if test='operStartDate != null and operStartDate != ""'>
            AND A.START_DATE <![CDATA[>=]]> #{operStartDate}
        </if>
        <if test='operEndDate != null and operEndDate != ""'>
            AND A.END_DATE <![CDATA[<=]]> #{operEndDate}
        </if>
        AND A.PROCESS_FLOW = RR.PROCESS_FLOW
        AND A.SCH_DEPT_FLOW = T.SCH_DEPT_FLOW
        AND A.TEACHER_USER_FLOW = T.TEACHER_USER_FLOW)) NOT_AUDIT_NUM
        FROM RES_DOCTOR_SCH_PROCESS T
        LEFT JOIN SCH_DEPT DEPT
        ON DEPT.SCH_DEPT_FLOW = T.SCH_DEPT_FLOW
        LEFT JOIN SYS_USER U
        ON U.USER_FLOW = T.TEACHER_USER_FLOW
        WHERE T.RECORD_STATUS = 'Y'
        <if test='orgFlow != null and orgFlow != ""'>
            AND T.ORG_FLOW = #{orgFlow}
        </if>
        <if test='schDept != null'>
            <if test='schDept.schDeptFlow != null and schDept.schDeptFlow != ""'>
                AND T.SCH_DEPT_FLOW = #{schDept.schDeptFlow}
            </if>
        </if>
        <if test='userName != null and userName != ""'>
            <bind name="name" value="'%'+userName+'%'"/>
            AND T.TEACHER_USER_NAME LIKE #{name}
        </if>
        GROUP BY T.SCH_DEPT_FLOW,
        DEPT.SCH_DEPT_NAME,
        T.TEACHER_USER_FLOW,
        U.USER_NAME
    </select>
    <select id="schDoctorQuery" resultMap="SchProcessResDoctorExt">
		select rd.DOCTOR_FLOW,re.SCH_DEPT_NAME,re.SCH_DEPT_FLOW,rd.DOCTOR_NAME,rd.SESSION_NUMBER,rd.TRAINING_SPE_NAME,re.SCH_START_DATE,re.SCH_END_DATE from RES_DOCTOR_SCH_PROCESS re
		inner join  RES_DOCTOR rd  on re.USER_FLOW=rd.DOCTOR_FLOW
		where re.RECORD_STATUS='Y' and re.RECORD_STATUS='Y'
		AND re.IS_CURRENT_FLAG = 'Y'
		and re.TEACHER_USER_FLOW=#{teacherUserFlow}
		and re.SCH_DEPT_FLOW=#{schDeptFlow}
	</select>
    <select id="chTeacherProcessFlowRec" resultMap="SchProcessResDoctorExt">
        select
        rd.DOCTOR_FLOW,re.SCH_DEPT_NAME,re.SCH_DEPT_FLOW,rd.DOCTOR_NAME,rd.SESSION_NUMBER,rd.TRAINING_SPE_NAME,re.SCH_START_DATE,re.SCH_END_DATE
        from RES_DOCTOR_SCH_PROCESS re
        inner join RES_DOCTOR rd on re.USER_FLOW=rd.DOCTOR_FLOW
        where re.RECORD_STATUS='Y' and re.RECORD_STATUS='Y'
        and re.TEACHER_USER_FLOW=#{teacherUserFlow}
        and re.SCH_DEPT_FLOW=#{schDeptFlow}
        <if test='operStartDate != null and operStartDate != ""'>
            AND re.START_DATE <![CDATA[>=]]> #{operStartDate}
        </if>
        <if test='operEndDate != null and operEndDate != ""'>
            AND re.END_DATE <![CDATA[<=]]> #{operEndDate}
        </if>
        AND re.SCH_FLAG = 'Y'
    </select>

    <resultMap id="newDocWorkingSearchMap" type="HashMap">
        <result property="doctorFlow" column="DOCTOR_FLOW" javaType="string"/>
        <result property="doctorName" column="DOCTOR_NAME" javaType="string"/>
        <result property="speId" column="TRAINING_SPE_ID" javaType="string"/>
        <result property="speName" column="TRAINING_SPE_NAME" javaType="string"/>
        <result property="sessionNumber" column="SESSION_NUMBER" javaType="string"/>
        <result property="reqNum" column="reqNum" javaType="string"/>
        <result property="completeNum" column="completeNum" javaType="string"/>
        <result property="rotationNum" column="rotationNum" javaType="string"/>
        <result property="lunzhuanNum" column="lunzhuanNum" javaType="string"/>
        <result property="chukeNum" column="chukeNum" javaType="string"/>
    </resultMap>
    <select id="newDocWorkingSearch" resultMap="newDocWorkingSearchMap">

        SELECT rd.DOCTOR_FLOW,
        rd.DOCTOR_NAME,
        rd.TRAINING_SPE_ID,
        rd.TRAINING_SPE_NAME,
        rd.SESSION_NUMBER,
        NVL(CASE #{flag}
        WHEN 'Y' THEN
        (select SUM(REQ.REQ_NUM)
        from SCH_ROTATION_DEPT_REQ REQ
        INNER JOIN SCH_ROTATION_DEPT SRD
        ON SRD.RECORD_FLOW = REQ.REL_RECORD_FLOW
        AND SRD.RECORD_STATUS = 'Y'
        INNER JOIN sch_arrange_result sar
        ON SAR.STANDARD_GROUP_FLOW = SRD.GROUP_FLOW
        AND SAR.STANDARD_DEPT_ID = SRD.STANDARD_DEPT_ID
        and sar.record_status = 'Y'
        where sar.doctor_flow = rd.doctor_flow
        AND REQ.RECORD_STATUS = 'Y')
        ELSE
        (select sum(req.REQ_NUM)
        from SCH_ROTATION_DEPT_REQ req
        where req.record_status = 'Y'
        AND REQ.ROTATION_FLOW = RD.ROTATION_FLOW)

        END,0) reqNum,
        NVL((select COUNT(1)
        from RES_REC RR
        WHERE RR.RECORD_STATUS = 'Y'
        AND RR.OPER_USER_FLOW = RD.DOCTOR_FLOW
        <if test='recTypeIds!=null and recTypeIds.size>0'>
            AND RR.REC_TYPE_ID IN
            <foreach collection="recTypeIds" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ),0) completeNum,
        NVL((select COUNT(1)
        from sch_rotation_dept dept
        where record_status = 'Y'
        and dept.org_flow is null
        and exists (select 1
        from sch_rotation_group g
        where rotation_flow = RD.ROTATION_FLOW
        and record_status = 'Y'
        and org_flow is null
        and g.group_flow = dept.group_flow)),0) rotationNum,
        NVL((
        select count(1) from
        res_doctor_sch_process
        where record_status = 'Y'
        and user_flow = rd.doctor_flow and exists(select null from res_rec RR where RR.record_status = 'Y' and
        RR.process_flow = res_doctor_sch_process.process_flow
        <if test='recTypeIds!=null and recTypeIds.size>0'>
            AND RR.REC_TYPE_ID IN
            <foreach collection="recTypeIds" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        )
        ),0) lunzhuanNum,
        NVL((SELECT COUNT(1)
        FROM RES_DOCTOR_SCH_PROCESS A
        WHERE A.RECORD_STATUS = 'Y'
        AND A.SCH_FLAG = 'Y'
        AND A.USER_FLOW = RD.DOCTOR_FLOW ),0) chukeNum
        FROM RES_DOCTOR rd
        INNER JOIN SYS_USER SU
        ON RD.DOCTOR_FLOW = SU.USER_FLOW
        WHERE rd.RECORD_STATUS = 'Y'
        <if test='orgFlow != null and orgFlow != ""'>
            AND rd.ORG_FLOW = #{orgFlow}
        </if>
        <if test='speId != null and speId != ""'>
            AND rd.TRAINING_SPE_ID = #{speId}
        </if>
        <if test='sessionNumber != null and sessionNumber != ""'>
            AND rd.SESSION_NUMBER = #{sessionNumber}
        </if>
        <if test='docName != null and docName != ""'>
            <bind name="name" value="'%'+docName+'%'"/>
            AND su.USER_NAME LIKE #{name}
        </if>
        <if test='cardNo != null and cardNo != ""'>
            <bind name="cardNo" value="'%'+cardNo+'%'"/>
            AND su.ID_NO LIKE #{cardNo}
        </if>
        order by NLSSORT(su.USER_NAME,'NLS_SORT = SCHINESE_PINYIN_M')
    </select>
    <resultMap id="newDocWorkingDetailMap" type="HashMap">
        <result property="standardDeptId" column="STANDARD_DEPT_ID" javaType="string"/>
        <result property="standDeptName" column="STANDARD_DEPT_NAME" javaType="string"/>
        <result property="schDeptFlow" column="SCH_DEPT_FLOW" javaType="string"/>
        <result property="schDeptName" column="SCH_DEPT_NAME" javaType="string"/>
        <result property="schStartDate" column="SCH_START_DATE" javaType="string"/>
        <result property="schEndDate" column="SCH_END_DATE" javaType="string"/>
        <result property="month" column="F_MONTH" javaType="string"/>
        <result property="teacherUserFlow" column="TEACHER_USER_FLOW" javaType="string"/>
        <result property="schFlag" column="SCH_FLAG" javaType="string"/>
        <result property="teacherUserName" column="TEACHER_USER_NAME" javaType="string"/>
        <result property="headUserName" column="HEAD_USER_NAME" javaType="string"/>
        <result property="reqNum" column="REQ_NUM" javaType="string"/>
        <result property="completeNum" column="COMPLETE_NUM" javaType="string"/>
        <result property="isCurrentFlag" column="IS_CURRENT_FLAG" javaType="string"/>
        <result property="processFlow" column="PROCESS_FLOW" javaType="string"/>
    </resultMap>
    <select id="newDocWorkingDetail" resultMap="newDocWorkingDetailMap">
        SELECT sar.STANDARD_DEPT_ID, sar.STANDARD_DEPT_NAME, sar.SCH_DEPT_FLOW, sar.SCH_DEPT_NAME, sar.SCH_START_DATE
        , rdsp.PROCESS_FLOW,
        sar.sch_month F_MONTH
        , sar.SCH_END_DATE, rdsp.TEACHER_USER_FLOW, RDSP.SCH_FLAG
        , rdsp.TEACHER_USER_NAME, rdsp.HEAD_USER_NAME,
        NVL((
        SELECT SUM(srdr.REQ_NUM)
        FROM SCH_ROTATION_DEPT srd
        INNER JOIN SCH_ROTATION_DEPT_REQ srdr
        ON srd.RECORD_FLOW = srdr.REL_RECORD_FLOW
        WHERE srd.RECORD_STATUS = 'Y'
        AND srdr.RECORD_STATUS = 'Y'
        AND srd.STANDARD_DEPT_ID = sar.STANDARD_DEPT_ID
        AND srd.GROUP_FLOW = sar.STANDARD_GROUP_FLOW
        ),0) REQ_NUM,
        NVL((
        SELECT COUNT(1)
        FROM RES_REC rr
        WHERE rr.RECORD_STATUS = 'Y'
        AND rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
        <if test='recTypeIds!=null and recTypeIds.size>0'>
            AND RR.REC_TYPE_ID IN
            <foreach collection="recTypeIds" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ),0) COMPLETE_NUM,
        RDSP.IS_CURRENT_FLAG
        FROM SCH_ARRANGE_RESULT sar
        left JOIN RES_DOCTOR_SCH_PROCESS rdsp
        ON rdsp.SCH_RESULT_FLOW = sar.RESULT_FLOW and rdsp.RECORD_STATUS = 'Y'
        WHERE sar.RECORD_STATUS = 'Y'
        <if test='userFlow != null and userFlow != ""'>
            AND sar.doctor_flow = #{userFlow}
        </if>
        ORDER BY sar.CREATE_TIME DESC
    </select>
    <resultMap type="HashMap" id="docCycleMap">
        <result property="userName" column="user_name" javaType="string"/>
        <result property="trainingSpeName" column="training_spe_name" javaType="string"/>
        <result property="sessionNumber" column="session_number" javaType="string"/>
        <result property="trainingYears" column="training_years" javaType="string"/>
        <result property="doctorFlow" column="doctor_flow" javaType="string"/>
        <result property="trainingSpeId" column="training_spe_id" javaType="string"/>
    </resultMap>

    <select id="searchDocCycleList" parameterType="java.util.Map" resultMap="docCycleMap">
        select u.USER_NAME user_name, dr.TRAINING_SPE_NAME training_spe_name,dr.DOCTOR_Flow doctor_flow,
        dr.SESSION_NUMBER session_number, dr.TRAINING_YEARS training_years,dr.TRAINING_SPE_ID training_spe_id
        from RES_DOCTOR dr
        inner join SYS_USER u
        on dr.DOCTOR_FLOW = u.USER_FLOW
        where dr.RECORD_STATUS= 'Y' and u.RECORD_STATUS= 'Y'
        <if test='trainingSpeId!=null and trainingSpeId!=""'>
            and dr.TRAINING_SPE_ID = #{trainingSpeId}
        </if>
        <if test='sessionNumber!=null and sessionNumber!=""'>
            and dr.SESSION_NUMBER = #{sessionNumber}
        </if>
        <if test='trainingYears!=null and trainingYears!=""'>
            and dr.TRAINING_YEARS = #{trainingYears}
        </if>

        <if test='userName!=null and userName!=""'>
            <bind name="name" value="'%'+userName+'%'"/>
            AND u.USER_NAME LIKE #{name}
        </if>
        <if test='idNo!=null and idNo!=""'>
            <bind name="idNo" value="'%'+idNo+'%'"/>
            AND u.ID_NO LIKE #{idNo}
        </if>
        <if test='orgFlow!=null and orgFlow!=""'>
            and (
            dr.ORG_FLOW = #{orgFlow}
            or exists(
            select null from res_joint_org rjo
            where rjo.record_status = 'Y'
            and rjo.org_flow = #{orgFlow}
            and dr.org_flow = rjo.joint_org_flow
            )
            )
        </if>
        order by NLSSORT(u.USER_NAME,'NLS_SORT = SCHINESE_PINYIN_M')
    </select>
    <select id="searchCycleArrangeResults" resultMap="com.pinde.sci.dao.base.SchArrangeResultMapper.BaseResultMap">
        select ar.*
        from SCH_ARRANGE_RESULT ar,RES_DOCTOR dr,SYS_USER u
        where dr.RECORD_STATUS= 'Y' and u.RECORD_STATUS= 'Y' and ar.RECORD_STATUS= 'Y' and dr.DOCTOR_FLOW = u.USER_FLOW
        and
        dr.DOCTOR_FLOW = ar.DOCTOR_FLOW
        <if test='startDate!=null and startDate!="" and endDate!=null and endDate!=""'>
            and(
            (ar.SCH_START_DATE>=#{startDate} and #{endDate}>=ar.SCH_START_DATE)
            or
            (ar.SCH_END_DATE>=#{startDate} and #{endDate}>=ar.SCH_END_DATE)
            )
        </if>
        <if test='userName!=null and userName!=""'>
            <bind name="name" value="'%'+userName+'%'"/>
            AND u.USER_NAME LIKE #{name}
        </if>
        <if test='idNo!=null and idNo!=""'>
            <bind name="idNo" value="'%'+idNo+'%'"/>
            AND u.ID_NO LIKE #{idNo}
        </if>
        <if test='trainingSpeId!=null and trainingSpeId!=""'>
            and dr.TRAINING_SPE_ID = #{trainingSpeId}
        </if>
        <if test='sessionNumber!=null and sessionNumber!=""'>
            and dr.SESSION_NUMBER = #{sessionNumber}
        </if>
        <if test='trainingYears!=null and trainingYears!=""'>
            and dr.TRAINING_YEARS = #{trainingYears}
        </if>
        <if test='orgFlow!=null and orgFlow!=""'>
            and (
            dr.ORG_FLOW = #{orgFlow}
            or exists(
            select null from res_joint_org rjo
            where rjo.record_status = 'Y'
            and rjo.org_flow = #{orgFlow}
            and dr.org_flow = rjo.joint_org_flow
            )
            )
        </if>
        order by NLSSORT(u.USER_NAME,'NLS_SORT = SCHINESE_PINYIN_M')
    </select>
    <select id="schDoctorSchProcessInfoQuery" parameterType="java.util.Map" resultMap="processUserMap">
        select a.* from(
        select rdsp.PROCESS_FLOW,
        rdsp.USER_FLOW,
        rdsp.ORG_FLOW,
        rdsp.ORG_NAME,
        rdsp.DEPT_FLOW,
        rdsp.DEPT_NAME,
        rdsp.SCH_DEPT_FLOW,
        rdsp.SCH_DEPT_NAME,
        rdsp.SCH_RESULT_FLOW,
        rdsp.SCH_START_DATE,
        rdsp.SCH_END_DATE,
        rdsp.TEACHER_USER_FLOW,
        rdsp.TEACHER_USER_NAME,
        rdsp.HEAD_USER_FLOW,
        rdsp.HEAD_USER_NAME,
        rdsp.SCH_FLAG,
        rdsp.SCH_SCORE,
        rdsp.IS_CURRENT_FLAG ,
        su.USER_Name,
        su.USER_HEAD_IMG,
        rd.DOCTOR_TYPE_ID,
        nvl((select CFG_VALUE from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code =
        'jsres_doctor_app_menu_'||rd.doctor_flow),'N')APP_MENU_FLAG,
        nvl(cfg2.power_start_time,'0000-00-00') power_start_time, nvl(cfg2.power_end_time,'9999-99-99') power_end_time
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rd.doctor_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        left join jsres_power_cfg cfg2
        on cfg2.record_status='Y' and cfg2.cfg_code = 'jsres_doctor_data_time_'||rd.doctor_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        <if test="teacherUserFlow!=null and teacherUserFlow!=''">
            and rdsp.TEACHER_USER_FLOW = #{teacherUserFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.dept_flow = #{deptFlow}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW = #{doctorFlow}
        </if>
        <if test='schStartDate!=null and schStartDate!=""'>
            and rdsp.SCH_START_DATE <![CDATA[>=]]> #{schStartDate}
        </if>
        <if test='schEndDate!=null and schEndDate!=""'>
            and rdsp.SCH_END_DATE <![CDATA[<=]]> #{schEndDate}
        </if>
        <if test="userName!=null and userName!=''">
            <bind name="name" value="'%'+userName+'%'"/>
            and su.USER_NAME like #{name}
        </if>
        <if test="biaoJi==null or biaoJi==''">
            <if test="recTypeId=='skill'">
                and  exists(
                    select null
                    from RES_SCH_PROCESS_EXPRESS rr
                    where rr.RECORD_STATUS='Y'
                    and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                    and rr.rec_type_id in('DOPS','Mini_CEX')
                )
            </if>
        </if>
        <if test="biaoJi!=null and biaoJi!=''">

            <if test="recTypeId=='skill'">
                and ( not exists(
                    select null
                    from RES_SCH_PROCESS_EXPRESS rr
                    where rr.RECORD_STATUS='Y'
                    and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                    and rr.rec_type_id in('DOPS')
                    )
                    or not exists(
                    select null
                    from RES_SCH_PROCESS_EXPRESS rr
                    where rr.RECORD_STATUS='Y'
                    and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                    and rr.rec_type_id in('Mini_CEX')
                    )
                )
            </if>
            <if test="recTypeId=='after'">
                and  not exists(
                    select null
                    from RES_SCH_PROCESS_EXPRESS rr
                    where rr.RECORD_STATUS='Y'
                    and rr.PROCESS_FLOW = rdsp.PROCESS_FLOW
                    and rr.rec_type_id='AfterEvaluation'
                )
            </if>
        </if>
        ) a
        where
        a.APP_MENU_FLAG='Y'
        AND ( ( a.SCH_START_DATE  <![CDATA[ <= ]]> A.power_start_time AND a.SCH_END_DATE >= A.power_END_time)
        or (a.SCH_START_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_START_DATE <![CDATA[ <= ]]>A.power_END_time)
        or (a.SCH_END_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_END_DATE <![CDATA[ <= ]]>A.power_END_time))
        <!--(
        (A.DOCTOR_TYPE_ID !='Graduate' AND A.STU_JD_GC='Y')
        OR
        (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='Y')
        OR
        (A.DOCTOR_TYPE_ID ='Graduate' AND A.STU_SEND_SCHOOL_GC='N' AND A.STU_JD_GC='Y' AND A.STU_JDZS_GC='Y')
        )-->
        ORDER BY a.process_flow DESC
    </select>
    <select id="schDoctorSchProcessEvalList" parameterType="java.util.Map" resultMap="processUserMap">
        select a.* from(
        select rdsp.PROCESS_FLOW,
        rdsp.USER_FLOW,
        rdsp.ORG_FLOW,
        rdsp.ORG_NAME,
        rdsp.DEPT_FLOW,
        rdsp.DEPT_NAME,
        rdsp.SCH_DEPT_FLOW,
        rdsp.SCH_DEPT_NAME,
        rdsp.SCH_RESULT_FLOW,
        rdsp.SCH_START_DATE,
        rdsp.SCH_END_DATE,
        rdsp.TEACHER_USER_FLOW,
        rdsp.TEACHER_USER_NAME,
        rdsp.HEAD_USER_FLOW,
        rdsp.HEAD_USER_NAME,
        rdsp.SCH_FLAG,
        rdsp.SCH_SCORE,
        rdsp.IS_CURRENT_FLAG ,
        su.USER_Name,
        su.USER_HEAD_IMG,
        rd.DOCTOR_TYPE_ID,
        nvl((select CFG_VALUE from jsres_power_cfg cfg where cfg.record_status='Y' and cfg.cfg_code =
        'jsres_doctor_app_menu_'||rd.doctor_flow),'N')APP_MENU_FLAG,
        MONTHS_BETWEEN(to_date(substr(rdsp.sch_end_date,0,7),'yyyy-MM'),to_date(substr(rdsp.sch_start_date,0,7),'yyyy-MM'))+1
        evl_count ,
        (select count(1) from RES_DOCTOR_SCH_PROCESS_EVAL eval where eval.process_flow=rdsp.process_flow and
        eval.record_status='Y') evled_count,
        nvl(cfg2.power_start_time,'0000-00-00') power_start_time, nvl(cfg2.power_end_time,'9999-99-99') power_end_time
        from RES_DOCTOR_SCH_PROCESS rdsp
        left join res_doctor rd
        on rdsp.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rd.doctor_flow
        left join sys_user tu
        on tu.user_flow = rdsp.teacher_user_flow
        left join jsres_power_cfg cfg2
        on cfg2.record_status='Y' and cfg2.cfg_code = 'jsres_doctor_data_time_'||rd.doctor_flow
        where rdsp.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        <if test="teacherUserFlow!=null and teacherUserFlow!=''">
            and rdsp.TEACHER_USER_FLOW = #{teacherUserFlow}
        </if>
        <if test="deptFlow!=null and deptFlow!=''">
            and rdsp.dept_flow = #{deptFlow}
        </if>
        <if test="doctorFlow!=null and doctorFlow!=''">
            and rdsp.USER_FLOW = #{doctorFlow}
        </if>
        <if test='schStartDate!=null and schStartDate!=""'>
            and rdsp.SCH_START_DATE <![CDATA[>=]]> #{schStartDate}
        </if>
        <if test='schEndDate!=null and schEndDate!=""'>
            and rdsp.SCH_END_DATE <![CDATA[<=]]> #{schEndDate}
        </if>
        <if test="userName!=null and userName!=''">
            <bind name="name" value="'%'+userName+'%'"/>
            and su.USER_NAME like #{name}
        </if>
        ) a
        where
        a.APP_MENU_FLAG='Y'
        AND ( ( a.SCH_START_DATE  <![CDATA[ <= ]]> A.power_start_time AND a.SCH_END_DATE >= A.power_END_time)
        or (a.SCH_START_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_START_DATE <![CDATA[ <= ]]>A.power_END_time)
        or (a.SCH_END_DATE  <![CDATA[ >= ]]> A.power_start_time AND a.SCH_END_DATE <![CDATA[ <= ]]>A.power_END_time))
        <if test="biaoJi!=null and biaoJi!=''and biaoJi=='Y'.toString()">
            and a.evl_count!=a.evled_count
        </if>
        <if test="biaoJi!=null and biaoJi!=''and biaoJi=='N'.toString()">
            and a.evled_count>0
        </if>
        ORDER BY a.process_flow DESC
    </select>

    <resultMap type="HashMap" id="evalMap">
        <result column="PROCESS_FLOW" javaType="string" property="processFlow"></result>
        <result column="RECORD_FLOW" javaType="string" property="recordFlow"></result>
        <result column="EVAL_MONTH" javaType="string" property="evalMonth"></result>
        <result column="START_TIME" javaType="string" property="startTime"></result>
        <result column="END_TIME" javaType="string" property="endTime"></result>
    </resultMap>
    <select id="findProcessEvals" parameterType="java.util.Map" resultMap="evalMap">
        select * from (
        select
        a.PROCESS_FLOW,
        a.EVAL_MONTH,
        a.START_TIME,
        a.END_TIME,
        eval.RECORD_FLOW,
        ROW_NUMBER()over(PARTITION by a.start_time ORDER BY eval.RECORD_FLOW DESC) as row_num
        from
        (
        <if test="times!=null and times.size>0">
            <foreach collection="times" item="item" index="index" separator=" UNION ALL ">
                SELECT #{item.processFlow} PROCESS_FLOW ,#{item.evlMonth} EVAL_MONTH,#{item.startTime}
                START_TIME,#{item.endTime} END_TIME FROM DUAL
            </foreach>
        </if>
        ) a
        left join
        RES_DOCTOR_SCH_PROCESS_EVAL eval on eval.process_flow=a.process_flow
        and eval.EVAL_MONTH = a.EVAL_MONTH
        and eval.record_status='Y'
        <if test="biaoJi!=null and biaoJi!='' and biaoJi=='Y'.toString()">
            where eval.record_flow is null
        </if>
        <if test="biaoJi!=null and biaoJi!='' and biaoJi=='N'.toString()">
            where eval.record_flow is not null
        </if>
        order by a.EVAL_MONTH
        ) b where b.row_num = 1
    </select>
    <select id="hbresDoctorSchProcessHead" resultMap="processUserMap">
        select * from (
        SELECT SAR.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        rd.training_spe_id AS SPE_ID,
        rd.training_spe_name AS SPE_NAME,
        rd.training_type_id CAT_SPE_ID,
        rd.training_type_Name CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        sar.DOCTOR_FLOW AS USER_FLOW,
        sar.ORG_FLOW,
        sar.ORG_NAME,
        sar.DEPT_FLOW,
        sar.DEPT_NAME,
        sar.SCH_DEPT_FLOW,
        sar.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        sar.SCH_START_DATE,
        sar.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name AS TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        nvl(RPC.POWER_START_TIME, NULL) AS POWER_START_TIME,
        nvl(RPC.POWER_END_TIME, NULL) AS POWER_END_TIME,
        case
        when rdsp.process_flow is null then
        'notCurrent'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        'isCurrent'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        'isSch'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        'notCurrent'
        ELSE
        NULL
        END
        end AS STATUS_ID,
        case
        when rdsp.process_flow is null then
        '待入科'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        '轮转中'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        '已出科'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        '待入科'
        ELSE
        NULL
        END
        end AS STATUS_NAME
        FROM sch_arrange_result sar
        LEFT JOIN (select row_number() over(partition by sch_result_flow order by create_time desc) rn,
        p.*
        from RES_DOCTOR_SCH_PROCESS p
        where p.record_status = 'Y') rdsp
        ON rdsp.sch_result_flow = sar.result_flow
        AND rdsp.record_status = 'Y'
        and rdsp.rn = 1
        LEFT JOIN res_doctor rd
        ON sar.doctor_flow = rd.doctor_flow
        LEFT JOIN sys_user su
        ON su.user_flow = sar.doctor_flow
        LEFT JOIN sys_user tu
        ON tu.user_flow = rdsp.teacher_user_flow
        AND tu.record_status = 'Y'
        LEFT JOIN RES_POWER_CFG RPC
        ON ('res_doctor_app_login_' || RDSP.USER_FLOW) = RPC.CFG_CODE
        WHERE rd.record_status = 'Y'
        AND su.record_status = 'Y'
        AND sar.record_status = 'Y'
        <if test='doctorFlow!=null and doctorFlow!=""'>
            and su.user_flow=#{doctorFlow}
        </if>
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and rpc.record_status = 'Y'
            and rpc.cfg_value = 'Y'
        </if>
        ) a
        WHERE A.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        and (exists(
        select null
        from SYS_USER_DEPT sud
        where sud.RECORD_STATUS='Y'
        and sud.USER_FLOW=#{headFlow}
        and a.DEPT_FLOW=sud.DEPT_FLOW
        )
        <if test="deptFlow!=null and deptFlow!=''">
            or a.DEPT_FLOW=#{deptFlow}
        </if>)
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and (a.POWER_START_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.POWER_END_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.SCH_START_DATE <![CDATA[>=]]> a.POWER_START_TIME
            AND a.SCH_END_DATE <![CDATA[<=]]> a.POWER_END_TIME)
            and a.POWER_START_TIME is not null
            and a.POWER_END_TIME is not null
        </if>
        <if test='seachStr!=null and seachStr!=""'>
            and (a.session_number like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%'))
        </if>
        <if test='typeId!=null and typeId!=""'>
            <if test="typeId=='allDoc'">
                and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
            </if>
            <if test="typeId=='monthCurrent'">
                and SUBSTR(a.SCH_START_DATE,0,7) <![CDATA[<=]]>to_char(sysdate,'yyyy-MM')
                and SUBSTR(a.SCH_END_DATE,0,7) <![CDATA[>=]]>to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='monthSch'">
                and SUBSTR(a.SCH_END_DATE,0,7) = to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='waitSch'">
                <if test='yearMonth!=null and yearMonth!=""'>
                    and SUBSTR(a.SCH_START_DATE,0,7) = #{yearMonth}
                </if>
                and a.status_id='notCurrent'
            </if>
            <if test="typeId=='errorSch'">
                and a.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and a.status_id!='isSch'
                and a.status_id!='notCurrent'
            </if>
        </if>
        ORDER BY a.SCH_START_DATE DESC
    </select>
    <select id="zseyDoctorSchProcessHead" resultMap="processUserMap">
        select * from (
        SELECT SAR.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        rd.training_spe_id AS SPE_ID,
        rd.training_spe_name AS SPE_NAME,
        rd.training_type_id CAT_SPE_ID,
        rd.training_type_Name CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        sar.DOCTOR_FLOW AS USER_FLOW,
        sar.ORG_FLOW,
        sar.ORG_NAME,
        sar.DEPT_FLOW,
        sar.DEPT_NAME,
        sar.SCH_DEPT_FLOW,
        sar.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        sar.SCH_START_DATE,
        sar.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name AS TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        nvl(RPC.POWER_START_TIME, NULL) AS POWER_START_TIME,
        nvl(RPC.POWER_END_TIME, NULL) AS POWER_END_TIME,
        case
        when rdsp.process_flow is null then
        'notCurrent'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        'isCurrent'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        'isSch'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        'notCurrent'
        ELSE
        NULL
        END
        end AS STATUS_ID,
        case
        when rdsp.process_flow is null then
        '待入科'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        '轮转中'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        '已出科'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        '待入科'
        ELSE
        NULL
        END
        end AS STATUS_NAME
        FROM sch_arrange_result sar
        LEFT JOIN (select row_number() over(partition by sch_result_flow order by create_time desc) rn,
        p.*
        from RES_DOCTOR_SCH_PROCESS p
        where p.record_status = 'Y') rdsp
        ON rdsp.sch_result_flow = sar.result_flow
        AND rdsp.record_status = 'Y'
        and rdsp.rn = 1
        LEFT JOIN res_doctor rd
        ON sar.doctor_flow = rd.doctor_flow
        LEFT JOIN sys_user su
        ON su.user_flow = sar.doctor_flow
        LEFT JOIN sys_user tu
        ON tu.user_flow = rdsp.teacher_user_flow
        AND tu.record_status = 'Y'
        LEFT JOIN RES_POWER_CFG RPC
        ON ('res_doctor_app_login_' || RDSP.USER_FLOW) = RPC.CFG_CODE
        WHERE rd.record_status = 'Y'
        AND su.record_status = 'Y'
        AND sar.record_status = 'Y'
        <if test='doctorFlow!=null and doctorFlow!=""'>
            and su.user_flow=#{doctorFlow}
        </if>
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and rpc.record_status = 'Y'
            and rpc.cfg_value = 'Y'
        </if>
        ) a
        WHERE A.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
            <if test='docTypeId!="deptStudent".toString()'>
                and (exists(
                select null
                from SYS_USER_DEPT sud
                where sud.RECORD_STATUS='Y'
                and sud.USER_FLOW=#{headFlow}
                and a.DEPT_FLOW=sud.DEPT_FLOW
                )
                <if test="deptFlow!=null and deptFlow!=''">
                    or a.DEPT_FLOW=#{deptFlow}
                </if>
                )
        </if>
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and (a.POWER_START_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.POWER_END_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.SCH_START_DATE <![CDATA[>=]]> a.POWER_START_TIME
            AND a.SCH_END_DATE <![CDATA[<=]]> a.POWER_END_TIME)
            and a.POWER_START_TIME is not null
            and a.POWER_END_TIME is not null
        </if>
        <if test='seachStr!=null and seachStr!=""'>
            and (a.session_number like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%'))
        </if>
        <if test='typeId!=null and typeId!=""'>
            <if test="typeId=='allDoc'">
            </if>
            <if test="typeId=='monthCurrent'">
                and SUBSTR(a.SCH_START_DATE,0,7) <![CDATA[<=]]>to_char(sysdate,'yyyy-MM')
                and SUBSTR(a.SCH_END_DATE,0,7) <![CDATA[>=]]>to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='monthSch'">
                and SUBSTR(a.SCH_END_DATE,0,7) = to_char(sysdate,'yyyy-MM')
                and a.status_id='isCurrent'
            </if>
            <if test="typeId=='waitSch'">
                <if test='yearMonth!=null and yearMonth!=""'>
                    and SUBSTR(a.SCH_START_DATE,0,7) = #{yearMonth}
                </if>
                and a.status_id='notCurrent'
            </if>
            <if test="typeId=='errorSch'">
                and a.SCH_END_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')
                and a.status_id!='isSch'
                and a.status_id!='notCurrent'
            </if>
        </if>
        ORDER BY a.SCH_START_DATE DESC
    </select>
    <select id="searchProcessByDoctorNew" resultMap="com.pinde.sci.dao.base.ResDoctorSchProcessMapper.BaseResultMap">
        SELECT RDSP.*
        FROM PDSCI.RES_DOCTOR_SCH_PROCESS RDSP
        left join PDSCI.RES_DOCTOR RD
        on RDSP.USER_FLOW = RD.DOCTOR_FLOW
        left join RES_POWER_CFG RPC
        on 'res_doctor_app_login_'||RDSP.USER_FLOW = RPC.CFG_CODE
        WHERE RDSP.RECORD_STATUS = 'Y'
        AND RD.RECORD_STATUS = 'Y'
        and exists(select null from RES_SCH_PROCESS_EXPRESS rr
        where RDSP.USER_FLOW = RR.OPER_USER_FLOW
        and RR.PROCESS_FLOW = RDSP.PROCESS_FLOW
        and RR.REC_TYPE_ID IN ('AfterEvaluation', 'AfterSummary')
        AND RR.RECORD_STATUS='Y'
        and rr.audit_status_id is not null
        and RR.HEAD_AUDIT_STATUS_ID IS NULL)
        <if test='userName!=null and userName!=""'>
            AND RD.DOCTOR_NAME LIKE CONCAT(CONCAT('%', #{userName}),'%')
        </if>
        <if test='sessionNumber!=null and sessionNumber!=""'>
            AND RD.SESSION_NUMBER = #{sessionNumber}
        </if>
        <if test='doctorFlow!=null and doctorFlow!=""'>
            AND RD.doctor_flow = #{doctorFlow}
        </if>
        <if test='isOpen!=null and isOpen!="" and isOpen =="Y" '>
            AND RPC.CFG_VALUE = 'Y'
            AND RPC.RECORD_STATUS = 'Y'
            AND
            (
            (RPC.POWER_START_TIME BETWEEN RDSP.SCH_START_DATE AND RDSP.SCH_END_DATE)
            OR
            (RPC.POWER_END_TIME BETWEEN RDSP.SCH_START_DATE AND RDSP.SCH_END_DATE)
            OR
            (RDSP.SCH_START_DATE >= RPC.POWER_START_TIME AND RDSP.SCH_END_DATE <![CDATA[<=]]> RPC.POWER_END_TIME)
            )
        </if>
        <if test='userFlow!=null and userFlow!=""'>
            AND ( RDSP.SCH_DEPT_FLOW IN (
            SELECT SCH_DEPT_FLOW
            FROM PDSCI.SCH_DEPT
            WHERE RECORD_STATUS = 'Y'
            AND DEPT_FLOW IN (
            SELECT DEPT_FLOW
            FROM SYS_USER_DEPT
            WHERE RECORD_STATUS = 'Y'
            AND USER_FLOW = #{userFlow}
            )
            ) or rdsp.head_user_flow=#{userFlow} )
        </if>
        ORDER by RD.session_Number DESC,RD.TRAINING_SPE_ID desc
    </select>
    <select id="hbresSchProcessStudent" resultType="int">
        select count(distinct(a.USER_FLOW)) from (
        SELECT SAR.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        rd.training_spe_id AS SPE_ID,
        rd.training_spe_name AS SPE_NAME,
        rd.training_type_id CAT_SPE_ID,
        rd.training_type_Name CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        sar.DOCTOR_FLOW AS USER_FLOW,
        sar.ORG_FLOW,
        sar.ORG_NAME,
        sar.DEPT_FLOW,
        sar.DEPT_NAME,
        sar.SCH_DEPT_FLOW,
        sar.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        sar.SCH_START_DATE,
        sar.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name AS TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        nvl(RPC.POWER_START_TIME, NULL) AS POWER_START_TIME,
        nvl(RPC.POWER_END_TIME, NULL) AS POWER_END_TIME,
        case
        when rdsp.process_flow is null then
        'notCurrent'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        'isCurrent'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        'isSch'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        'notCurrent'
        ELSE
        NULL
        END
        end AS STATUS_ID,
        case
        when rdsp.process_flow is null then
        '待入科'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        '轮转中'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        '已出科'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        '待入科'
        ELSE
        NULL
        END
        end AS STATUS_NAME
        FROM sch_arrange_result sar
        LEFT JOIN (select row_number() over(partition by sch_result_flow order by create_time desc) rn,
        p.*
        from RES_DOCTOR_SCH_PROCESS p
        where p.record_status = 'Y') rdsp
        ON rdsp.sch_result_flow = sar.result_flow
        AND rdsp.record_status = 'Y'
        and rdsp.rn = 1
        LEFT JOIN res_doctor rd
        ON sar.doctor_flow = rd.doctor_flow
        LEFT JOIN sys_user su
        ON su.user_flow = sar.doctor_flow
        LEFT JOIN sys_user tu
        ON tu.user_flow = rdsp.teacher_user_flow
        AND tu.record_status = 'Y'
        LEFT JOIN RES_POWER_CFG RPC
        ON ('res_doctor_app_login_' || RDSP.USER_FLOW) = RPC.CFG_CODE
        WHERE rd.record_status = 'Y'
        AND su.record_status = 'Y'
        AND sar.record_status = 'Y'
        <if test='isOpen!=null and isOpen!="" and isOpen =="Y" '>
            AND rpc.record_status = 'Y'
            AND rpc.cfg_value = 'Y'
        </if>
        ) a
        WHERE A.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        <if test='isOpen!=null and isOpen!="" and isOpen =="Y" '>
            and (a.SCH_START_DATE  <![CDATA[<=]]> A.power_start_time
            AND a.SCH_END_DATE >= A.power_END_time
            OR a.SCH_START_DATE >= A.power_start_time
            AND a.SCH_START_DATE  <![CDATA[<=]]> A.power_END_time
            OR a.SCH_END_DATE >= A.power_start_time
            AND a.SCH_END_DATE  <![CDATA[<=]]> A.power_END_time)
        </if>
        and (
        exists(
        select null
        from SYS_USER_DEPT sud
        where sud.RECORD_STATUS='Y'
        and sud.USER_FLOW=#{userFlow}
        and a.DEPT_FLOW=sud.DEPT_FLOW
        )
        <if test="deptFlow!=null and deptFlow!=''">
            or a.DEPT_FLOW=#{deptFlow}
        </if>
        )
        <!--and a.SCH_START_DATE <![CDATA[<=]]>to_char(sysdate,'yyyy-MM-dd')-->
    </select>
    <select id="getOrgDocCount" resultType="int">
        select count(1)
        from pdsci.RES_DOCTOR_RECRUIT dr
        left join  pdsci.SYS_USER u
        on dr.DOCTOR_FLOW =  u.USER_FLOW
        left join  RES_DOCTOR ed
        on dr.DOCTOR_FLOW =  ed.DOCTOR_FLOW
        where dr.RECORD_STATUS= 'Y' and u.RECORD_STATUS= 'Y'
            <if test="sessionNumber!=null and sessionNumber!=''">
                and dr.SESSION_NUMBER = #{sessionNumber}
            </if>
            <if test='orgFlow!=null and orgFlow!=""'>
                and dr.ORG_FLOW = #{orgFlow}
            </if>
                and dr.AUDIT_STATUS_ID='Passed'
            <if test="statusId!=null and statusId!=''">
                and ed.doctor_Status_Id = #{statusId}
            </if>
    </select>

    <resultMap id="DoctorRecruit" type="hashmap" extends="com.pinde.sci.dao.base.ResDoctorRecruitMapper.BaseResultMap" >
        <result column="USER_FLOW" property="userFlow" jdbcType="VARCHAR" />
        <result column="USER_CODE" property="userCode" jdbcType="VARCHAR" />
        <result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
        <result column="SEX_ID" property="sexId" jdbcType="VARCHAR" />
        <result column="SEX_NAME" property="sexName" jdbcType="VARCHAR" />
        <result column="USER_PHONE" property="userPhone" jdbcType="VARCHAR" />
        <result column="USER_EMAIL" property="userEmail" jdbcType="VARCHAR" />
        <result column="ID_NO" property="idNo" jdbcType="VARCHAR" />
        <result column="USER_BIRTHDAY" property="userBirthday" jdbcType="VARCHAR" />
        <result column="TITLE_ID" property="titleId" jdbcType="VARCHAR" />
        <result column="TITLE_NAME" property="titleName" jdbcType="VARCHAR" />
        <result column="DEGREE_ID" property="degreeId" jdbcType="VARCHAR" />
        <result column="DEGREE_NAME" property="degreeName" jdbcType="VARCHAR" />
        <result column="EDUCATION_ID" property="educationId" jdbcType="VARCHAR" />
        <result column="EDUCATION_NAME" property="educationName" jdbcType="VARCHAR" />
        <result column="POST_ID" property="postId" jdbcType="VARCHAR" />
        <result column="POST_NAME" property="postName" jdbcType="VARCHAR" />
        <result column="USER_HEAD_IMG" property="userHeadImg" jdbcType="VARCHAR" />
        <result column="USER_QQ" property="userQq" jdbcType="VARCHAR" />
        <result column="DOCTOR_TYPE_NAME" property="doctorTypeName" jdbcType="VARCHAR" />
        <result column="DOCTOR_TYPE_ID" property="doctorTypeId" jdbcType="VARCHAR" />
    </resultMap>
    <select id="getOrgDocList" resultMap="DoctorRecruit">
        select dr.*,u.USER_FLOW, u.USER_CODE, u.USER_NAME, u.SEX_ID, u.SEX_NAME, u.USER_PHONE, u.USER_EMAIL,u.USER_HEAD_IMG,ED.DOCTOR_TYPE_ID,ED.DOCTOR_TYPE_NAME
        , u.ID_NO, u.USER_BIRTHDAY, u.TITLE_ID, u.TITLE_NAME, u.DEGREE_ID, u.DEGREE_NAME, u.EDUCATION_ID, u.EDUCATION_NAME, u.POST_ID, u.POST_NAME,
        ed.ORG_FLOW as edOrgFlow,ed.ORG_Name as edOrgName
        from pdsci.RES_DOCTOR_RECRUIT dr
        left join  pdsci.SYS_USER u
        on dr.DOCTOR_FLOW =  u.USER_FLOW
        left join  RES_DOCTOR ed
        on dr.DOCTOR_FLOW =  ed.DOCTOR_FLOW
        where dr.RECORD_STATUS= 'Y' and u.RECORD_STATUS= 'Y'
            <if test="sessionNumber!=null and sessionNumber!=''">
                and dr.SESSION_NUMBER = #{sessionNumber}
            </if>
            <if test="trainingTypeId!=null and trainingTypeId!=''">
                and dr.CAT_SPE_ID = #{trainingTypeId}
            </if>
            <if test="trainingSpeId!=null and trainingSpeId!=''">
                and dr.SPE_ID = #{trainingSpeId}
            </if>
            <if test='orgFlow!=null and orgFlow!=""'>
                and dr.ORG_FLOW = #{orgFlow}
            </if>
                and dr.AUDIT_STATUS_ID='Passed'
            <if test="userName!=null and userName!=''">
                <bind name="userName" value="'%'+userName+'%'"/>
                and u.USER_NAME like #{userName}
            </if>
            <if test="doctorTypeId!=null and doctorTypeId!=''">
                and ed.DOCTOR_TYPE_ID = #{doctorTypeId}
            </if>
            <if test="statusId!=null and statusId!=''">
                and ed.doctor_Status_Id = #{statusId}
            </if>
        order by  NLSSORT(u.USER_NAME,'NLS_SORT = SCHINESE_PINYIN_M'),dr.org_flow, dr.doctor_flow,dr.CREATE_TIME desc
    </select>
    <resultMap type="HashMap" id="deptStudentsMap" extends="com.pinde.core.common.sci.dao.SysUserMapper.BaseResultMap">
        <result column="training_spe_name" javaType="string" property="trainingSpeName"/>
        <result column="session_number" javaType="string" property="sessionNumber"/>
        <result column="RING_PASS" property="ringPass" jdbcType="VARCHAR" />
        <result column="RING_ID" property="ringId" jdbcType="VARCHAR" />
        <result column="depart_Ment_Flow" property="departMentFlow" jdbcType="VARCHAR" />
        <result column="depart_Ment_name" property="departMentName" jdbcType="VARCHAR" />
        <result column="work_org_name2" property="workOrgName2" jdbcType="VARCHAR" />
        <result column="doctor_type_id" property="doctorTypeId" jdbcType="VARCHAR" />
    </resultMap>
    <select id="getCycleStudents" resultMap="deptStudentsMap">
        select su.*,rd.session_number,rd.training_spe_name,ring.RING_ID,ring.RING_PASS,rd.depart_Ment_Flow,rd.depart_Ment_name,
        rd.work_org_name  work_org_name2,rd.doctor_type_id
        from sys_user su
        left join res_doctor rd
        on su.user_flow=rd.doctor_flow
        left join RES_Ring_letter_user ring
        on ring.record_status='Y' and su.user_flow=ring.user_flow
        where su.record_status='Y'
        and rd.record_status='Y'
        and su.user_flow != #{userFlow}
        <if test="speId!=null and speId!=''">
            and rd.training_spe_id = #{speId}
        </if>
        <if test="sessionNumber!=null and sessionNumber!=''">
            and rd.session_number  = #{sessionNumber}
        </if>
        <if test="stuName!=null and stuName!=''">
            <bind name="name" value="'%'+stuName+'%'"/>
            and su.USER_NAME like #{name}
        </if>
        and exists(
        SELECT 1
        FROM pdsci.res_doctor_sch_process rdsp
        LEFT JOIN res_power_cfg rpc
        on 'res_doctor_web_' || rdsp.user_flow = rpc.cfg_code
        INNER JOIN pdsci.sch_arrange_result sar
        ON sar.record_status = 'Y'
        AND sar.result_flow = rdsp.sch_result_flow
        WHERE rdsp.record_status = 'Y'
        and (rdsp.sch_flag ='Y' or rdsp.is_current_flag='Y')
        and rdsp.user_flow=su.user_flow
        <if test='isPermitOpen != null and isPermitOpen!="" and isPermitOpen=="Y"'>
            and rpc.record_status = 'Y'
            and rpc.cfg_value = 'Y'
            and (
            (rpc.power_start_time between rdsp.sch_start_date and rdsp.sch_end_date )
            or (rpc.power_end_time between rdsp.sch_start_date and rdsp.sch_end_date)
            or (rdsp.sch_start_date >= rpc.power_start_time and rdsp.sch_end_date <![CDATA[ <= ]]>  rpc.power_end_time)
            )
        </if>
        <if test='schDeptFlow != null and schDeptFlow!=""'>
            and rdsp.sch_dept_flow=#{schDeptFlow}
        </if>
        and (
            rdsp.dept_flow in (
            select sud.dept_flow from sys_user_dept sud
            left join sys_dept d on sud.dept_flow=d.dept_flow
            where sud.record_status='Y'
            and d.record_status = 'Y'
            and sud.user_flow=#{userFlow}
            union
            select dept_flow
            from sys_user sud
            where sud.record_status='Y'
            and sud.user_flow=#{userFlow}
            )
            )
        )
        order by nlssort(user_name,'NLS_SORT=SCHINESE_PINYIN_M')
    </select>
    <select id="docSchDeptList" resultMap="processUserMap">
        select * from (
        SELECT SAR.SESSION_NUMBER,
        SAR.RESULT_FLOW,
        rd.training_spe_id AS SPE_ID,
        rd.training_spe_name AS SPE_NAME,
        rd.training_type_id CAT_SPE_ID,
        rd.training_type_Name CAT_SPE_NAME,
        RDSP.PROCESS_FLOW,
        sar.DOCTOR_FLOW AS USER_FLOW,
        sar.ORG_FLOW,
        sar.ORG_NAME,
        sar.DEPT_FLOW,
        sar.DEPT_NAME,
        sar.SCH_DEPT_FLOW,
        sar.SCH_DEPT_NAME,
        RDSP.SCH_RESULT_FLOW,
        sar.SCH_START_DATE,
        sar.SCH_END_DATE,
        RDSP.TEACHER_USER_FLOW,
        tu.user_name AS TEACHER_USER_NAME,
        RDSP.HEAD_USER_FLOW,
        RDSP.HEAD_USER_NAME,
        RDSP.SCH_FLAG,
        RDSP.SCH_SCORE,
        RDSP.IS_CURRENT_FLAG,
        SU.USER_NAME,
        SU.USER_HEAD_IMG,
        RD.DOCTOR_TYPE_ID,
        nvl(RPC.POWER_START_TIME, NULL) AS POWER_START_TIME,
        nvl(RPC.POWER_END_TIME, NULL) AS POWER_END_TIME,
        case
        when rdsp.process_flow is null then
        'notCurrent'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        'isCurrent'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        'isSch'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        'notCurrent'
        ELSE
        NULL
        END
        end AS STATUS_ID,
        case
        when rdsp.process_flow is null then
        '待入科'
        else
        CASE
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG = 'Y' THEN
        NULL
        WHEN rdsp.IS_CURRENT_FLAG = 'Y' AND rdsp.SCH_FLAG != 'Y' THEN
        '轮转中'
        WHEN rdsp.SCH_FLAG = 'Y' AND rdsp.IS_CURRENT_FLAG != 'Y' THEN
        '已出科'
        WHEN rdsp.SCH_FLAG = 'N' AND rdsp.IS_CURRENT_FLAG = 'N' THEN
        '待入科'
        ELSE
        NULL
        END
        end AS STATUS_NAME
        FROM sch_arrange_result sar
        LEFT JOIN (select row_number() over(partition by sch_result_flow order by create_time desc) rn,
        p.*
        from RES_DOCTOR_SCH_PROCESS p
        where p.record_status = 'Y') rdsp
        ON rdsp.sch_result_flow = sar.result_flow
        AND rdsp.record_status = 'Y'
        and rdsp.rn = 1
        LEFT JOIN res_doctor rd
        ON sar.doctor_flow = rd.doctor_flow
        LEFT JOIN sys_user su
        ON su.user_flow = sar.doctor_flow
        LEFT JOIN sys_user tu
        ON tu.user_flow = rdsp.teacher_user_flow
        AND tu.record_status = 'Y'
        LEFT JOIN RES_POWER_CFG RPC
        ON ('res_doctor_app_login_' || RDSP.USER_FLOW) = RPC.CFG_CODE
        WHERE rd.record_status = 'Y'
        AND su.record_status = 'Y'
        AND sar.record_status = 'Y'
        <if test='doctorFlow!=null and doctorFlow!=""'>
            and su.user_flow=#{doctorFlow}
        </if>
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and rpc.record_status = 'Y'
            and rpc.cfg_value = 'Y'
        </if>
        ) a
        WHERE A.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate','CompanyEntrust','ExternalEntrust')
        and a.dept_flow in (
            select sud.dept_flow from sys_user_dept sud
            left join sys_dept d on sud.dept_flow=d.dept_flow
            where sud.record_status='Y'
            and d.record_status = 'Y'
            and sud.user_flow=#{userFlow}
            union
            select dept_flow
            from sys_user sud
            where sud.record_status='Y'
            and sud.user_flow=#{userFlow}
        )
        <if test='isOpen!=null and isOpen!="" and isOpen=="Y".toString()'>
            and (a.POWER_START_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.POWER_END_TIME BETWEEN a.SCH_START_DATE AND a.SCH_END_DATE
            OR a.SCH_START_DATE <![CDATA[>=]]> a.POWER_START_TIME
            AND a.SCH_END_DATE <![CDATA[<=]]> a.POWER_END_TIME)
            and a.POWER_START_TIME is not null
            and a.POWER_END_TIME is not null
        </if>
        <if test='seachStr!=null and seachStr!=""'>
            and (a.session_number like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.spe_name like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.STATUS_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%')
            OR a.TEACHER_USER_NAME like CONCAT(CONCAT('%', #{seachStr}),'%'))
        </if>
                and (a.status_id='isCurrent'or a.status_id='isSch')
        ORDER BY a.SCH_START_DATE DESC,a.sch_end_date
    </select>
    <select id="readSchDeptList" resultMap="com.pinde.sci.dao.base.SchDeptMapper.BaseResultMap">
        select  * from sch_dept
        where record_status='Y'
        and dept_flow in  (
            select sud.dept_flow from sys_user_dept sud
            left join sys_dept d on sud.dept_flow=d.dept_flow
            where sud.record_status='Y'
            and d.record_status = 'Y'
            and sud.user_flow=#{userFlow}
            union
            select dept_flow
            from sys_user sud
            where sud.record_status='Y'
            and sud.user_flow=#{userFlow}
        )
    </select>
    <select id="searchJoinActivityByProcessFlow" resultMap="com.pinde.sci.dao.base.TeachingActivityInfoMapper.BaseResultMap">
        		SELECT INFO.*
		  FROM TEACHING_ACTIVITY_RESULT R
		  LEFT JOIN TEACHING_ACTIVITY_INFO INFO
			ON R.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
		  LEFT JOIN SCH_ARRANGE_RESULT SAR
			ON R.USER_FLOW = SAR.DOCTOR_FLOW
          LEFT JOIN RES_DOCTOR_SCH_PROCESS P
          ON P.USER_FLOW=R.USER_FLOW
          AND SAR.RESULT_FLOW=P.SCH_RESULT_FLOW
             WHERE R.RECORD_STATUS = 'Y'
               AND INFO.RECORD_STATUS = 'Y'
               AND P.RECORD_STATUS = 'Y'
              AND P.PROCESS_FLOW=#{processFlow}
               AND SAR.RECORD_STATUS = 'Y'
               AND INFO.IS_EFFECTIVE = 'Y'
               AND R.IS_EFFECTIVE = 'Y'
           AND ((SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.start_time, 0, 10) AND
             SAR.SCH_END_DATE >= substr(info.end_time, 0, 10)) or
             (SAR.SCH_START_DATE >= substr(info.start_time, 0, 10) AND
             SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)) or
             (SAR.SCH_END_DATE >= substr(info.start_time, 0, 10) AND
             SAR.SCH_END_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)))
    </select>

    <select id="searchJoinActivityByProcessFlowNotScore" resultMap="com.pinde.sci.dao.base.TeachingActivityInfoMapper.BaseResultMap">
        		SELECT INFO.*
		  FROM TEACHING_ACTIVITY_RESULT R
		  LEFT JOIN TEACHING_ACTIVITY_INFO INFO
			ON R.ACTIVITY_FLOW = INFO.ACTIVITY_FLOW
		  LEFT JOIN SCH_ARRANGE_RESULT SAR
			ON R.USER_FLOW = SAR.DOCTOR_FLOW
          LEFT JOIN RES_DOCTOR_SCH_PROCESS P
          ON P.USER_FLOW=R.USER_FLOW
          AND SAR.RESULT_FLOW=P.SCH_RESULT_FLOW
             WHERE R.RECORD_STATUS = 'Y'
               AND INFO.RECORD_STATUS = 'Y'
               AND P.RECORD_STATUS = 'Y'
              AND P.PROCESS_FLOW=#{processFlow}
               AND SAR.RECORD_STATUS = 'Y'
               AND INFO.IS_EFFECTIVE = 'Y'
               AND R.EVAL_SCORE IS NOT NULL
               AND R.IS_EFFECTIVE = 'Y'
           AND ((SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.start_time, 0, 10) AND
             SAR.SCH_END_DATE >= substr(info.end_time, 0, 10)) or
             (SAR.SCH_START_DATE >= substr(info.start_time, 0, 10) AND
             SAR.SCH_START_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)) or
             (SAR.SCH_END_DATE >= substr(info.start_time, 0, 10) AND
             SAR.SCH_END_DATE <![CDATA[ <= ]]> substr(info.end_time, 0, 10)))
    </select>

    <select id="checkProcessEval" resultType="Integer">
        select count(1)
        from res_doctor_sch_process rdsp
        where record_status = 'Y'
        and process_flow=#{processFlow}
        and MONTHS_BETWEEN(to_date(substr(sch_end_date, 0, 7), 'yyyy-MM'),
        to_date(substr(sch_start_date, 0, 7), 'yyyy-MM')) + 1 !=
        (select count(1)
        from RES_DOCTOR_SCH_PROCESS_EVAL eval
        where eval.process_flow = rdsp.process_flow
        and eval.record_status = 'Y')
    </select>
    <select id="dayAttendListCount" resultType="java.lang.Integer">
        select count(1)
        FROM RES_DOCTOR_SCH_PROCESS RDSP
        LEFT JOIN SYS_DATE_INFO SDI ON SDI.RECORD_STATUS = 'Y'
        AND DATE_DAY  <![CDATA[<=]]> RDSP.SCH_END_DATE
        AND DATE_DAY >= RDSP.SCH_START_DATE
        LEFT JOIN JSRES_ATTENDANCE JA ON SDI.DATE_DAY = JA.ATTEND_DATE
        AND JA.RECORD_STATUS = 'Y'
        AND JA.DOCTOR_FLOW = RDSP.USER_FLOW
        LEFT JOIN JSRES_ATTENDANCE_DETAIL JAD ON JAD.ATTENDANCE_FLOW =
        JA.ATTENDANCE_FLOW and jad.record_status='Y'
        WHERE 1=1
        <if test="attendType!=null and attendType!=''">
            <if test="attendType=='0'.toString()">
                and (JA.ATTEND_STATUS = '0' OR JA.ATTEND_STATUS IS NULL)
            </if>
            <if test="attendType!='0'.toString()">
                and (JA.ATTEND_STATUS = #{attendType})
            </if>
        </if>
        <if test="biaoJi!=null and biaoJi!=''">
            and (JA.AUDIT_STATUS_ID = 'Auditing' OR JA.AUDIT_STATUS_ID IS NULL)
        </if>
        <if test="processFlow!=null and processFlow!=''">
            and rdsp.process_flow =#{processFlow}
        </if>
        <if test="nowDate!=null and nowDate!=''">
            and DATE_DAY <![CDATA[<=]]>#{nowDate}
        </if>

    </select>
    <resultMap id="doctorDeptAvgWorkDetailMap" type="HashMap">
        <result  property="recruitFlow" column="RECRUIT_FLOW" javaType="string"/>
        <result  property="rotationFlow" column="ROTATION_FLOW" javaType="string"/>
        <result  property="doctorFlow" column="DOCTOR_FLOW" javaType="string"/>
        <result  property="avgComplete" column="AVG_COMPLETE" javaType="string"/>
        <result  property="avgInComplete" column="AVG_IN_COMPLETE" javaType="string"/>
        <result  property="avgOutComplete" column="AVG_OUT_COMPLETE" javaType="string"/>
        <result  property="avgAudit" column="AVG_AUDIT" javaType="string"/>
    </resultMap>
    <select id="doctorDeptAvgWorkDetail"  resultMap="doctorDeptAvgWorkDetailMap">
	SELECT T.RECRUIT_FLOW,NVL(AVG_COMPLETE,0) AVG_COMPLETE,NVL(AVG_IN_COMPLETE,0) AVG_IN_COMPLETE,NVL(AVG_OUT_COMPLETE,0) AVG_OUT_COMPLETE,NVL(AVG_AUDIT,0) AVG_AUDIT
			  FROM jsres_graduation_apply T
			 WHERE  T.RECORD_STATUS = 'Y'
			 and T.RECRUIT_FLOW = #{recruitFlow}
			 and t.apply_year=#{applyYear}
	</select>

    <select id="selectProcessByDoctorNew" resultMap="com.pinde.sci.dao.base.ResDoctorSchProcessMapper.BaseResultMap">
        SELECT RDSP.*
        FROM PDSCI.RES_DOCTOR_SCH_PROCESS RDSP
        left join PDSCI.RES_DOCTOR RD
        on RDSP.USER_FLOW = RD.DOCTOR_FLOW
        WHERE RDSP.RECORD_STATUS = 'Y'
        AND RD.RECORD_STATUS = 'Y'
        AND RD.DOCTOR_STATUS_NAME in( '在培','其他')
        <if test="roleFlog == 'Nurse'">
            <if test="null != deptFlow and '' != deptFlow">
                AND RDSP.DEPT_FLOW = #{deptFlow}
            </if>
            <if test="null != deptFlows and deptFlows.size >0">
                AND RDSP.DEPT_FLOW IN (
                <foreach collection="deptFlows" separator="," item="deptFlow">
                    #{deptFlow}
                </foreach>)
            </if>
            AND RDSP.ORG_FLOW =  #{orgFlow}
        </if>
        <if test="roleFlog == 'Teacher'">
            AND RDSP.TEACHER_USER_FLOW = #{teacherUserFlow}
        </if>
        <if test="docTypeList!=null and docTypeList.size>0">
            and rd.DOCTOR_TYPE_ID in
            <foreach collection="docTypeList" open="(" separator="," close=")" item="item">#{item}</foreach>
        </if>
        <if test="doctor!=null">
            <if test='doctor.doctorName!=null and doctor.doctorName!=""'>
                AND RD.DOCTOR_NAME LIKE CONCAT(CONCAT('%', #{doctor.doctorName}),'%')
            </if>
            <if test='doctor.trainingSpeId!=null and doctor.trainingSpeId!=""'>
                AND RD.TRAINING_SPE_ID = #{doctor.trainingSpeId}
            </if>
            <if test='doctor.sessionNumber!=null and doctor.sessionNumber!=""'>
                AND RD.SESSION_NUMBER = #{doctor.sessionNumber}
            </if>
            <if test='doctor.trainingTypeId!=null and doctor.trainingTypeId!=""'>
                AND RD.TRAINING_TYPE_ID = #{doctor.trainingTypeId}
            </if>
        </if>
        <if test='assessStatusId != null and assessStatusId !="" '>
            <if test="assessStatusId == 'Assessed'">
                AND EXISTS (SELECT 1 FROM DEPT_TEACHER_GRADE_INFO DTGI
                WHERE DTGI.RECORD_STATUS='Y'
                AND DTGI.PROCESS_FLOW=RDSP.PROCESS_FLOW
                <if test="roleFlog == 'nurse'">
                    AND DTGI.REC_TYPE_ID='NurseDoctorGrade'
                </if>
                <if test="roleFlog == 'teacher'">
                    AND DTGI.REC_TYPE_ID='TeacherDoctorGrade'
                </if>
                AND DTGI.OPER_USER_FLOW = #{userFlow}
                )
            </if>
            <if test="assessStatusId == 'Assessing'">
                AND not EXISTS (SELECT 1 FROM DEPT_TEACHER_GRADE_INFO DTGI
                WHERE DTGI.RECORD_STATUS='Y'
                AND DTGI.PROCESS_FLOW=RDSP.PROCESS_FLOW
                <if test="roleFlog == 'nurse'">
                    AND DTGI.REC_TYPE_ID='NurseDoctorGrade'
                </if>
                <if test="roleFlog == 'teacher'">
                    AND DTGI.REC_TYPE_ID='TeacherDoctorGrade'
                </if>
                AND DTGI.OPER_USER_FLOW = #{userFlow}
                )
            </if>
        </if>
        ORDER by RD.session_Number DESC,RD.TRAINING_SPE_ID desc,rd.doctor_flow
    </select>

    <select id="findDoctorNameByRecTime" resultType="string">
        SELECT DISTINCT A.DOCTOR_NAME FROM (
            SELECT RDSP.PROCESS_FLOW,SAR.DOCTOR_NAME FROM SCH_ARRANGE_RESULT SAR
            LEFT JOIN RES_DOCTOR_SCH_PROCESS RDSP ON SAR.RESULT_FLOW=RDSP.SCH_RESULT_FLOW
            LEFT JOIN RES_DOCTOR RD ON SAR.DOCTOR_FLOW=RD.DOCTOR_FLOW
            WHERE SAR.RECORD_STATUS = 'Y'
            AND RDSP.RECORD_STATUS = 'Y'
            AND RD.RECORD_STATUS = 'Y'
            AND RD.DOCTOR_STATUS_ID = '20'
            AND SAR.HAVE_AFTER_PIC != 'Y'
            AND RDSP.SCH_START_DATE <![CDATA[<=]]> #{appointDateSch}
            AND RDSP.DEPT_FLOW IN (
                SELECT DEPT_FLOW
                FROM SYS_USER_DEPT D
                WHERE D.USER_FLOW = #{userFlow}
                AND D.RECORD_STATUS = 'Y')
            )A
        WHERE (
            SELECT COUNT(1) AS NUM FROM RES_REC B
            WHERE A.PROCESS_FLOW=B.PROCESS_FLOW
            AND B.RECORD_STATUS = 'Y'
            AND B.MODIFY_TIME <![CDATA[<=]]> #{appointDateRec}
        )=0
        ORDER BY NLSSORT(DOCTOR_NAME, 'NLS_SORT = SCHINESE_PINYIN_M')
    </select>

    <select id="temporaryOutSearch"  resultMap="processUserMap">
        select p.PROCESS_FLOW,
        p.USER_FLOW USER_FLOW,
        P.ORG_FLOW          ORG_FLOW,
        P.ORG_NAME          ORG_NAME,
        P.DEPT_FLOW DEPT_FLOW,
        P.MODIFY_TIME,
        P.DEPT_NAME,
        P.SCH_DEPT_FLOW,
        P.SCH_DEPT_NAME,
        P.SCH_RESULT_FLOW,
        P.SCH_START_DATE SCH_START_DATE,
        P.SCH_END_DATE SCH_END_DATE,
        P.TEACHER_USER_FLOW TEACHER_USER_FLOW,
        P.TEACHER_USER_NAME,
        P.HEAD_USER_FLOW,
        P.HEAD_USER_NAME,
        P.SCH_FLAG,
        P.SCH_SCORE,
        P.IS_CURRENT_FLAG,
        P.TEMPORARY_AUDIT_STATUS_ID,
        P.TEMPORARY_AUDIT_STATUS_NAME,
        su.USER_Name USER_Name,
        su.SEX_NAME,
        su.USER_PHONE,
        RD.DOCTOR_TYPE_ID,
        RD.DOCTOR_TYPE_Name
        from res_doctor_sch_process p
        left join res_doctor rd
        on p.user_flow = rd.doctor_flow
        left join sys_user su
        on su.user_flow = rd.doctor_flow
        left join sys_user tu
        on tu.user_flow = p.teacher_user_flow
        where p.record_status = 'Y'
        and rd.record_status = 'Y'
        and su.record_status = 'Y'
        and tu.record_status = 'Y'
        <if test="roleId != null and roleId == 'user'.toString()">
            and su.USER_FLOW = #{userFlow}
        </if>
        <if test="roleId != null and roleId == 'org'.toString()">
            and rd.ORG_FLOW = #{orgFlow}
        </if>
        <if test="roleId != null and roleId != 'org'.toString() and roleId != 'user'.toString()">
            AND P.DEPT_FLOW IN
            (
            SELECT DEPT_FLOW FROM
            SYS_USER_DEPT D WHERE D.RECORD_STATUS = 'Y'
            AND (D.USER_FLOW = #{userFlow}
            <if test="deptFlow!=null and deptFlow!=''">
                OR D.DEPT_FLOW = #{deptFlow}
            </if>
            ))
        </if>

        <if test="doctorName!=null and doctorName!=''">
            <bind name="name" value="'%'+doctorName+'%'"/>
            and su.USER_NAME like #{name}
        </if>
        <if test="docTypeList!=null and docTypeList.size>0">
            and rd.DOCTOR_TYPE_ID in
            <foreach collection="docTypeList" open="(" separator="," close=")" item="item">#{item}</foreach>
        </if>
        <if test="temporaryAuditStatusId!=null and temporaryAuditStatusId!=''">
            AND p.TEMPORARY_AUDIT_STATUS_ID = #{temporaryAuditStatusId}
        </if>
        <if test="trainingTypeId!=null and trainingTypeId!=''">
            AND rd.training_type_id = #{trainingTypeId}
        </if>
        AND P.TEMPORARY_OUT = 'Y'
        ORDER BY P.MODIFY_TIME DESC
    </select>

    <resultMap type="HashMap" id="schProcessStudentDistinctQuery2Map">
        <result column="DEPT_FLOW" javaType="string" property="deptFlow"></result>
        <result column="DEPT_NAME" javaType="string" property="deptName"></result>
        <result column="NUM" javaType="string" property="num"></result>
    </resultMap>
    <select id="schProcessStudentDistinctQuery2"  resultMap="schProcessStudentDistinctQuery2Map">
        SELECT DEPT_FLOW,DEPT_NAME,COUNT(DISTINCT a.USER_FLOW) NUM
        FROM (
        SELECT SAR.SESSION_NUMBER, SAR.RESULT_FLOW, RDR.SPE_ID, RDR.SPE_NAME, RDR.CAT_SPE_ID
        , RDR.CAT_SPE_NAME, RDSP.PROCESS_FLOW, RDSP.USER_FLOW, RDSP.ORG_FLOW, RDSP.ORG_NAME
        , RDSP.DEPT_FLOW, RDSP.DEPT_NAME, RDSP.SCH_DEPT_FLOW, RDSP.SCH_DEPT_NAME, RDSP.SCH_RESULT_FLOW
        , RDSP.SCH_START_DATE, RDSP.SCH_END_DATE, RDSP.TEACHER_USER_FLOW, tu.user_name AS TEACHER_USER_NAME, RDSP.HEAD_USER_FLOW
        , RDSP.HEAD_USER_NAME, RDSP.SCH_FLAG, RDSP.SCH_SCORE, RDSP.IS_CURRENT_FLAG, SU.USER_NAME
        , SU.USER_HEAD_IMG, RD.DOCTOR_TYPE_ID, nvl((
        SELECT CFG_VALUE
        FROM jsres_power_cfg cfg
        WHERE cfg.record_status = 'Y'
        AND cfg.cfg_code = ('jsres_doctor_app_menu_' || rd.doctor_flow)
        ), 'N') AS APP_MENU_FLAG, nvl(cfg2.power_start_time, '0000-00-00') AS power_start_time, nvl(cfg2.power_end_time, '9999-99-99') AS power_end_time
        FROM RES_DOCTOR_SCH_PROCESS rdsp
        LEFT JOIN sch_arrange_result sar ON rdsp.sch_result_flow = sar.result_flow
        LEFT JOIN res_doctor_recruit rdr ON rdr.DOCTOR_FLOW = sar.DOCTOR_FLOW
        AND rdr.RECORD_STATUS = 'Y'
        AND sar.session_number = rdr.SESSION_NUMBER
        AND rdr.AUDIT_STATUS_ID = 'Passed'
        LEFT JOIN res_doctor rd ON rdsp.user_flow = rd.doctor_flow
        LEFT JOIN sys_user su ON su.user_flow = rdsp.user_flow
        LEFT JOIN sys_user tu ON tu.user_flow = rdsp.teacher_user_flow
        LEFT JOIN SYS_DEPT SD ON SD.DEPT_FLOW=RDSP.SCH_DEPT_FLOW
        LEFT JOIN jsres_power_cfg cfg2 ON cfg2.record_status = 'Y'
        AND cfg2.cfg_code = ('jsres_doctor_data_time_' || rd.doctor_flow)
        WHERE rdsp.record_status = 'Y'
        AND rd.record_status = 'Y'
        AND su.record_status = 'Y'
        AND tu.record_status = 'Y'
        AND SAR.RECORD_STATUS = 'Y'
        AND SD.RECORD_STATUS = 'Y'
        <if test="orgFlow!=null and orgFlow!=''">
            AND SD.ORG_FLOW= #{orgFlow}
        </if>
        <if test="startTime!=null and startTime!=''">
            AND RDSP.SCH_START_DATE <![CDATA[>=]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            and RDSP.SCH_END_DATE <![CDATA[<=]]> #{endTime}
        </if>
        ) a
        WHERE a.APP_MENU_FLAG = 'Y'
        <!--
        AND (a.SCH_START_DATE <![CDATA[<=]]> A.power_start_time
        AND a.SCH_END_DATE <![CDATA[>=]]> A.power_END_time
        OR a.SCH_START_DATE <![CDATA[>=]]> A.power_start_time
        AND a.SCH_START_DATE <![CDATA[<=]]> A.power_END_time
        OR a.SCH_END_DATE <![CDATA[>=]]> A.power_start_time
        AND a.SCH_END_DATE <![CDATA[<=]]> A.power_END_time)
        -->
        AND A.DOCTOR_TYPE_ID IN ('Company', 'Social', 'Graduate')
        AND (EXISTS (SELECT NULL
        FROM SYS_USER_DEPT sud
        WHERE sud.RECORD_STATUS = 'Y'
        AND a.DEPT_FLOW = sud.DEPT_FLOW))
        <if test="deptFlow!=null and deptFlow!=''">
            AND A.DEPT_FLOW= #{deptFlow}
        </if>
        GROUP BY DEPT_FLOW, DEPT_NAME
    </select>
    <select id="studentList" resultType="java.lang.String">
        SELECT
        u.USER_FLOW
        FROM
        SYS_USER u
        LEFT JOIN
        RES_DOCTOR_SCH_PROCESS p ON u.USER_FLOW = p.USER_FLOW
        WHERE
        u.RECORD_STATUS = 'Y'
        AND p.RECORD_STATUS = 'Y'
        AND p.TEACHER_USER_FLOW = #{userFlow}
        <if test="isNow!=null">
            AND p.SCH_START_DATE <![CDATA[<=]]> TO_CHAR( SYSDATE, 'yyyy-mm-dd' )
            AND p.SCH_END_DATE >= TO_CHAR( SYSDATE, 'yyyy-mm-dd' )
        </if>
        GROUP BY u.USER_FLOW
    </select>

</mapper>